{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/projects/astralis-nextjs/src/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\n\n/**\n * Middleware for route protection and authentication\n *\n * This middleware runs before every route and can:\n * - Protect authenticated routes\n * - Protect admin routes\n * - Redirect based on auth status\n * - Add custom headers\n */\n\n// Routes that require authentication\nconst PROTECTED_ROUTES = [\n  '/checkout',\n  '/orders',\n  '/dashboard',\n  '/profile',\n  '/account',\n];\n\n// Routes that require admin role\nconst ADMIN_ROUTES = [\n  '/admin',\n];\n\n// Routes that should redirect to home if user is already authenticated\nconst AUTH_ROUTES = [\n  '/login',\n  '/register',\n  '/signup',\n];\n\nexport function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n\n  // Get authentication token from cookies or headers\n  const token = getAuthToken(request);\n  const isAuthenticated = !!token;\n\n  // Get user role from token (you'll need to implement JWT verification)\n  const userRole = getUserRole(token);\n  const isAdmin = userRole === 'ADMIN';\n\n  // Protect admin routes\n  if (isAdminRoute(pathname)) {\n    if (!isAuthenticated) {\n      return redirectToLogin(request);\n    }\n    if (!isAdmin) {\n      return redirectToHome(request, 'Unauthorized access');\n    }\n  }\n\n  // Protect authenticated routes\n  if (isProtectedRoute(pathname)) {\n    if (!isAuthenticated) {\n      return redirectToLogin(request);\n    }\n  }\n\n  // Redirect authenticated users away from auth pages\n  if (isAuthRoute(pathname) && isAuthenticated) {\n    return redirectToHome(request);\n  }\n\n  // Continue with the request\n  const response = NextResponse.next();\n\n  // Add custom headers\n  response.headers.set('x-middleware-cache', 'no-cache');\n\n  return response;\n}\n\n/**\n * Helper Functions\n */\n\nfunction getAuthToken(request: NextRequest): string | null {\n  // Try to get token from Authorization header\n  const authHeader = request.headers.get('authorization');\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    return authHeader.substring(7);\n  }\n\n  // Try to get token from cookies\n  const tokenFromCookie = request.cookies.get('token')?.value;\n  if (tokenFromCookie) {\n    return tokenFromCookie;\n  }\n\n  // Try NextAuth session token\n  const nextAuthToken = request.cookies.get('next-auth.session-token')?.value;\n  if (nextAuthToken) {\n    return nextAuthToken;\n  }\n\n  return null;\n}\n\nfunction getUserRole(token: string | null): string | null {\n  if (!token) return null;\n\n  try {\n    // TODO: Implement proper JWT verification\n    // For now, we'll use a simple base64 decode (NOT SECURE IN PRODUCTION)\n    // In production, use a library like 'jose' or 'jsonwebtoken'\n    const payload = parseJwtPayload(token);\n    return payload?.role || null;\n  } catch (error) {\n    console.error('Error parsing JWT token:', error);\n    return null;\n  }\n}\n\nfunction parseJwtPayload(token: string): any {\n  try {\n    const parts = token.split('.');\n    if (parts.length !== 3) return null;\n\n    const payload = parts[1];\n    const decoded = Buffer.from(payload, 'base64').toString('utf-8');\n    return JSON.parse(decoded);\n  } catch (error) {\n    return null;\n  }\n}\n\nfunction isProtectedRoute(pathname: string): boolean {\n  return PROTECTED_ROUTES.some((route) => pathname.startsWith(route));\n}\n\nfunction isAdminRoute(pathname: string): boolean {\n  return ADMIN_ROUTES.some((route) => pathname.startsWith(route));\n}\n\nfunction isAuthRoute(pathname: string): boolean {\n  return AUTH_ROUTES.some((route) => pathname.startsWith(route));\n}\n\nfunction redirectToLogin(request: NextRequest): NextResponse {\n  const loginUrl = new URL('/', request.url);\n  loginUrl.searchParams.set('redirect', request.nextUrl.pathname);\n  loginUrl.searchParams.set('message', 'Please login to continue');\n  return NextResponse.redirect(loginUrl);\n}\n\nfunction redirectToHome(request: NextRequest, message?: string): NextResponse {\n  const homeUrl = new URL('/', request.url);\n  if (message) {\n    homeUrl.searchParams.set('message', message);\n  }\n  return NextResponse.redirect(homeUrl);\n}\n\n/**\n * Middleware Configuration\n *\n * Define which paths should be processed by this middleware\n */\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except:\n     * - api/auth (auth endpoints)\n     * - api/proxy (proxy endpoints)\n     * - _next/static (static files)\n     * - _next/image (image optimization)\n     * - favicon.ico (favicon)\n     * - public files (images, etc.)\n     */\n    '/((?!api/auth|api/proxy|_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico)$).*)',\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}