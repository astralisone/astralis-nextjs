exports.id=5207,exports.ids=[5207],exports.modules={24064:(a,b,c)=>{"use strict";c.d(b,{K:()=>j});var d=c(96798),e=c(76212);class f{constructor(){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY environment variable is required for vector search");this.openai=new e.Ay({apiKey:process.env.OPENAI_API_KEY,organization:process.env.OPENAI_ORG_ID})}async generateEmbedding(a){try{let b=await this.openai.embeddings.create({model:"text-embedding-3-small",input:a,encoding_format:"float"}),c=b.data[0]?.embedding;if(!c)throw Error("No embedding returned from OpenAI");if(1536!==c.length)throw Error(`Expected 1536 dimensions, got ${c.length}`);return c}catch(a){throw console.error("[VectorSearch] Error generating embedding:",a),Error(`Failed to generate embedding: ${a instanceof Error?a.message:"Unknown error"}`)}}cosineSimilarity(a,b){if(a.length!==b.length)throw Error(`Embedding dimensions mismatch: ${a.length} vs ${b.length}`);let c=0,d=0,e=0;for(let f=0;f<a.length;f++)c+=a[f]*b[f],d+=a[f]*a[f],e+=b[f]*b[f];return(d=Math.sqrt(d),e=Math.sqrt(e),0===d||0===e)?0:Math.max(0,Math.min(1,c/(d*e)))}async search(a,b,c,e=5){if(!a||0===a.trim().length)throw Error("Query text cannot be empty");if(!b)throw Error("Organization ID is required");if(e<1||e>100)throw Error("Limit must be between 1 and 100");try{console.log(`[VectorSearch] Generating embedding for query: "${a.substring(0,50)}..."`);let f=await this.generateEmbedding(a),g={orgId:b};c&&(g.documentId=c),console.log(`[VectorSearch] Retrieving embeddings for orgId: ${b}${c?`, documentId: ${c}`:""}`);let h=await d.z.documentEmbedding.findMany({where:g,select:{id:!0,documentId:!0,chunkIndex:!0,content:!0,embedding:!0,metadata:!0}});if(0===h.length)return console.log("[VectorSearch] No embeddings found for the given criteria"),[];console.log(`[VectorSearch] Retrieved ${h.length} embeddings, calculating similarities...`);let i=h.map(a=>{let b;try{b=JSON.parse(a.embedding)}catch(b){return console.error(`Failed to parse embedding for chunk ${a.id}:`,b),{documentId:a.documentId,chunkIndex:a.chunkIndex,content:a.content,similarity:0,metadata:a.metadata}}if(!Array.isArray(b)||1536!==b.length)return console.error(`Invalid embedding dimensions for chunk ${a.id}: expected 1536, got ${b?.length||"N/A"}`),{documentId:a.documentId,chunkIndex:a.chunkIndex,content:a.content,similarity:0,metadata:a.metadata};let c=this.cosineSimilarity(f,b);return{documentId:a.documentId,chunkIndex:a.chunkIndex,content:a.content,similarity:c,metadata:a.metadata}}).filter(a=>a.similarity>0).sort((a,b)=>b.similarity-a.similarity).slice(0,e);return console.log(`[VectorSearch] Returning ${i.length} results (similarities: ${i.map(a=>a.similarity.toFixed(3)).join(", ")})`),i}catch(a){throw console.error("[VectorSearch] Search failed:",a),Error(`Vector search failed: ${a instanceof Error?a.message:"Unknown error"}`)}}async searchWithThreshold(a,b,c=.7,d,e=5){if(c<0||c>1)throw Error("Threshold must be between 0 and 1");let f=await this.search(a,b,d,e),g=f.filter(a=>a.similarity>=c);return console.log(`[VectorSearch] Applied threshold ${c}: ${g.length}/${f.length} results passed`),g}formatContextForRAG(a,b=4e3){if(0===a.length)return"No relevant context found.";let c="Relevant context from documents:\n\n",d=c.length;for(let e=0;e<a.length;e++){let f=a[e],g=`[Document ${e+1}] (Similarity: ${(100*f.similarity).toFixed(1)}%)
${f.content}

`;if(d+g.length>b){let a=b-d-20;a>100&&(c+=g.substring(0,a)+"...\n\n");break}c+=g,d+=g.length}return c.trim()}async batchSearch(a,b,c,d=3){if(0===a.length)throw Error("At least one query is required");if(a.length>10)throw Error("Maximum 10 queries allowed per batch");console.log(`[VectorSearch] Batch search with ${a.length} queries`);let e=a.map(a=>this.search(a,b,c,d)),f=await Promise.all(e),g=new Set,h=[];for(let a of f)for(let b of a){let a=`${b.documentId}:${b.chunkIndex}`;g.has(a)||(g.add(a),h.push(b))}let i=h.sort((a,b)=>b.similarity-a.similarity).slice(0,d*a.length);return console.log(`[VectorSearch] Batch search returned ${i.length} unique results`),i}async getEmbeddingStats(a,b){let c={orgId:a};b&&(c.documentId=b);let e=await d.z.documentEmbedding.findMany({where:c,select:{documentId:!0,content:!0}}),f=new Set(e.map(a=>a.documentId)).size,g=e.reduce((a,b)=>a+b.content.length,0);return{totalEmbeddings:e.length,totalDocuments:f,avgChunksPerDocument:f>0?e.length/f:0,totalContentLength:g}}}let g=null;class h{constructor(){if(this.vectorSearchService=(g||(g=new f),g),this.chatModel="gpt-4-turbo-preview",!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY environment variable is not set");this.openai=new e.Ay({apiKey:process.env.OPENAI_API_KEY})}async sendMessage(a,b,c,e,f,g=5,h=.7){try{let i=e?await d.z.documentChat.findFirst({where:{id:e,userId:a,orgId:b},include:{document:!0}}):null;i||(i=await d.z.documentChat.create({data:{userId:a,orgId:b,documentId:f||null,title:null,messages:[],lastMessageAt:new Date},include:{document:!0}}),console.log(`[ChatService] Created new chat: ${i.id}`));let j=await this.vectorSearchService.search(c,b,i.documentId||f,g);console.log(`[ChatService] Retrieved ${j.length} relevant chunks for context`);let k=[...new Set(j.map(a=>a.documentId))],l=await d.z.document.findMany({where:{id:{in:k}},select:{id:!0,originalName:!0}}),m=new Map(l.map(a=>[a.id,a.originalName])),n=j.map((a,b)=>`[Source ${b+1}]: ${a.content}`).join("\n\n"),o=i.messages||[],p=o.map(a=>({role:a.role,content:a.content})),q=this.buildSystemPrompt(n,i.documentId||f),r=await this.openai.chat.completions.create({model:this.chatModel,messages:[{role:"system",content:q},...p,{role:"user",content:c}],temperature:h,max_tokens:1e3}),s=r.choices[0].message.content||"I apologize, but I could not generate a response.",t=r.usage?.total_tokens,u=j.map(a=>({documentId:a.documentId,documentName:m.get(a.documentId)||"Unknown Document",chunkIndex:a.chunkIndex,content:a.content,similarity:a.similarity})),v={role:"user",content:c,timestamp:new Date().toISOString()},w={role:"assistant",content:s,timestamp:new Date().toISOString(),sources:j.map(a=>({documentId:a.documentId,chunkIndex:a.chunkIndex,content:a.content,similarity:a.similarity}))},x=[...o,v,w],y=i.title;return y||0!==o.length||(y=await this.generateChatTitle(c)),await d.z.documentChat.update({where:{id:i.id},data:{title:y,messages:x,lastMessageAt:new Date}}),console.log(`[ChatService] Chat ${i.id} updated with new messages`),{chatId:i.id,response:{message:s,sources:u,tokensUsed:t}}}catch(a){throw console.error("[ChatService] Send message error:",a),Error(`Failed to send message: ${a instanceof Error?a.message:"Unknown error"}`)}}buildSystemPrompt(a,b){return`You are a helpful AI assistant with access to ${b?"the provided document":"the available documents in your organization"}. Your role is to answer questions based on the provided context.

CONTEXT:
${a||"No relevant context found."}

INSTRUCTIONS:
- Answer questions using ONLY the information from the context above.
- If the context does not contain enough information to answer, say so clearly.
- Cite specific sources when making claims (e.g., "According to Source 1...").
- Be concise and accurate.
- If asked about information not in the context, politely explain that you can only answer based on the available documents.
- Do not make up or infer information beyond what is explicitly stated in the context.`}async generateChatTitle(a){try{let b=await this.openai.chat.completions.create({model:"gpt-3.5-turbo",messages:[{role:"system",content:"Generate a concise, descriptive title (max 6 words) for a chat conversation based on the first user message. Return only the title, nothing else."},{role:"user",content:a}],temperature:.7,max_tokens:20});return(b.choices[0].message.content?.trim()||"New Chat").replace(/^["']|["']$/g,"")}catch(a){return console.error("[ChatService] Title generation error:",a),"New Chat"}}async listChats(a,b,c,e=50,f=0){let g={userId:a,orgId:b};c&&(g.documentId=c);let[h,i]=await Promise.all([d.z.documentChat.findMany({where:g,include:{document:{select:{id:!0,originalName:!0,fileName:!0}}},orderBy:{lastMessageAt:"desc"},take:e,skip:f}),d.z.documentChat.count({where:g})]);return{chats:h.map(a=>({id:a.id,title:a.title||"Untitled Chat",documentId:a.documentId,document:a.document,messageCount:Array.isArray(a.messages)?a.messages.length:0,lastMessageAt:a.lastMessageAt,createdAt:a.createdAt})),pagination:{total:i,limit:e,offset:f,hasMore:f+e<i}}}async getChat(a,b,c){let e=await d.z.documentChat.findFirst({where:{id:a,userId:b,orgId:c},include:{document:{select:{id:!0,originalName:!0,fileName:!0,cdnUrl:!0}}}});if(!e)throw Error("Chat not found");return{id:e.id,title:e.title||"Untitled Chat",documentId:e.documentId,document:e.document,messages:e.messages,lastMessageAt:e.lastMessageAt,createdAt:e.createdAt,updatedAt:e.updatedAt}}async deleteChat(a,b,c){if(!await d.z.documentChat.findFirst({where:{id:a,userId:b,orgId:c}}))throw Error("Chat not found");await d.z.documentChat.delete({where:{id:a}}),console.log(`[ChatService] Deleted chat ${a}`)}}let i=null;function j(){return i||(i=new h),i}},41132:(a,b,c)=>{"use strict";c.d(b,{j:()=>n,N:()=>m});var d=c(52963),e=c(28120),f=c(75783),g=c(27761),h=c(96798),i=c(7028);async function j(a,b){return i.Ay.compare(a,b)}var k=c(45711);k.Ik({email:k.Yj().email("Invalid email address"),password:k.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number"),name:k.Yj().min(2,"Name must be at least 2 characters").max(100),orgName:k.Yj().min(2,"Organization name required").max(100)});let l=k.Ik({email:k.Yj().email("Invalid email address"),password:k.Yj().min(1,"Password is required")});k.Ik({email:k.Yj().email("Invalid email address")}),k.Ik({token:k.Yj().min(1,"Token is required"),password:k.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number")});let m={adapter:(0,g.y)(h.z),providers:[(0,e.A)({id:"credentials",name:"Email & Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){let b=l.safeParse(a);if(!b.success)return null;let{email:c,password:d}=b.data,e=await h.z.users.findUnique({where:{email:c},include:{organization:!0}});return e&&e.password&&await j(d,e.password)?{id:e.id,email:e.email,name:e.name,role:e.role,orgId:e.orgId||"",image:e.avatar}:null}}),(0,f.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async jwt({token:a,user:b,account:c}){if(b&&(a.id=b.id,a.role=b.role,a.orgId=b.orgId),c?.provider==="google"&&b){let c=await h.z.users.findUnique({where:{id:b.id},include:{organization:!0}});c&&(a.orgId=c.orgId||"",a.role=c.role)}return a},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.orgId=b.orgId),a),async signIn({user:a,account:b,profile:c}){if(b?.provider==="email")return!0;if(b?.provider==="google"){let b=await h.z.users.findUnique({where:{email:a.email},include:{organization:!0}});if(!b?.organization){let c=await h.z.organization.create({data:{name:`${a.name}'s Organization`,users:{connect:{id:b.id}}}});await h.z.users.update({where:{id:b.id},data:{orgId:c.id,role:"ADMIN"}})}}return!0}},pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error",verifyRequest:"/auth/verify-email"},events:{async signIn({user:a}){}}},n=()=>(0,d.getServerSession)(m)},78335:()=>{},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};