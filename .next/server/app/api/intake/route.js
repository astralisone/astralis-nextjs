"use strict";(()=>{var e={};e.id=406,e.ids=[406],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},160:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>P,routeModule:()=>m,serverHooks:()=>k,staticGenerationAsyncStorage:()=>x});var n={};i.r(n),i.d(n,{GET:()=>f,POST:()=>c});var r=i(9303),s=i(8716),a=i(670),o=i(7070),u=i(1067),d=i(3538),l=i(3524);let p=u.Ry({source:u.Km(["FORM","EMAIL","CHAT","API"]),title:u.Z_().min(2),description:u.Z_().optional(),requestData:u.Yj(),orgId:u.Z_(),priority:u.Rx().int().min(0).max(10).optional().default(0)});async function c(e){try{let t=await e.json(),i=p.safeParse(t);if(!i.success)return o.NextResponse.json({error:"Invalid payload",details:i.error.flatten()},{status:400});let{source:n,title:r,description:s,requestData:a,orgId:u,priority:c}=i.data;if(!await d._.organization.findUnique({where:{id:u}}))return o.NextResponse.json({error:"Organization not found"},{status:404});let f=await g({title:r,description:s,requestData:a,orgId:u}),m=await d._.intakeRequest.create({data:{source:n,status:f.assignedPipeline?l.IntakeStatus.ASSIGNED:l.IntakeStatus.NEW,title:r,description:s,requestData:a,priority:c||0,orgId:u,assignedPipeline:f.assignedPipeline,aiRoutingMeta:{confidence:f.confidence,reasoning:f.reasoning,suggestedPipelines:f.suggestedPipelines,routedAt:new Date().toISOString()}},include:{pipeline:!0}});return o.NextResponse.json({intakeRequest:m,routing:{assigned:!!f.assignedPipeline,confidence:f.confidence,reasoning:f.reasoning}},{status:201})}catch(e){return console.error("Error processing intake request:",e),o.NextResponse.json({error:"Failed to process intake request"},{status:500})}}async function g(e){let t=await d._.pipeline.findMany({where:{orgId:e.orgId},select:{id:!0,name:!0}});if(0===t.length)return{assignedPipeline:null,confidence:0,reasoning:"No pipelines available for this organization",suggestedPipelines:[]};let i=`${e.title} ${e.description||""}`.toLowerCase(),n=null,r=.3,s="Default routing to first available pipeline";return i.includes("urgent")||i.includes("emergency")?(n=t[0].id,r=.7,s="Urgent request detected - routed to priority pipeline"):i.includes("document")||i.includes("invoice")?(n=t.find(e=>e.name.toLowerCase().includes("document"))?.id||t[0].id,r=.6,s="Document processing request detected"):n=t[0].id,{assignedPipeline:n,confidence:r,reasoning:s,suggestedPipelines:t.map(e=>e.id)}}async function f(e){try{let{searchParams:t}=e.nextUrl,i=t.get("orgId"),n=t.get("status"),r=t.get("source"),s=parseInt(t.get("limit")||"50"),a=parseInt(t.get("offset")||"0"),u={};i&&(u.orgId=i),n&&(u.status=n),r&&(u.source=r);let[l,p]=await Promise.all([d._.intakeRequest.findMany({where:u,include:{pipeline:{select:{id:!0,name:!0}}},orderBy:[{priority:"desc"},{createdAt:"desc"}],take:s,skip:a}),d._.intakeRequest.count({where:u})]);return o.NextResponse.json({intakeRequests:l,pagination:{total:p,limit:s,offset:a,hasMore:a+s<p}})}catch(e){return console.error("Error fetching intake requests:",e),o.NextResponse.json({error:"Failed to fetch intake requests"},{status:500})}}let m=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/intake/route",pathname:"/api/intake",filename:"route",bundlePath:"app/api/intake/route"},resolvedPagePath:"/Users/gregorystarr/projects/astralis-nextjs/src/app/api/intake/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:P,staticGenerationAsyncStorage:x,serverHooks:k}=m,h="/api/intake/route";function y(){return(0,a.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:x})}},3538:(e,t,i)=>{i.d(t,{_:()=>r});var n=i(3524);let r=globalThis.prisma??new n.PrismaClient({log:["error","warn"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[276,934],()=>i(160));module.exports=n})();