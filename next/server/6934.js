"use strict";exports.id=6934,exports.ids=[6934],exports.modules={10674:(a,b,c)=>{c.d(b,{AG:()=>y,OM:()=>v,QL:()=>u,SX:()=>o,Z8:()=>z,dU:()=>x,dt:()=>w,lh:()=>m,qM:()=>n});var d=c(45711),e=c(96798),f=c(90701),g=c(26253);let h=d.Ik({userId:d.Yj(),title:d.Yj().min(1),description:d.Yj().optional(),location:d.Yj().optional(),startTime:d.p6(),endTime:d.p6(),participantEmails:d.YO(d.Yj().email()).optional(),isRecurring:d.zM().optional().default(!1),recurrenceRule:d.Yj().optional(),syncToGoogle:d.zM().optional().default(!0)}),i=d.Ik({title:d.Yj().min(1).optional(),description:d.Yj().optional(),location:d.Yj().optional(),startTime:d.p6().optional(),endTime:d.p6().optional(),participantEmails:d.YO(d.Yj().email()).optional(),status:d.k5(["SCHEDULED","CONFIRMED","CANCELLED","COMPLETED","CONFLICT"]).optional(),syncToGoogle:d.zM().optional().default(!0)});function j(a){return({0:"SUNDAY",1:"MONDAY",2:"TUESDAY",3:"WEDNESDAY",4:"THURSDAY",5:"FRIDAY",6:"SATURDAY"})[a]}let k=d.Ik({userId:d.Yj(),dayOfWeek:d.ai().min(0).max(6),startTime:d.Yj().regex(/^\d{2}:\d{2}$/),endTime:d.Yj().regex(/^\d{2}:\d{2}$/),isAvailable:d.zM()}),l=d.Ik({dayOfWeek:d.ai().min(0).max(6).optional(),startTime:d.Yj().regex(/^\d{2}:\d{2}$/).optional(),endTime:d.Yj().regex(/^\d{2}:\d{2}$/).optional(),isAvailable:d.zM().optional()});async function m(a){let b=h.parse(a);if(b.endTime<=b.startTime)throw Error("End time must be after start time");try{let a=await e.z.schedulingEvent.create({data:{userId:b.userId,title:b.title,description:b.description,location:b.location,startTime:b.startTime,endTime:b.endTime,participantEmails:b.participantEmails??[],status:"SCHEDULED"},include:{user:{select:{id:!0,name:!0,email:!0}}}}),c=new Date(b.startTime);c.setHours(c.getHours()-24);let d=new Date(b.startTime);d.setHours(d.getHours()-1);let h=new Date;if(c>h){let b=await e.z.eventReminder.create({data:{eventId:a.id,reminderTime:c,status:"PENDING"}});try{await (0,g.vh)({reminderId:b.id,eventId:b.eventId})}catch(a){console.error(`Failed to queue reminder ${b.id}:`,a)}}if(d>h){let b=await e.z.eventReminder.create({data:{eventId:a.id,reminderTime:d,status:"PENDING"}});try{await (0,g.vh)({reminderId:b.id,eventId:b.eventId})}catch(a){console.error(`Failed to queue reminder ${b.id}:`,a)}}if(b.syncToGoogle)try{let c=await e.z.users.findUnique({where:{id:b.userId},select:{timezone:!0}}),d=c?.timezone||"UTC",g={summary:a.title,description:a.description||void 0,location:a.location||void 0,start:{dateTime:a.startTime.toISOString(),timeZone:d},end:{dateTime:a.endTime.toISOString(),timeZone:d},attendees:b.participantEmails?.map(a=>({email:a})),reminders:{useDefault:!1,overrides:[{method:"email",minutes:1440},{method:"popup",minutes:60}]}},h=await f.lh(b.userId,g);await e.z.schedulingEvent.update({where:{id:a.id},data:{calendarIntegrationData:{googleEventId:h.id,provider:"google",syncedAt:new Date().toISOString()}}}),console.log(`Event ${a.id} synced to Google Calendar as ${h.id}`)}catch(a){console.error("Failed to sync event to Google Calendar:",a)}return console.log(`Created scheduling event ${a.id} for user ${b.userId}`),a}catch(a){throw console.error("Error creating scheduling event:",a),Error(`Failed to create event: ${a.message}`)}}async function n(a,b){let c=i.parse(b);try{let b=await e.z.schedulingEvent.findUnique({where:{id:a}});if(!b)throw Error("Event not found");let d=c.startTime||b.startTime;if((c.endTime||b.endTime)<=d)throw Error("End time must be after start time");let g=await e.z.schedulingEvent.update({where:{id:a},data:{title:c.title,description:c.description,location:c.location,startTime:c.startTime,endTime:c.endTime,status:c.status},include:{user:{select:{id:!0,name:!0,email:!0}}}}),h=b.calendarIntegrationData,i=h?.googleEventId;if(c.syncToGoogle&&i)try{let a=await e.z.users.findUnique({where:{id:b.userId},select:{timezone:!0}}),c=a?.timezone||"UTC",d={summary:g.title,description:g.description||void 0,location:g.location||void 0,start:{dateTime:g.startTime.toISOString(),timeZone:c},end:{dateTime:g.endTime.toISOString(),timeZone:c}};await f.qM(b.userId,i,d),console.log(`Event ${g.id} synced update to Google Calendar`)}catch(a){console.error("Failed to sync event update to Google Calendar:",a)}return console.log(`Updated scheduling event ${a}`),g}catch(a){throw console.error("Error updating scheduling event:",a),Error(`Failed to update event: ${a.message}`)}}async function o(a){try{let b=await e.z.schedulingEvent.findUnique({where:{id:a}});if(!b)throw Error("Event not found");let c=b.calendarIntegrationData,d=c?.googleEventId;if(d)try{await f.SX(b.userId,d),console.log(`Event ${a} deleted from Google Calendar`)}catch(a){console.error("Failed to delete event from Google Calendar:",a)}await e.z.eventReminder.deleteMany({where:{eventId:a}}),await e.z.schedulingEvent.delete({where:{id:a}}),console.log(`Deleted scheduling event ${a}`)}catch(a){throw console.error("Error deleting scheduling event:",a),Error(`Failed to delete event: ${a.message}`)}}async function p(a){try{return await e.z.schedulingEvent.findUnique({where:{id:a},include:{user:{select:{id:!0,name:!0,email:!0}},reminders:!0}})}catch(a){throw console.error("Error fetching scheduling event:",a),Error(`Failed to fetch event: ${a.message}`)}}async function q(a,b){try{let c={userId:a};return(b?.startDate||b?.endDate)&&(c.AND=[],b.startDate&&c.AND.push({startTime:{gte:b.startDate}}),b.endDate&&c.AND.push({endTime:{lte:b.endDate}})),b?.status&&(c.status=b.status),b?.search&&(c.OR=[{title:{contains:b.search,mode:"insensitive"}},{description:{contains:b.search,mode:"insensitive"}},{location:{contains:b.search,mode:"insensitive"}}]),await e.z.schedulingEvent.findMany({where:c,include:{user:{select:{id:!0,name:!0,email:!0}},reminders:!0},orderBy:{startTime:"asc"}})}catch(a){throw console.error("Error listing scheduling events:",a),Error(`Failed to list events: ${a.message}`)}}async function r(a){let b=k.parse(a);try{let a=await e.z.availabilityRule.create({data:{userId:b.userId,dayOfWeek:j(b.dayOfWeek),startTime:b.startTime,endTime:b.endTime,isActive:b.isAvailable,timezone:"UTC"}});return console.log(`Created availability rule ${a.id} for user ${b.userId}`),a}catch(a){throw console.error("Error creating availability rule:",a),Error(`Failed to create availability rule: ${a.message}`)}}async function s(a,b){let c=l.parse(b);try{let b={startTime:c.startTime,endTime:c.endTime,isActive:c.isAvailable};void 0!==c.dayOfWeek&&(b.dayOfWeek=j(c.dayOfWeek));let d=await e.z.availabilityRule.update({where:{id:a},data:b});return console.log(`Updated availability rule ${a}`),d}catch(a){throw console.error("Error updating availability rule:",a),Error(`Failed to update availability rule: ${a.message}`)}}async function t(a){try{await e.z.availabilityRule.delete({where:{id:a}}),console.log(`Deleted availability rule ${a}`)}catch(a){throw console.error("Error deleting availability rule:",a),Error(`Failed to delete availability rule: ${a.message}`)}}async function u(a){try{let b=await e.z.availabilityRule.findMany({where:{userId:a},orderBy:[{dayOfWeek:"asc"},{startTime:"asc"}]});return console.log(`Retrieved ${b.length} availability rules for user ${a}`),b}catch(a){throw console.error("Error getting availability rules:",a),Error(`Failed to get availability rules: ${a.message}`)}}async function v(a){return r(a)}async function w(a,b,c){try{let d=await e.z.availabilityRule.findUnique({where:{id:a}});if(!d)throw Error("Availability rule not found");if(d.userId!==b)throw Error("Unauthorized: You do not own this availability rule");return s(a,c)}catch(a){throw console.error("Error updating availability rule:",a),a}}async function x(a,b){try{let c=await e.z.availabilityRule.findUnique({where:{id:a}});if(!c)throw Error("Availability rule not found");if(c.userId!==b)throw Error("Unauthorized: You do not own this availability rule");return t(a)}catch(a){throw console.error("Error deleting availability rule:",a),a}}async function y(a,b){return q(a,b)}async function z(a){return p(a)}},11381:(a,b,c)=>{c.d(b,{Sd:()=>e,X5:()=>f});var d=c(45711);let e=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number"),name:d.Yj().min(2,"Name must be at least 2 characters").max(100),orgName:d.Yj().min(2,"Organization name required").max(100)}),f=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(1,"Password is required")});d.Ik({email:d.Yj().email("Invalid email address")}),d.Ik({token:d.Yj().min(1,"Token is required"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number")})},25603:(a,b,c)=>{c.d(b,{K:()=>d});let d=new(c(37659)).Redis(process.env.REDIS_URL||"redis://localhost:6379",{maxRetriesPerRequest:null,enableReadyCheck:!1,retryStrategy:a=>Math.min(50*a,2e3)});d.on("error",a=>{console.error("[Redis] Connection error:",a)}),d.on("connect",()=>{console.log("[Redis] Connected successfully")}),d.on("ready",()=>{console.log("[Redis] Ready to accept commands")}),d.on("close",()=>{console.log("[Redis] Connection closed")}),d.on("reconnecting",()=>{console.log("[Redis] Reconnecting...")})},26253:(a,b,c)=>{c.d(b,{vh:()=>g});var d=c(83367),e=c(25603);let f=new d.Queue("scheduling-reminders",{connection:e.K,defaultJobOptions:{attempts:3,backoff:{type:"exponential",delay:2e3},removeOnComplete:{age:604800,count:500},removeOnFail:{age:1209600}}});async function g(a){await f.add("send-reminder",a,{jobId:`reminder-${a.reminderId}`}),console.log(`[Queue] Reminder job queued: ${a.reminderId} for event ${a.eventId}`)}},47513:(a,b,c)=>{c.d(b,{BE:()=>i,Er:()=>h,HU:()=>j,Yc:()=>m,w:()=>l});var d=c(7028),e=c(55511),f=c.n(e);let g="aes-256-gcm";async function h(a){if(!a||"string"!=typeof a)throw TypeError("hashPassword: password must be a non-empty string");return d.tW(a,12)}async function i(a,b){return d.UD(a,b)}function j(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}function k(){let a=process.env.N8N_ENCRYPTION_KEY||process.env.NEXTAUTH_SECRET;if(!a)throw Error("Encryption key not found in environment variables");return f().pbkdf2Sync(a,"astralis-salt",1e5,32,"sha256")}function l(a){try{let b=f().randomBytes(16),c=f().randomBytes(64),d=k(),e=f().createCipheriv(g,d,b),h=e.update(a,"utf8","hex");h+=e.final("hex");let i=e.getAuthTag();return c.toString("hex")+":"+b.toString("hex")+":"+i.toString("hex")+":"+h}catch(a){throw console.error("Encryption error:",a),Error("Failed to encrypt data")}}function m(a){try{let b=a.split(":");if(4!==b.length)throw Error("Invalid encrypted data format");Buffer.from(b[0],"hex");let c=Buffer.from(b[1],"hex"),d=Buffer.from(b[2],"hex"),e=b[3],h=k(),i=f().createDecipheriv(g,h,c);i.setAuthTag(d);let j=i.update(e,"hex","utf8");return j+=i.final("utf8")}catch(a){throw console.error("Decryption error:",a),Error("Failed to decrypt data")}}},61501:(a,b,c)=>{c.d(b,{N:()=>k,j:()=>l});var d=c(52963),e=c(28120),f=c(75783),g=c(27761),h=c(96798),i=c(47513),j=c(11381);let k={adapter:(0,g.y)(h.z),providers:[(0,e.A)({id:"credentials",name:"Email & Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){let b=j.X5.safeParse(a);if(!b.success)return null;let{email:c,password:d}=b.data,e=await h.z.users.findUnique({where:{email:c},include:{organization:!0}});return e&&e.password&&await (0,i.BE)(d,e.password)?{id:e.id,email:e.email,name:e.name,role:e.role,orgId:e.orgId||"",image:e.avatar}:null}}),(0,f.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async jwt({token:a,user:b,account:c,trigger:d,session:e}){if(b&&(a.id=b.id,a.role=b.role,a.orgId=b.orgId,a.picture=b.image),"update"===d&&e&&(void 0!==e.image&&(a.picture=e.image),void 0!==e.name&&(a.name=e.name)),c?.provider==="google"&&b){let c=await h.z.users.findUnique({where:{id:b.id},include:{organization:!0}});c&&(a.orgId=c.orgId||"",a.role=c.role,a.picture=c.avatar)}return a},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.orgId=b.orgId,a.user.image=b.picture),a),async signIn({user:a,account:b,profile:c}){if(b?.provider==="email")return!0;if(b?.provider==="google"){let b=await h.z.users.findUnique({where:{email:a.email},include:{organization:!0}});if(!b?.organization){let c=await h.z.organization.create({data:{name:`${a.name}'s Organization`,users:{connect:{id:b.id}}}});await h.z.users.update({where:{id:b.id},data:{orgId:c.id,role:"ADMIN"}})}}return!0}},pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error",verifyRequest:"/auth/verify-email"},events:{async signIn({user:a}){}}},l=()=>(0,d.getServerSession)(k)}};