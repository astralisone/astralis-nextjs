exports.id=1967,exports.ids=[1967],exports.modules={8431:(a,b,c)=>{var d={"./v1.10.100/build/pdf.js":79682,"./v1.10.88/build/pdf.js":59369,"./v1.9.426/build/pdf.js":82265,"./v2.0.550/build/pdf.js":1265};function e(a){return c(f(a))}function f(a){if(!c.o(d,a)){var b=Error("Cannot find module '"+a+"'");throw b.code="MODULE_NOT_FOUND",b}return d[a]}e.keys=function(){return Object.keys(d)},e.resolve=f,a.exports=e,e.id=8431},11381:(a,b,c)=>{"use strict";c.d(b,{Sd:()=>e,X5:()=>f});var d=c(45711);let e=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number"),name:d.Yj().min(2,"Name must be at least 2 characters").max(100),orgName:d.Yj().min(2,"Organization name required").max(100)}),f=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(1,"Password is required")});d.Ik({email:d.Yj().email("Invalid email address")}),d.Ik({token:d.Yj().min(1,"Token is required"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number")})},14291:(a,b,c)=>{"use strict";c.d(b,{ln:()=>h,so:()=>g});var d=c(83367),e=c(25603);let f=new d.Queue("document-processing",{connection:e.K,defaultJobOptions:{attempts:3,backoff:{type:"exponential",delay:5e3},removeOnComplete:{age:86400,count:1e3},removeOnFail:{age:604800}}});async function g(a){await f.add("process-document",a,{jobId:`doc-${a.documentId}`}),console.log(`[Queue] Document processing job queued: ${a.documentId}`)}async function h(a){let b=`doc-${a.documentId}`;try{let c=await f.getJob(b);c&&(await c.remove(),console.log(`[Queue] Removed existing job for retry: ${a.documentId}`))}catch(b){console.log(`[Queue] No existing job to remove: ${a.documentId}`)}await f.add("process-document",a,{jobId:b}),console.log(`[Queue] Document retry job queued: ${a.documentId}`)}},17017:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{H:()=>o});var e=c(96798),f=c(96330),g=c(62071),h=c(44812),i=c(56756),j=c(87520),k=c(14291),l=c(9288),m=c.n(l),n=a([i]);i=(n.then?(await n)():n)[0];class p{async uploadDocument(a,b,c,d,g,h={performOCR:!0,performVisionExtraction:!1,generateThumbnail:!0,language:"eng"}){let i=await (0,j.nJ)(a,b,c);if(!i.valid)throw Error(i.error||"File validation failed");let l=await this.spacesService.uploadFile(a,b,i.detectedMimeType||c,g),m=null;if(h.generateThumbnail&&c.startsWith("image/"))try{let c=await this.generateThumbnail(a);m=(await this.spacesService.uploadThumbnail(c,`thumb_${b}`,g)).cdnUrl}catch(a){console.error("Failed to generate thumbnail:",a)}let{metadata:n,...o}={fileName:l.fileName,originalName:b,filePath:l.filePath,cdnUrl:l.cdnUrl,thumbnailUrl:m,fileSize:l.fileSize,mimeType:i.detectedMimeType||c,uploadedById:d,orgId:g,metadata:{uploadedAt:new Date().toISOString(),originalMimeType:c}},p=await e.z.document.create({data:{...o,status:"PENDING",metadata:null===n?f.Prisma.JsonNull:n||f.Prisma.JsonNull}});try{await (0,k.so)({documentId:p.id,orgId:g,performOCR:h.performOCR,performVisionExtraction:h.performVisionExtraction,documentType:h.documentType||void 0,language:h.language}),console.log(`[DocumentService] Queued processing for document ${p.id}`)}catch(a){console.error("[DocumentService] Failed to queue document processing:",a)}return p}async generateThumbnail(a,b=200,c=200){try{return await m()(a).resize(b,c,{fit:"cover",position:"center"}).jpeg({quality:80}).toBuffer()}catch(a){throw console.error("Thumbnail generation error:",a),Error("Failed to generate thumbnail")}}async getDocument(a,b){let c=await e.z.document.findFirst({where:{id:a,orgId:b}});if(!c)throw Error("Document not found");return c}async listDocuments(a){let b=parseInt(a.limit||"50"),c=parseInt(a.offset||"0"),d={orgId:a.orgId};a.status&&(d.status=a.status),a.mimeType&&(d.mimeType=a.mimeType),a.uploadedBy&&(d.uploadedBy=a.uploadedBy),a.search&&(d.OR=[{originalName:{contains:a.search,mode:"insensitive"}},{fileName:{contains:a.search,mode:"insensitive"}},{ocrText:{contains:a.search,mode:"insensitive"}}]),(a.startDate||a.endDate)&&(d.createdAt={},a.startDate&&(d.createdAt.gte=new Date(a.startDate)),a.endDate&&(d.createdAt.lte=new Date(a.endDate)));let[f,g]=await Promise.all([e.z.document.findMany({where:d,orderBy:[{createdAt:"desc"}],take:b,skip:c}),e.z.document.count({where:d})]);return{documents:f,pagination:{total:g,limit:b,offset:c,hasMore:c+b<g}}}async updateDocument(a,b,c){await this.getDocument(a,b);let{metadata:d,extractedData:g,...h}=c;return await e.z.document.update({where:{id:a},data:{...h,...void 0!==d&&{metadata:null===d?f.Prisma.JsonNull:d},...void 0!==g&&{extractedData:null===g?f.Prisma.JsonNull:g}}})}async deleteDocument(a,b){let c=await this.getDocument(a,b);try{if(await this.spacesService.deleteFile(c.filePath),c.thumbnailUrl){let a=c.thumbnailUrl.split("/").slice(-3).join("/");await this.spacesService.deleteFile(a)}}catch(a){console.error("Failed to delete files from Spaces:",a)}await e.z.document.delete({where:{id:a}})}async downloadDocument(a,b){let c=await this.getDocument(a,b);return{buffer:await this.spacesService.downloadFile(c.filePath),filename:c.originalName,mimeType:c.mimeType}}async processOCR(a,b,c="eng"){let d=await this.getDocument(a,b);if(!(0,j.BH)(d.mimeType))throw Error("Document type does not support OCR");await this.updateDocument(a,b,{status:"PROCESSING"});try{let e=await this.spacesService.downloadFile(d.filePath),f=await this.ocrService.extractText(e,d.mimeType,c);return await this.updateDocument(a,b,{status:"COMPLETED",ocrText:f.text,ocrConfidence:f.confidence,processedAt:new Date,metadata:{...d.metadata,ocr:{language:f.language,wordCount:f.wordCount,processingTime:f.processingTime}}}),f}catch(c){throw await this.updateDocument(a,b,{status:"FAILED",processingError:c instanceof Error?c.message:"OCR processing failed"}),c}}async extractStructuredData(a,b,c){let d=await this.getDocument(a,b);if(!d.mimeType.startsWith("image/"))throw Error("Vision extraction only supports image documents");try{let e=await this.spacesService.downloadFile(d.filePath),f=c;f||(f=await this.visionService.detectDocumentType(e,d.mimeType));let g=await this.visionService.extractStructuredData(e,d.mimeType,f);return await this.updateDocument(a,b,{extractedData:g.data,metadata:{...d.metadata,vision:{documentType:g.type,confidence:g.confidence,model:g.model,processingTime:g.processingTime}}}),g}catch(a){throw console.error("Vision extraction error:",a),a}}constructor(){this.spacesService=(0,g.$)(),this.ocrService=(0,h.u)(),this.visionService=(0,i.Sr)()}}let q=null;function o(){return q||(q=new p),q}d()}catch(a){d(a)}})},25603:(a,b,c)=>{"use strict";c.d(b,{K:()=>d});let d=new(c(37659)).Redis(process.env.REDIS_URL||"redis://localhost:6379",{maxRetriesPerRequest:null,enableReadyCheck:!1,retryStrategy:a=>Math.min(50*a,2e3)});d.on("error",a=>{console.error("[Redis] Connection error:",a)}),d.on("connect",()=>{console.log("[Redis] Connected successfully")}),d.on("ready",()=>{console.log("[Redis] Ready to accept commands")}),d.on("close",()=>{console.log("[Redis] Connection closed")}),d.on("reconnecting",()=>{console.log("[Redis] Reconnecting...")})},44812:(a,b,c)=>{"use strict";c.d(b,{u:()=>j});var d=c(28887),e=c.n(d),f=c(9288),g=c.n(f);class h{async preprocessImage(a,b={}){try{let c={...this.defaultPreprocessing,...b},d=g()(a),e=(await d.metadata()).width||0;return c.resize&&c.targetWidth&&(e>c.targetWidth||e<800)&&(d=d.resize(c.targetWidth,null,{fit:"inside",withoutEnlargement:!1})),c.grayscale&&(d=d.grayscale()),c.enhanceContrast&&(d=d.normalize()),c.sharpen&&(d=d.sharpen()),await d.png().toBuffer()}catch(b){return console.error("Image preprocessing error:",b),a}}async extractTextFromImage(a,b=this.defaultLanguage,c={}){let d=Date.now();try{let f=await this.preprocessImage(a,c),g=await e().recognize(f,b,{logger:a=>{"recognizing text"===a.status&&console.log(`OCR progress: ${Math.round(100*a.progress)}%`)}}),h=Date.now()-d;console.log("[OCR] Result structure:",{hasData:!!g.data,hasText:!!g.data?.text,hasConfidence:!!g.data?.confidence,textLength:g.data?.text?.length||0});let i=g.data.text.trim(),j=g.data.confidence/100,k=i.split(/\s+/).filter(a=>a.length>0).length;return console.log(`[OCR] Extracted: ${i.length} chars, ${k} words, ${(100*j).toFixed(1)}% confidence`),{text:i,confidence:j,language:b,wordCount:k,processingTime:h}}catch(a){throw console.error("OCR extraction error:",a),Error(`Failed to extract text from image: ${a instanceof Error?a.message:"Unknown error"}`)}}async extractTextFromPDF(a,b=this.defaultLanguage){let d=Date.now();try{let e=c(16297),f=e.default||e,g=(await f(a)).text.trim(),h=g.split(/\s+/).filter(a=>a.length>0).length,i=Date.now()-d,j=.95;return 0===h?j=0:h<10?j=.5:h<50&&(j=.7),0===g.length&&console.warn("[OCR] No text found in PDF. This might be a scanned PDF requiring image-based OCR."),{text:g,confidence:j,language:b,wordCount:h,processingTime:i}}catch(a){throw console.error("PDF text extraction error:",a),Error(`Failed to extract text from PDF: ${a instanceof Error?a.message:"Unknown error"}`)}}async extractText(a,b,c=this.defaultLanguage,d={}){if(b.startsWith("image/"))return this.extractTextFromImage(a,c,d);if("application/pdf"===b)return this.extractTextFromPDF(a,c);throw Error(`Unsupported file type for OCR: ${b}`)}validateOCRResult(a){let b=[];return a.text&&0!==a.text.length||b.push("No text extracted from document"),a.confidence<.5&&b.push(`Low confidence score: ${Math.round(100*a.confidence)}%`),0===a.wordCount?b.push("No words detected in document"):a.wordCount<5&&b.push("Very few words detected (may indicate poor quality scan)"),{valid:0===b.length,issues:b}}getSupportedLanguages(){return["eng","spa","fra","deu","ita","por","rus","chi_sim","chi_tra","jpn","kor","ara","hin"]}detectLanguage(a){if(/[\u4e00-\u9fa5]/.test(a))return"chi_sim";if(/[\u3040-\u309f\u30a0-\u30ff]/.test(a))return"jpn";if(/[\uac00-\ud7af]/.test(a))return"kor";if(/[\u0600-\u06ff]/.test(a))return"ara";if(/[\u0400-\u04ff]/.test(a))return"rus";return"eng"}constructor(){this.defaultLanguage="eng",this.defaultPreprocessing={enhanceContrast:!0,grayscale:!0,sharpen:!0,resize:!0,targetWidth:2e3}}}let i=null;function j(){return i||(i=new h),i}},47513:(a,b,c)=>{"use strict";c.d(b,{BE:()=>i,Er:()=>h,HU:()=>j,Yc:()=>m,w:()=>l});var d=c(7028),e=c(55511),f=c.n(e);let g="aes-256-gcm";async function h(a){if(!a||"string"!=typeof a)throw TypeError("hashPassword: password must be a non-empty string");return d.tW(a,12)}async function i(a,b){return d.UD(a,b)}function j(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}function k(){let a=process.env.N8N_ENCRYPTION_KEY||process.env.NEXTAUTH_SECRET;if(!a)throw Error("Encryption key not found in environment variables");return f().pbkdf2Sync(a,"astralis-salt",1e5,32,"sha256")}function l(a){try{let b=f().randomBytes(16),c=f().randomBytes(64),d=k(),e=f().createCipheriv(g,d,b),h=e.update(a,"utf8","hex");h+=e.final("hex");let i=e.getAuthTag();return c.toString("hex")+":"+b.toString("hex")+":"+i.toString("hex")+":"+h}catch(a){throw console.error("Encryption error:",a),Error("Failed to encrypt data")}}function m(a){try{let b=a.split(":");if(4!==b.length)throw Error("Invalid encrypted data format");Buffer.from(b[0],"hex");let c=Buffer.from(b[1],"hex"),d=Buffer.from(b[2],"hex"),e=b[3],h=k(),i=f().createDecipheriv(g,h,c);i.setAuthTag(d);let j=i.update(e,"hex","utf8");return j+=i.final("utf8")}catch(a){throw console.error("Decryption error:",a),Error("Failed to decrypt data")}}},56756:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{Sr:()=>g});var e=c(87984),f=a([e]);e=(f.then?(await f)():f)[0];class h{constructor(){if(this.model="gpt-4-vision-preview",!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY environment variable is required");this.openai=new e.default({apiKey:process.env.OPENAI_API_KEY,organization:process.env.OPENAI_ORG_ID})}getExtractionSchema(a){return({invoice:{type:"invoice",fields:["invoice_number","invoice_date","due_date","vendor_name","vendor_address","customer_name","customer_address","items","subtotal","tax","total","currency","payment_terms"],prompt:`Extract structured data from this invoice image. Return a JSON object with the following fields:
- invoice_number: Invoice number
- invoice_date: Invoice date (ISO format)
- due_date: Payment due date (ISO format)
- vendor_name: Vendor/supplier name
- vendor_address: Vendor address
- customer_name: Customer name
- customer_address: Customer address
- items: Array of line items with {description, quantity, unit_price, total}
- subtotal: Subtotal amount
- tax: Tax amount
- total: Total amount
- currency: Currency code (e.g., USD, EUR)
- payment_terms: Payment terms description

Return ONLY valid JSON, no additional text.`},receipt:{type:"receipt",fields:["merchant_name","merchant_address","date","time","items","subtotal","tax","tip","total","payment_method","transaction_id"],prompt:`Extract structured data from this receipt image. Return a JSON object with the following fields:
- merchant_name: Store/restaurant name
- merchant_address: Store address
- date: Transaction date (ISO format)
- time: Transaction time
- items: Array of purchased items with {description, quantity, price}
- subtotal: Subtotal amount
- tax: Tax amount
- tip: Tip amount (if applicable)
- total: Total amount
- payment_method: Payment method (e.g., Credit Card, Cash)
- transaction_id: Transaction ID or receipt number

Return ONLY valid JSON, no additional text.`},form:{type:"form",fields:["form_type","form_fields","date","signature_present"],prompt:`Extract structured data from this form image. Return a JSON object with the following fields:
- form_type: Type of form (e.g., Application, Registration, Survey)
- form_fields: Object with all visible form fields and their values
- date: Date on form (ISO format)
- signature_present: Boolean indicating if signature is present

Return ONLY valid JSON, no additional text.`},contract:{type:"contract",fields:["contract_type","parties","effective_date","expiration_date","terms","signatures"],prompt:`Extract structured data from this contract image. Return a JSON object with the following fields:
- contract_type: Type of contract
- parties: Array of parties involved with {name, role}
- effective_date: Contract effective date (ISO format)
- expiration_date: Contract expiration date (ISO format)
- terms: Key terms and conditions (array of strings)
- signatures: Array of signatures present with {party, signed, date}

Return ONLY valid JSON, no additional text.`},identity:{type:"identity",fields:["document_type","full_name","date_of_birth","id_number","expiration_date","issuing_authority"],prompt:`Extract structured data from this identity document image. Return a JSON object with the following fields:
- document_type: Type (e.g., Passport, Driver License, ID Card)
- full_name: Full name
- date_of_birth: Date of birth (ISO format)
- id_number: ID/document number
- expiration_date: Expiration date (ISO format)
- issuing_authority: Issuing authority/country

Return ONLY valid JSON, no additional text.`},business_card:{type:"business_card",fields:["name","title","company","email","phone","address","website"],prompt:`Extract structured data from this business card image. Return a JSON object with the following fields:
- name: Person's name
- title: Job title
- company: Company name
- email: Email address
- phone: Phone number
- address: Business address
- website: Website URL

Return ONLY valid JSON, no additional text.`},generic:{type:"generic",fields:["document_type","key_information","dates","amounts"],prompt:`Extract structured data from this document image. Return a JSON object with the following fields:
- document_type: Best guess of document type
- key_information: Object with all relevant fields and values
- dates: Array of dates found in the document
- amounts: Array of monetary amounts found

Return ONLY valid JSON, no additional text.`}})[a]}bufferToDataUrl(a,b){let c=a.toString("base64");return`data:${b};base64,${c}`}async extractStructuredData(a,b,c="generic"){let d=Date.now();try{let e=this.getExtractionSchema(c),f=this.bufferToDataUrl(a,b),g=await this.openai.chat.completions.create({model:this.model,messages:[{role:"user",content:[{type:"text",text:e.prompt},{type:"image_url",image_url:{url:f}}]}],max_tokens:1e3,temperature:.2}),h=Date.now()-d,i=g.choices[0]?.message?.content||"{}",j=this.parseExtractionResponse(i),k=this.calculateConfidence(j,e.fields);return{type:c,data:j,confidence:k,model:this.model,processingTime:h}}catch(a){throw console.error("Vision extraction error:",a),Error(`Failed to extract structured data: ${a instanceof Error?a.message:"Unknown error"}`)}}parseExtractionResponse(a){try{let b=a.trim();return b.startsWith("```json")?b=b.replace(/^```json\s*/,"").replace(/```\s*$/,""):b.startsWith("```")&&(b=b.replace(/^```\s*/,"").replace(/```\s*$/,"")),JSON.parse(b)}catch(b){return console.error("Failed to parse extraction response:",b),{raw_response:a}}}calculateConfidence(a,b){if(!a||0===Object.keys(a).length)return 0;let c=b.filter(b=>{let c=a[b];return null!=c&&""!==c}).length/b.length,d=1;return a.raw_response&&(d*=.3),Object.values(a).some(a=>"string"==typeof a&&(a.toLowerCase().includes("not found")||a.toLowerCase().includes("n/a")||"null"===a))&&(d*=.8),Math.min(c*d,1)}async detectDocumentType(a,b){try{let c=this.bufferToDataUrl(a,b),d=await this.openai.chat.completions.create({model:this.model,messages:[{role:"user",content:[{type:"text",text:`Analyze this document image and classify it into one of these categories:
- invoice
- receipt
- form
- contract
- identity
- business_card
- generic

Return ONLY the category name, nothing else.`},{type:"image_url",image_url:{url:c}}]}],max_tokens:50,temperature:.1});return({invoice:"invoice",receipt:"receipt",form:"form",contract:"contract",identity:"identity",business_card:"business_card",generic:"generic"})[d.choices[0]?.message?.content?.trim().toLowerCase()||"generic"]||"generic"}catch(a){return console.error("Document type detection error:",a),"generic"}}async extractField(a,b,c,d){try{let e=this.bufferToDataUrl(a,b),f=await this.openai.chat.completions.create({model:this.model,messages:[{role:"user",content:[{type:"text",text:`Extract the following field from this document:
Field: ${c}
Description: ${d}

Return ONLY the field value, nothing else. If not found, return "NOT_FOUND".`},{type:"image_url",image_url:{url:e}}]}],max_tokens:100,temperature:.1}),g=f.choices[0]?.message?.content?.trim()||"NOT_FOUND";return"NOT_FOUND"===g?null:g}catch(a){return console.error("Field extraction error:",a),null}}}let i=null;function g(){return i||(i=new h),i}d()}catch(a){d(a)}})},61501:(a,b,c)=>{"use strict";c.d(b,{N:()=>k,j:()=>l});var d=c(52963),e=c(28120),f=c(75783),g=c(27761),h=c(96798),i=c(47513),j=c(11381);let k={adapter:(0,g.y)(h.z),providers:[(0,e.A)({id:"credentials",name:"Email & Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){let b=j.X5.safeParse(a);if(!b.success)return null;let{email:c,password:d}=b.data,e=await h.z.users.findUnique({where:{email:c},include:{organization:!0}});return e&&e.password&&await (0,i.BE)(d,e.password)?{id:e.id,email:e.email,name:e.name,role:e.role,orgId:e.orgId||"",image:e.avatar}:null}}),(0,f.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async jwt({token:a,user:b,account:c,trigger:d,session:e}){if(b&&(a.id=b.id,a.role=b.role,a.orgId=b.orgId,a.picture=b.image),"update"===d&&e&&(void 0!==e.image&&(a.picture=e.image),void 0!==e.name&&(a.name=e.name)),c?.provider==="google"&&b){let c=await h.z.users.findUnique({where:{id:b.id},include:{organization:!0}});c&&(a.orgId=c.orgId||"",a.role=c.role,a.picture=c.avatar)}return a},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.orgId=b.orgId,a.user.image=b.picture),a),async signIn({user:a,account:b,profile:c}){if(b?.provider==="email")return!0;if(b?.provider==="google"){let b=await h.z.users.findUnique({where:{email:a.email},include:{organization:!0}});if(!b?.organization){let c=await h.z.organization.create({data:{name:`${a.name}'s Organization`,users:{connect:{id:b.id}}}});await h.z.users.update({where:{id:b.id},data:{orgId:c.id,role:"ADMIN"}})}}return!0}},pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error",verifyRequest:"/auth/verify-email"},events:{async signIn({user:a}){}}},l=()=>(0,d.getServerSession)(k)},62071:(a,b,c)=>{"use strict";c.d(b,{$:()=>l});var d=c(91043),e=c(78677),f=c(42994),g=c.n(f),h=c(55511),i=c.n(h);class j{constructor(){if(!process.env.SPACES_ACCESS_KEY||!process.env.SPACES_SECRET_KEY)throw Error("Spaces credentials not configured. Set SPACES_ACCESS_KEY and SPACES_SECRET_KEY.");if(!process.env.SPACES_ENDPOINT)throw Error("SPACES_ENDPOINT environment variable is required");this.bucket=process.env.SPACES_BUCKET||"astralis-documents",this.cdnUrl=process.env.SPACES_CDN_URL||"",this.endpoint=process.env.SPACES_ENDPOINT,console.log("[SpacesService] Initialized with bucket:",this.bucket),console.log("[SpacesService] SPACES_BUCKET env var:",process.env.SPACES_BUCKET),this.client=new d.S3Client({endpoint:`https://${this.endpoint}`,region:process.env.SPACES_REGION||"nyc3",credentials:{accessKeyId:process.env.SPACES_ACCESS_KEY,secretAccessKey:process.env.SPACES_SECRET_KEY},forcePathStyle:!1})}generateFilename(a){let b=g()(a),c=b.split(".").pop()||"",d=b.slice(0,-(c.length+1))||"file",e=Date.now(),f=i().randomBytes(8).toString("hex");return`${d}-${e}-${f}.${c}`}getFilePath(a,b,c="documents"){return`org-${a}/${c}/${b}`}getCdnUrl(a){return this.cdnUrl?`${this.cdnUrl}/${a}`:`https://${this.bucket}.${this.endpoint}/${a}`}async uploadFile(a,b,c,e,f="documents"){try{let g=this.generateFilename(b),h=this.getFilePath(e,g,f),i=new d.PutObjectCommand({Bucket:this.bucket,Key:h,Body:a,ContentType:c,CacheControl:"public, max-age=31536000",ACL:"private",Metadata:{"original-name":b,"org-id":e,"uploaded-at":new Date().toISOString()}});await this.client.send(i);let j=this.getCdnUrl(h);return{fileName:g,filePath:h,cdnUrl:j,fileSize:a.length}}catch(a){throw console.error("Spaces upload error:",a),Error(`Failed to upload file: ${a instanceof Error?a.message:"Unknown error"}`)}}async downloadFile(a){try{let b=new d.GetObjectCommand({Bucket:this.bucket,Key:a}),c=await this.client.send(b);if(!c.Body)throw Error("No file body received");let e=[];for await(let a of c.Body)e.push(a);return Buffer.concat(e)}catch(a){throw console.error("Spaces download error:",a),Error(`Failed to download file: ${a instanceof Error?a.message:"Unknown error"}`)}}async deleteFile(a){try{let b=new d.DeleteObjectCommand({Bucket:this.bucket,Key:a});await this.client.send(b)}catch(a){throw console.error("Spaces delete error:",a),Error(`Failed to delete file: ${a instanceof Error?a.message:"Unknown error"}`)}}async getFileMetadata(a){try{let b=new d.HeadObjectCommand({Bucket:this.bucket,Key:a}),c=await this.client.send(b);return{contentType:c.ContentType||"application/octet-stream",contentLength:c.ContentLength||0,lastModified:c.LastModified||new Date,metadata:c.Metadata||{}}}catch(a){throw console.error("Spaces metadata error:",a),Error(`Failed to get file metadata: ${a instanceof Error?a.message:"Unknown error"}`)}}async getSignedUrl(a,b=3600){try{let c=new d.GetObjectCommand({Bucket:this.bucket,Key:a});return await (0,e.A)(this.client,c,{expiresIn:b})}catch(a){throw console.error("Spaces signed URL error:",a),Error(`Failed to generate signed URL: ${a instanceof Error?a.message:"Unknown error"}`)}}async copyFile(a,b){try{let c=new d.CopyObjectCommand({Bucket:this.bucket,CopySource:`${this.bucket}/${a}`,Key:b});await this.client.send(c)}catch(a){throw console.error("Spaces copy error:",a),Error(`Failed to copy file: ${a instanceof Error?a.message:"Unknown error"}`)}}async fileExists(a){try{return await this.getFileMetadata(a),!0}catch(a){return!1}}async uploadThumbnail(a,b,c){return this.uploadFile(a,b,"image/jpeg",c,"thumbnails")}}let k=null;function l(){return k||(k=new j),k}},78335:()=>{},87520:(a,b,c)=>{"use strict";c.d(b,{BH:()=>k,nJ:()=>j});var d=c(98770);let e=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp","image/tiff","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain","text/csv"],f=parseInt(process.env.MAX_FILE_SIZE||"52428800"),g={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",tiff:"image/tiff",tif:"image/tiff",pdf:"application/pdf",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",txt:"text/plain",csv:"text/csv"};function h(a){let b=a.toLowerCase().trim();return e.includes(b)?{valid:!0,detectedMimeType:b}:{valid:!1,error:`File type '${a}' is not allowed. Allowed types: images, PDFs, Office documents`,detectedMimeType:b}}async function i(a){try{let b=await (0,d.BI)(a);return b?.mime||null}catch(a){return console.error("Error detecting MIME type:",a),null}}async function j(a,b,c){let d=function(a,b=f){if(a<=0)return{valid:!1,error:"File is empty",fileSize:a};if(a>b){let c=(b/1048576).toFixed(2);return{valid:!1,error:`File size exceeds maximum allowed size of ${c}MB`,fileSize:a}}return{valid:!0,fileSize:a}}(a.length);if(!d.valid)return d;let e=h(c);if(!e.valid)return e;let j=await i(a),k=function(a){let b=a.split(".").pop()?.toLowerCase();return b&&g[b]||null}(b);if(j){if(!h(j).valid)return{valid:!1,error:`Detected file type '${j}' is not allowed (declared as '${c}')`,detectedMimeType:j};if(!function(a,b){let c=a.toLowerCase().trim(),d=b.toLowerCase().trim();return c===d||"image/jpeg"===c&&"image/jpg"===d||"image/jpg"===c&&"image/jpeg"===d||"image/tiff"===c&&"image/tif"===d||"image/tif"===c&&"image/tiff"===d}(c,j))return{valid:!1,error:`File type mismatch: declared '${c}' but detected '${j}'`,detectedMimeType:j}}else{if(!k)return{valid:!1,error:`Unable to determine file type for '${b}'`};let a=h(k);if(!a.valid)return a}let l=function(a,b){for(let c of(a.includes(0)&&b.toLowerCase().endsWith(".pdf"),[/\.\./,/[<>:"|?*]/,/^\./]))if(c.test(b))return{valid:!1,error:`Filename contains invalid or suspicious characters: '${b}'`};return{valid:!0}}(a,b);return l.valid?{valid:!0,detectedMimeType:j||k||c,fileSize:a.length}:l}function k(a){return a.startsWith("image/")||"application/pdf"===a}},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};