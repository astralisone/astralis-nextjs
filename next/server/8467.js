exports.id=8467,exports.ids=[8467],exports.modules={13364:(a,b,c)=>{"use strict";c.d(b,{P:()=>f});var d=c(97311);class e{constructor(){let a=process.env.N8N_PROTOCOL||"http",b=process.env.N8N_HOST||"localhost",c=process.env.N8N_PORT||"5678";this.baseUrl=`${a}://${b}:${c}/api/v1`;let e={"Content-Type":"application/json"},f=process.env.N8N_API_KEY;if(f)e["X-N8N-API-KEY"]=f,console.log("[N8N Service] Using API key authentication");else{let a=process.env.N8N_BASIC_AUTH_USER||"",b=process.env.N8N_BASIC_AUTH_PASSWORD||"";if(a&&b){let c=Buffer.from(`${a}:${b}`).toString("base64");e.Authorization=`Basic ${c}`,console.log("[N8N Service] Using Basic Auth authentication")}else console.warn("[N8N Service] No authentication configured - this may fail in production")}this.client=d.A.create({baseURL:this.baseUrl,headers:e,timeout:3e4}),this.client.interceptors.response.use(a=>a,a=>{throw console.error("[N8N Service] API Error:",{url:a.config?.url,method:a.config?.method,status:a.response?.status,message:a.response?.data?.message||a.message}),a})}async createWorkflow(a){try{let b=await this.client.post("/workflows",{name:a.name,nodes:a.nodes,connections:a.connections,settings:a.settings||{}});return console.log(`[N8N Service] Workflow created: ${b.data.id}`),a.active&&console.log("[N8N Service] Workflow created as inactive - activate manually in n8n UI at http://localhost:5678"),b.data}catch(a){throw console.error("[N8N Service] Failed to create workflow:",a),Error(`Failed to create n8n workflow: ${a instanceof Error?a.message:"Unknown error"}`)}}async getWorkflow(a){try{return(await this.client.get(`/workflows/${a}`)).data}catch(b){throw console.error(`[N8N Service] Failed to get workflow ${a}:`,b),Error(`Failed to get n8n workflow: ${b instanceof Error?b.message:"Unknown error"}`)}}async updateWorkflow(a,b){try{let c=await this.client.patch(`/workflows/${a}`,b);return console.log(`[N8N Service] Workflow updated: ${a}`),c.data}catch(b){throw console.error(`[N8N Service] Failed to update workflow ${a}:`,b),Error(`Failed to update n8n workflow: ${b instanceof Error?b.message:"Unknown error"}`)}}async deleteWorkflow(a){try{await this.client.delete(`/workflows/${a}`),console.log(`[N8N Service] Workflow deleted: ${a}`)}catch(b){throw console.error(`[N8N Service] Failed to delete workflow ${a}:`,b),Error(`Failed to delete n8n workflow: ${b instanceof Error?b.message:"Unknown error"}`)}}async executeWorkflow(a,b={}){try{let c=await this.client.post(`/workflows/${a}/execute`,{data:b});return console.log(`[N8N Service] Workflow executed: ${a}, execution: ${c.data.id}`),c.data}catch(b){throw console.error(`[N8N Service] Failed to execute workflow ${a}:`,b),Error(`Failed to execute n8n workflow: ${b instanceof Error?b.message:"Unknown error"}`)}}async getExecutions(a,b=100){try{return(await this.client.get("/executions",{params:{workflowId:a,limit:b}})).data.data||[]}catch(b){throw console.error(`[N8N Service] Failed to get executions for workflow ${a}:`,b),Error(`Failed to get n8n executions: ${b instanceof Error?b.message:"Unknown error"}`)}}async getExecution(a){try{return(await this.client.get(`/executions/${a}`)).data}catch(b){throw console.error(`[N8N Service] Failed to get execution ${a}:`,b),Error(`Failed to get n8n execution: ${b instanceof Error?b.message:"Unknown error"}`)}}async activateWorkflow(a){return this.updateWorkflow(a,{active:!0})}async deactivateWorkflow(a){return this.updateWorkflow(a,{active:!1})}async healthCheck(){try{return await this.client.get("/workflows",{params:{limit:1}}),!0}catch(a){return console.error("[N8N Service] Health check failed:",a),!1}}}let f=new e},28327:(a,b,c)=>{"use strict";c.d(b,{Z:()=>g});var d=c(96798),e=c(13364);class f{extractWebhookUrl(a){let b=a.find(a=>"n8n-nodes-base.webhook"===a.type);if(!b)return null;let c=b.parameters?.path||b.webhookId||"webhook",d=process.env.N8N_PROTOCOL||"http",e=process.env.N8N_HOST||"localhost",f=process.env.N8N_PORT||"5678",g=`${d}://${e}:${f}/webhook-test/${c}`;return console.log("[Automation Service] Extracted webhook URL from n8n:",g),g}async createAutomation(a){try{console.log("[Automation Service] Creating automation:",a.name);let b=null,c=null;if(process.env.N8N_API_KEY||process.env.N8N_BASIC_AUTH_USER&&process.env.N8N_BASIC_AUTH_PASSWORD){console.log("[Automation Service] Creating workflow in n8n...");let d=await e.P.createWorkflow({name:a.name,nodes:a.workflowJson.nodes,connections:a.workflowJson.connections,active:!0});b=d.id,console.log("[Automation Service] N8N workflow created:",b),"WEBHOOK"===a.triggerType&&(c=this.extractWebhookUrl(d.nodes))}else console.warn("[Automation Service] Skipping n8n workflow creation (no API key configured)"),console.warn("[Automation Service] Workflow JSON will be stored locally only"),a.metadata||(a.metadata={}),a.metadata.workflowJson=a.workflowJson;let f=await d.z.automation.create({data:{name:a.name,description:a.description||null,n8nWorkflowId:b,webhookUrl:c,triggerType:a.triggerType,triggerConfig:a.triggerConfig,isActive:!0,orgId:a.orgId,createdById:a.createdById,executionCount:0,successCount:0,failureCount:0,tags:a.tags||[],metadata:a.metadata||null}});try{await d.z.activityLog.create({data:{userId:a.createdById,orgId:a.orgId,action:"CREATE",entity:"AUTOMATION",entityId:f.id,metadata:{name:a.name,triggerType:a.triggerType,n8nWorkflowId:b,webhookUrl:c}}})}catch(a){console.error("[Automation Service] Failed to log activity:",a)}return console.log("[Automation Service] Automation created successfully:",f.id),c&&console.log("[Automation Service] Webhook URL:",c),f}catch(a){throw console.error("[Automation Service] Failed to create automation:",a),Error(`Failed to create automation: ${a instanceof Error?a.message:"Unknown error"}`)}}async getAutomation(a,b){try{let c=await d.z.automation.findFirst({where:{id:a,orgId:b}});if(!c)return null;return c}catch(a){throw console.error("[Automation Service] Failed to get automation:",a),Error(`Failed to get automation: ${a instanceof Error?a.message:"Unknown error"}`)}}async listAutomations(a,b){try{let c={orgId:a};return b?.isActive!==void 0&&(c.isActive=b.isActive),b?.search&&(c.OR=[{name:{contains:b.search,mode:"insensitive"}},{description:{contains:b.search,mode:"insensitive"}}]),await d.z.automation.findMany({where:c,orderBy:{createdAt:"desc"}})}catch(a){throw console.error("[Automation Service] Failed to list automations:",a),Error(`Failed to list automations: ${a instanceof Error?a.message:"Unknown error"}`)}}async executeAutomation(a,b,c){try{console.log("[Automation Service] Executing automation:",a);let f=await this.getAutomation(a,b);if(!f)throw Error("Automation not found");if(!f.isActive)throw Error("Automation is not active");if(!f.n8nWorkflowId)throw Error("Automation has no associated n8n workflow");let g=Date.now(),h=await e.P.executeWorkflow(f.n8nWorkflowId,c),i=Date.now()-g;console.log("[Automation Service] N8N execution completed:",h.id,`(${i}ms)`),await d.z.automation.update({where:{id:a},data:{executionCount:{increment:1},successCount:{increment:1},lastExecutedAt:new Date}});try{await d.z.activityLog.create({data:{userId:null,orgId:b,action:"EXECUTE",entity:"AUTOMATION",entityId:a,metadata:{n8nExecutionId:h.id,executionTime:i,status:"SUCCESS"}}})}catch(a){console.error("[Automation Service] Failed to log execution:",a)}return{id:f.id,n8nExecutionId:h.id,status:"SUCCESS",executionTime:i,data:h.data}}catch(c){console.error("[Automation Service] Execution failed:",c);try{await d.z.activityLog.create({data:{userId:null,orgId:b,action:"EXECUTE",entity:"AUTOMATION",entityId:a,metadata:{status:"FAILED",error:c instanceof Error?c.message:"Unknown error"}}})}catch(a){console.error("[Automation Service] Failed to log error:",a)}throw Error(`Failed to execute automation: ${c instanceof Error?c.message:"Unknown error"}`)}}async toggleAutomation(a,b,c){try{let f=await this.getAutomation(a,b);if(!f)throw Error("Automation not found");f.n8nWorkflowId&&(c?await e.P.activateWorkflow(f.n8nWorkflowId):await e.P.deactivateWorkflow(f.n8nWorkflowId));let g=await d.z.automation.update({where:{id:a},data:{isActive:c}});console.log(`[Automation Service] Automation ${c?"activated":"deactivated"}:`,a);try{await d.z.activityLog.create({data:{userId:null,orgId:b,action:"UPDATE",entity:"AUTOMATION",entityId:a,metadata:{isActive:c,action:c?"activated":"deactivated"}}})}catch(a){console.error("[Automation Service] Failed to log toggle:",a)}return g}catch(a){throw console.error("[Automation Service] Failed to toggle automation:",a),Error(`Failed to toggle automation: ${a instanceof Error?a.message:"Unknown error"}`)}}async deleteAutomation(a,b){try{let c=await this.getAutomation(a,b);if(!c)throw Error("Automation not found");if(c.n8nWorkflowId)try{await e.P.deleteWorkflow(c.n8nWorkflowId),console.log("[Automation Service] N8N workflow deleted:",c.n8nWorkflowId)}catch(a){console.error("[Automation Service] Failed to delete n8n workflow:",a)}await d.z.automation.delete({where:{id:a}}),console.log("[Automation Service] Automation deleted:",a);try{await d.z.activityLog.create({data:{userId:null,orgId:b,action:"DELETE",entity:"AUTOMATION",entityId:a,metadata:{name:c.name,n8nWorkflowId:c.n8nWorkflowId}}})}catch(a){console.error("[Automation Service] Failed to log deletion:",a)}}catch(a){throw console.error("[Automation Service] Failed to delete automation:",a),Error(`Failed to delete automation: ${a instanceof Error?a.message:"Unknown error"}`)}}async updateAutomation(a,b,c){try{let f=await this.getAutomation(a,b);if(!f)throw Error("Automation not found");c.name&&f.n8nWorkflowId&&await e.P.updateWorkflow(f.n8nWorkflowId,{name:c.name});let g=await d.z.automation.update({where:{id:a},data:{...c.name&&{name:c.name},...void 0!==c.description&&{description:c.description},...void 0!==c.isActive&&{isActive:c.isActive},...c.tags&&{tags:c.tags},...void 0!==c.metadata&&{metadata:c.metadata}}});return console.log("[Automation Service] Automation updated:",a),g}catch(a){throw console.error("[Automation Service] Failed to update automation:",a),Error(`Failed to update automation: ${a instanceof Error?a.message:"Unknown error"}`)}}async getExecutionHistory(a,b,c=50){try{return console.log("[Automation Service] Execution history not yet available (requires migration)"),[]}catch(a){throw console.error("[Automation Service] Failed to get execution history:",a),Error(`Failed to get execution history: ${a instanceof Error?a.message:"Unknown error"}`)}}}let g=new f},78335:()=>{},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};