(()=>{var a={};a.id=2253,a.ids=[2253],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},15185:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>O,patchFetch:()=>N,routeModule:()=>J,serverHooks:()=>M,workAsyncStorage:()=>K,workUnitAsyncStorage:()=>L});var d={};c.r(d),c.d(d,{GET:()=>I,POST:()=>H});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(55511),w=c.n(v),x=c(96798),y=c(96330),z=c(56842);let A=process.env.EMAIL_WEBHOOK_SECRET||"",B=process.env.DEFAULT_ORG_ID||"",C="true"===process.env.ENABLE_AGENT_EMAIL_PROCESSING;function D(a){if(!a||"string"!=typeof a)return null;let b=((a.match(/<([^>]+)>/)||[null,a])[1]||a).trim().toLowerCase(),c=b.lastIndexOf("@");return -1===c||c===b.length-1?null:b.substring(c+1)}function E(a){if(!a||"string"!=typeof a)return"";let b=a.match(/<([^>]+)>/);return(b?b[1]:a).trim().toLowerCase()}async function F(a,b){if(C)try{let c=new z.L_({orgId:b,skipSpam:!0,skipBounces:!0,skipAutoReplies:!1,logger:{debug:(a,b)=>console.debug(`[Email Agent] ${a}`,b??""),info:(a,b)=>console.info(`[Email Agent] ${a}`,b??""),warn:(a,b)=>console.warn(`[Email Agent] ${a}`,b??""),error:(a,b,c)=>console.error(`[Email Agent] ${a}`,b,c??"")}}),d=await c.handleInput(a);d.success?console.log("[Email Webhook] Agent processing completed",{correlationId:d.input.correlationId,eventEmitted:d.eventEmitted}):console.warn("[Email Webhook] Agent processing failed",{error:d.error?.message})}catch(a){console.error("[Email Webhook] Agent processing error:",a)}}async function G(a){let b=D(a);if(!b)return console.log("[Email Webhook] Could not extract domain, using default org"),B;try{let a=await x.z.organization.findFirst({where:{OR:[{name:{contains:b,mode:"insensitive"}}]},select:{id:!0}});if(a)return console.log(`[Email Webhook] Found org for domain ${b}: ${a.id}`),a.id}catch(a){console.error("[Email Webhook] Error looking up organization:",a)}return console.log(`[Email Webhook] No org found for domain ${b}, using default`),B}async function H(a){let b,c=Date.now();try{var d,e;let f;if(!(b=await a.text()))return console.error("[Email Webhook] Empty request body"),u.NextResponse.json({error:"Bad Request",details:"Empty request body"},{status:400});let g=a.headers.get("X-Webhook-Signature")||a.headers.get("x-webhook-signature")||"",h=a.headers.get("X-Webhook-Timestamp")||a.headers.get("x-webhook-timestamp")||"";if(A&&!function(a,b,c){if(!A)return console.error("[Email Webhook] EMAIL_WEBHOOK_SECRET not configured"),!1;if(!a||!b)return console.error("[Email Webhook] Missing signature or timestamp"),!1;let d=1e3*parseInt(b,10),e=Date.now();if(isNaN(d)||Math.abs(e-d)>3e5)return console.error("[Email Webhook] Timestamp outside validity window"),!1;let f=`${b}.${c}`,g=w().createHmac("sha256",A).update(f).digest("hex");try{let b=Buffer.from(a),c=Buffer.from(g);if(b.length!==c.length)return!1;return w().timingSafeEqual(b,c)}catch(a){return console.error("[Email Webhook] Signature comparison error:",a),!1}}(g,h,b))return console.error("[Email Webhook] Invalid webhook signature"),u.NextResponse.json({error:"Unauthorized",details:"Invalid webhook signature"},{status:401});try{f=JSON.parse(b)}catch(a){return console.error("[Email Webhook] Failed to parse JSON:",a),u.NextResponse.json({error:"Bad Request",details:"Invalid JSON payload"},{status:400})}if(!f.from)return console.error("[Email Webhook] Missing from address"),u.NextResponse.json({error:"Bad Request",details:"Missing required field: from"},{status:400});if(!f.to)return console.error("[Email Webhook] Missing to address"),u.NextResponse.json({error:"Bad Request",details:"Missing required field: to"},{status:400});let i=E(f.from),j=E(f.to),k=f.subject||"(No Subject)",l=(d=f.text,e=f.html,d&&d.trim()?d.trim():e?e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g," ").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/\s+/g," ").trim():""),m=function(a,b){if(!a)return"";if(a.length<=2e3)return a;let c=a.substring(0,2e3),d=c.lastIndexOf(" ");return d>.8*b?c.substring(0,d)+"...":c+"..."}(l,2e3),n=Array.isArray(f.attachments)&&f.attachments.length>0,o=n?f.attachments.length:0,p=await G(j);if(!p)return console.error("[Email Webhook] No organization ID available (DEFAULT_ORG_ID not set)"),u.NextResponse.json({error:"Configuration Error",details:"No default organization configured"},{status:500});let q=await x.z.organization.findUnique({where:{id:p},select:{id:!0,name:!0}});if(!q)return console.error(`[Email Webhook] Organization not found: ${p}`),u.NextResponse.json({error:"Configuration Error",details:"Organization not found"},{status:500});let r={fromEmail:i,toEmail:j,subject:k,bodyPreview:m.substring(0,500),bodyFull:m,hasAttachments:n,attachmentCount:o,attachments:n?f.attachments.map(a=>({filename:a.filename,contentType:a.contentType,size:a.size})):[],receivedAt:new Date().toISOString(),messageId:f.messageId||null,headers:f.headers||{},spamScore:f.spamScore,spf:f.spf,dkim:f.dkim},s=await x.z.intakeRequest.create({data:{source:y.IntakeSource.EMAIL,status:y.IntakeStatus.NEW,title:k,description:m,requestData:r,priority:2,orgId:q.id,aiRoutingMeta:{source:"email_webhook",fromDomain:D(i),toDomain:D(j),hasAttachments:n,attachmentCount:o,receivedAt:new Date().toISOString(),processingStartedAt:new Date(c).toISOString()}}});console.log(`[Email Webhook] Created intake request: ${s.id}`),F(f,q.id).catch(a=>{console.error("[Email Webhook] Agent processing failed:",a)});let t=Date.now()-c;return console.log(`[Email Webhook] Processed in ${t}ms`),u.NextResponse.json({success:!0,intakeRequestId:s.id,status:"queued",message:"Email received and queued for processing"},{status:200})}catch(a){if(console.error("[Email Webhook] Error processing webhook:",a),a instanceof SyntaxError)return u.NextResponse.json({error:"Bad Request",details:"Invalid JSON payload"},{status:400});return u.NextResponse.json({error:"Internal Server Error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function I(){return u.NextResponse.json({success:!0,service:"email-webhook",status:"active",timestamp:new Date().toISOString(),config:{signatureVerification:!!A,defaultOrgConfigured:!!B,agentProcessingEnabled:C},supportedProviders:["sendgrid","mailgun","postmark","generic"]})}let J=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/webhooks/email/route",pathname:"/api/webhooks/email",filename:"route",bundlePath:"app/api/webhooks/email/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/webhooks/email/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:K,workUnitAsyncStorage:L,serverHooks:M}=J;function N(){return(0,g.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:L})}async function O(a,b,c){var d;let e="/api/webhooks/email/route";"/index"===e&&(e="/");let g=await J.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||J.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===J.isDev||!E,H=E&&!G,I=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>J.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>J.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await J.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await J.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await J.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},83878:(a,b,c)=>{"use strict";c.d(b,{Dd:()=>f,HA:()=>u,Ls:()=>t,MU:()=>p,OE:()=>l,PS:()=>h,VN:()=>j,W9:()=>q,n$:()=>e,nm:()=>g,qx:()=>k,tc:()=>i,uE:()=>n,v3:()=>m,yI:()=>o,z3:()=>r});var d=c(45711);let e=d.Ik({role:d.k5(["system","user","assistant"]),content:d.Yj(),name:d.Yj().optional()});var f=function(a){return a.OPENAI="OPENAI",a.CLAUDE="CLAUDE",a}({}),g=function(a){return a.EMAIL="EMAIL",a.WEBHOOK="WEBHOOK",a.DB_TRIGGER="DB_TRIGGER",a.WORKER="WORKER",a.API="API",a.SCHEDULE="SCHEDULE",a}({}),h=function(a){return a.ASSIGN_PIPELINE="ASSIGN_PIPELINE",a.CREATE_TASK="CREATE_TASK",a.CREATE_EVENT="CREATE_EVENT",a.UPDATE_EVENT="UPDATE_EVENT",a.CANCEL_EVENT="CANCEL_EVENT",a.SEND_NOTIFICATION="SEND_NOTIFICATION",a.TRIGGER_AUTOMATION="TRIGGER_AUTOMATION",a.ESCALATE="ESCALATE",a.NO_ACTION="NO_ACTION",a}({}),i=function(a){return a.PENDING="PENDING",a.EXECUTED="EXECUTED",a.FAILED="FAILED",a.REJECTED="REJECTED",a.REQUIRES_APPROVAL="REQUIRES_APPROVAL",a}({});let j={maxRetries:3,retryBaseDelay:1e3};class k extends Error{constructor(a,b,c,d,e=!1,f){super(a),this.code=b,this.provider=c,this.statusCode=d,this.retryable=e,this.originalError=f,this.name="LLMError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,k)}}class l extends k{constructor(a,b,c,d){super(a,"RATE_LIMIT_EXCEEDED",b,429,!0,d),this.retryAfterMs=c,this.name="RateLimitError"}}class m extends k{constructor(a,b,c){super(a,"AUTHENTICATION_FAILED",b,401,!1,c),this.name="AuthenticationError"}}class n extends k{constructor(a,b){super(`API key not configured for ${a}. Please set the appropriate environment variable.`,"API_KEY_MISSING",a,void 0,!1,b),this.name="APIKeyError"}}class o extends k{constructor(a,b,c){super(a,"VALIDATION_FAILED",b,400,!1),this.validationErrors=c,this.name="ValidationError"}}class p extends k{constructor(a,b,c){super(`Request timed out after ${b}ms`,"TIMEOUT",a,408,!0,c),this.name="TimeoutError"}}class q extends k{constructor(a,b,c){super(a,"CONTENT_FILTERED",b,400,!1,c),this.name="ContentFilterError"}}class r extends k{constructor(a,b,c){super(`${a} model is currently overloaded. Please retry later.`,"MODEL_OVERLOADED",a,503,!0,c),this.retryAfterMs=b,this.name="ModelOverloadedError"}}d.Ik({source:d.fc(g),type:d.Yj().min(1),rawContent:d.Yj(),structuredData:d.g1(d.L5()).optional(),metadata:d.Ik({senderEmail:d.Yj().email().optional(),senderName:d.Yj().optional(),ipAddress:d.Yj().optional(),userAgent:d.Yj().optional(),webhookSignature:d.Yj().optional(),headers:d.g1(d.Yj()).optional(),relatedEntityIds:d.g1(d.Yj()).optional(),priorityHint:d.ai().int().min(1).max(5).optional(),tags:d.YO(d.Yj()).optional()}).optional(),timestamp:d.p6(),correlationId:d.Yj().optional()}),d.Ik({intent:d.Yj(),confidence:d.ai().min(0).max(1),urgency:d.ai().int().min(1).max(5),keywords:d.YO(d.Yj()),entities:d.YO(d.Ik({type:d.Yj(),value:d.Yj(),confidence:d.ai().min(0).max(1),position:d.Ik({start:d.ai(),end:d.ai()}).optional()})),subIntent:d.Yj().optional(),sentiment:d.k5(["positive","neutral","negative"]).optional()});let s=d.Ik({type:d.fc(h),params:d.g1(d.L5()),priority:d.ai().int().min(1).max(5),requiresConfirmation:d.zM(),delayMs:d.ai().int().positive().optional(),condition:d.Ik({type:d.k5(["time_range","user_available","slot_available","custom"]),params:d.g1(d.L5())}).optional()});d.Ik({intent:d.Yj(),confidence:d.ai().min(0).max(1),reasoning:d.Yj(),actions:d.YO(s),requiresApproval:d.zM(),priority:d.ai().int().min(1).max(5).optional(),warnings:d.YO(d.Yj()).optional(),alternatives:d.YO(d.Ik({intent:d.Yj(),confidence:d.ai().min(0).max(1),reason:d.Yj()})).optional()});let t={temperature:.3,maxTokens:2e3,timeout:3e4},u={temperature:.3,autoExecuteThreshold:.85,requireApprovalThreshold:.5,maxActionsPerMinute:60,maxActionsPerHour:500}},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},95758:(a,b,c)=>{"use strict";function d(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}c.d(b,{Ju:()=>h,T$:()=>i,io:()=>g});let e="undefined"!=typeof process&&!1,f={debug:(a,b)=>{e&&console.debug(`[EventBus] ${a}`,b??"")},info:(a,b)=>{console.info(`[EventBus] ${a}`,b??"")},warn:(a,b)=>{console.warn(`[EventBus] ${a}`,b??"")},error:(a,b,c)=>{console.error(`[EventBus] ${a}`,b,c??"")}};class g{static{this.instance=null}constructor(a={}){this.subscriptions=new Map,this.eventHistory=[],this.historySize=a.historySize??100,this.logger=a.logger??f,this.debug=a.debug??!1,this.defaultOrgId=a.defaultOrgId,this.stats={totalEventsEmitted:0,totalHandlersInvoked:0,totalErrors:0,eventCounts:new Map},this.logger.info("EventBus initialized",{historySize:this.historySize})}static getInstance(a){return g.instance||(g.instance=new g(a)),g.instance}static resetInstance(){g.instance&&(g.instance.removeAllListeners(),g.instance=null)}on(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!1}),this.debug&&this.logger.debug(`Handler registered for event "${a}"`,{subscriptionId:c}),c}once(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!0}),this.debug&&this.logger.debug(`Once handler registered for event "${a}"`,{subscriptionId:c}),c}onAny(a){let b=this.generateSubscriptionId();return this.subscriptions.has("*")||this.subscriptions.set("*",new Map),this.subscriptions.get("*").set(b,{eventType:"*",handler:a,subscriptionId:b,once:!1}),this.debug&&this.logger.debug("Wildcard handler registered",{subscriptionId:b}),b}off(a){for(let[,b]of this.subscriptions)if(b.has(a))return b.delete(a),this.debug&&this.logger.debug("Handler removed",{subscriptionId:a}),!0;return!1}removeAllListeners(a){a?(this.subscriptions.delete(a),this.logger.info(`All handlers removed for event "${a}"`)):(this.subscriptions.clear(),this.logger.info("All handlers removed"))}async emit(a,b,c){let e=d(),f=new Date,g=[],h=[],i={type:a,payload:b,timestamp:f,source:c?.source??"system",eventId:e,correlationId:c?.correlationId,orgId:c?.orgId??this.defaultOrgId,metadata:c?.metadata};this.stats.totalEventsEmitted++,this.stats.eventCounts.set(a,(this.stats.eventCounts.get(a)??0)+1),this.debug&&this.logger.debug(`Emitting event "${a}"`,{eventId:e,source:i.source});let j=[],k=this.subscriptions.get(a);if(k)for(let a of k.values())j.push(a);let l=this.subscriptions.get("*");if(l)for(let a of l.values())j.push(a);let m=[],n=j.map(async b=>{let c=Date.now();try{return await b.handler(i),this.stats.totalHandlersInvoked++,b.once&&m.push(b.subscriptionId),{subscriptionId:b.subscriptionId,success:!0,executionTimeMs:Date.now()-c}}catch(f){let d=f instanceof Error?f:Error(String(f));return this.stats.totalErrors++,this.logger.error(`Handler ${b.subscriptionId} failed for event "${a}"`,d,{eventId:e,subscriptionId:b.subscriptionId}),{subscriptionId:b.subscriptionId,success:!1,error:d,executionTimeMs:Date.now()-c}}}),o=await Promise.all(n);for(let a of m)this.off(a);for(let a of o)g.push(a),a.error&&h.push(a.error);return this.addToHistory(i,g.length,h.map(a=>a.message)),this.debug&&this.logger.debug(`Event "${a}" processing complete`,{eventId:e,handlersInvoked:g.length,successCount:g.filter(a=>a.success).length,errorCount:h.length}),{eventType:a,eventId:e,timestamp:f,handlersInvoked:g.length,results:g,errors:h}}emitSync(a,b,c){this.emit(a,b,c).catch(b=>{this.logger.error(`Sync emit failed for event "${a}"`,b)})}getHistory(a,b){let c=[...this.eventHistory];if(a){let b=Array.isArray(a)?a:[a];c=c.filter(a=>b.includes(a.event.type))}return b&&b>0&&(c=c.slice(-b)),c}async replay(a){this.logger.info(`Replaying ${a.length} events`);let b=[];for(let c of a){let a=await this.emit(c.event.type,c.event.payload,{source:c.event.source,correlationId:c.event.correlationId,orgId:c.event.orgId,metadata:{...c.event.metadata,replayed:!0,originalEventId:c.event.eventId,originalTimestamp:c.event.timestamp.toISOString()}});b.push(a)}return b}clearHistory(){this.eventHistory=[],this.logger.info("Event history cleared")}getStats(){let a={};for(let[b,c]of this.stats.eventCounts)a[b]=c;let b={};for(let[a,c]of this.subscriptions)b[a]=c.size;return{totalEventsEmitted:this.stats.totalEventsEmitted,totalHandlersInvoked:this.stats.totalHandlersInvoked,totalErrors:this.stats.totalErrors,eventCounts:a,subscriptionCounts:b,historySize:this.eventHistory.length}}listenerCount(a){let b=this.subscriptions.get(a),c=this.subscriptions.get("*");return(b?.size??0)+(c?.size??0)}eventNames(){let a=[];for(let b of this.subscriptions.keys())"*"!==b&&a.push(b);return a}getSubscriptions(){let a=[];for(let b of this.subscriptions.values())for(let c of b.values())a.push(c);return a}generateSubscriptionId(){return`sub_${d().slice(0,8)}`}addToHistory(a,b,c){let e={id:a.eventId??d(),event:a,timestamp:new Date,processed:!0,handlersInvoked:b,errors:c?.length?c:void 0};this.eventHistory.push(e),this.eventHistory.length>this.historySize&&(this.eventHistory=this.eventHistory.slice(-this.historySize))}}function h(a){return g.getInstance(a)}async function i(a,b,c){return g.getInstance().emit(a,b,c)}},96330:a=>{"use strict";a.exports=require("@prisma/client")},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[40,8208,7519,5711,1692,6842],()=>b(b.s=15185));module.exports=c})();