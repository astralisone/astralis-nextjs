"use strict";(()=>{var a={};a.id=2725,a.ids=[2725],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5644:(a,b,c)=>{c.d(b,{J:()=>e});var d=c(95726);function e(a,b,c){return(0,d.f)(a,7*b,c)}},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11244:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{W:()=>r});var e=c(87984),f=c(55511),g=c(99750),h=c(28134),i=c(95726),j=c(5644),k=c(30509),l=c(66850),m=c(79504),n=c(87044),o=c(14160),p=c(87813),q=a([e]);e=(q.then?(await q)():q)[0];class s{constructor(){if(this.chatModel="gpt-4-turbo-preview",!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY environment variable is not set");this.openai=new e.default({apiKey:process.env.OPENAI_API_KEY,timeout:3e4,maxRetries:2})}async processCalendarMessage(a,b,c,d){try{if(d?.confirmed&&d?.pendingAction){let c=await this.executeCalendarAction(d.pendingAction.type,d.pendingAction.data,a,b);return{message:c.message,data:c.data,requiresConfirmation:!1}}let e=[{name:"list_events",description:"List calendar events in a date range. Use this when user wants to view their schedule.",parameters:{type:"object",properties:{startDate:{type:"string",description:"Start date in ISO format (YYYY-MM-DD)"},endDate:{type:"string",description:"End date in ISO format (YYYY-MM-DD)"}},required:["startDate","endDate"]}},{name:"check_availability",description:"Check if user is available at a specific time or find free time slots.",parameters:{type:"object",properties:{startDate:{type:"string",description:"Start date in ISO format (YYYY-MM-DD)"},endDate:{type:"string",description:"End date in ISO format (YYYY-MM-DD)"},duration:{type:"number",description:"Required duration in minutes (optional)"}},required:["startDate","endDate"]}},{name:"schedule_event",description:"Schedule a new calendar event. Always requires user confirmation.",parameters:{type:"object",properties:{title:{type:"string",description:"Event title"},startDateTime:{type:"string",description:"Start date and time in ISO format"},duration:{type:"number",description:"Duration in minutes"},participants:{type:"array",items:{type:"string"},description:"Email addresses of participants"},description:{type:"string",description:"Event description (optional)"},location:{type:"string",description:"Event location (optional)"}},required:["title","startDateTime","duration"]}},{name:"find_time_slots",description:"Find available time slots for a meeting of specific duration.",parameters:{type:"object",properties:{startDate:{type:"string",description:"Start date to search from in ISO format"},endDate:{type:"string",description:"End date to search until in ISO format"},duration:{type:"number",description:"Required duration in minutes"},maxSlots:{type:"number",description:"Maximum number of slots to return (default 5)"}},required:["duration","startDate","endDate"]}},{name:"cancel_event",description:"Cancel a calendar event. Always requires user confirmation.",parameters:{type:"object",properties:{eventId:{type:"string",description:"Event ID to cancel"}},required:["eventId"]}},{name:"set_reminder",description:"Set a reminder for an event or create a standalone reminder. Use when user asks to remind them about something.",parameters:{type:"object",properties:{title:{type:"string",description:"What to remind about"},reminderTime:{type:"string",description:"When to send the reminder in ISO format"},eventId:{type:"string",description:"Optional event ID to attach reminder to"},notifyBefore:{type:"number",description:"Minutes before event to remind (e.g., 15, 60, 1440 for 24h)"}},required:["title","reminderTime"]}},{name:"list_reminders",description:"List upcoming reminders for the user.",parameters:{type:"object",properties:{startDate:{type:"string",description:"Start date in ISO format"},endDate:{type:"string",description:"End date in ISO format"}},required:["startDate","endDate"]}}],f=`You are a helpful calendar assistant. You help users manage their calendar using natural language.

Current date and time: ${new Date().toISOString()}

When interpreting dates:
- "tomorrow" = ${(0,h.GP)((0,i.f)(new Date,1),"yyyy-MM-dd")}
- "next week" = ${(0,h.GP)((0,j.J)(new Date,1),"yyyy-MM-dd")} to ${(0,h.GP)((0,j.J)(new Date,2),"yyyy-MM-dd")}
- "this week" = ${(0,h.GP)((0,k.o)(new Date),"yyyy-MM-dd")} to ${(0,h.GP)((0,l.D)((0,i.f)(new Date,7)),"yyyy-MM-dd")}

Guidelines:
- Be conversational and helpful
- Always confirm before creating, modifying, or deleting events
- Parse dates and times naturally (e.g., "tomorrow at 2pm", "next Tuesday")
- Provide clear summaries of events and time slots
- If information is missing, ask clarifying questions
- Use appropriate function calls to fulfill user requests`,g=[{role:"system",content:f},...d?.previousMessages||[],{role:"user",content:c}],m=(await this.openai.chat.completions.create({model:this.chatModel,messages:g,functions:e,function_call:"auto",temperature:.7,max_tokens:1e3})).choices[0].message;if(m.function_call){let c=m.function_call.name,d=JSON.parse(m.function_call.arguments);console.log(`[CalendarChat] Function call: ${c}`,d);let e=await this.executeFunctionCall(c,d,a,b);if(this.requiresConfirmation(c))return{message:e.message,requiresConfirmation:!0,action:{type:c,data:d}};return{message:e.message,data:e.data,requiresConfirmation:!1}}return{message:m.content||"I apologize, but I could not understand that request.",requiresConfirmation:!1}}catch(a){return console.error("[CalendarChat] Process message error:",a),{message:`I encountered an error: ${a instanceof Error?a.message:"Unknown error"}. Please try again.`,requiresConfirmation:!1}}}async executeFunctionCall(a,b,c,d){try{switch(a){case"list_events":return await this.listEvents(c,d,(0,m.H)(b.startDate),(0,m.H)(b.endDate));case"check_availability":return await this.checkAvailability(c,d,(0,m.H)(b.startDate),(0,m.H)(b.endDate),b.duration);case"schedule_event":return await this.prepareScheduleEvent(b);case"find_time_slots":return await this.findTimeSlots(c,d,(0,m.H)(b.startDate),(0,m.H)(b.endDate),b.duration,b.maxSlots||5);case"cancel_event":return await this.prepareCancelEvent(c,d,b.eventId);case"set_reminder":return await this.setReminder(c,d,b.title,(0,m.H)(b.reminderTime),b.eventId,b.notifyBefore);case"list_reminders":return await this.listReminders(c,(0,m.H)(b.startDate),(0,m.H)(b.endDate));default:return{success:!1,message:`Unknown function: ${a}`,error:"Unknown function"}}}catch(b){return console.error(`[CalendarChat] Function execution error (${a}):`,b),{success:!1,message:`Failed to execute ${a}: ${b instanceof Error?b.message:"Unknown error"}`,error:b instanceof Error?b.message:"Unknown error"}}}async executeCalendarAction(a,b,c,d){try{switch(a){case"schedule_event":case"schedule":return await this.scheduleEvent(c,d,b);case"cancel":return await this.cancelEvent(c,d,b.eventId);default:return{success:!1,message:`Cannot execute action: ${a}`,error:"Invalid intent"}}}catch(a){return console.error("[CalendarChat] Action execution error:",a),{success:!1,message:`Failed to execute action: ${a instanceof Error?a.message:"Unknown error"}`,error:a instanceof Error?a.message:"Unknown error"}}}requiresConfirmation(a){return["schedule","schedule_event","reschedule","cancel","cancel_event"].includes(a)}async listEvents(a,b,c,d){try{let b=await g.z.consultations.findMany({where:{userId:a,scheduledAt:{gte:c,lte:d},status:{in:["PENDING","CONFIRMED","IN_PROGRESS"]}},orderBy:{scheduledAt:"asc"}}),e=await g.z.audit_bookings.findMany({where:{userId:a,scheduledDate:{gte:c,lte:d},status:{in:["SCHEDULED","CONFIRMED","IN_PROGRESS"]}},orderBy:{scheduledDate:"asc"}}),f=await g.z.schedulingEvent.findMany({where:{userId:a,startTime:{gte:c,lte:d},status:{in:["SCHEDULED","CONFIRMED"]}},orderBy:{startTime:"asc"}}),i=[...b.map(a=>({id:a.id,title:a.title,startTime:a.scheduledAt||new Date,endTime:(0,n.z)(a.scheduledAt||new Date,a.duration),description:a.description||void 0,location:a.meetingUrl||void 0,participants:a.clientEmail?[a.clientEmail]:[],status:a.status,type:"consultation"})),...e.map(a=>({id:a.id,title:`${a.auditType} Audit - ${a.clientName}`,startTime:a.scheduledDate,endTime:(0,n.z)(a.scheduledDate,a.duration),description:a.additionalNotes||void 0,location:a.meetingLink||void 0,participants:[a.clientEmail],status:a.status,type:"audit"})),...f.map(a=>({id:a.id,title:a.title,startTime:a.startTime,endTime:a.endTime,description:a.description||void 0,location:a.location||a.meetingLink||void 0,participants:a.participantEmails,status:a.status,type:"meeting"}))];if(i.sort((a,b)=>a.startTime.getTime()-b.startTime.getTime()),0===i.length)return{success:!0,message:`You have no events scheduled between ${(0,h.GP)(c,"MMM d")} and ${(0,h.GP)(d,"MMM d, yyyy")}.`,data:{events:[]}};let j=i.map((a,b)=>`${b+1}. **${a.title}**
   üìÖ ${(0,h.GP)(a.startTime,"EEE, MMM d")} at ${(0,h.GP)(a.startTime,"h:mm a")}
   ‚è±Ô∏è ${Math.round((a.endTime.getTime()-a.startTime.getTime())/6e4)} minutes${a.location?`
   üìç ${a.location}`:""}${(a.participants?.length??0)>0?`
   üë• ${a.participants?.join(", ")}`:""}`).join("\n\n");return{success:!0,message:`Here are your ${i.length} upcoming event${i.length>1?"s":""}:

${j}`,data:{events:i}}}catch(a){throw console.error("[CalendarChat] List events error:",a),a}}async checkAvailability(a,b,c,d,e){try{let f=await this.listEvents(a,b,c,d);if(!f.success)return f;let g=f.data?.events||[];if(0===g.length)return{success:!0,message:`You are completely free between ${(0,h.GP)(c,"MMM d")} and ${(0,h.GP)(d,"MMM d, yyyy")}! ${e?`Plenty of time for a ${e}-minute meeting.`:""}`,data:{available:!0,conflicts:[]}};let i=g.map(a=>`- ${(0,h.GP)(a.startTime,"EEE, MMM d at h:mm a")}: ${a.title}`).join("\n");return{success:!0,message:`You have ${g.length} event${g.length>1?"s":""} during that time:

${i}`,data:{available:!1,conflicts:g}}}catch(a){throw console.error("[CalendarChat] Check availability error:",a),a}}async prepareScheduleEvent(a){let b=(0,m.H)(a.startDateTime),c=(0,n.z)(b,a.duration),d=a.participants?.length>0?`
üë• Participants: ${a.participants.join(", ")}`:"",e=a.location?`
üìç Location: ${a.location}`:"",f=a.description?`
üìù ${a.description}`:"";return{success:!0,message:`I'll schedule the following event:

**${a.title}**
üìÖ ${(0,h.GP)(b,"EEEE, MMMM d, yyyy")}
‚è∞ ${(0,h.GP)(b,"h:mm a")} - ${(0,h.GP)(c,"h:mm a")} (${a.duration} minutes)${d}${e}${f}

Please confirm to proceed.`}}async scheduleEvent(a,b,c){try{let d=(0,m.H)(c.startDateTime),e=(0,n.z)(d,c.duration),i=await g.z.schedulingEvent.create({data:{id:(0,f.randomUUID)(),userId:a,orgId:b||void 0,title:c.title,description:c.description||void 0,startTime:d,endTime:e,timezone:"UTC",location:c.location||void 0,meetingLink:c.meetingLink||void 0,participantEmails:c.participants||[],status:"SCHEDULED"}}),j=(0,n.z)(d,-15),k=await g.z.eventReminder.create({data:{id:(0,f.randomUUID)(),eventId:i.id,reminderTime:j,status:"PENDING"}});try{await (0,p.vh)({reminderId:k.id,eventId:k.eventId})}catch(a){console.error(`[CalendarChat] Failed to queue reminder ${k.id}:`,a)}return{success:!0,message:`Event scheduled successfully!

**${c.title}** is now on your calendar for ${(0,h.GP)(d,"EEEE, MMMM d")} at ${(0,h.GP)(d,"h:mm a")}.
A reminder has been set for 15 minutes before the event.`,data:{eventId:i.id}}}catch(a){throw console.error("[CalendarChat] Schedule event error:",a),a}}async prepareCancelEvent(a,b,c){try{let b=await g.z.consultations.findFirst({where:{id:c,userId:a}}),d=await g.z.audit_bookings.findFirst({where:{id:c,userId:a}});if(!(b||d))return{success:!1,message:"Event not found or you do not have permission to cancel it.",error:"Event not found"};let e=b?b.title:`${d?.auditType} Audit`,f=b?b.scheduledAt:d?.scheduledDate;return{success:!0,message:`Are you sure you want to cancel:

**${e}**
üìÖ ${f?(0,h.GP)(f,"EEEE, MMMM d at h:mm a"):"Unknown time"}

Please confirm to proceed.`}}catch(a){throw console.error("[CalendarChat] Prepare cancel error:",a),a}}async cancelEvent(a,b,c){try{let b=await g.z.consultations.findFirst({where:{id:c,userId:a}});if(b)return await g.z.consultations.update({where:{id:c},data:{status:"CANCELLED"}}),{success:!0,message:`‚úÖ Event cancelled successfully.

**${b.title}** has been removed from your calendar.`};let d=await g.z.audit_bookings.findFirst({where:{id:c,userId:a}});if(d)return await g.z.audit_bookings.update({where:{id:c},data:{status:"CANCELLED"}}),{success:!0,message:`‚úÖ Event cancelled successfully.

Your ${d.auditType} audit has been cancelled.`};return{success:!1,message:"Event not found or already cancelled.",error:"Event not found"}}catch(a){throw console.error("[CalendarChat] Cancel event error:",a),a}}async findTimeSlots(a,b,c,d,e,f){try{let g=await this.listEvents(a,b,c,d),j=g.data?.events||[],m=[],p=(0,k.o)(c),q=(0,l.D)(d);for(;p<=q&&m.length<f;){let a=p.getDay();if(0===a||6===a){p=(0,i.f)(p,1);continue}for(let a=9;a<17;a++){let b=(0,o.L)((0,k.o)(p),a),c=(0,n.z)(b,e);if(!(c.getHours()>17)&&!j.some(a=>b>=a.startTime&&b<a.endTime||c>a.startTime&&c<=a.endTime||b<=a.startTime&&c>=a.endTime)&&(m.push({start:b,end:c}),m.length>=f))break}if(m.length>=f)break;p=(0,i.f)(p,1)}if(0===m.length)return{success:!0,message:`I couldn't find any ${e}-minute slots between ${(0,h.GP)(c,"MMM d")} and ${(0,h.GP)(d,"MMM d, yyyy")} during business hours (9 AM - 5 PM, Mon-Fri). Your calendar is quite busy!`,data:{slots:[]}};let r=m.map((a,b)=>`${b+1}. ${(0,h.GP)(a.start,"EEE, MMM d")} at ${(0,h.GP)(a.start,"h:mm a")} - ${(0,h.GP)(a.end,"h:mm a")}`).join("\n");return{success:!0,message:`Here are ${m.length} available ${e}-minute time slot${m.length>1?"s":""}:

${r}

Would you like to schedule a meeting in one of these slots?`,data:{slots:m}}}catch(a){throw console.error("[CalendarChat] Find time slots error:",a),a}}async setReminder(a,b,c,d,e,i){try{let j=e;j||(j=(await g.z.schedulingEvent.create({data:{id:(0,f.randomUUID)(),userId:a,orgId:b||void 0,title:`Reminder: ${c}`,startTime:d,endTime:(0,n.z)(d,15),timezone:"UTC",status:"SCHEDULED"}})).id);let k=d;if(i&&e){let a=await g.z.schedulingEvent.findUnique({where:{id:e}});a&&(k=(0,n.z)(a.startTime,-i))}let l=await g.z.eventReminder.create({data:{id:(0,f.randomUUID)(),eventId:j,reminderTime:k,status:"PENDING",retryCount:0}});try{await (0,p.vh)({reminderId:l.id,eventId:l.eventId})}catch(a){console.error(`[CalendarChat] Failed to queue reminder ${l.id}:`,a)}let m=(0,h.GP)(k,"EEEE, MMMM d, yyyy 'at' h:mm a");return{success:!0,message:`Reminder set successfully!

**${c}**
You will be reminded on ${m}.`,data:{reminderId:l.id,eventId:j,reminderTime:k}}}catch(a){throw console.error("[CalendarChat] Set reminder error:",a),a}}async listReminders(a,b,c){try{let d=await g.z.eventReminder.findMany({where:{reminderTime:{gte:b,lte:c},event:{userId:a}},include:{event:{select:{id:!0,title:!0,startTime:!0,endTime:!0}}},orderBy:{reminderTime:"asc"}});if(0===d.length)return{success:!0,message:`You have no reminders scheduled between ${(0,h.GP)(b,"MMM d")} and ${(0,h.GP)(c,"MMM d, yyyy")}.`,data:{reminders:[]}};let e=d.map((a,b)=>{let c="SENT"===a.status?"(sent)":"FAILED"===a.status?"(failed)":"(pending)";return`${b+1}. **${a.event.title}** ${c}
   Reminder: ${(0,h.GP)(a.reminderTime,"EEE, MMM d 'at' h:mm a")}
   Event: ${(0,h.GP)(a.event.startTime,"EEE, MMM d 'at' h:mm a")}`}).join("\n\n");return{success:!0,message:`Here are your ${d.length} upcoming reminder${d.length>1?"s":""}:

${e}`,data:{reminders:d.map(a=>({id:a.id,eventId:a.eventId,eventTitle:a.event.title,reminderTime:a.reminderTime,eventStartTime:a.event.startTime,status:a.status}))}}}catch(a){throw console.error("[CalendarChat] List reminders error:",a),a}}}let t=null;function r(){return t||(t=new s),t}d()}catch(a){d(a)}})},11723:a=>{a.exports=require("querystring")},12412:a=>{a.exports=require("assert")},14160:(a,b,c)=>{c.d(b,{L:()=>g});var d=c(54755),e=c(12121),f=c(89515);function g(a,b,c){var g;return g=b*f.s0,(0,d.w)(c?.in||a,+(0,e.a)(a)+g)}},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21272:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{OPTIONS:()=>l,POST:()=>k});var e=c(90449),f=c(89966),g=c(75625),h=c(11244),i=c(20229),j=a([h]);h=(j.then?(await j)():j)[0];let m=g.Ik({message:g.Yj().min(1,"Message is required").max(1e3,"Message too long"),context:g.Ik({previousMessages:g.YO(g.Ik({role:g.k5(["user","assistant"]),content:g.Yj()})).optional(),confirmed:g.zM().optional(),pendingAction:g.Ik({type:g.Yj(),data:g.bz()}).optional()}).optional()});async function k(a){try{let b=await (0,f.getServerSession)(i.N);if(!b?.user?.id)return e.NextResponse.json({error:"Unauthorized",details:"You must be signed in to use the calendar chat"},{status:401});let c=b.user.id,d=b.user.orgId||"default-org",g=await a.json(),j=m.safeParse(g);if(!j.success)return e.NextResponse.json({error:"Validation failed",details:j.error.flatten().fieldErrors},{status:400});let{message:k,context:l}=j.data,n=(0,h.W)();console.log(`[CalendarChatAPI] Processing message for user ${c}:`,k);let o=Date.now(),p=await n.processCalendarMessage(c,d,k,l),q=Date.now()-o;return console.log(`[CalendarChatAPI] Response generated in ${q}ms`),e.NextResponse.json({success:!0,message:p.message,requiresConfirmation:p.requiresConfirmation||!1,action:p.action,data:p.data},{status:200})}catch(a){return console.error("[CalendarChatAPI] Error:",a),a instanceof Error&&(console.error("[CalendarChatAPI] Error name:",a.name),console.error("[CalendarChatAPI] Error message:",a.message),a.stack&&console.error("[CalendarChatAPI] Error stack:",a.stack.substring(0,500))),e.NextResponse.json({error:"Internal server error",details:a instanceof Error?a.message:"Unknown error occurred"},{status:500})}}async function l(a){return e.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}d()}catch(a){d(a)}})},28354:a=>{a.exports=require("util")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},37659:a=>{a.exports=require("ioredis")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74185:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(27192),f=c(91165),g=c(20972),h=c(97182),i=c(9060),j=c(261),k=c(40306),l=c(43568),m=c(43376),n=c(81827),o=c(7293),p=c(45135),q=c(23857),r=c(99510),s=c(86439),t=c(27196),u=c(21272),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/chat/calendar/route",pathname:"/api/chat/calendar",filename:"route",bundlePath:"app/api/chat/calendar/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/chat/calendar/route.ts",nextConfigOutput:"standalone",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/chat/calendar/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},82923:(a,b,c)=>{c.d(b,{K:()=>d});let d=new(c(37659)).Redis(process.env.REDIS_URL||"redis://localhost:6379",{maxRetriesPerRequest:null,enableReadyCheck:!1,retryStrategy:a=>Math.min(50*a,2e3)});d.on("error",a=>{console.error("[Redis] Connection error:",a)}),d.on("connect",()=>{console.log("[Redis] Connected successfully")}),d.on("ready",()=>{console.log("[Redis] Ready to accept commands")}),d.on("close",()=>{console.log("[Redis] Connection closed")}),d.on("reconnecting",()=>{console.log("[Redis] Reconnecting...")})},83367:a=>{a.exports=require("bullmq")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87044:(a,b,c)=>{c.d(b,{z:()=>f});var d=c(89515),e=c(12121);function f(a,b,c){let f=(0,e.a)(a,c?.in);return f.setTime(f.getTime()+b*d.Cg),f}},87813:(a,b,c)=>{c.d(b,{vh:()=>g});var d=c(83367),e=c(82923);let f=new d.Queue("scheduling-reminders",{connection:e.K,defaultJobOptions:{attempts:3,backoff:{type:"exponential",delay:2e3},removeOnComplete:{age:604800,count:500},removeOnFail:{age:1209600}}});async function g(a){await f.add("send-reminder",a,{jobId:`reminder-${a.reminderId}`}),console.log(`[Queue] Reminder job queued: ${a.reminderId} for event ${a.eventId}`)}},87984:a=>{a.exports=import("openai")},94735:a=>{a.exports=require("events")},95726:(a,b,c)=>{c.d(b,{f:()=>f});var d=c(54755),e=c(12121);function f(a,b,c){let f=(0,e.a)(a,c?.in);return isNaN(b)?(0,d.w)(c?.in||a,NaN):(b&&f.setDate(f.getDate()+b),f)}},96330:a=>{a.exports=require("@prisma/client")},96456:a=>{a.exports=require("zlib")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[8114,5449,8139,9229,5625,624,4437,5062,1057,9420,4418,3152,8864,5829,5883,6224],()=>b(b.s=74185));module.exports=c})();