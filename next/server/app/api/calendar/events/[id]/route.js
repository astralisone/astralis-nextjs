"use strict";(()=>{var a={};a.id=2598,a.ids=[2598],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},1064:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{DELETE:()=>E,GET:()=>C,PUT:()=>D});var e=c(27192),f=c(91165),g=c(20972),h=c(97182),i=c(9060),j=c(261),k=c(40306),l=c(43568),m=c(43376),n=c(81827),o=c(7293),p=c(45135),q=c(23857),r=c(99510),s=c(86439),t=c(27196),u=c(90449),v=c(89966),w=c(20229),x=c(94122),y=c(75625),z=c(76934),A=c(99750);let B=y.Ik({title:y.Yj().min(1).optional(),description:y.Yj().optional(),startTime:y.Yj().datetime().optional(),endTime:y.Yj().datetime().optional(),location:y.Yj().optional(),attendees:y.YO(y.Yj().email()).optional(),status:y.k5(["SCHEDULED","CONFIRMED","CANCELLED","COMPLETED"]).optional(),metadata:y.g1(y.bz()).optional()});async function C(a,{params:b}){try{let a=await (0,v.getServerSession)(w.N);if(!a?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b,d=await x.Z8(c);if(!d)return u.NextResponse.json({error:"Event not found"},{status:404});return u.NextResponse.json({success:!0,data:d},{status:200})}catch(a){if(console.error("Error fetching event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});return u.NextResponse.json({error:"Failed to fetch event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function D(a,{params:b}){try{let c=await (0,v.getServerSession)(w.N);if(!c?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:d}=await b,e=await a.json(),f=B.safeParse(e);if(!f.success)return u.NextResponse.json({error:"Validation failed",details:f.error.flatten().fieldErrors},{status:400});let g=f.data,h=await x.Z8(d);if(!h)return u.NextResponse.json({error:"Event not found"},{status:404});if(g.startTime&&g.endTime){let a=new Date(g.startTime);if(new Date(g.endTime)<=a)return u.NextResponse.json({error:"End time must be after start time"},{status:400})}let i={title:g.title,description:g.description,startTime:g.startTime?new Date(g.startTime):void 0,endTime:g.endTime?new Date(g.endTime):void 0,location:g.location,participantEmails:g.attendees,status:g.status,syncToGoogle:!1},j=await x.qM(d,i);if(await (0,z.T$)("calendar:event_updated",{eventId:j.id,title:j.title,status:j.status,previousStatus:h.status,userId:j.userId,orgId:j.orgId,timestamp:new Date},{source:"system",orgId:j.orgId||void 0}),g.status&&["CONFIRMED","CANCELLED","COMPLETED"].includes(g.status)){let a=await A.z.task.findFirst({where:{OR:[{sourceId:d},{data:{path:["schedulingEventId"],equals:d}}]}});if(a){let b="CONFIRMED"===g.status?"IN_PROGRESS":"COMPLETED"===g.status?"DONE":"CANCELLED";await (0,z.T$)("task:status_changed",{taskId:a.id,previousStatus:a.status,newStatus:b,reason:`Calendar event ${g.status.toLowerCase()}`,timestamp:new Date},{source:"system",orgId:a.orgId})}}return u.NextResponse.json({success:!0,data:j,message:"Event updated successfully"},{status:200})}catch(a){if(console.error("Error updating event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});if(a instanceof Error&&a.message.includes("Unauthorized"))return u.NextResponse.json({error:"You don't have permission to update this event"},{status:403});if(a instanceof Error&&a.message.includes("conflict"))return u.NextResponse.json({error:"Scheduling conflict detected",details:a.message},{status:409});return u.NextResponse.json({error:"Failed to update event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function E(a,{params:b}){try{let a=await (0,v.getServerSession)(w.N);if(!a?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b;return await x.SX(c),u.NextResponse.json({success:!0,message:"Event deleted successfully"},{status:200})}catch(a){if(console.error("Error deleting event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});if(a instanceof Error&&a.message.includes("Unauthorized"))return u.NextResponse.json({error:"You don't have permission to delete this event"},{status:403});return u.NextResponse.json({error:"Failed to delete event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/calendar/events/[id]/route",pathname:"/api/calendar/events/[id]",filename:"route",bundlePath:"app/api/calendar/events/[id]/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/calendar/events/[id]/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/calendar/events/[id]/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},1708:a=>{a.exports=require("node:process")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:a=>{a.exports=require("node:buffer")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{a.exports=require("querystring")},12412:a=>{a.exports=require("assert")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},19771:a=>{a.exports=require("process")},21820:a=>{a.exports=require("os")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},34631:a=>{a.exports=require("tls")},37067:a=>{a.exports=require("node:http")},37659:a=>{a.exports=require("ioredis")},37830:a=>{a.exports=require("node:stream/web")},38522:a=>{a.exports=require("node:zlib")},44708:a=>{a.exports=require("node:https")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},57075:a=>{a.exports=require("node:stream")},57975:a=>{a.exports=require("node:util")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{a.exports=require("node:fs")},73136:a=>{a.exports=require("node:url")},73496:a=>{a.exports=require("http2")},73566:a=>{a.exports=require("worker_threads")},76760:a=>{a.exports=require("node:path")},76934:(a,b,c)=>{function d(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}c.d(b,{Ju:()=>h,T$:()=>i,io:()=>g});let e="undefined"!=typeof process&&!1,f={debug:(a,b)=>{e&&console.debug(`[EventBus] ${a}`,b??"")},info:(a,b)=>{console.info(`[EventBus] ${a}`,b??"")},warn:(a,b)=>{console.warn(`[EventBus] ${a}`,b??"")},error:(a,b,c)=>{console.error(`[EventBus] ${a}`,b,c??"")}};class g{static{this.instance=null}constructor(a={}){this.subscriptions=new Map,this.eventHistory=[],this.historySize=a.historySize??100,this.logger=a.logger??f,this.debug=a.debug??!1,this.defaultOrgId=a.defaultOrgId,this.stats={totalEventsEmitted:0,totalHandlersInvoked:0,totalErrors:0,eventCounts:new Map},this.logger.info("EventBus initialized",{historySize:this.historySize})}static getInstance(a){return g.instance||(g.instance=new g(a)),g.instance}static resetInstance(){g.instance&&(g.instance.removeAllListeners(),g.instance=null)}on(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!1}),this.debug&&this.logger.debug(`Handler registered for event "${a}"`,{subscriptionId:c}),c}once(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!0}),this.debug&&this.logger.debug(`Once handler registered for event "${a}"`,{subscriptionId:c}),c}onAny(a){let b=this.generateSubscriptionId();return this.subscriptions.has("*")||this.subscriptions.set("*",new Map),this.subscriptions.get("*").set(b,{eventType:"*",handler:a,subscriptionId:b,once:!1}),this.debug&&this.logger.debug("Wildcard handler registered",{subscriptionId:b}),b}off(a){for(let[,b]of this.subscriptions)if(b.has(a))return b.delete(a),this.debug&&this.logger.debug("Handler removed",{subscriptionId:a}),!0;return!1}removeAllListeners(a){a?(this.subscriptions.delete(a),this.logger.info(`All handlers removed for event "${a}"`)):(this.subscriptions.clear(),this.logger.info("All handlers removed"))}async emit(a,b,c){let e=d(),f=new Date,g=[],h=[],i={type:a,payload:b,timestamp:f,source:c?.source??"system",eventId:e,correlationId:c?.correlationId,orgId:c?.orgId??this.defaultOrgId,metadata:c?.metadata};this.stats.totalEventsEmitted++,this.stats.eventCounts.set(a,(this.stats.eventCounts.get(a)??0)+1),this.debug&&this.logger.debug(`Emitting event "${a}"`,{eventId:e,source:i.source});let j=[],k=this.subscriptions.get(a);if(k)for(let a of k.values())j.push(a);let l=this.subscriptions.get("*");if(l)for(let a of l.values())j.push(a);let m=[],n=j.map(async b=>{let c=Date.now();try{return await b.handler(i),this.stats.totalHandlersInvoked++,b.once&&m.push(b.subscriptionId),{subscriptionId:b.subscriptionId,success:!0,executionTimeMs:Date.now()-c}}catch(f){let d=f instanceof Error?f:Error(String(f));return this.stats.totalErrors++,this.logger.error(`Handler ${b.subscriptionId} failed for event "${a}"`,d,{eventId:e,subscriptionId:b.subscriptionId}),{subscriptionId:b.subscriptionId,success:!1,error:d,executionTimeMs:Date.now()-c}}}),o=await Promise.all(n);for(let a of m)this.off(a);for(let a of o)g.push(a),a.error&&h.push(a.error);return this.addToHistory(i,g.length,h.map(a=>a.message)),this.debug&&this.logger.debug(`Event "${a}" processing complete`,{eventId:e,handlersInvoked:g.length,successCount:g.filter(a=>a.success).length,errorCount:h.length}),{eventType:a,eventId:e,timestamp:f,handlersInvoked:g.length,results:g,errors:h}}emitSync(a,b,c){this.emit(a,b,c).catch(b=>{this.logger.error(`Sync emit failed for event "${a}"`,b)})}getHistory(a,b){let c=[...this.eventHistory];if(a){let b=Array.isArray(a)?a:[a];c=c.filter(a=>b.includes(a.event.type))}return b&&b>0&&(c=c.slice(-b)),c}async replay(a){this.logger.info(`Replaying ${a.length} events`);let b=[];for(let c of a){let a=await this.emit(c.event.type,c.event.payload,{source:c.event.source,correlationId:c.event.correlationId,orgId:c.event.orgId,metadata:{...c.event.metadata,replayed:!0,originalEventId:c.event.eventId,originalTimestamp:c.event.timestamp.toISOString()}});b.push(a)}return b}clearHistory(){this.eventHistory=[],this.logger.info("Event history cleared")}getStats(){let a={};for(let[b,c]of this.stats.eventCounts)a[b]=c;let b={};for(let[a,c]of this.subscriptions)b[a]=c.size;return{totalEventsEmitted:this.stats.totalEventsEmitted,totalHandlersInvoked:this.stats.totalHandlersInvoked,totalErrors:this.stats.totalErrors,eventCounts:a,subscriptionCounts:b,historySize:this.eventHistory.length}}listenerCount(a){let b=this.subscriptions.get(a),c=this.subscriptions.get("*");return(b?.size??0)+(c?.size??0)}eventNames(){let a=[];for(let b of this.subscriptions.keys())"*"!==b&&a.push(b);return a}getSubscriptions(){let a=[];for(let b of this.subscriptions.values())for(let c of b.values())a.push(c);return a}generateSubscriptionId(){return`sub_${d().slice(0,8)}`}addToHistory(a,b,c){let e={id:a.eventId??d(),event:a,timestamp:new Date,processed:!0,handlersInvoked:b,errors:c?.length?c:void 0};this.eventHistory.push(e),this.eventHistory.length>this.historySize&&(this.eventHistory=this.eventHistory.slice(-this.historySize))}}function h(a){return g.getInstance(a)}async function i(a,b,c){return g.getInstance().emit(a,b,c)}},77030:a=>{a.exports=require("node:net")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},79646:a=>{a.exports=require("child_process")},81630:a=>{a.exports=require("http")},83367:a=>{a.exports=require("bullmq")},83997:a=>{a.exports=require("tty")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91645:a=>{a.exports=require("net")},94735:a=>{a.exports=require("events")},96330:a=>{a.exports=require("@prisma/client")},96456:a=>{a.exports=require("zlib")}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[8114,5449,8139,9229,5625,624,4437,5062,1057,9420,4418,3152,8864,5829,5233,2268,147,3803,9889,8676,7436,8911,59,7545,5266,776,4252,1386,2582,3724,9428,8281,5459,5527,2429,9378,9907,5429,8207,1360,5428,9444,2019,2242,3240,9670,3556,3041,3324,9585,5488,9824,7465,5952,989,12,1686,2727,2120,6186,2288,1916,120,7027,1840,3915,8554,5820,5585,1610,7844,2235,5275,5317,3444,3759,4264,5308,4328,9543,2022,9987,6436,8782,6904,7899,4928,6346,5639,3846,550,2495,3545,8417,4661,9869,4814,6191,4017,9651,9380,8186,6707,4973,1548,7705,2110,3681,87,8234,7804,6095,6180,3136,3082,94,797,2156,9047,9526,3550,5693,3878,3980,1960,8737,7956,8496,6531,5466,3272,303,5674,9511,6188,5066,6632,4094,2830,7264,7646,4319,2824,1133,8453,1355,725,2647,5770,2688,747,1317,8014,4523,8441,3250,7778,4530,8958,3495,2231,6538,2237,8731,3957,2709,4191,8597,2985,4932,2130,3989,9393,5389,5200,8880,2115,9616,2427,201,3710,9238,2481,8839,8850,1191,8851,8938,7522,2471,3394,2201,9225,4863,1446,4612,9703,1365,5975,6104,8068,4540,7973,4925,4852,9277,2018,9886,9548,1671,9619,7987,1088,9641,2415,7294,4509,8145,2284,7708,8825,6936,8966,750,3200,6230,6027,5979,5350,5756,1893,2436,6823,5870,5990,760,5866,8551,6661,5877,5783,8390,501,2174,1390,8350,6457,9142],()=>b(b.s=1064));module.exports=c})();