"use strict";(()=>{var a={};a.id=2598,a.ids=[2598],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},1708:a=>{a.exports=require("node:process")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:a=>{a.exports=require("node:buffer")},9162:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{DELETE:()=>E,GET:()=>C,PUT:()=>D});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(52963),w=c(61501),x=c(10674),y=c(45711),z=c(95758),A=c(96798);let B=y.Ik({title:y.Yj().min(1).optional(),description:y.Yj().optional(),startTime:y.Yj().datetime().optional(),endTime:y.Yj().datetime().optional(),location:y.Yj().optional(),attendees:y.YO(y.Yj().email()).optional(),status:y.k5(["SCHEDULED","CONFIRMED","CANCELLED","COMPLETED"]).optional(),metadata:y.g1(y.bz()).optional()});async function C(a,{params:b}){try{let a=await (0,v.getServerSession)(w.N);if(!a?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b,d=await x.Z8(c);if(!d)return u.NextResponse.json({error:"Event not found"},{status:404});return u.NextResponse.json({success:!0,data:d},{status:200})}catch(a){if(console.error("Error fetching event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});return u.NextResponse.json({error:"Failed to fetch event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function D(a,{params:b}){try{let c=await (0,v.getServerSession)(w.N);if(!c?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:d}=await b,e=await a.json(),f=B.safeParse(e);if(!f.success)return u.NextResponse.json({error:"Validation failed",details:f.error.flatten().fieldErrors},{status:400});let g=f.data,h=await x.Z8(d);if(!h)return u.NextResponse.json({error:"Event not found"},{status:404});if(g.startTime&&g.endTime){let a=new Date(g.startTime);if(new Date(g.endTime)<=a)return u.NextResponse.json({error:"End time must be after start time"},{status:400})}let i={title:g.title,description:g.description,startTime:g.startTime?new Date(g.startTime):void 0,endTime:g.endTime?new Date(g.endTime):void 0,location:g.location,participantEmails:g.attendees,status:g.status,syncToGoogle:!1},j=await x.qM(d,i);if(await (0,z.T$)("calendar:event_updated",{eventId:j.id,title:j.title,status:j.status,previousStatus:h.status,userId:j.userId,orgId:j.orgId,timestamp:new Date},{source:"system",orgId:j.orgId||void 0}),g.status&&["CONFIRMED","CANCELLED","COMPLETED"].includes(g.status)){let a=await A.z.task.findFirst({where:{OR:[{sourceId:d},{data:{path:["schedulingEventId"],equals:d}}]}});if(a){let b="CONFIRMED"===g.status?"IN_PROGRESS":"COMPLETED"===g.status?"DONE":"CANCELLED";await (0,z.T$)("task:status_changed",{taskId:a.id,previousStatus:a.status,newStatus:b,reason:`Calendar event ${g.status.toLowerCase()}`,timestamp:new Date},{source:"system",orgId:a.orgId})}}return u.NextResponse.json({success:!0,data:j,message:"Event updated successfully"},{status:200})}catch(a){if(console.error("Error updating event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});if(a instanceof Error&&a.message.includes("Unauthorized"))return u.NextResponse.json({error:"You don't have permission to update this event"},{status:403});if(a instanceof Error&&a.message.includes("conflict"))return u.NextResponse.json({error:"Scheduling conflict detected",details:a.message},{status:409});return u.NextResponse.json({error:"Failed to update event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function E(a,{params:b}){try{let a=await (0,v.getServerSession)(w.N);if(!a?.user?.id)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b;return await x.SX(c),u.NextResponse.json({success:!0,message:"Event deleted successfully"},{status:200})}catch(a){if(console.error("Error deleting event:",a),a instanceof Error&&a.message.includes("not found"))return u.NextResponse.json({error:"Event not found"},{status:404});if(a instanceof Error&&a.message.includes("Unauthorized"))return u.NextResponse.json({error:"You don't have permission to delete this event"},{status:403});return u.NextResponse.json({error:"Failed to delete event",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/calendar/events/[id]/route",pathname:"/api/calendar/events/[id]",filename:"route",bundlePath:"app/api/calendar/events/[id]/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/calendar/events/[id]/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/calendar/events/[id]/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{a.exports=require("querystring")},12412:a=>{a.exports=require("assert")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},19771:a=>{a.exports=require("process")},21820:a=>{a.exports=require("os")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},34631:a=>{a.exports=require("tls")},37067:a=>{a.exports=require("node:http")},37659:a=>{a.exports=require("ioredis")},37830:a=>{a.exports=require("node:stream/web")},38522:a=>{a.exports=require("node:zlib")},44708:a=>{a.exports=require("node:https")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},57075:a=>{a.exports=require("node:stream")},57975:a=>{a.exports=require("node:util")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{a.exports=require("node:fs")},73136:a=>{a.exports=require("node:url")},73496:a=>{a.exports=require("http2")},73566:a=>{a.exports=require("worker_threads")},74075:a=>{a.exports=require("zlib")},76760:a=>{a.exports=require("node:path")},77030:a=>{a.exports=require("node:net")},79428:a=>{a.exports=require("buffer")},79551:a=>{a.exports=require("url")},79646:a=>{a.exports=require("child_process")},81630:a=>{a.exports=require("http")},83367:a=>{a.exports=require("bullmq")},83997:a=>{a.exports=require("tty")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91645:a=>{a.exports=require("net")},94735:a=>{a.exports=require("events")},95758:(a,b,c)=>{function d(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}c.d(b,{Ju:()=>h,T$:()=>i,io:()=>g});let e="undefined"!=typeof process&&!1,f={debug:(a,b)=>{e&&console.debug(`[EventBus] ${a}`,b??"")},info:(a,b)=>{console.info(`[EventBus] ${a}`,b??"")},warn:(a,b)=>{console.warn(`[EventBus] ${a}`,b??"")},error:(a,b,c)=>{console.error(`[EventBus] ${a}`,b,c??"")}};class g{static{this.instance=null}constructor(a={}){this.subscriptions=new Map,this.eventHistory=[],this.historySize=a.historySize??100,this.logger=a.logger??f,this.debug=a.debug??!1,this.defaultOrgId=a.defaultOrgId,this.stats={totalEventsEmitted:0,totalHandlersInvoked:0,totalErrors:0,eventCounts:new Map},this.logger.info("EventBus initialized",{historySize:this.historySize})}static getInstance(a){return g.instance||(g.instance=new g(a)),g.instance}static resetInstance(){g.instance&&(g.instance.removeAllListeners(),g.instance=null)}on(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!1}),this.debug&&this.logger.debug(`Handler registered for event "${a}"`,{subscriptionId:c}),c}once(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!0}),this.debug&&this.logger.debug(`Once handler registered for event "${a}"`,{subscriptionId:c}),c}onAny(a){let b=this.generateSubscriptionId();return this.subscriptions.has("*")||this.subscriptions.set("*",new Map),this.subscriptions.get("*").set(b,{eventType:"*",handler:a,subscriptionId:b,once:!1}),this.debug&&this.logger.debug("Wildcard handler registered",{subscriptionId:b}),b}off(a){for(let[,b]of this.subscriptions)if(b.has(a))return b.delete(a),this.debug&&this.logger.debug("Handler removed",{subscriptionId:a}),!0;return!1}removeAllListeners(a){a?(this.subscriptions.delete(a),this.logger.info(`All handlers removed for event "${a}"`)):(this.subscriptions.clear(),this.logger.info("All handlers removed"))}async emit(a,b,c){let e=d(),f=new Date,g=[],h=[],i={type:a,payload:b,timestamp:f,source:c?.source??"system",eventId:e,correlationId:c?.correlationId,orgId:c?.orgId??this.defaultOrgId,metadata:c?.metadata};this.stats.totalEventsEmitted++,this.stats.eventCounts.set(a,(this.stats.eventCounts.get(a)??0)+1),this.debug&&this.logger.debug(`Emitting event "${a}"`,{eventId:e,source:i.source});let j=[],k=this.subscriptions.get(a);if(k)for(let a of k.values())j.push(a);let l=this.subscriptions.get("*");if(l)for(let a of l.values())j.push(a);let m=[],n=j.map(async b=>{let c=Date.now();try{return await b.handler(i),this.stats.totalHandlersInvoked++,b.once&&m.push(b.subscriptionId),{subscriptionId:b.subscriptionId,success:!0,executionTimeMs:Date.now()-c}}catch(f){let d=f instanceof Error?f:Error(String(f));return this.stats.totalErrors++,this.logger.error(`Handler ${b.subscriptionId} failed for event "${a}"`,d,{eventId:e,subscriptionId:b.subscriptionId}),{subscriptionId:b.subscriptionId,success:!1,error:d,executionTimeMs:Date.now()-c}}}),o=await Promise.all(n);for(let a of m)this.off(a);for(let a of o)g.push(a),a.error&&h.push(a.error);return this.addToHistory(i,g.length,h.map(a=>a.message)),this.debug&&this.logger.debug(`Event "${a}" processing complete`,{eventId:e,handlersInvoked:g.length,successCount:g.filter(a=>a.success).length,errorCount:h.length}),{eventType:a,eventId:e,timestamp:f,handlersInvoked:g.length,results:g,errors:h}}emitSync(a,b,c){this.emit(a,b,c).catch(b=>{this.logger.error(`Sync emit failed for event "${a}"`,b)})}getHistory(a,b){let c=[...this.eventHistory];if(a){let b=Array.isArray(a)?a:[a];c=c.filter(a=>b.includes(a.event.type))}return b&&b>0&&(c=c.slice(-b)),c}async replay(a){this.logger.info(`Replaying ${a.length} events`);let b=[];for(let c of a){let a=await this.emit(c.event.type,c.event.payload,{source:c.event.source,correlationId:c.event.correlationId,orgId:c.event.orgId,metadata:{...c.event.metadata,replayed:!0,originalEventId:c.event.eventId,originalTimestamp:c.event.timestamp.toISOString()}});b.push(a)}return b}clearHistory(){this.eventHistory=[],this.logger.info("Event history cleared")}getStats(){let a={};for(let[b,c]of this.stats.eventCounts)a[b]=c;let b={};for(let[a,c]of this.subscriptions)b[a]=c.size;return{totalEventsEmitted:this.stats.totalEventsEmitted,totalHandlersInvoked:this.stats.totalHandlersInvoked,totalErrors:this.stats.totalErrors,eventCounts:a,subscriptionCounts:b,historySize:this.eventHistory.length}}listenerCount(a){let b=this.subscriptions.get(a),c=this.subscriptions.get("*");return(b?.size??0)+(c?.size??0)}eventNames(){let a=[];for(let b of this.subscriptions.keys())"*"!==b&&a.push(b);return a}getSubscriptions(){let a=[];for(let b of this.subscriptions.values())for(let c of b.values())a.push(c);return a}generateSubscriptionId(){return`sub_${d().slice(0,8)}`}addToHistory(a,b,c){let e={id:a.eventId??d(),event:a,timestamp:new Date,processed:!0,handlersInvoked:b,errors:c?.length?c:void 0};this.eventHistory.push(e),this.eventHistory.length>this.historySize&&(this.eventHistory=this.eventHistory.slice(-this.historySize))}}function h(a){return g.getInstance(a)}async function i(a,b,c){return g.getInstance().emit(a,b,c)}},96330:a=>{a.exports=require("@prisma/client")}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[40,8208,7519,5711,1692,7028,8741,5237,3088,6802,1774,5504,8563,8143,1421,4067,3249,5058,8647,1710,9241,8698,8185,4343,2759,9784,5841,494,4433,6123,8166,5883,3770,2278,9357,6760,7348,2810,9873,6318,8835,5529,2818,1886,67,617,1586,5458,9923,2233,8179,5036,3561,8738,8419,754,440,8864,4756,6419,5317,2981,7970,4559,2322,7336,2446,9533,9936,5929,1150,3304,4443,1676,2862,8816,8035,4705,1138,7096,2112,7613,3189,1107,5107,8847,7003,7570,141,3629,6365,1904,2007,2343,1752,174,6154,9109,3752,2417,2763,9426,2321,30,7608,1120,235,8475,4118,2945,8121,6735,8769,7371,1792,1941,7368,2784,9504,4685,1806,5991,2514,9697,8875,3513,303,3508,8032,2828,5438,319,3438,2834,8691,5794,3869,8443,5636,3734,1047,178,2580,9634,9488,4011,3291,4614,4692,3873,461,5340,1472,2019,2289,2287,133,9933,8119,9438,2968,8189,3638,543,7652,8562,9469,3467,1351,6992,7821,296,6603,8063,2225,2953,6956,4874,7596,7831,8800,6,3013,5537,1787,5586,7026,6736,3179,1814,6185,1833,4314,8947,1773,8321,7578,6719,5956,693,7069,2341,3673,5236,5320,3941,3511,6280,8438,3856,7825,9988,1674,1969,6112,9145,2424,9251,1842,329,1200,7966,9325,6512,3586,3623,8474,7390,1046,8729,3772,525,788,3613,7401,1018,7859,779,3311,7609,529,6934],()=>b(b.s=9162));module.exports=c})();