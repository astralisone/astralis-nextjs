"use strict";(()=>{var a={};a.id=3103,a.ids=[3103],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8861:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(15798),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/booking/route",pathname:"/api/booking",filename:"route",bundlePath:"app/api/booking/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/booking/route.ts",nextConfigOutput:"standalone",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/booking/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14985:a=>{a.exports=require("dns")},15798:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{POST:()=>n});var e=c(10641),f=c(45711),g=c(65724),h=c(82716),i=c(96798),j=c(23566),k=c(67658),l=c(26253),m=a([k]);k=(m.then?(await m)():m)[0];let o=f.Ik({name:f.Yj().min(2,"Name must be at least 2 characters"),email:f.Yj().email("Invalid email address"),phone:f.Yj().min(10,"Phone number must be at least 10 characters"),company:f.Yj().optional(),date:f.Yj().min(1,"Date is required"),time:f.Yj().min(1,"Time is required"),meetingType:f.k5(["VIDEO_CALL","PHONE_CALL","IN_PERSON"]),message:f.Yj().optional()});async function n(a){try{let b=await a.json(),d=o.safeParse(b);if(!d.success)return e.NextResponse.json({error:"Invalid booking data",details:d.error.flatten().fieldErrors},{status:400});let{name:f,email:m,phone:n,company:p,date:q,time:r,meetingType:s,message:t}=d.data,{startTime:u,endTime:v}=function(a,b){let[c,d,e]=a.split("-").map(Number),{hours:f,minutes:g}=function(a){let b=a.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);if(!b)throw Error(`Invalid time format: ${a}`);let c=parseInt(b[1],10),d=parseInt(b[2],10),e=b[3].toUpperCase();return"PM"===e&&12!==c?c+=12:"AM"===e&&12===c&&(c=0),{hours:c,minutes:d}}(b),h=new Date(c,d-1,e,f,g,0,0),i=new Date(h);return i.setHours(i.getHours()+1),{startTime:h,endTime:i}}(q,r),w=process.env.DEFAULT_USER_ID,x=null;if(w){let a=await i.z.users.findUnique({where:{id:w},select:{id:!0,name:!0,email:!0,isActive:!0}});if(!a)return console.error(`[Booking] Default user not found: ${w}`),e.NextResponse.json({error:"Booking system configuration error",details:"Default host user not found"},{status:500});if(!a.isActive)return console.error(`[Booking] Default user is inactive: ${w}`),e.NextResponse.json({error:"Booking system unavailable",details:"The booking host is not accepting bookings"},{status:503});let b=await (0,j.Ri)(w,u,v);if(b.hasConflict){let a=b.conflicts.map(a=>({eventId:a.eventId,eventTitle:a.eventTitle,startTime:a.startTime.toISOString(),endTime:a.endTime.toISOString(),conflictType:a.conflictType})),c=b.availabilityIssues.map(a=>({message:a.message,affectedTime:a.affectedTime}));return console.log(`[Booking] Conflict detected for ${q} at ${r}:`,{severity:b.severity,conflicts:a,availabilityIssues:c}),e.NextResponse.json({error:"Scheduling conflict detected",severity:b.severity,conflicts:a,availabilityIssues:c,message:"high"===b.severity?"The requested time slot is not available. Please choose a different time.":"There are potential conflicts with this time slot. Please choose a different time."},{status:409})}try{let a=await i.z.schedulingEvent.create({data:{userId:w,title:`Consultation: ${f}${p?` (${p})`:""}`,description:t||`${s} consultation requested`,startTime:u,endTime:v,timezone:"America/New_York",participantEmails:[m],status:"SCHEDULED",aiSuggestionMeta:{guestName:f,guestEmail:m,guestPhone:n,company:p||null,meetingType:s,bookedAt:new Date().toISOString(),source:"booking_modal"}}});x=a.id,console.log(`[Booking] SchedulingEvent created: ${a.id}`);let b=new Date,c=[],d=new Date(u);d.setHours(d.getHours()-24);let e=new Date(u);if(e.setHours(e.getHours()-1),d>b&&c.push(i.z.eventReminder.create({data:{eventId:a.id,reminderTime:d,status:"PENDING"}})),e>b&&c.push(i.z.eventReminder.create({data:{eventId:a.id,reminderTime:e,status:"PENDING"}})),c.length>0){let b=await Promise.all(c);for(let d of(console.log(`[Booking] Created ${c.length} reminders for event ${a.id}`),b))try{await (0,l.vh)({reminderId:d.id,eventId:d.eventId})}catch(a){console.error(`[Booking] Failed to queue reminder ${d.id}:`,a)}}}catch(a){console.error("[Booking] Failed to create SchedulingEvent:",a)}}else console.warn("[Booking] DEFAULT_USER_ID not configured, skipping conflict detection and event creation");let y=`BK-${Date.now()}-${Math.random().toString(36).substring(2,7).toUpperCase()}`,z={bookingId:y,name:f,email:m,phone:n,company:p,date:q,time:r,meetingType:s,message:t};console.log("New booking received:",{...z,schedulingEventId:x,timestamp:new Date().toISOString()});let A=await (0,g.n)({name:f,email:m,company:p,date:q,time:r,meetingType:s,message:t}),B=!1;try{console.log(`[Booking] Sending confirmation email to customer: ${m}`),await (0,h.ZM)({to:m,subject:`Consultation Confirmed - ${q} at ${r}`,html:(0,h.du)(z),text:(0,h.KG)(z),attachments:[{filename:"consultation.ics",content:A,contentType:"text/calendar"}]}),B=!0,console.log(`[Booking] âœ… Customer confirmation email sent successfully to ${m}`)}catch(a){console.error("[Booking] âŒ FAILED to send customer confirmation email:",a),console.error("[Booking] Error details:",a instanceof Error?a.stack:String(a))}let C=process.env.SYSTEM_NOTIFICATION_EMAIL||"gregory.a.starr@gmail.com",D=!1;try{console.log(`[Booking] Sending internal notification email to: ${C}`),await (0,h.ZM)({to:C,subject:`ðŸ”” New Booking: ${f} - ${q} at ${r}`,html:(0,h.mk)(z),attachments:[{filename:"consultation.ics",content:A,contentType:"text/calendar"}]}),D=!0,console.log(`[Booking] âœ… Internal notification email sent successfully to ${C}`)}catch(a){console.error("[Booking] âŒ FAILED to send internal notification email:",a),console.error("[Booking] Error details:",a instanceof Error?a.stack:String(a))}let E=process.env.DEFAULT_ORG_ID,F=null;if(E)try{if(await i.z.organization.findUnique({where:{id:E}})){let a=await i.z.intakeRequest.create({data:{source:"FORM",status:"NEW",title:`Consultation Request: ${f}`,description:t||`${s} consultation requested for ${q} at ${r}`,requestData:{bookingId:y,name:f,email:m,phone:n,company:p||null,date:q,time:r,meetingType:s,message:t||null,formType:"booking",submittedAt:new Date().toISOString()},priority:2,orgId:E}});F=a.id,console.log(`[Booking] Intake request created: ${a.id} for booking ${y}`);try{let b=(0,k.BN)(a.orgId);b.isActive()||b.start(),console.log(`[Booking] Agent verified active for org ${a.orgId}`)}catch(b){if(console.log("Agent not available for booking, attempting to initialize system..."),!globalThis.agentSystemInitialized)try{let{initializeAgentSystem:b}=await Promise.resolve().then(c.bind(c,67658)),d=!!process.env.ANTHROPIC_API_KEY,e=!!process.env.OPENAI_API_KEY;if(d||e){await b({enableWebhooks:!0,enableEmail:!0,enableDBTriggers:!0,enableWorkerEvents:!0}),globalThis.agentSystemInitialized=!0,console.log("âœ… Agent system initialized during booking processing");let c=(0,k.BN)(a.orgId);c.isActive()||c.start(),console.log(`[Booking] Agent started for org ${a.orgId} after initialization`)}}catch(a){console.log("Agent system initialization failed:",a instanceof Error?a.message:String(a))}}let b=(0,k.Ju)();await b.emit("intake:created",{id:a.id,source:"api",timestamp:new Date,payload:{intakeId:a.id,type:"booking_request",data:{title:a.title,description:a.description,source:a.source,status:a.status,priority:a.priority,requestData:a.requestData},contactInfo:{email:a.requestData?.email,name:a.requestData?.name,phone:a.requestData?.phone}}})}else console.error(`[Booking] Organization not found: ${E}`)}catch(a){console.error("[Booking] Failed to create intake request:",a)}else console.warn("[Booking] DEFAULT_ORG_ID not configured, skipping intake request creation");return console.log("[Booking] ========== BOOKING COMPLETE =========="),console.log(`[Booking] Booking ID: ${y}`),console.log(`[Booking] Scheduling Event ID: ${x||"N/A"}`),console.log(`[Booking] Intake Request ID: ${F||"N/A"}`),console.log(`[Booking] Customer Email Sent: ${B?"âœ… YES":"âŒ NO"}`),console.log(`[Booking] Internal Email Sent: ${D?"âœ… YES":"âŒ NO"}`),console.log("[Booking] =========================================="),e.NextResponse.json({success:!0,bookingId:y,schedulingEventId:x,intakeRequestId:F,emailStatus:{customerEmail:B,internalEmail:D},message:"Booking confirmed! Check your email for details and calendar invite."},{status:200})}catch(a){return console.error("Error processing booking:",a),e.NextResponse.json({error:"Failed to process booking. Please try again.",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}d()}catch(a){d(a)}})},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:a=>{a.exports=require("os")},23566:(a,b,c)=>{c.d(b,{Ri:()=>g,o6:()=>h});var d=c(96798),e=c(96330);let f=[e.DayOfWeek.SUNDAY,e.DayOfWeek.MONDAY,e.DayOfWeek.TUESDAY,e.DayOfWeek.WEDNESDAY,e.DayOfWeek.THURSDAY,e.DayOfWeek.FRIDAY,e.DayOfWeek.SATURDAY];async function g(a,b,c,e){let g=[],j=[];try{for(let d of(await h(a,b,c))){let a=i({startTime:b,endTime:c},d),e="partial_overlap";d.startTime<=b&&d.endTime>=c?e="full_overlap":(d.endTime.getTime()===b.getTime()||d.startTime.getTime()===c.getTime())&&(e="back_to_back"),g.push({eventId:d.id,eventTitle:d.title,startTime:d.startTime,endTime:d.endTime,conflictScore:a,conflictType:e})}let k=f[b.getDay()],l=`${b.getHours().toString().padStart(2,"0")}:${b.getMinutes().toString().padStart(2,"0")}`,m=`${c.getHours().toString().padStart(2,"0")}:${c.getMinutes().toString().padStart(2,"0")}`,n=await d.z.availabilityRule.findMany({where:{userId:a,dayOfWeek:k}}),o=!1;for(let a of n)if(a.isActive){if(l>=a.startTime&&m<=a.endTime){o=!0;break}}else(l>=a.startTime&&l<a.endTime||m>a.startTime&&m<=a.endTime||l<=a.startTime&&m>=a.endTime)&&j.push({dayOfWeek:k,message:`Time conflicts with unavailable period ${a.startTime}-${a.endTime}`,affectedTime:`${a.startTime}-${a.endTime}`});if(n.some(a=>a.isActive)&&!o&&j.push({dayOfWeek:k,message:"Time is outside of available hours",affectedTime:`${l}-${m}`}),e&&e.length>0)for(let a of(await d.z.users.findMany({where:{email:{in:e}},select:{id:!0,email:!0,name:!0}})))for(let d of(await h(a.id,b,c)))g.push({eventId:d.id,eventTitle:`${a.name||a.email}: ${d.title}`,startTime:d.startTime,endTime:d.endTime,conflictScore:i({startTime:b,endTime:c},d),conflictType:"partial_overlap"});let p="none";if(g.length>0||j.length>0){let a=Math.max(...g.map(a=>a.conflictScore),0);p=a>=80||j.length>0?"high":a>=50?"medium":"low"}let q=g.length>0||j.length>0;return console.log(`Conflict check for user ${a}: ${q?"conflicts found":"no conflicts"} (severity: ${p})`),{hasConflict:q,conflicts:g,availabilityIssues:j,severity:p}}catch(a){throw console.error("Error detecting conflicts:",a),Error(`Failed to detect conflicts: ${a.message}`)}}async function h(a,b,c){try{return await d.z.schedulingEvent.findMany({where:{userId:a,status:{in:["SCHEDULED","CONFIRMED"]},AND:[{startTime:{lt:c}},{endTime:{gt:b}}]},orderBy:{startTime:"asc"}})}catch(a){throw console.error("Error getting conflicting events:",a),Error(`Failed to get conflicting events: ${a.message}`)}}function i(a,b){let c=new Date(a.startTime).getTime(),d=new Date(a.endTime).getTime(),e=new Date(b.startTime).getTime(),f=new Date(b.endTime).getTime(),g=Math.max(c,e),h=Math.min(d,f);if(g>=h)return 10*(d===e||f===c);if(e<=c&&f>=d||c<=e&&d>=f)return 100;let i=(h-g)/Math.min(d-c,f-e)*100;return i>=75?Math.min(80+(i-75)*.8,99):i>=50?50+(i-50)*1.2:i>=25?25+(i-25):Math.max(1,i)}},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{a.exports=require("path")},34631:a=>{a.exports=require("tls")},37659:a=>{a.exports=require("ioredis")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50832:a=>{a.exports=import("@anthropic-ai/sdk")},55511:a=>{a.exports=require("crypto")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},65724:(a,b,c)=>{c.d(b,{n:()=>f});var d=c(99905);async function e(a){var b;let c={start:[(b=a.startDate).getFullYear(),b.getMonth()+1,b.getDate(),b.getHours(),b.getMinutes()],duration:{minutes:a.duration},title:a.title,description:a.description,location:a.location,status:"CONFIRMED",busyStatus:"BUSY",organizer:{name:a.organizerName,email:a.organizerEmail},attendees:[{name:a.attendeeName,email:a.attendeeEmail,rsvp:!0,partstat:"NEEDS-ACTION",role:"REQ-PARTICIPANT"}],method:"REQUEST"};return new Promise((a,b)=>{(0,d.lh)(c,(c,d)=>{c?b(c):a(d)})})}async function f(a){let b=function(a,b){let c=new Date(a),{hours:d,minutes:e}=function(a){let[b,c]=a.split(" "),[d,e]=b.split(":").map(Number),f=d;return"PM"===c&&12!==d?f=d+12:"AM"===c&&12===d&&(f=0),{hours:f,minutes:e}}(b);return c.setHours(d,e,0,0),c}(a.date,a.time),c="";"VIDEO_CALL"===a.meetingType?c="Video Call (link will be sent separately)":"PHONE_CALL"===a.meetingType?c="Phone Call":"IN_PERSON"===a.meetingType&&(c="To be determined");let d=`Consultation call with ${a.name}`;return a.company&&(d+=` from ${a.company}`),a.message&&(d+=`

Discussion topics:
${a.message}`),d+=`

Contact: ${a.email}`,e({title:`Consultation: ${a.name}${a.company?` (${a.company})`:""}`,description:d,location:c,startDate:b,duration:30,attendeeEmail:a.email,attendeeName:a.name,organizerEmail:"support@astralisone.com",organizerName:"Astralis"})}},74075:a=>{a.exports=require("zlib")},79551:a=>{a.exports=require("url")},79646:a=>{a.exports=require("child_process")},81630:a=>{a.exports=require("http")},83367:a=>{a.exports=require("bullmq")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87984:a=>{a.exports=import("openai")},91645:a=>{a.exports=require("net")},94735:a=>{a.exports=require("events")},96330:a=>{a.exports=require("@prisma/client")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[40,8208,7519,5711,1692,4686,3887,5112,5355,7350,9905,4412,2932,2100,1102,6842,2716,7658],()=>b(b.s=8861));module.exports=c})();