(()=>{var a={};a.id=6408,a.ids=[6408],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6829:(a,b,c)=>{"use strict";c.d(b,{Sd:()=>e,X5:()=>f});var d=c(75625);let e=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number"),name:d.Yj().min(2,"Name must be at least 2 characters").max(100),orgName:d.Yj().min(2,"Organization name required").max(100)}),f=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(1,"Password is required")});d.Ik({email:d.Yj().email("Invalid email address")}),d.Ik({token:d.Yj().min(1,"Token is required"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number")})},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},12412:a=>{"use strict";a.exports=require("assert")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},20229:(a,b,c)=>{"use strict";c.d(b,{N:()=>k,j:()=>l});var d=c(89966),e=c(26413),f=c(4696),g=c(13028),h=c(99750),i=c(65585),j=c(6829);let k={adapter:(0,g.y)(h.z),providers:[(0,e.A)({id:"credentials",name:"Email & Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){let b=j.X5.safeParse(a);if(!b.success)return null;let{email:c,password:d}=b.data,e=await h.z.users.findUnique({where:{email:c},include:{organization:!0}});return e&&e.password&&await (0,i.BE)(d,e.password)?{id:e.id,email:e.email,name:e.name,role:e.role,orgId:e.orgId||"",image:e.avatar}:null}}),(0,f.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async jwt({token:a,user:b,account:c,trigger:d,session:e}){if(b&&(a.id=b.id,a.role=b.role,a.orgId=b.orgId,a.picture=b.image),"update"===d&&e&&(void 0!==e.image&&(a.picture=e.image),void 0!==e.name&&(a.name=e.name)),c?.provider==="google"&&b){let c=await h.z.users.findUnique({where:{id:b.id},include:{organization:!0}});c&&(a.orgId=c.orgId||"",a.role=c.role,a.picture=c.avatar)}return a},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.orgId=b.orgId,a.user.image=b.picture),a),async signIn({user:a,account:b,profile:c}){if(b?.provider==="email")return!0;if(b?.provider==="google"){let b=await h.z.users.findUnique({where:{email:a.email},include:{organization:!0}});if(!b?.organization){let c=await h.z.organization.create({data:{name:`${a.name}'s Organization`,users:{connect:{id:b.id}}}});await h.z.users.update({where:{id:b.id},data:{orgId:c.id,role:"ADMIN"}})}}return!0}},pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error",verifyRequest:"/auth/verify-email"},events:{async signIn({user:a}){}}},l=()=>(0,d.getServerSession)(k)},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},37659:a=>{"use strict";a.exports=require("ioredis")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},53367:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>Q,patchFetch:()=>P,routeModule:()=>L,serverHooks:()=>O,workAsyncStorage:()=>M,workUnitAsyncStorage:()=>N});var d={};c.r(d),c.d(d,{GET:()=>K,POST:()=>J});var e=c(27192),f=c(91165),g=c(20972),h=c(97182),i=c(9060),j=c(261),k=c(40306),l=c(43568),m=c(43376),n=c(81827),o=c(7293),p=c(45135),q=c(23857),r=c(99510),s=c(86439),t=c(27196),u=c(90449),v=c(75625),w=c(99750),x=c(20229),y=c(96330),z=c(83367),A=c(82923);let B=new z.Queue("scheduling-agent",{connection:A.K,defaultJobOptions:{attempts:3,backoff:{type:"exponential",delay:2e3},removeOnComplete:{age:86400},removeOnFail:{age:604800}}});async function C(a,b){let c=await B.add("process-inbox",{type:"process-inbox",data:a},{jobId:`process-inbox-${a.taskId}`,priority:a.priority||3,...b});return console.log(`[SchedulingAgentQueue] Queued process-inbox job: ${a.taskId}`),c.id||""}async function D(a){return C({...a,priority:1},{priority:1})}let E=new Map;function F(a){let b=Date.now(),c=`rate:${a}`,d=E.get(c);return!d||b>d.resetTime?(E.set(c,{count:1,resetTime:b+6e4}),{allowed:!0,remaining:59,reset:Math.ceil((b+6e4)/1e3),limit:60}):d.count>=60?{allowed:!1,remaining:0,reset:Math.ceil(d.resetTime/1e3),limit:60}:(d.count++,{allowed:!0,remaining:60-d.count,reset:Math.ceil(d.resetTime/1e3),limit:60})}function G(a,b){return a.headers.set("X-RateLimit-Limit",b.limit.toString()),a.headers.set("X-RateLimit-Remaining",b.remaining.toString()),a.headers.set("X-RateLimit-Reset",b.reset.toString()),a}let H=v.Ik({source:v.k5(["FORM","EMAIL","SMS","API","CHAT","VOICE"]),sourceId:v.Yj().optional(),content:v.Yj().min(1,"Content is required"),userId:v.Yj().optional(),orgId:v.Yj().optional(),metadata:v.g1(v.L5()).optional()}),I=v.Ik({userId:v.Yj().optional(),orgId:v.Yj().optional(),status:v.k5(["PENDING","PROCESSING","AWAITING_INPUT","SCHEDULED","COMPLETED","FAILED","CANCELLED"]).optional(),taskType:v.k5(["SCHEDULE_MEETING","RESCHEDULE_MEETING","CANCEL_MEETING","CHECK_AVAILABILITY","CREATE_TASK","UPDATE_TASK","INQUIRY","REMINDER","UNKNOWN"]).optional(),source:v.k5(["FORM","EMAIL","SMS","API","CHAT","VOICE"]).optional(),priority:v.au.number().int().min(1).max(5).optional(),limit:v.au.number().int().min(1).max(100).optional().default(20),offset:v.au.number().int().min(0).optional().default(0)});async function J(a){try{let b=await (0,x.j)(),c=await a.json(),d=H.safeParse(c);if(!d.success)return u.NextResponse.json({success:!1,error:"Validation failed",details:d.error.flatten().fieldErrors},{status:400});let{source:e,sourceId:f,content:g,metadata:h}=d.data,i=d.data.userId;if(!i&&b?.user?.id&&(i=b.user.id),!i)return u.NextResponse.json({success:!1,error:"Unauthorized",details:"User ID is required. Provide userId in body or authenticate."},{status:401});let j=F(i);if(!j.allowed){let a=u.NextResponse.json({success:!1,error:"Rate limit exceeded",details:`Too many requests. Try again after ${new Date(1e3*j.reset).toISOString()}`},{status:429});return G(a,j)}let k=await w.z.users.findUnique({where:{id:i},select:{id:!0,orgId:!0}});if(!k){let a=u.NextResponse.json({success:!1,error:"User not found",details:"The specified user does not exist."},{status:404});return G(a,j)}let l=d.data.orgId||k.orgId||void 0;if(l&&!await w.z.organization.findUnique({where:{id:l},select:{id:!0}})){let a=u.NextResponse.json({success:!1,error:"Organization not found",details:"The specified organization does not exist."},{status:404});return G(a,j)}let m=function(a){let b=a.toLowerCase();return["urgent","asap","emergency","immediately","critical","crisis"].some(a=>b.includes(a))?5:["important","priority","deadline","today","client","customer"].some(a=>b.includes(a))?4:["meeting","schedule","appointment","call","follow up"].some(a=>b.includes(a))?3:["when convenient","no rush","whenever","sometime","general"].some(a=>b.includes(a))?2:3}(g),n=await w.z.schedulingAgentTask.create({data:{userId:i,orgId:l,source:e,sourceId:f,rawContent:g,taskType:y.AgentTaskType.UNKNOWN,priority:m,status:y.AgentTaskStatus.PENDING,aiMetadata:h?{sourceMetadata:h,createdAt:new Date().toISOString()}:{createdAt:new Date().toISOString()}}}),o=null;try{let a={taskId:n.id,userId:i,orgId:l||void 0,priority:m};o=m>=4?await D(a):await C(a),console.log(`[Agent Inbox] Task created and queued: ${n.id} (priority: ${m}, source: ${e})`)}catch(a){console.error(`[Agent Inbox] Failed to queue task ${n.id}:`,a)}let p=u.NextResponse.json({success:!0,task:{id:n.id,status:n.status,source:n.source,sourceId:n.sourceId,taskType:n.taskType,priority:n.priority,createdAt:n.createdAt.toISOString(),...o&&{jobId:o}}},{status:201});return G(p,j)}catch(a){return console.error("[Agent Inbox] Error creating task:",a),u.NextResponse.json({success:!1,error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function K(a){try{let b=await (0,x.j)();if(!b?.user?.id)return u.NextResponse.json({success:!1,error:"Unauthorized",details:"Authentication required to list tasks."},{status:401});let c=F(b.user.id);if(!c.allowed){let a=u.NextResponse.json({success:!1,error:"Rate limit exceeded",details:`Too many requests. Try again after ${new Date(1e3*c.reset).toISOString()}`},{status:429});return G(a,c)}let{searchParams:d}=a.nextUrl,e={userId:d.get("userId")||void 0,orgId:d.get("orgId")||void 0,status:d.get("status")||void 0,taskType:d.get("taskType")||void 0,source:d.get("source")||void 0,priority:d.get("priority")||void 0,limit:d.get("limit")||"20",offset:d.get("offset")||"0"},f=I.safeParse(e);if(!f.success){let a=u.NextResponse.json({success:!1,error:"Invalid query parameters",details:f.error.flatten().fieldErrors},{status:400});return G(a,c)}let{userId:g,orgId:h,status:i,taskType:j,source:k,priority:l,limit:m,offset:n}=f.data,o={};g?o.userId=g:h?o.orgId=h:o.userId=b.user.id,i&&(o.status=i),j&&(o.taskType=j),k&&(o.source=k),void 0!==l&&(o.priority=l);let[p,q]=await Promise.all([w.z.schedulingAgentTask.findMany({where:o,select:{id:!0,userId:!0,orgId:!0,source:!0,sourceId:!0,rawContent:!0,taskType:!0,intent:!0,entities:!0,priority:!0,confidence:!0,title:!0,description:!0,dueDate:!0,assignedTo:!0,schedulingEventId:!0,proposedSlots:!0,selectedSlot:!0,status:!0,resolution:!0,errorMessage:!0,processingTime:!0,retryCount:!0,createdAt:!0,updatedAt:!0,processedAt:!0,completedAt:!0,user:{select:{id:!0,name:!0,email:!0}},organization:{select:{id:!0,name:!0}},schedulingEvent:{select:{id:!0,title:!0,startTime:!0,endTime:!0,status:!0}}},orderBy:[{priority:"desc"},{createdAt:"desc"}],take:m,skip:n}),w.z.schedulingAgentTask.count({where:o})]),r=u.NextResponse.json({success:!0,tasks:p,pagination:{total:q,limit:m,offset:n,hasMore:n+m<q}},{status:200});return G(r,c)}catch(a){return console.error("[Agent Inbox] Error listing tasks:",a),u.NextResponse.json({success:!1,error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}let L=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/agent/inbox/route",pathname:"/api/agent/inbox",filename:"route",bundlePath:"app/api/agent/inbox/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/agent/inbox/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:M,workUnitAsyncStorage:N,serverHooks:O}=L;function P(){return(0,g.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:N})}async function Q(a,b,c){var d;let e="/api/agent/inbox/route";"/index"===e&&(e="/");let g=await L.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||L.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===L.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>L.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>L.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await L.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await L.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await L.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},56931:()=>{},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},65585:(a,b,c)=>{"use strict";c.d(b,{BE:()=>i,Er:()=>h,HU:()=>j,Yc:()=>m,w:()=>l});var d=c(84437),e=c(55511),f=c.n(e);let g="aes-256-gcm";async function h(a){if(!a||"string"!=typeof a)throw TypeError("hashPassword: password must be a non-empty string");return d.tW(a,12)}async function i(a,b){return d.UD(a,b)}function j(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}function k(){let a=process.env.N8N_ENCRYPTION_KEY||process.env.NEXTAUTH_SECRET;if(!a)throw Error("Encryption key not found in environment variables");return f().pbkdf2Sync(a,"astralis-salt",1e5,32,"sha256")}function l(a){try{let b=f().randomBytes(16),c=f().randomBytes(64),d=k(),e=f().createCipheriv(g,d,b),h=e.update(a,"utf8","hex");h+=e.final("hex");let i=e.getAuthTag();return c.toString("hex")+":"+b.toString("hex")+":"+i.toString("hex")+":"+h}catch(a){throw console.error("Encryption error:",a),Error("Failed to encrypt data")}}function m(a){try{let b=a.split(":");if(4!==b.length)throw Error("Invalid encrypted data format");Buffer.from(b[0],"hex");let c=Buffer.from(b[1],"hex"),d=Buffer.from(b[2],"hex"),e=b[3],h=k(),i=f().createDecipheriv(g,h,c);i.setAuthTag(d);let j=i.update(e,"hex","utf8");return j+=i.final("utf8")}catch(a){throw console.error("Decryption error:",a),Error("Failed to decrypt data")}}},71003:()=>{},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},82923:(a,b,c)=>{"use strict";c.d(b,{K:()=>d});let d=new(c(37659)).Redis(process.env.REDIS_URL||"redis://localhost:6379",{maxRetriesPerRequest:null,enableReadyCheck:!1,retryStrategy:a=>Math.min(50*a,2e3)});d.on("error",a=>{console.error("[Redis] Connection error:",a)}),d.on("connect",()=>{console.log("[Redis] Connected successfully")}),d.on("ready",()=>{console.log("[Redis] Ready to accept commands")}),d.on("close",()=>{console.log("[Redis] Connection closed")}),d.on("reconnecting",()=>{console.log("[Redis] Reconnecting...")})},83367:a=>{"use strict";a.exports=require("bullmq")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{"use strict";a.exports=require("events")},96330:a=>{"use strict";a.exports=require("@prisma/client")},96456:a=>{"use strict";a.exports=require("zlib")},99750:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[8114,5449,8139,9229,5625,624,4437,5062,1057,9420,4418,3152,8864,5829],()=>b(b.s=53367));module.exports=c})();