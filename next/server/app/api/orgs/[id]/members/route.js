(()=>{var a={};a.id=6595,a.ids=[6595],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14985:a=>{"use strict";a.exports=require("dns")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:a=>{"use strict";a.exports=require("os")},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{"use strict";a.exports=require("path")},34631:a=>{"use strict";a.exports=require("tls")},35163:(a,b,c)=>{"use strict";c.d(b,{fi:()=>h,lh:()=>j,uE:()=>g});var d=c(99750),e=c(96330),f=c(44388);async function g(a,b){return null!==await d.z.users.findFirst({where:{id:a,orgId:b,role:e.UserRole.ADMIN,isActive:!0},select:{id:!0}})}async function h(a,b){return null!==await d.z.users.findFirst({where:{id:a,orgId:b,isActive:!0},select:{id:!0}})}class i{async getOrgSettings(a){let b=await d.z.organization.findUnique({where:{id:a},include:{_count:{select:{users:!0}}}});return b?{id:b.id,name:b.name,slug:b.slug,website:b.website,createdAt:b.createdAt,updatedAt:b.updatedAt,memberCount:b._count.users}:null}async updateOrgSettings(a,b,c){if(!await g(b,a))throw Error("Only organization admins can update settings");let e=await d.z.organization.update({where:{id:a},data:{name:c.name,slug:c.slug,website:c.website},include:{_count:{select:{users:!0}}}});return await d.z.activityLog.create({data:{userId:b,orgId:a,action:"UPDATE",entity:"ORGANIZATION",entityId:a,metadata:{changes:JSON.parse(JSON.stringify(c))}}}),{id:e.id,name:e.name,slug:e.slug,website:e.website,createdAt:e.createdAt,updatedAt:e.updatedAt,memberCount:e._count.users}}async getOrgMembers(a){return await d.z.users.findMany({where:{orgId:a},select:{id:!0,email:!0,name:!0,role:!0,isActive:!0,createdAt:!0,lastLoginAt:!0},orderBy:[{role:"asc"},{createdAt:"asc"}]})}async inviteMember(a,b,c,h){if(!await g(b,a))throw Error("Only organization admins can invite members");let i=Object.values(e.UserRole);if(!i.includes(h))throw Error(`Invalid role: ${h}. Valid roles are: ${i.join(", ")}`);let j=await d.z.users.findUnique({where:{email:c}});if(j){if(j.orgId)throw Error("User is already a member of an organization");let e=await d.z.users.update({where:{id:j.id},data:{orgId:a,role:h}});return await d.z.activityLog.create({data:{userId:b,orgId:a,action:"ADD_MEMBER",entity:"USER",entityId:e.id,metadata:{email:c,role:h,addedBy:b}}}),{success:!0,message:"Existing user added to organization",userId:e.id}}let k=(0,f.g$)(),l=new Date(Date.now()+6048e5),m=await d.z.users.create({data:{email:c,password:`PENDING_INVITE:${k}:${l.getTime()}`,role:h,orgId:a,isActive:!1}});await d.z.activityLog.create({data:{userId:b,orgId:a,action:"INVITE_MEMBER",entity:"USER",entityId:m.id,metadata:{email:c,role:h,invitedBy:b}}});let[n,o]=await Promise.all([d.z.users.findUnique({where:{id:b},select:{name:!0,email:!0}}),d.z.organization.findUnique({where:{id:a},select:{name:!0}})]),p=n?.name||n?.email||"A team member",q=o?.name||"your organization",r=await (0,f.D3)({inviteeEmail:c,inviterName:p,organizationName:q,role:h,inviteToken:k});return r||console.error(`[OrgSettings] Failed to send invite email to ${c}, but invite was created`),{success:!0,message:r?"Invitation sent successfully. User will receive an email with instructions.":"Invitation created, but email could not be sent. User can still be activated manually.",userId:m.id}}async removeMember(a,b,c){if(!await g(b,a))throw Error("Only organization admins can remove members");if(b===c)throw Error("Cannot remove yourself from the organization");let f=await d.z.users.findFirst({where:{id:c,orgId:a}});if(!f)throw Error("Member not found in this organization");if(f.role===e.UserRole.ADMIN&&await d.z.users.count({where:{orgId:a,role:e.UserRole.ADMIN,isActive:!0}})<=1)throw Error("Cannot remove the last admin from the organization");return await d.z.users.update({where:{id:c},data:{orgId:null}}),await d.z.activityLog.create({data:{userId:b,orgId:a,action:"REMOVE_MEMBER",entity:"USER",entityId:c,metadata:{removedUserEmail:f.email,removedUserRole:f.role,removedBy:b}}}),{success:!0,message:"Member removed from organization"}}async updateMemberRole(a,b,c,f){if(!await g(b,a))throw Error("Only organization admins can update member roles");let h=Object.values(e.UserRole);if(!h.includes(f))throw Error(`Invalid role: ${f}. Valid roles are: ${h.join(", ")}`);let i=await d.z.users.findFirst({where:{id:c,orgId:a}});if(!i)throw Error("Member not found in this organization");if(i.role===e.UserRole.ADMIN&&f!==e.UserRole.ADMIN&&await d.z.users.count({where:{orgId:a,role:e.UserRole.ADMIN,isActive:!0}})<=1)throw Error("Cannot demote the last admin of the organization");let j=i.role,k=await d.z.users.update({where:{id:c},data:{role:f},select:{id:!0,email:!0,name:!0,role:!0,isActive:!0,createdAt:!0,lastLoginAt:!0}});return await d.z.activityLog.create({data:{userId:b,orgId:a,action:"UPDATE_ROLE",entity:"USER",entityId:c,metadata:{oldRole:j,newRole:f,updatedBy:b}}}),{success:!0,message:`Member role updated from ${j} to ${f}`,member:k}}}let j=new i},38610:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>K,patchFetch:()=>J,routeModule:()=>F,serverHooks:()=>I,workAsyncStorage:()=>G,workUnitAsyncStorage:()=>H});var d={};c.r(d),c.d(d,{DELETE:()=>D,GET:()=>B,PATCH:()=>E,POST:()=>C});var e=c(27192),f=c(91165),g=c(20972),h=c(97182),i=c(9060),j=c(261),k=c(40306),l=c(43568),m=c(43376),n=c(81827),o=c(7293),p=c(45135),q=c(23857),r=c(99510),s=c(86439),t=c(27196),u=c(90449),v=c(75625),w=c(96330),x=c(35163);let y=v.Ik({email:v.Yj().email("Invalid email address"),role:v.k5([w.UserRole.USER,w.UserRole.AUTHOR,w.UserRole.EDITOR,w.UserRole.ADMIN,w.UserRole.PM,w.UserRole.OPERATOR,w.UserRole.CLIENT],{errorMap:()=>({message:"Invalid role"})})}),z=v.Ik({role:v.k5([w.UserRole.USER,w.UserRole.AUTHOR,w.UserRole.EDITOR,w.UserRole.ADMIN,w.UserRole.PM,w.UserRole.OPERATOR,w.UserRole.CLIENT],{errorMap:()=>({message:"Invalid role"})})}),A="x-user-id";async function B(a,{params:b}){try{let{id:c}=await b,d=a.headers.get(A);if(!d)return u.NextResponse.json({error:"Authentication required",details:"Missing user ID header"},{status:401});if(!await (0,x.fi)(d,c))return u.NextResponse.json({error:"Access denied",details:"You are not a member of this organization"},{status:403});let e=await x.lh.getOrgMembers(c);return u.NextResponse.json({members:e,count:e.length})}catch(a){return console.error("Error fetching organization members:",a),u.NextResponse.json({error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function C(a,{params:b}){try{let{id:c}=await b,d=a.headers.get(A);if(!d)return u.NextResponse.json({error:"Authentication required",details:"Missing user ID header"},{status:401});if(!await (0,x.uE)(d,c))return u.NextResponse.json({error:"Access denied",details:"Only organization admins can invite members"},{status:403});let e=await a.json(),f=y.safeParse(e);if(!f.success)return u.NextResponse.json({error:"Validation failed",details:f.error.flatten().fieldErrors},{status:400});let{email:g,role:h}=f.data,i=await x.lh.inviteMember(c,d,g,h);return u.NextResponse.json(i,{status:201})}catch(a){if(console.error("Error inviting member:",a),a instanceof Error){if(a.message.includes("admin"))return u.NextResponse.json({error:"Access denied",details:a.message},{status:403});if(a.message.includes("already a member"))return u.NextResponse.json({error:"Conflict",details:a.message},{status:409});if(a.message.includes("Invalid role"))return u.NextResponse.json({error:"Validation failed",details:a.message},{status:400})}return u.NextResponse.json({error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function D(a,{params:b}){try{let{id:c}=await b,d=a.headers.get(A);if(!d)return u.NextResponse.json({error:"Authentication required",details:"Missing user ID header"},{status:401});if(!await (0,x.uE)(d,c))return u.NextResponse.json({error:"Access denied",details:"Only organization admins can remove members"},{status:403});let e=(await a.json()).memberId;if(!e||"string"!=typeof e)return u.NextResponse.json({error:"Validation failed",details:"memberId is required"},{status:400});let f=await x.lh.removeMember(c,d,e);return u.NextResponse.json(f)}catch(a){if(console.error("Error removing member:",a),a instanceof Error){if(a.message.includes("admin"))return u.NextResponse.json({error:"Access denied",details:a.message},{status:403});if(a.message.includes("yourself"))return u.NextResponse.json({error:"Bad request",details:a.message},{status:400});if(a.message.includes("not found"))return u.NextResponse.json({error:"Not found",details:a.message},{status:404});if(a.message.includes("last admin"))return u.NextResponse.json({error:"Bad request",details:a.message},{status:400})}return u.NextResponse.json({error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function E(a,{params:b}){try{let{id:c}=await b,d=a.headers.get(A);if(!d)return u.NextResponse.json({error:"Authentication required",details:"Missing user ID header"},{status:401});if(!await (0,x.uE)(d,c))return u.NextResponse.json({error:"Access denied",details:"Only organization admins can update member roles"},{status:403});let e=await a.json(),f=e.memberId;if(!f||"string"!=typeof f)return u.NextResponse.json({error:"Validation failed",details:"memberId is required"},{status:400});let g=z.safeParse({role:e.role});if(!g.success)return u.NextResponse.json({error:"Validation failed",details:g.error.flatten().fieldErrors},{status:400});let h=await x.lh.updateMemberRole(c,d,f,g.data.role);return u.NextResponse.json(h)}catch(a){if(console.error("Error updating member role:",a),a instanceof Error){if(a.message.includes("admin"))return u.NextResponse.json({error:"Access denied",details:a.message},{status:403});if(a.message.includes("not found"))return u.NextResponse.json({error:"Not found",details:a.message},{status:404});if(a.message.includes("demote"))return u.NextResponse.json({error:"Bad request",details:a.message},{status:400});if(a.message.includes("Invalid role"))return u.NextResponse.json({error:"Validation failed",details:a.message},{status:400})}return u.NextResponse.json({error:"Internal server error",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}let F=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/orgs/[id]/members/route",pathname:"/api/orgs/[id]/members",filename:"route",bundlePath:"app/api/orgs/[id]/members/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/orgs/[id]/members/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:G,workUnitAsyncStorage:H,serverHooks:I}=F;function J(){return(0,g.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:H})}async function K(a,b,c){var d;let e="/api/orgs/[id]/members/route";"/index"===e&&(e="/");let g=await F.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!E||F.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===F.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>F.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>F.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await F.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await F.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await F.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},56931:()=>{},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},71003:()=>{},79551:a=>{"use strict";a.exports=require("url")},79646:a=>{"use strict";a.exports=require("child_process")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91645:a=>{"use strict";a.exports=require("net")},94735:a=>{"use strict";a.exports=require("events")},96330:a=>{"use strict";a.exports=require("@prisma/client")},96456:a=>{"use strict";a.exports=require("zlib")},99750:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[8114,5449,8139,9229,5625,624,4148,6873,9834,9747,4404,4388],()=>b(b.s=38610));module.exports=c})();