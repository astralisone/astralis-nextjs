"use strict";(()=>{var a={};a.id=5946,a.ids=[5946],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12529:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{GET:()=>m,POST:()=>l});var e=c(90449),f=c(75625),g=c(99750),h=c(96330),i=c(38097),j=c(60562),k=a([j]);j=(k.then?(await k)():k)[0];let n=f.Ik({source:f.k5(["FORM","EMAIL","CHAT","API"]),title:f.Yj().min(2),description:f.Yj().optional(),requestData:f.bz(),orgId:f.Yj(),priority:f.ai().int().min(0).max(10).optional().default(0)}),o=f.Ik({orgId:f.Yj().min(1),status:f.k5(["NEW","ROUTING","ASSIGNED","PROCESSING","COMPLETED","REJECTED"]).optional().nullable(),source:f.k5(["FORM","EMAIL","CHAT","API"]).optional().nullable(),search:f.Yj().optional().nullable(),limit:f.Yj().optional().nullable(),offset:f.Yj().optional().nullable()});async function l(a){try{let b=await a.json(),d=n.safeParse(b);if(!d.success)return e.NextResponse.json({error:"Invalid payload",details:d.error.flatten()},{status:400});let{source:f,title:k,description:l,requestData:m,orgId:o,priority:p}=d.data;if(!await g.z.organization.findUnique({where:{id:o}}))return e.NextResponse.json({error:"Organization not found"},{status:404});try{await i.DF.enforceIntakeQuota(o)}catch(a){if(a instanceof i.e2)return console.error(`[Intake API] Quota exceeded for org ${o}:`,a.message),e.NextResponse.json({error:"Quota exceeded",details:{quotaType:a.quotaType,used:a.used,limit:a.limit,plan:a.plan,message:`Monthly intake request quota exceeded (${a.used}/${a.limit}). Please upgrade your plan to continue.`}},{status:429});throw a}if(process.env.OPENAI_API_KEY){console.log(`[Intake API] OpenAI configured - creating intake for OA routing (org: ${o})`);let a=await g.z.intakeRequest.create({data:{source:f,status:h.IntakeStatus.NEW,title:k,description:l,requestData:m,priority:p||0,orgId:o,aiRoutingMeta:{routingMethod:"ai",routedAt:new Date().toISOString(),pending:!0}},include:{pipeline:!0}});try{console.log("[Intake API] Relying on OA for routing via intake:created event");let b=await g.z.intakeRequest.findUnique({where:{id:a.id},include:{pipeline:!0}});if(!b)throw Error("Intake request not found after AI processing");let d=b.aiRoutingMeta;try{let a=(0,j.BN)(b.orgId);a.isActive()||a.start()}catch(a){if(console.log("Agent not available, attempting to initialize system..."),!globalThis.agentSystemInitialized)try{let{initializeAgentSystem:a}=await Promise.resolve().then(c.bind(c,60562)),d=!!process.env.ANTHROPIC_API_KEY,e=!!process.env.OPENAI_API_KEY;if(d||e){await a({enableWebhooks:!0,enableEmail:!0,enableDBTriggers:!0,enableWorkerEvents:!0}),globalThis.agentSystemInitialized=!0,console.log("✅ Agent system initialized during intake processing");let c=(0,j.BN)(b.orgId);c.isActive()||c.start()}}catch(a){console.log("Agent system initialization failed:",a instanceof Error?a.message:String(a))}}let f=(0,j.Ju)();return await f.emit("intake:created",{id:b.id,source:"api",timestamp:new Date,payload:{intakeId:b.id,type:"intake_request",data:{title:b.title,description:b.description,source:b.source,status:b.status,priority:b.priority,requestData:b.requestData},contactInfo:{email:b.requestData?.email,name:b.requestData?.name,phone:b.requestData?.phone}}}),e.NextResponse.json({intakeRequest:b,routing:{assigned:!!b.assignedPipeline,confidence:d?.confidence??0,reasoning:d?.reasoning??"AI routing completed",usedAIRouting:!0}},{status:201})}catch(f){console.error("[Intake API] AI routing failed, intake created with NEW status:",f),await g.z.intakeRequest.update({where:{id:a.id},data:{aiRoutingMeta:{routingMethod:"ai_failed",error:f instanceof Error?f.message:"Unknown error",routedAt:new Date().toISOString(),fallbackRequired:!0}}});let b=await g.z.intakeRequest.findUnique({where:{id:a.id},include:{pipeline:!0}});try{let a=(0,j.BN)(b.orgId);a.isActive()||a.start()}catch(a){if(console.log("Agent not available, attempting to initialize system..."),!globalThis.agentSystemInitialized)try{let{initializeAgentSystem:a}=await Promise.resolve().then(c.bind(c,60562)),d=!!process.env.ANTHROPIC_API_KEY,e=!!process.env.OPENAI_API_KEY;if(d||e){await a({enableWebhooks:!0,enableEmail:!0,enableDBTriggers:!0,enableWorkerEvents:!0}),globalThis.agentSystemInitialized=!0,console.log("✅ Agent system initialized during intake processing");let c=(0,j.BN)(b.orgId);c.isActive()||c.start()}}catch(a){console.log("Agent system initialization failed:",a instanceof Error?a.message:String(a))}}let d=(0,j.Ju)();return await d.emit("intake:created",{id:b.id,source:"api",timestamp:new Date,payload:{intakeId:b.id,type:"intake_request",data:{title:b.title,description:b.description,source:b.source,status:b.status,priority:b.priority,requestData:b.requestData},contactInfo:{email:b.requestData?.email,name:b.requestData?.name,phone:b.requestData?.phone}}}),e.NextResponse.json({intakeRequest:a,routing:{assigned:!1,confidence:0,reasoning:"AI routing failed - manual routing required",usedAIRouting:!1,error:"AI routing failed"}},{status:201})}}{console.log(`[Intake API] No OpenAI configured - OA will handle routing via events (org: ${o})`);let a=await g.z.intakeRequest.create({data:{source:f,status:h.IntakeStatus.NEW,title:k,description:l,requestData:m,priority:p||0,orgId:o,aiRoutingMeta:{routingMethod:"oa_event_based",routedAt:new Date().toISOString(),pending:!0}},include:{pipeline:!0}});try{let b=(0,j.BN)(a.orgId);b.isActive()||b.start()}catch(b){if(console.log("Agent not available, attempting to initialize system..."),!globalThis.agentSystemInitialized)try{let{initializeAgentSystem:b}=await Promise.resolve().then(c.bind(c,60562)),d=!!process.env.ANTHROPIC_API_KEY,e=!!process.env.OPENAI_API_KEY;if(d||e){await b({enableWebhooks:!0,enableEmail:!0,enableDBTriggers:!0,enableWorkerEvents:!0}),globalThis.agentSystemInitialized=!0,console.log("✅ Agent system initialized during intake processing");let c=(0,j.BN)(a.orgId);c.isActive()||c.start()}}catch(a){console.log("Agent system initialization failed:",a instanceof Error?a.message:String(a))}}let b=(0,j.Ju)();return await b.emit("intake:created",{id:a.id,source:"api",timestamp:new Date,payload:{intakeId:a.id,type:"intake_request",data:{title:a.title,description:a.description,source:a.source,status:a.status,priority:a.priority,requestData:a.requestData},contactInfo:{email:a.requestData?.email,name:a.requestData?.name,phone:a.requestData?.phone}}}),e.NextResponse.json({intakeRequest:a,routing:{assigned:!1,confidence:0,reasoning:"OA will handle routing via events",usedAIRouting:!1}},{status:201})}}catch(a){return console.error("Error processing intake request:",a),e.NextResponse.json({error:"Failed to process intake request",details:a instanceof Error?a.message:"Unknown error"},{status:500})}}async function m(a){try{let{searchParams:b}=a.nextUrl,c={orgId:b.get("orgId"),status:b.get("status"),source:b.get("source"),search:b.get("search"),limit:b.get("limit"),offset:b.get("offset")},d=o.safeParse(c);if(!d.success)return e.NextResponse.json({error:"Invalid filters",details:d.error.flatten()},{status:400});let{orgId:f,status:h,source:i,search:j,limit:k,offset:l}=d.data,m=parseInt(k||"50"),n=parseInt(l||"0"),p={};f&&(p.orgId=f),h&&(p.status=h),i&&(p.source=i),j&&(p.OR=[{title:{contains:j,mode:"insensitive"}},{description:{contains:j,mode:"insensitive"}}]);let[q,r]=await Promise.all([g.z.intakeRequest.findMany({where:p,include:{pipeline:{select:{id:!0,name:!0}}},orderBy:[{priority:"desc"},{createdAt:"desc"}],take:m,skip:n}),g.z.intakeRequest.count({where:p})]);return e.NextResponse.json({intakeRequests:q,pagination:{total:r,limit:m,offset:n,hasMore:n+m<r}})}catch(a){return console.error("Error fetching intake requests:",a),e.NextResponse.json({error:"Failed to fetch intake requests"},{status:500})}}d()}catch(a){d(a)}})},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29970:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(27192),f=c(91165),g=c(20972),h=c(97182),i=c(9060),j=c(261),k=c(40306),l=c(43568),m=c(43376),n=c(81827),o=c(7293),p=c(45135),q=c(23857),r=c(99510),s=c(86439),t=c(27196),u=c(12529),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/intake/route",pathname:"/api/intake",filename:"route",bundlePath:"app/api/intake/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/gadmin/Projects/astralis-nextjs/src/app/api/intake/route.ts",nextConfigOutput:"standalone",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/intake/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},37659:a=>{a.exports=require("ioredis")},38097:(a,b,c)=>{c.d(b,{DF:()=>h,e2:()=>f});var d=c(99750);let e={free:{intake:10,documents:50,teamMembers:2,pipelines:2},starter:{intake:500,documents:100,teamMembers:3,pipelines:5},professional:{intake:5e3,documents:1e3,teamMembers:15,pipelines:-1},enterprise:{intake:-1,documents:-1,teamMembers:-1,pipelines:-1}};class f extends Error{constructor(a,b,c,d){super(`Quota exceeded for ${a}: ${b}/${c} (${d} plan)`),this.name="QuotaExceededError",this.quotaType=a,this.used=b,this.limit=c,this.plan=d}}class g{getStartOfMonth(){let a=new Date;return new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),1,0,0,0,0))}getEndOfMonth(){let a=new Date;return new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth()+1,0,23,59,59,999))}async getOrgPlan(a){let b=await d.z.organization.findUnique({where:{id:a},select:{plan:!0}});if(!b)throw Error(`Organization not found: ${a}`);return b.plan.toLowerCase()}getPlanLimits(a){let b=e[a.toLowerCase()];return b||(console.warn(`Unknown plan "${a}", defaulting to starter limits`),e.starter)}calculateQuotaResult(a,b,c){let d=-1===b,e=d?-1:Math.max(0,b-a),f=d?0:b>0?Math.min(100,a/b*100):100;return{allowed:d||a<b,used:a,limit:b,remaining:e,percentUsed:Math.round(100*f)/100,plan:c}}async checkIntakeQuota(a){let b=await this.getOrgPlan(a),c=this.getPlanLimits(b),e=this.getStartOfMonth(),f=await d.z.intakeRequest.count({where:{orgId:a,createdAt:{gte:e}}}),g=this.calculateQuotaResult(f,c.intake,b);return console.log(`Intake quota check for org ${a}: ${f}/${c.intake} (${b} plan)`),g}async checkDocumentQuota(a){let b=await this.getOrgPlan(a),c=this.getPlanLimits(b),e=this.getStartOfMonth(),f=await d.z.document.count({where:{orgId:a,createdAt:{gte:e}}}),g=this.calculateQuotaResult(f,c.documents,b);return console.log(`Document quota check for org ${a}: ${f}/${c.documents} (${b} plan)`),g}async checkTeamMemberQuota(a){let b=await this.getOrgPlan(a),c=this.getPlanLimits(b),e=await d.z.users.count({where:{orgId:a,isActive:!0}}),f=this.calculateQuotaResult(e,c.teamMembers,b);return console.log(`Team member quota check for org ${a}: ${e}/${c.teamMembers} (${b} plan)`),f}async checkPipelineQuota(a){let b=await this.getOrgPlan(a),c=this.getPlanLimits(b),e=await d.z.pipeline.count({where:{orgId:a}}),f=this.calculateQuotaResult(e,c.pipelines,b);return console.log(`Pipeline quota check for org ${a}: ${e}/${c.pipelines} (${b} plan)`),f}async getOrgQuotas(a){let b=await this.getOrgPlan(a),[c,d,e,f]=await Promise.all([this.checkIntakeQuota(a),this.checkDocumentQuota(a),this.checkTeamMemberQuota(a),this.checkPipelineQuota(a)]);return{intake:c,documents:d,teamMembers:e,pipelines:f,plan:b,billingPeriodStart:this.getStartOfMonth(),billingPeriodEnd:this.getEndOfMonth()}}async enforceIntakeQuota(a){let b=await this.checkIntakeQuota(a);if(!b.allowed)throw new f("intake",b.used,b.limit,b.plan)}async enforceDocumentQuota(a){let b=await this.checkDocumentQuota(a);if(!b.allowed)throw new f("documents",b.used,b.limit,b.plan)}async enforceTeamMemberQuota(a){let b=await this.checkTeamMemberQuota(a);if(!b.allowed)throw new f("teamMembers",b.used,b.limit,b.plan)}async enforcePipelineQuota(a){let b=await this.checkPipelineQuota(a);if(!b.allowed)throw new f("pipelines",b.used,b.limit,b.plan)}async checkQuotaWarnings(a){let b=await this.getOrgQuotas(a),c=[];for(let{key:a,name:d}of[{key:"intake",name:"Intake Requests"},{key:"documents",name:"Documents"},{key:"teamMembers",name:"Team Members"},{key:"pipelines",name:"Pipelines"}]){let e=b[a];-1!==e.limit&&e.percentUsed>=80&&c.push({quotaType:d,percentUsed:e.percentUsed,used:e.used,limit:e.limit})}return{hasWarnings:c.length>0,warnings:c}}async getUsageHistory(a){let b=this.getStartOfMonth(),c=new Date,e=await d.z.intakeRequest.findMany({where:{orgId:a,createdAt:{gte:b,lte:c}},select:{createdAt:!0}}),f=await d.z.document.findMany({where:{orgId:a,createdAt:{gte:b,lte:c}},select:{createdAt:!0}}),g=a=>Object.entries(a.reduce((a,b)=>{let c=b.createdAt.toISOString().split("T")[0];return a[c]=(a[c]||0)+1,a},{})).map(([a,b])=>({date:a,count:b})).sort((a,b)=>a.date.localeCompare(b.date));return{intake:g(e),documents:g(f)}}getPlanLimitsReference(a){return a?this.getPlanLimits(a):{...e}}}let h=new g},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50832:a=>{a.exports=import("@anthropic-ai/sdk")},55511:a=>{a.exports=require("crypto")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},83367:a=>{a.exports=require("bullmq")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87984:a=>{a.exports=import("openai")},96330:a=>{a.exports=require("@prisma/client")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[8114,5449,8139,9229,5625,624,407,5724,9660,7850,9407,562],()=>b(b.s=29970));module.exports=c})();