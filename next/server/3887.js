"use strict";exports.id=3887,exports.ids=[3887],exports.modules={11292:(a,b,c)=>{let d=c(15135),e=c(58018),f=c(4877).parseDataURI;class g{constructor(a){this.mail=a||{},this.message=!1}compile(){return this._alternatives=this.getAlternatives(),this._htmlNode=this._alternatives.filter(a=>/^text\/html\b/i.test(a.contentType)).pop(),this._attachments=this.getAttachments(!!this._htmlNode),this._useRelated=!!(this._htmlNode&&this._attachments.related.length),this._useAlternative=this._alternatives.length>1,this._useMixed=this._attachments.attached.length>1||this._alternatives.length&&1===this._attachments.attached.length,this.mail.raw?this.message=new d("message/rfc822",{newline:this.mail.newline}).setRaw(this.mail.raw):this._useMixed?this.message=this._createMixed():this._useAlternative?this.message=this._createAlternative():this._useRelated?this.message=this._createRelated():this.message=this._createContentNode(!1,[].concat(this._alternatives||[]).concat(this._attachments.attached||[]).shift()||{contentType:"text/plain",content:""}),this.mail.headers&&this.message.addHeader(this.mail.headers),["from","sender","to","cc","bcc","reply-to","in-reply-to","references","subject","message-id","date"].forEach(a=>{let b=a.replace(/-(\w)/g,(a,b)=>b.toUpperCase());this.mail[b]&&this.message.setHeader(a,this.mail[b])}),this.mail.envelope&&this.message.setEnvelope(this.mail.envelope),this.message.messageId(),this.message}getAttachments(a){let b,c,d=[].concat(this.mail.attachments||[]).map((a,b)=>{let c;/^data:/i.test(a.path||a.href)&&(a=this._processDataUrl(a));let d=a.contentType||e.detectMimeType(a.filename||a.path||a.href||"bin"),f=/^image\//i.test(d),g=/^message\//i.test(d);return c={contentType:d,contentDisposition:a.contentDisposition||(g||f&&a.cid?"inline":"attachment"),contentTransferEncoding:"contentTransferEncoding"in a?a.contentTransferEncoding:g?"7bit":"base64"},a.filename?c.filename=a.filename:!g&&!1!==a.filename&&(c.filename=(a.path||a.href||"").split("/").pop().split("?").shift()||"attachment-"+(b+1),0>c.filename.indexOf(".")&&(c.filename+="."+e.detectExtension(c.contentType))),/^https?:\/\//i.test(a.path)&&(a.href=a.path,a.path=void 0),a.cid&&(c.cid=a.cid),a.raw?c.raw=a.raw:a.path?c.content={path:a.path}:a.href?c.content={href:a.href,httpHeaders:a.httpHeaders}:c.content=a.content||"",a.encoding&&(c.encoding=a.encoding),a.headers&&(c.headers=a.headers),c});return(this.mail.icalEvent&&(b="object"==typeof this.mail.icalEvent&&(this.mail.icalEvent.content||this.mail.icalEvent.path||this.mail.icalEvent.href||this.mail.icalEvent.raw)?this.mail.icalEvent:{content:this.mail.icalEvent},c={},Object.keys(b).forEach(a=>{c[a]=b[a]}),c.contentType="application/ics",c.headers||(c.headers={}),c.filename=c.filename||"invite.ics",c.headers["Content-Disposition"]="attachment",c.headers["Content-Transfer-Encoding"]="base64"),a)?{attached:d.filter(a=>!a.cid).concat(c||[]),related:d.filter(a=>!!a.cid)}:{attached:d.concat(c||[]),related:[]}}getAlternatives(){let a=[],b,c,d,f,g,h;return this.mail.text&&((b="object"==typeof this.mail.text&&(this.mail.text.content||this.mail.text.path||this.mail.text.href||this.mail.text.raw)?this.mail.text:{content:this.mail.text}).contentType="text/plain; charset=utf-8"),this.mail.watchHtml&&((d="object"==typeof this.mail.watchHtml&&(this.mail.watchHtml.content||this.mail.watchHtml.path||this.mail.watchHtml.href||this.mail.watchHtml.raw)?this.mail.watchHtml:{content:this.mail.watchHtml}).contentType="text/watch-html; charset=utf-8"),this.mail.amp&&((f="object"==typeof this.mail.amp&&(this.mail.amp.content||this.mail.amp.path||this.mail.amp.href||this.mail.amp.raw)?this.mail.amp:{content:this.mail.amp}).contentType="text/x-amp-html; charset=utf-8"),this.mail.icalEvent&&(g="object"==typeof this.mail.icalEvent&&(this.mail.icalEvent.content||this.mail.icalEvent.path||this.mail.icalEvent.href||this.mail.icalEvent.raw)?this.mail.icalEvent:{content:this.mail.icalEvent},h={},Object.keys(g).forEach(a=>{h[a]=g[a]}),h.content&&"object"==typeof h.content&&(h.content._resolve=!0),h.filename=!1,h.contentType="text/calendar; charset=utf-8; method="+(h.method||"PUBLISH").toString().trim().toUpperCase(),h.headers||(h.headers={})),this.mail.html&&((c="object"==typeof this.mail.html&&(this.mail.html.content||this.mail.html.path||this.mail.html.href||this.mail.html.raw)?this.mail.html:{content:this.mail.html}).contentType="text/html; charset=utf-8"),[].concat(b||[]).concat(d||[]).concat(f||[]).concat(c||[]).concat(h||[]).concat(this.mail.alternatives||[]).forEach(b=>{let c;/^data:/i.test(b.path||b.href)&&(b=this._processDataUrl(b)),c={contentType:b.contentType||e.detectMimeType(b.filename||b.path||b.href||"txt"),contentTransferEncoding:b.contentTransferEncoding},b.filename&&(c.filename=b.filename),/^https?:\/\//i.test(b.path)&&(b.href=b.path,b.path=void 0),b.raw?c.raw=b.raw:b.path?c.content={path:b.path}:b.href?c.content={href:b.href}:c.content=b.content||"",b.encoding&&(c.encoding=b.encoding),b.headers&&(c.headers=b.headers),a.push(c)}),a}_createMixed(a){let b;return b=a?a.createChild("multipart/mixed",{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}):new d("multipart/mixed",{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}),this._useAlternative?this._createAlternative(b):this._useRelated&&this._createRelated(b),[].concat(!this._useAlternative&&this._alternatives||[]).concat(this._attachments.attached||[]).forEach(a=>{this._useRelated&&a===this._htmlNode||this._createContentNode(b,a)}),b}_createAlternative(a){let b;return b=a?a.createChild("multipart/alternative",{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}):new d("multipart/alternative",{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}),this._alternatives.forEach(a=>{this._useRelated&&this._htmlNode===a?this._createRelated(b):this._createContentNode(b,a)}),b}_createRelated(a){let b;return b=a?a.createChild('multipart/related; type="text/html"',{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}):new d('multipart/related; type="text/html"',{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}),this._createContentNode(b,this._htmlNode),this._attachments.related.forEach(a=>this._createContentNode(b,a)),b}_createContentNode(a,b){let c;(b=b||{}).content=b.content||"";let e=(b.encoding||"utf8").toString().toLowerCase().replace(/[-_\s]/g,"");return c=a?a.createChild(b.contentType,{filename:b.filename,textEncoding:this.mail.textEncoding,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}):new d(b.contentType,{filename:b.filename,baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline}),b.headers&&c.addHeader(b.headers),b.cid&&c.setHeader("Content-Id","<"+b.cid.replace(/[<>]/g,"")+">"),b.contentTransferEncoding?c.setHeader("Content-Transfer-Encoding",b.contentTransferEncoding):this.mail.encoding&&/^text\//i.test(b.contentType)&&c.setHeader("Content-Transfer-Encoding",this.mail.encoding),(!/^text\//i.test(b.contentType)||b.contentDisposition)&&c.setHeader("Content-Disposition",b.contentDisposition||(b.cid&&/^image\//i.test(b.contentType)?"inline":"attachment")),"string"!=typeof b.content||["utf8","usascii","ascii"].includes(e)||(b.content=Buffer.from(b.content,e)),b.raw?c.setRaw(b.raw):c.setContent(b.content),c}_processDataUrl(a){let b,c=a.path||a.href;if(!c||"string"!=typeof c||!c.startsWith("data:"))return a;if(c.length>0x3200000){let b="application/octet-stream",d=c.indexOf(",");if(d>0&&d<200){let a=c.substring(5,d).split(";");a[0]&&a[0].includes("/")&&(b=a[0].trim())}return Object.assign({},a,{path:!1,href:!1,content:Buffer.alloc(0),contentType:a.contentType||b})}try{b=f(c)}catch(b){return a}return b&&(a.content=b.data,a.contentType=a.contentType||b.contentType,"path"in a&&(a.path=!1),"href"in a&&(a.href=!1)),a}}a.exports=g},49370:(a,b,c)=>{let d=c(49074),e=c(4877);class f{constructor(a){a=a||{},this.options=a||{},this.name="JSONTransport",this.version=d.version,this.logger=e.getLogger(this.options,{component:this.options.component||"json-transport"})}send(a,b){a.message.keepBcc=!0;let c=a.data.envelope||a.message.getEnvelope(),d=a.message.messageId(),e=[].concat(c.to||[]);e.length>3&&e.push("...and "+e.splice(2).length+" more"),this.logger.info({tnx:"send",messageId:d},"Composing JSON structure of %s to <%s>",d,e.join(", ")),setImmediate(()=>{a.normalize((a,e)=>a?(this.logger.error({err:a,tnx:"send",messageId:d},"Failed building JSON structure for %s. %s",d,a.message),b(a)):(delete e.envelope,delete e.normalizedHeaders,b(null,{envelope:c,messageId:d,message:this.options.skipEncoding?e:JSON.stringify(e)})))})}}a.exports=f}};