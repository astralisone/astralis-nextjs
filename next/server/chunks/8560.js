"use strict";exports.id=8560,exports.ids=[8560],exports.modules={38560:(a,b,c)=>{c.d(b,{io:()=>d.io,nM:()=>z,L_:()=>Z,v_:()=>s,su:()=>p});var d=c(97845);let e="undefined"!=typeof process&&!1;class f{constructor(a={}){this.stats={totalInputsProcessed:0,successfulInputs:0,failedInputs:0,validationErrors:0},this.eventBus=a.eventBus??d.io.getInstance(),this.logger=a.logger??(a=>({debug:(b,c)=>{e&&console.debug(`[${a}] ${b}`,c??"")},info:(b,c)=>{console.info(`[${a}] ${b}`,c??"")},warn:(b,c)=>{console.warn(`[${a}] ${b}`,c??"")},error:(b,c,d)=>{console.error(`[${a}] ${b}`,c,d??"")}}))(this.constructor.name),this.orgId=a.orgId,this.debug=a.debug??!1,this.logger.info(`${this.constructor.name} initialized`,{source:this.getSource(),orgId:this.orgId})}async emitEvent(a,b,c){this.debug&&this.logger.debug(`Emitting event "${a}"`,{correlationId:c});try{let d=await this.eventBus.emit(a,b,{source:this.getSource(),correlationId:c,orgId:this.orgId,metadata:{handlerClass:this.constructor.name}});return d.errors.length>0&&this.logger.warn(`Event "${a}" had ${d.errors.length} handler errors`,{eventId:d.eventId,errorCount:d.errors.length}),d}catch(b){throw this.logger.error(`Failed to emit event "${a}"`,b),b}}normalizeInput(a,b,c={}){let d,e,f=c.correlationId??("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})),g=new Date;if("string"==typeof a)d=a;else if(null==a)d="";else try{d=JSON.stringify(a,null,2)}catch{d=String(a)}"object"==typeof a&&null!==a&&(e=a);let h={...c.metadata,tags:[...c.metadata?.tags??[],this.constructor.name]};return{source:this.getSource(),type:b,rawContent:d,structuredData:e,metadata:h,timestamp:g,correlationId:f}}createSuccessResult(a,b,c){return this.stats.totalInputsProcessed++,this.stats.successfulInputs++,{success:!0,input:a,eventEmitted:b,processingTimeMs:c?Date.now()-c:0,correlationId:a.correlationId}}createErrorResult(a,b,c){return this.stats.totalInputsProcessed++,this.stats.failedInputs++,this.logger.error("Input processing failed",b,{inputType:a.type,correlationId:a.correlationId}),{success:!1,input:a,error:b,processingTimeMs:c?Date.now()-c:0,correlationId:a.correlationId}}async processWithErrorHandling(a,b){let c=Date.now(),d=this.validate(a);if(!d.isValid){this.stats.validationErrors++;let b=this.normalizeInput(a,"validation_error");return this.createErrorResult(b,Error(`Validation failed: ${d.errors.join(", ")}`),c)}d.warnings.length>0&&this.logger.warn("Input validation warnings",{warnings:d.warnings});try{let c=d.sanitizedInput??a,e=this.normalizeInput(c,this.determineInputType(c));return await b(e)}catch(e){let b=e instanceof Error?e:Error(String(e)),d=this.normalizeInput(a,"processing_error");return this.createErrorResult(d,b,c)}}determineInputType(a){return"object"==typeof a&&null!==a&&"type"in a&&"string"==typeof a.type?a.type:"unknown"}getStats(){return{...this.stats,source:this.getSource()}}resetStats(){this.stats={totalInputsProcessed:0,successfulInputs:0,failedInputs:0,validationErrors:0}}canHandle(a){return this.validate(a).isValid}}var g=c(21955),h=c(81885);function i(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}let j=g.Ik({source:g.Yj().min(1),timestamp:g.KC([g.Yj(),g.p6()]).optional(),data:g.g1(g.L5()),headers:g.g1(g.Yj()).optional(),signature:g.Yj().optional()}),k=g.Ik({name:g.Yj().min(1).optional(),email:g.Yj().email(),phone:g.Yj().optional(),message:g.Yj().optional(),subject:g.Yj().optional(),company:g.Yj().optional()}),l=g.Ik({date:g.Yj().min(1),time:g.Yj().min(1),duration:g.ai().optional(),guestEmail:g.Yj().email(),guestName:g.Yj().optional(),purpose:g.Yj().optional(),hostId:g.Yj().optional(),notes:g.Yj().optional()}),m=g.Ik({type:g.Yj().min(1),email:g.Yj().email(),name:g.Yj().optional(),phone:g.Yj().optional(),details:g.g1(g.L5()).optional(),urgency:g.ai().min(1).max(5).optional()}),n={contact_form:"webhook:form_submitted",booking_form:"webhook:booking_requested",survey_form:"webhook:form_submitted",newsletter_signup:"webhook:form_submitted",intake_form:"intake:created",callback_request:"webhook:callback_received",generic:"webhook:form_submitted"};class o extends f{constructor(a={}){super(a),this.allowedSources=a.allowedSources,this.webhookSecret=a.webhookSecret,this.requireSignature=a.requireSignature??!1,this.sourceEventMapping={...n,...a.sourceEventMapping}}getSource(){return h.nm.WEBHOOK}validate(a){let b=[],c=[];if("object"!=typeof a||null===a)return{isValid:!1,errors:["Input must be an object"],warnings:[]};let d=j.safeParse(a);if(!d.success)return{isValid:!1,errors:d.error.errors.map(a=>`${a.path.join(".")}: ${a.message}`),warnings:[]};let e=d.data;this.allowedSources&&this.allowedSources.length>0&&!this.allowedSources.includes(e.source)&&b.push(`Source "${e.source}" is not allowed. Allowed sources: ${this.allowedSources.join(", ")}`),this.requireSignature&&!e.signature&&b.push("Webhook signature is required but not provided");let f=this.validateSourceData(e.source,e.data);return b.push(...f.errors),c.push(...f.warnings),{isValid:0===b.length,errors:b,warnings:c,sanitizedInput:0===b.length?e:void 0}}async handleInput(a){let b=Date.now(),c=this.validate(a);if(!c.isValid){this.stats.validationErrors++;let d=this.normalizeInput(a,"webhook_validation_error");return this.createErrorResult(d,Error(`Validation failed: ${c.errors.join(", ")}`),b)}let d=c.sanitizedInput;try{if(d.signature&&this.webhookSecret&&!await this.verifySignature(d)){let c=this.normalizeInput(a,"webhook_signature_error");return this.createErrorResult(c,Error("Webhook signature verification failed"),b)}let c=this.normalizeWebhookInput(d),e=this.determineEventType(d.source),f=this.createEventPayload(d,c),g=await this.emitEvent(e,f,c.correlationId);return this.createSuccessResult(c,{type:e,result:g},b)}catch(e){let c=e instanceof Error?e:Error(String(e)),d=this.normalizeInput(a,"webhook_processing_error");return this.createErrorResult(d,c,b)}}async handleContactForm(a){return this.handleInput({source:"contact_form",timestamp:new Date,data:a})}async handleBookingForm(a){return this.handleInput({source:"booking_form",timestamp:new Date,data:a})}async handleIntakeForm(a){return this.handleInput({source:"intake_form",timestamp:new Date,data:a})}async handleCallbackRequest(a){return this.handleInput({source:"callback_request",timestamp:new Date,data:a})}async handleGenericWebhook(a,b,c){return this.handleInput({source:a,timestamp:new Date,data:b,headers:c?.headers,signature:c?.signature})}validateSourceData(a,b){let c=[],d=[];switch(a){case"contact_form":{let a=k.safeParse(b);a.success||c.push(...a.error.errors.map(a=>`Contact form: ${a.path.join(".")}: ${a.message}`));break}case"booking_form":{let a=l.safeParse(b);a.success||c.push(...a.error.errors.map(a=>`Booking form: ${a.path.join(".")}: ${a.message}`));break}case"intake_form":{let a=m.safeParse(b);a.success||c.push(...a.error.errors.map(a=>`Intake form: ${a.path.join(".")}: ${a.message}`));break}case"survey_form":case"newsletter_signup":b.email&&"string"==typeof b.email||d.push(`${a}: email field is recommended`);break;case"callback_request":b.phone||b.email||d.push("Callback request: phone or email is recommended");break;default:0===Object.keys(b).length&&d.push("Webhook data is empty")}return{isValid:0===c.length,errors:c,warnings:d}}async verifySignature(a){if(!this.webhookSecret||!a.signature)return this.logger.debug("Skipping signature verification",{hasSignature:!!a.signature,hasSecret:!!this.webhookSecret}),!0;try{let{verifyWebhookSignature:b}=await c.e(9422).then(c.bind(c,29422)),d=JSON.stringify(a.data),e=b({secret:this.webhookSecret,signature:a.signature,payload:d,algorithm:"sha256",allowUnprefixed:!0});if(!e.isValid)return this.logger.warn("Webhook signature verification failed",{error:e.error,algorithm:e.algorithm,source:a.source,hasHeaders:!!a.headers,signaturePrefix:a.signature.substring(0,10)+"..."}),!1;return this.logger.debug("Webhook signature verified successfully",{algorithm:e.algorithm,source:a.source}),!0}catch(b){return this.logger.error("Unexpected error during signature verification",{error:b instanceof Error?b.message:String(b),source:a.source}),!1}}normalizeWebhookInput(a){let b=a.source,c=a.timestamp?new Date(a.timestamp):new Date,d=i();return{source:h.nm.WEBHOOK,type:`webhook:${b}`,rawContent:JSON.stringify(a.data,null,2),structuredData:a.data,metadata:{headers:a.headers,webhookSignature:a.signature,tags:[b,"webhook"]},timestamp:c,correlationId:d}}determineEventType(a){return this.sourceEventMapping[a]??"webhook:form_submitted"}createEventPayload(a,b){let c=a.source,d=b.correlationId??i();switch(c){case"booking_form":return this.createBookingPayload(d,a.data);case"intake_form":return this.createIntakePayload(d,a.data);case"callback_request":return this.createCallbackPayload(d,a.data);default:return this.createFormPayload(d,c,a.data)}}createFormPayload(a,b,c){return{formId:`${b}_${a.slice(0,8)}`,formType:b,fields:c,submitterEmail:this.extractEmail(c),submitterName:this.extractName(c),submittedAt:new Date}}createBookingPayload(a,b){return{bookingId:`booking_${a.slice(0,8)}`,date:String(b.date??""),time:String(b.time??""),duration:"number"==typeof b.duration?b.duration:void 0,guestEmail:this.extractEmail(b),guestName:this.extractName(b),purpose:"string"==typeof b.purpose?b.purpose:void 0,hostId:"string"==typeof b.hostId?b.hostId:void 0,requestedAt:new Date}}createIntakePayload(a,b){return{intakeId:`intake_${a.slice(0,8)}`,type:"string"==typeof b.type?b.type:"general",data:b,contactInfo:{email:this.extractEmail(b),name:this.extractName(b),phone:this.extractPhone(b)},urgency:"number"==typeof b.urgency?b.urgency:void 0,createdAt:new Date}}createCallbackPayload(a,b){return{callbackId:`callback_${a.slice(0,8)}`,phone:this.extractPhone(b),email:this.extractEmail(b),name:this.extractName(b),preferredTime:"string"==typeof b.preferredTime?b.preferredTime:void 0,message:"string"==typeof b.message?b.message:void 0,receivedAt:new Date}}extractEmail(a){for(let b of["email","guestEmail","submitterEmail","userEmail","contact_email"])if("string"==typeof a[b]&&a[b])return a[b]}extractName(a){for(let b of["name","guestName","submitterName","userName","fullName","full_name"])if("string"==typeof a[b]&&a[b])return a[b];let b=a.firstName||a.first_name,c=a.lastName||a.last_name;if(b||c)return[b,c].filter(Boolean).join(" ")}extractPhone(a){for(let b of["phone","phoneNumber","phone_number","mobile","tel"])if("string"==typeof a[b]&&a[b])return a[b]}determineInputType(a){return"object"==typeof a&&null!==a&&"source"in a&&"string"==typeof a.source?`webhook:${a.source}`:"webhook:unknown"}}function p(a){return new o(a)}let q={email:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered",scheduled:"schedule:triggered"},notifications:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered",scheduled:"schedule:triggered"},automation:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered",scheduled:"automation:triggered"},reports:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered",scheduled:"schedule:triggered"},reminders:{completed:"calendar:reminder_due",failed:"automation:failed",scheduled:"calendar:reminder_due"},sync:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered"},cleanup:{completed:"automation:completed",failed:"automation:failed"},analytics:{completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered"}},r={completed:"automation:completed",failed:"automation:failed",progress:"automation:triggered",scheduled:"schedule:triggered",stalled:"automation:failed",active:"automation:triggered",delayed:"automation:triggered",waiting:"automation:triggered"};class s extends f{constructor(a={}){super(a),this.progressTracker=new Map,this.retryTracker=new Map,this.workerStats={completedJobs:0,failedJobs:0,progressUpdates:0,scheduledTriggers:0,stalledJobs:0,permanentFailures:0,retriedJobs:0,byQueue:{}},this.queueEventMap={...q,...a.queueEventMap},this.emitProgressEvents=a.emitProgressEvents??!1,this.progressThreshold=a.progressThreshold??10,this.trackRetries=a.trackRetries??!0,this.maxRetriesForPermanentFailure=a.maxRetriesForPermanentFailure??3,this.logger.info("WorkerEventHandler initialized",{emitProgressEvents:this.emitProgressEvents,progressThreshold:this.progressThreshold,trackRetries:this.trackRetries,maxRetriesForPermanentFailure:this.maxRetriesForPermanentFailure})}getSource(){return h.nm.WORKER}validate(a){let b=[],c=[];if(!a||"object"!=typeof a)return{isValid:!1,errors:["Input must be a non-null object"],warnings:[]};if(a.eventType?this.isValidEventType(a.eventType)||b.push(`Invalid eventType: ${a.eventType}. Must be one of: completed, failed, progress, scheduled, stalled, active, delayed, waiting`):b.push("Missing required field: eventType"),a.queueName?"string"!=typeof a.queueName&&b.push("queueName must be a string"):b.push("Missing required field: queueName"),a.job)if("object"!=typeof a.job)b.push("job must be an object");else{let d=a.job;d.name?"string"!=typeof d.name&&b.push("job.name must be a string"):b.push("Missing required field: job.name"),void 0!==d.data&&"object"!=typeof d.data&&b.push("job.data must be an object"),d.timestamp?"number"!=typeof d.timestamp&&b.push("job.timestamp must be a number (Unix timestamp)"):c.push("Missing job.timestamp, will use current time"),"failed"!==a.eventType||d.failedReason||c.push("Failed job missing failedReason"),"progress"===a.eventType&&void 0===d.progress&&c.push("Progress event missing progress value")}else b.push("Missing required field: job");return{isValid:0===b.length,errors:b,warnings:c,sanitizedInput:0===b.length?this.sanitizeInput(a):void 0}}async handleInput(a){return this.processWithErrorHandling(a,async b=>{let c=Date.now(),d=this.getAgentEventType(a.queueName,a.eventType),e=this.buildEventPayload(a);if(this.updateStats(a),!this.shouldEmitEvent(a))return this.logger.debug("Skipping event emission",{reason:"Event filtered by configuration",eventType:a.eventType,queueName:a.queueName}),this.createSuccessResult(b,void 0,c);"failed"===a.eventType&&this.trackRetries&&this.handleFailedJobRetry(a);let f=await this.emitEvent(d,e,b.correlationId);return this.logger.info("Worker event processed",{eventType:a.eventType,queueName:a.queueName,jobId:a.job.id,jobName:a.job.name,agentEventType:d,emitResult:{eventId:f.eventId,handlersInvoked:f.handlersInvoked}}),this.createSuccessResult(b,{type:d,result:f},c)})}getAgentEventType(a,b){let c=a.toLowerCase(),d=this.queueEventMap[c];return d&&d[b]?d[b]:r[b]||"automation:triggered"}buildEventPayload(a){let b={id:a.job.id||this.generateId(),timestamp:new Date(a.job.timestamp||Date.now()),source:h.nm.WORKER,orgId:this.orgId,metadata:{queueName:a.queueName,eventType:a.eventType,jobName:a.job.name,attemptsMade:a.job.attemptsMade,workerId:a.workerId,repeatJobKey:a.job.repeatJobKey}},c=a.queueName.toLowerCase();return"reminders"===c||"scheduled"===a.eventType?this.buildReminderPayload(a,b):["automation","email","notifications","reports","sync"].includes(c)?this.buildAutomationPayload(a,b):{...b,metadata:{...b.metadata,jobData:a.job.data,returnValue:a.job.returnValue,failedReason:a.job.failedReason}}}buildAutomationPayload(a,b){let c="completed"===a.eventType,d="failed"===a.eventType||"stalled"===a.eventType;return{...b,workflowId:a.job.data.workflowId||a.job.name,workflowName:a.job.data.workflowName||a.job.name,status:c?"success":d?"failure":"success",executionTime:this.calculateExecutionTime(a),result:c?a.job.returnValue:void 0,error:a.job.failedReason}}buildReminderPayload(a,b){let c=a.job.data;return{...b,reminderId:c.reminderId||b.id,eventId:c.eventId,message:c.message||`Reminder: ${a.job.name}`,dueAt:new Date(c.dueAt||a.job.timestamp),recipientIds:c.recipientIds||[]}}shouldEmitEvent(a){return!!["completed","failed","scheduled","stalled"].includes(a.eventType)||("progress"===a.eventType?!!this.emitProgressEvents&&this.meetsProgressThreshold(a):this.debug)}meetsProgressThreshold(a){let b=`${a.queueName}:${a.job.id}`,c=this.extractProgressValue(a.job.progress);return Math.abs(c-(this.progressTracker.get(b)??0))>=this.progressThreshold&&(this.progressTracker.set(b,c),!0)}extractProgressValue(a){if("number"==typeof a)return a;if("object"==typeof a&&null!==a){if("number"==typeof a.percent)return a.percent;if("number"==typeof a.percentage)return a.percentage;if("number"==typeof a.value)return a.value}return 0}handleFailedJobRetry(a){let b=`${a.queueName}:${a.job.id}`,c=(this.retryTracker.get(b)??0)+1;this.retryTracker.set(b,c),this.workerStats.retriedJobs++;let d=a.job.opts?.attempts??this.maxRetriesForPermanentFailure,e=a.job.attemptsMade??c;e>=d&&(this.workerStats.permanentFailures++,this.logger.warn("Job permanently failed after max retries",{jobId:a.job.id,jobName:a.job.name,queueName:a.queueName,attemptsMade:e,maxAttempts:d,failedReason:a.job.failedReason}),this.retryTracker.delete(b))}updateStats(a){let b=a.queueName.toLowerCase();switch(!this.workerStats.byQueue[b]&&(this.workerStats.byQueue[b]={completed:0,failed:0}),a.eventType){case"completed":this.workerStats.completedJobs++,this.workerStats.byQueue[b].completed++,this.progressTracker.delete(`${b}:${a.job.id}`),this.retryTracker.delete(`${b}:${a.job.id}`);break;case"failed":this.workerStats.failedJobs++,this.workerStats.byQueue[b].failed++;break;case"progress":this.workerStats.progressUpdates++;break;case"scheduled":this.workerStats.scheduledTriggers++;break;case"stalled":this.workerStats.stalledJobs++,this.workerStats.byQueue[b].failed++}}calculateExecutionTime(a){let b=a.job.data;return b.processedOn&&b.finishedOn?b.finishedOn-b.processedOn:0}isValidEventType(a){return["completed","failed","progress","scheduled","stalled","active","delayed","waiting"].includes(a)}sanitizeInput(a){return{eventType:a.eventType,queueName:a.queueName,job:{...a.job,id:a.job.id||this.generateId(),data:a.job.data||{},timestamp:a.job.timestamp||Date.now()},workerId:a.workerId,previousState:a.previousState}}generateId(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():`worker_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}determineInputType(a){return"object"==typeof a&&null!==a?`worker:${a.queueName}:${a.eventType}`:"worker:unknown"}buildInputMetadata(a){let b={jobId:a.job.id||"",queueName:a.queueName};return a.job.data.entityId&&(b.entityId=a.job.data.entityId),a.job.data.workflowId&&(b.workflowId=a.job.data.workflowId),{tags:["worker",a.queueName,a.eventType,a.job.name],relatedEntityIds:b}}getWorkerStats(){return{...this.workerStats}}resetWorkerStats(){this.workerStats={completedJobs:0,failedJobs:0,progressUpdates:0,scheduledTriggers:0,stalledJobs:0,permanentFailures:0,retriedJobs:0,byQueue:{}},this.progressTracker.clear(),this.retryTracker.clear()}getJobRetryCount(a,b){return this.retryTracker.get(`${a}:${b}`)??0}clearJobTracking(a,b){let c=`${a}:${b}`;this.progressTracker.delete(c),this.retryTracker.delete(c)}addQueueMapping(a,b){this.queueEventMap[a.toLowerCase()]={...this.queueEventMap[a.toLowerCase()],...b}}}var t=function(a){return a.INTAKE="Intake",a.PIPELINE="Pipeline",a.PIPELINE_ITEM="PipelineItem",a.PIPELINE_STAGE="PipelineStage",a.CALENDAR_EVENT="CalendarEvent",a.BOOKING="Booking",a.USER="User",a.CONTACT="Contact",a.ORGANIZATION="Organization",a.NOTIFICATION="Notification",a.TASK="Task",a}({});let u=["updatedAt","createdAt","version","lastModified","modifiedAt","lastAccessed","accessedAt","viewCount","impressions","checksum","hash","etag"],v={Intake:["status","priority","assignedTo","assignedToId","pipelineId","stageId","category","urgency"],Pipeline:["name","isActive","isArchived"],PipelineItem:["stageId","pipelineId","assignedToId","status","priority","dueDate"],PipelineStage:["name","order","isActive"],CalendarEvent:["startTime","endTime","title","status","isCancelled","attendees"],Booking:["status","date","time","duration","isCancelled","isConfirmed"],User:["role","isActive","permissions"],Contact:["email","status","tags"],Task:["status","priority","assignedToId","dueDate","completedAt"]},w={create:"CREATE",createMany:"CREATE",update:"UPDATE",updateMany:"UPDATE",upsert:"UPDATE",delete:"DELETE",deleteMany:"DELETE"},x={Intake:{CREATE:"intake:created",UPDATE:"intake:updated",DELETE:null},PipelineItem:{CREATE:"intake:created",UPDATE:"pipeline:stage_changed",DELETE:null},CalendarEvent:{CREATE:"calendar:event_created",UPDATE:"calendar:event_updated",DELETE:"calendar:event_cancelled"},Booking:{CREATE:"webhook:booking_requested",UPDATE:"webhook:booking_requested",DELETE:"calendar:event_cancelled"},Pipeline:{CREATE:null,UPDATE:"pipeline:completed",DELETE:null}};function y(a,b){if(a===b)return!0;if(null===a||null===b||typeof a!=typeof b)return!1;if(a instanceof Date&&b instanceof Date)return a.getTime()===b.getTime();if(Array.isArray(a)&&Array.isArray(b))return a.length===b.length&&a.every((a,c)=>y(a,b[c]));if("object"==typeof a&&"object"==typeof b){let c=Object.keys(a),d=Object.keys(b);return c.length===d.length&&c.every(c=>y(a[c],b[c]))}return!1}class z extends f{constructor(a={}){super(a),this.dbStats={byEntityType:new Map,byChangeType:new Map,significantChanges:0,filteredChanges:0},this.ignoredFields=new Set([...u,...a.ignoredFields??[]]),this.significantFields={...v,...a.significantFields},this.processBatchOperations=a.processBatchOperations??!1,this.minConfidenceThreshold=a.minConfidenceThreshold??.5,this.entityTypeMapper=a.entityTypeMapper}getSource(){return h.nm.DB_TRIGGER}validate(a){let b=[],c=[];return a&&"object"==typeof a?(a.model&&"string"==typeof a.model||b.push("model is required and must be a string"),a.action&&"string"==typeof a.action||b.push("action is required and must be a string"),a.action&&!w[a.action]&&c.push(`Unknown action "${a.action}", will attempt to process`),void 0===a.before&&void 0===a.after&&b.push("At least one of before or after must be provided"),!this.processBatchOperations&&a.action?.includes("Many")&&c.push(`Batch operation "${a.action}" detected. Set processBatchOperations: true to enable.`),null!==a.before&&void 0!==a.before&&"object"!=typeof a.before&&b.push("before must be an object or null"),null!==a.after&&void 0!==a.after&&"object"!=typeof a.after&&b.push("after must be an object or null"),{isValid:0===b.length,errors:b,warnings:c,sanitizedInput:a}):(b.push("Input must be a non-null object"),{isValid:!1,errors:b,warnings:c})}async handleInput(a){return this.processWithErrorHandling(a,async a=>{let b=Date.now();if(!a.structuredData)throw Error("No structured data in normalized input");let c=a.structuredData,d=this.detectEntityType(c.model),e=this.detectChanges(c,d);this.updateDbStats(d,e.changeType,e.hasSignificantChanges);let f=this.mapToEvent(d,e);if(!f.shouldEmit)return this.dbStats.filteredChanges++,this.createSuccessResult(a,void 0,b);let g=this.buildEventPayload(c,d,e),h=await this.emitEvent(f.eventType,g,a.correlationId);return this.createSuccessResult(a,{type:f.eventType,result:h},b)})}detectEntityType(a){if(this.entityTypeMapper)return this.entityTypeMapper(a);for(let b of Object.values(t))if(a===b||a.toLowerCase()===b.toLowerCase())return b;return a}detectChanges(a,b){let c=this.getChangeType(a.action),d=[],e=[];if("CREATE"===c&&a.after){let c=this.significantFields[b]??[];for(let[b,f]of Object.entries(a.after)){if(this.ignoredFields.has(b))continue;let a=c.includes(b)||this.isFieldInherentlySignificant(b,f);d.push({field:b,oldValue:null,newValue:f,isSignificant:a}),a&&e.push(b)}}if("DELETE"===c&&a.before)for(let[b,c]of Object.entries(a.before))this.ignoredFields.has(b)||(d.push({field:b,oldValue:c,newValue:null,isSignificant:!0}),e.push(b));if("UPDATE"===c&&a.before&&a.after){let c=this.significantFields[b]??[];for(let f of new Set([...Object.keys(a.before),...Object.keys(a.after)])){if(this.ignoredFields.has(f))continue;let g=a.before[f],h=a.after[f];if(y(g,h))continue;let i=c.includes(f)||this.isFieldChangeSignificant(f,g,h,b);d.push({field:f,oldValue:g,newValue:h,isSignificant:i}),i&&e.push(f)}}let f=e.length>0||"DELETE"===c;return{changeType:c,entityType:b,changes:d,hasSignificantChanges:f,significantFields:e,summary:this.buildChangeSummary(c,b,d,e)}}getFieldChanges(a,b){let c=[];if(!a&&b)for(let[a,d]of Object.entries(b))this.ignoredFields.has(a)||c.push({field:a,oldValue:null,newValue:d,isSignificant:!1});else if(a&&!b)for(let[b,d]of Object.entries(a))this.ignoredFields.has(b)||c.push({field:b,oldValue:d,newValue:null,isSignificant:!0});else if(a&&b)for(let d of new Set([...Object.keys(a),...Object.keys(b)])){if(this.ignoredFields.has(d))continue;let e=a[d],f=b[d];y(e,f)||c.push({field:d,oldValue:e,newValue:f,isSignificant:!1})}return c}didFieldChange(a,b,c){return!y(b?.[a],c?.[a])}mapToEvent(a,b){let c=x[a];if(!c)return{eventType:`custom:db_${a.toLowerCase()}_${b.changeType.toLowerCase()}`,shouldEmit:b.hasSignificantChanges,skipReason:b.hasSignificantChanges?void 0:"No significant changes detected"};let d=c[b.changeType];return d?"PipelineItem"!==a||"UPDATE"!==b.changeType||b.changes.some(a=>"stageId"===a.field||"pipelineStageId"===a.field)||b.hasSignificantChanges?"UPDATE"!==b.changeType||b.hasSignificantChanges?{eventType:d,shouldEmit:!0}:{eventType:d,shouldEmit:!1,skipReason:"Update without significant changes"}:{eventType:d,shouldEmit:!1,skipReason:"Pipeline item update without stage change or significant fields"}:{eventType:"agent:action_executed",shouldEmit:!1,skipReason:`No event mapping for ${a}:${b.changeType}`}}getEventType(a,b){let c=x[a];return c?.[b]??null}buildEventPayload(a,b,c){let d={id:this.extractEntityId(a)??("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})),timestamp:a.timestamp??new Date,source:h.nm.DB_TRIGGER,orgId:this.orgId,metadata:{entityType:b,changeType:c.changeType,changedFields:c.changes.map(a=>a.field),significantFields:c.significantFields,triggeredBy:a.triggeredBy,model:a.model,action:a.action}};switch(b){case"Intake":return this.buildIntakePayload(a,d,c);case"PipelineItem":return this.buildPipelinePayload(a,d,c);case"Booking":case"CalendarEvent":return this.buildBookingPayload(a,d,c);default:return{...d,data:a.after??a.before??{}}}}buildIntakePayload(a,b,c){let d=a.after??a.before;return{...b,intakeId:this.extractEntityId(a)??"",type:d.type??d.category??"unknown",data:{...d,changes:c.changes},contactInfo:this.extractContactInfo(d)}}buildPipelinePayload(a,b,c){let d=a.before,e=a.after??d??{},f=c.changes.find(a=>"stageId"===a.field||"pipelineStageId"===a.field||"stage"===a.field);return{...b,pipelineId:e.pipelineId??"",entityId:this.extractEntityId(a)??"",entityType:e.entityType??"intake",previousStage:f?.oldValue,newStage:f?.newValue??e.stageId??"",triggeredBy:a.triggeredBy}}buildBookingPayload(a,b,c){let d=a.after??a.before,e="updated";return"CREATE"===c.changeType?e="created":("DELETE"===c.changeType||!0===d.isCancelled||"cancelled"===d.status)&&(e="cancelled"),{...b,bookingId:this.extractEntityId(a)??"",eventType:e,bookingData:{date:this.formatDate(d.date??d.startTime??d.startDate),time:this.formatTime(d.time??d.startTime),duration:d.duration??d.durationMinutes,guestEmail:d.guestEmail??d.email,guestName:d.guestName??d.name,purpose:d.purpose??d.title??d.description,hostId:d.hostId??d.userId}}}getChangeType(a){return w[a]??"UPDATE"}determineInputType(a){let b=this.detectEntityType(a.model),c=this.getChangeType(a.action);return`db_${b.toLowerCase()}_${c.toLowerCase()}`}isFieldInherentlySignificant(a,b){return!!(a.endsWith("Id")&&null!==b||"status"===a||"priority"===a||a.startsWith("is")&&"boolean"==typeof b)}isFieldChangeSignificant(a,b,c,d){return!!((null===b&&null!==c||null!==b&&null===c)&&!a.includes("At")&&!a.includes("Date")&&!a.includes("Time")||"status"===a||a.includes("Status")||"priority"===a||a.includes("Priority")||a.includes("assignee")||a.includes("Assigned"))}buildChangeSummary(a,b,c,d){let e=`${"CREATE"===a?"Created":"DELETE"===a?"Deleted":"Updated"} ${b}`;if("UPDATE"===a&&c.length>0){let a=c.map(a=>a.field).slice(0,5).join(", "),b=c.length>5?` (+${c.length-5} more)`:"";e+=`: ${a}${b}`,d.length>0&&(e+=` [significant: ${d.join(", ")}]`)}return e}extractEntityId(a){let b=a.after??a.before;if(b){for(let a of["id","Id","_id","uuid","uid"])if(void 0!==b[a])return String(b[a])}}extractContactInfo(a){let b=a.email??a.contactEmail??a.senderEmail,c=a.name??a.contactName??a.senderName??a.fullName,d=a.phone??a.phoneNumber??a.contactPhone;if(b||c||d)return{email:b,name:c,phone:d}}formatDate(a){if(!a)return"";if(a instanceof Date)return a.toISOString().split("T")[0];if("string"==typeof a){let b=new Date(a);return isNaN(b.getTime())?a:b.toISOString().split("T")[0]}return String(a)}formatTime(a){if(!a)return"";if(a instanceof Date)return a.toISOString().split("T")[1]?.slice(0,5)??"";if("string"==typeof a){let b=new Date(a);return isNaN(b.getTime())?a:b.toISOString().split("T")[1]?.slice(0,5)??a}return String(a)}updateDbStats(a,b,c){this.dbStats.byEntityType.set(a,(this.dbStats.byEntityType.get(a)??0)+1),this.dbStats.byChangeType.set(b,(this.dbStats.byChangeType.get(b)??0)+1),c&&this.dbStats.significantChanges++}getExtendedStats(){let a=this.getStats(),b={};for(let[a,c]of this.dbStats.byEntityType)b[a]=c;let c={};for(let[a,b]of this.dbStats.byChangeType)c[a]=b;return{...a,byEntityType:b,byChangeType:c,significantChanges:this.dbStats.significantChanges,filteredChanges:this.dbStats.filteredChanges}}resetStats(){super.resetStats(),this.dbStats={byEntityType:new Map,byChangeType:new Map,significantChanges:0,filteredChanges:0}}addIgnoredFields(...a){for(let b of a)this.ignoredFields.add(b)}removeIgnoredFields(...a){for(let b of a)this.ignoredFields.delete(b)}setSignificantFields(a,b){this.significantFields[a]=b}getSignificantFields(a){return this.significantFields[a]??[]}}let A=g.Ik({from:g.Yj().min(1,"From address is required"),to:g.Yj().min(1,"To address is required"),subject:g.Yj().default(""),text:g.Yj().default(""),html:g.Yj().optional(),sender_ip:g.Yj().optional(),envelope:g.Yj().optional(),headers:g.Yj().optional(),dkim:g.Yj().optional(),SPF:g.Yj().optional(),spam_score:g.Yj().optional(),spam_report:g.Yj().optional(),attachments:g.Yj().optional(),"attachment-info":g.Yj().optional(),charsets:g.Yj().optional()}).passthrough(),B=g.Ik({sender:g.Yj().min(1,"Sender address is required"),recipient:g.Yj().min(1,"Recipient address is required"),subject:g.Yj().default(""),"body-plain":g.Yj().default(""),"body-html":g.Yj().optional(),"stripped-text":g.Yj().optional(),"stripped-html":g.Yj().optional(),from:g.Yj().optional(),"Message-Id":g.Yj().optional(),"In-Reply-To":g.Yj().optional(),References:g.Yj().optional(),Date:g.Yj().optional(),timestamp:g.KC([g.Yj(),g.ai()]).optional(),token:g.Yj().optional(),signature:g.Yj().optional(),"message-headers":g.Yj().optional(),"content-id-map":g.Yj().optional(),attachments:g.Yj().optional(),"X-Mailgun-Sflag":g.Yj().optional(),"X-Mailgun-Sscore":g.Yj().optional(),"X-Mailgun-Spf":g.Yj().optional(),"X-Mailgun-Dkim-Check-Result":g.Yj().optional()}).passthrough(),C=g.Ik({from:g.Yj().optional(),sender:g.Yj().optional(),from_email:g.Yj().optional(),fromEmail:g.Yj().optional(),to:g.KC([g.Yj(),g.YO(g.Yj())]).optional(),recipient:g.Yj().optional(),recipients:g.KC([g.Yj(),g.YO(g.Yj())]).optional(),to_email:g.Yj().optional(),toEmail:g.Yj().optional(),subject:g.Yj().optional(),title:g.Yj().optional(),text:g.Yj().optional(),body:g.Yj().optional(),text_body:g.Yj().optional(),textBody:g.Yj().optional(),"body-plain":g.Yj().optional(),plain:g.Yj().optional(),content:g.Yj().optional(),html:g.Yj().optional(),html_body:g.Yj().optional(),htmlBody:g.Yj().optional(),"body-html":g.Yj().optional(),message_id:g.Yj().optional(),messageId:g.Yj().optional(),"Message-Id":g.Yj().optional(),id:g.Yj().optional(),headers:g.KC([g.Yj(),g.g1(g.Yj())]).optional(),attachments:g.KC([g.Yj(),g.YO(g.Ik({filename:g.Yj().optional(),name:g.Yj().optional(),contentType:g.Yj().optional(),content_type:g.Yj().optional(),type:g.Yj().optional(),size:g.ai().optional(),url:g.Yj().optional()}).passthrough())]).optional(),timestamp:g.KC([g.Yj(),g.ai(),g.p6()]).optional(),date:g.KC([g.Yj(),g.p6()]).optional(),spam_score:g.KC([g.Yj(),g.ai()]).optional(),spamScore:g.KC([g.Yj(),g.ai()]).optional()}).passthrough();g.KC([A,B,C]);let D={subjects:[/^auto[:\s-]*reply/i,/^automatic\s+reply/i,/^out\s+of\s+(the\s+)?office/i,/^ooo[:\s]/i,/away\s+from\s+(my\s+)?desk/i,/^vacation\s+reply/i,/^holiday\s+notice/i,/^\[auto-?reply\]/i,/^re:.*\[auto\]/i,/on\s+leave/i,/^automatic\s+response/i,/abwesenheitsnotiz/i,/absence\s+du\s+bureau/i],headers:{"auto-submitted":["auto-replied","auto-generated","auto-notified"],"x-auto-response-suppress":["all","oof","autoreply"],precedence:["bulk","junk","list","auto_reply"],"x-autoreply":["yes"],"x-autorespond":[]}},E={subjects:[/^undelivered\s+mail/i,/^returned\s+mail/i,/^mail\s+delivery\s+(failed|failure|system)/i,/^delivery\s+(status\s+)?notification/i,/failure\s+notice/i,/^undeliverable/i,/could\s+not\s+be\s+delivered/i,/^rejected/i,/^(non[- ])?delivery\s+(report|notification)/i,/^postmaster/i,/^mailer[- ]daemon/i],fromAddresses:[/^mailer-daemon@/i,/^postmaster@/i,/^mail-daemon@/i,/^bounce/i,/^noreply/i,/^no-reply/i,/^donotreply/i]},F={subjects:[/\$\$\$/,/free\s+money/i,/click\s+here\s+now/i,/act\s+now/i,/limited\s+time/i,/congratulations.*winner/i,/you'?ve?\s+won/i,/claim\s+your\s+prize/i,/nigerian?\s+prince/i,/urgent.*transfer/i,/viagra|cialis/i,/\bsex\b/i,/\bxxx\b/i],scoreThreshold:5},G={headers:{"list-unsubscribe":!0,"list-id":!0,"x-campaign":!0,"x-mailchimp":!0,"x-sendgrid-marketing":!0}},H={subjects:[/^re:\s*/i,/^aw:\s*/i,/^sv:\s*/i,/^antw:\s*/i,/^r:\s*/i,/^rif:\s*/i,/^res:\s*/i]},I={subjects:[/^fwd?:\s*/i,/^fw:\s*/i,/^wg:\s*/i,/^vs:\s*/i,/^tr:\s*/i,/^i:\s*/i,/^rv:\s*/i,/^enc:\s*/i]};function J(){let a=Date.now().toString(36),b=Math.random().toString(36).substring(2,10);return`${a}-${b}@agent-generated`}function K(a){if(!a)return"";let b=a.match(/<([^>]+)>/);if(b)return b[1].trim().toLowerCase();let c=a.match(/[\w.+-]+@[\w.-]+\.\w+/);return c?c[0].trim().toLowerCase():a.trim().toLowerCase()}function L(a){if(!a)return;let b=a.match(/^"([^"]+)"\s*</);if(b)return b[1].trim();let c=a.indexOf("<");if(c>0){let b=a.substring(0,c).trim();if(b&&!b.includes("@"))return b}}function M(a){if(!a)return"";let b=a.split("@")[0];return b?b.replace(/[._-]/g," ").replace(/\b\w/g,a=>a.toUpperCase()).trim():a}function N(a){return a?Array.isArray(a)?a.map(K).filter(Boolean):a.split(/,\s*/).map(K).filter(Boolean):[]}function O(a){if(!a)return{};if("object"==typeof a){let b={};for(let[c,d]of Object.entries(a))b[c.toLowerCase()]=d;return b}let b={},c=a.split(/\r?\n/),d="",e="";for(let a of c)if(a.startsWith(" ")||a.startsWith("	"))e+=" "+a.trim();else{d&&(b[d.toLowerCase()]=e);let c=a.indexOf(":");c>0&&(d=a.substring(0,c).trim(),e=a.substring(c+1).trim())}return d&&(b[d.toLowerCase()]=e),b}function P(a){return a.inReplyTo?a.inReplyTo.replace(/[<>]/g,"").trim()||void 0:a.references&&a.references.length>0&&a.references[0].replace(/[<>]/g,"").trim()||void 0}function Q(a){return a?a.split(/\s+/).map(a=>a.replace(/[<>]/g,"").trim()).filter(Boolean):[]}function R(a,b){if(!a&&!b)return[];let c=[];if(b)try{let a=JSON.parse(b);if("object"==typeof a)for(let[b,d]of Object.entries(a))"object"==typeof d&&null!==d&&c.push({filename:String(d.filename||d.name||b),contentType:String(d.type||d["content-type"]||"application/octet-stream"),size:Number(d.size||0),contentId:d["content-id"]?String(d["content-id"]):void 0})}catch{}if(Array.isArray(a))for(let b of a)"object"==typeof b&&null!==b&&c.push({filename:String(b.filename||b.name||"unknown"),contentType:String(b.contentType||b.content_type||b.type||"application/octet-stream"),size:Number(b.size||0),contentId:b.contentId?String(b.contentId):void 0,url:b.url?String(b.url):void 0});if("string"==typeof a&&a.startsWith("["))try{let b=JSON.parse(a);if(Array.isArray(b))return R(b)}catch{}return c}function S(a,b){for(let b of D.subjects)if(b.test(a))return!0;if(b.autoSubmitted){let a=b.autoSubmitted.toLowerCase();if(D.headers["auto-submitted"].some(b=>a.includes(b)))return!0}if(b.autoResponseSuppress){let a=b.autoResponseSuppress.toLowerCase();if(D.headers["x-auto-response-suppress"].some(b=>a.includes(b)))return!0}if(b.precedence){let a=b.precedence.toLowerCase();if(D.headers.precedence.some(b=>a===b))return!0}return!1}function T(a,b,c){for(let b of E.subjects)if(b.test(a))return!0;for(let a of E.fromAddresses)if(a.test(b))return!0;if(c.returnPath){for(let a of E.fromAddresses)if(a.test(c.returnPath))return!0}return!!(c.autoSubmitted&&c.autoSubmitted.toLowerCase().includes("auto-generated")&&E.subjects.some(b=>b.test(a)))||!1}function U(a,b,c){let d=b??0;for(let b of F.subjects)b.test(a)&&(d+=2);return c.spfResult&&!["pass","softfail"].includes(c.spfResult.toLowerCase())&&(d+=1),c.dkimResult&&"pass"!==c.dkimResult.toLowerCase()&&(d+=1),{isSpam:d>=F.scoreThreshold,score:Math.min(d,10)}}function V(a,b,c,d,e,f){if(e)return"bounce";if(d)return"spam";if(f)return"auto_reply";if(function(a){let b=a.raw??{};for(let c of Object.keys(G.headers))if(b[c]||a.listUnsubscribe)return!0;return!1}(c))return"newsletter";for(let b of I.subjects)if(b.test(a))return"forward";for(let b of H.subjects)if(b.test(a))return"reply";return c.inReplyTo||c.references&&c.references.length>0?"reply":[/^notify@/i,/^notification/i,/^alert@/i,/^system@/i].some(a=>a.test(b))?"notification":"new_inquiry"}function W(a){let b=K(a.from),c=L(a.from)??M(b),d=N(a.to),e={};if(a.envelope)try{e=JSON.parse(a.envelope)}catch{}let f=O(a.headers),g={messageId:f["message-id"],inReplyTo:f["in-reply-to"],references:Q(f.references),date:f.date,mailer:f["x-mailer"]||f["user-agent"],listUnsubscribe:f["list-unsubscribe"],autoSubmitted:f["auto-submitted"],autoResponseSuppress:f["x-auto-response-suppress"],precedence:f.precedence,returnPath:f["return-path"],dkimResult:a.dkim,spfResult:a.SPF,raw:f},h=a.spam_score?parseFloat(a.spam_score):void 0,i=S(a.subject,g),j=T(a.subject,b,g),k=U(a.subject,h,g),l=V(a.subject,b,g,k.isSpam,j,i),m=R(void 0,a["attachment-info"]);return{provider:"sendgrid",messageId:g.messageId??J(),from:b,fromName:c,to:d.length>0?d:e.to??[],subject:a.subject,textBody:a.text,htmlBody:a.html,attachments:m,headers:g,emailType:l,threadId:P(g),spamScore:k.score,isSpam:k.isSpam,isAutoReply:i,isBounce:j,timestamp:g.date?new Date(g.date):void 0,rawPayload:a}}function X(a){let b,c=K(a.sender||a.from||""),d=L(a.from||a.sender||"")??M(c),e=N(a.recipient),f=function(a){if(!a)return{};try{let b=JSON.parse(a);if(Array.isArray(b)){let a={};for(let[c,d]of b)"string"==typeof c&&"string"==typeof d&&(a[c.toLowerCase()]=d);return a}}catch{}return{}}(a["message-headers"]),g={messageId:a["Message-Id"]||f["message-id"],inReplyTo:a["In-Reply-To"]||f["in-reply-to"],references:Q(a.References||f.references),date:a.Date||f.date,mailer:f["x-mailer"]||f["user-agent"],listUnsubscribe:f["list-unsubscribe"],autoSubmitted:f["auto-submitted"],autoResponseSuppress:f["x-auto-response-suppress"],precedence:f.precedence,returnPath:f["return-path"],dkimResult:a["X-Mailgun-Dkim-Check-Result"],spfResult:a["X-Mailgun-Spf"],raw:f},h=a["X-Mailgun-Sscore"]?parseFloat(a["X-Mailgun-Sscore"]):void 0,i=a["X-Mailgun-Sflag"]?.toLowerCase()==="yes",j=S(a.subject,g),k=T(a.subject,c,g),l=U(a.subject,h,g),m=V(a.subject,c,g,i||l.isSpam,k,j),n=R(a.attachments);return a.timestamp?b=new Date(1e3*("string"==typeof a.timestamp?parseInt(a.timestamp,10):a.timestamp)):g.date&&(b=new Date(g.date)),{provider:"mailgun",messageId:g.messageId??J(),from:c,fromName:d,to:e,subject:a.subject,textBody:a["stripped-text"]||a["body-plain"],htmlBody:a["stripped-html"]||a["body-html"],attachments:n,headers:g,emailType:m,threadId:P(g),spamScore:l.score,isSpam:i||l.isSpam,isAutoReply:j,isBounce:k,timestamp:b,rawPayload:a}}function Y(a){let b,c=a.from||a.sender||a.from_email||a.fromEmail||"",d=K(c),e=L(c)??M(d),f=N(a.to||a.recipient||a.recipients||a.to_email||a.toEmail),g=a.subject||a.title||"",h=a.text||a.body||a.text_body||a.textBody||a["body-plain"]||a.plain||a.content||"",i=a.html||a.html_body||a.htmlBody||a["body-html"],j=a.message_id||a.messageId||a["Message-Id"]||a.id||J(),k=O(a.headers),l={messageId:j,inReplyTo:k["in-reply-to"],references:Q(k.references),date:k.date,mailer:k["x-mailer"]||k["user-agent"],listUnsubscribe:k["list-unsubscribe"],autoSubmitted:k["auto-submitted"],autoResponseSuppress:k["x-auto-response-suppress"],precedence:k.precedence,returnPath:k["return-path"],raw:k},m=a.spam_score||a.spamScore,n=void 0!==m?"string"==typeof m?parseFloat(m):m:void 0,o=S(g,l),p=T(g,d,l),q=U(g,n,l),r=V(g,d,l,q.isSpam,p,o),s=R(a.attachments);return a.timestamp?b=a.timestamp instanceof Date?a.timestamp:new Date("number"==typeof a.timestamp?1e3*a.timestamp:a.timestamp):a.date&&(b=a.date instanceof Date?a.date:new Date(a.date)),{provider:"generic",messageId:j,from:d,fromName:e,to:f,subject:g,textBody:h,htmlBody:i,attachments:s,headers:l,emailType:r,threadId:P(l),spamScore:q.score,isSpam:q.isSpam,isAutoReply:o,isBounce:p,timestamp:b,rawPayload:a}}class Z extends f{constructor(a={}){super(a),this.emailStats={totalEmails:0,byType:new Map,byProvider:new Map,skippedSpam:0,skippedBounces:0,skippedAutoReplies:0,skippedBlockedDomain:0},this.skipSpam=a.skipSpam??!1,this.skipBounces=a.skipBounces??!1,this.skipAutoReplies=a.skipAutoReplies??!1,this.spamThreshold=a.spamThreshold??F.scoreThreshold,this.allowedDomains=new Set((a.allowedDomains??[]).map(a=>a.toLowerCase())),this.blockedDomains=new Set((a.blockedDomains??[]).map(a=>a.toLowerCase()))}getSource(){return h.nm.EMAIL}validate(a){let b,c=[],d=[];if("object"!=typeof a||null===a)return{isValid:!1,errors:["Input must be a non-null object"],warnings:[]};let e=A.safeParse(a),f=B.safeParse(a),g=C.safeParse(a);return e.success||f.success||g.success?(e.success?b=e.data:f.success?b=f.data:g.success&&(b=g.data),a.subject||a.title||d.push("Email has no subject line"),a.text||a.body||a["body-plain"]||a.content||d.push("Email has no text body"),{isValid:!0,errors:[],warnings:d,sanitizedInput:b}):(a.from||a.sender||a.from_email||a.fromEmail||c.push("Missing sender email address (from, sender, from_email, or fromEmail field)"),a.to||a.recipient||a.recipients||a.to_email||a.toEmail||c.push("Missing recipient email address (to, recipient, recipients, to_email, or toEmail field)"),0===c.length&&c.push("Invalid email webhook payload format"),{isValid:!1,errors:c,warnings:d})}async handleInput(a){let b=Date.now();return this.processWithErrorHandling(a,async()=>{let c=this.detectAndParseEmail(a);this.updateEmailStats(c);let d=this.shouldSkipEmail(c);if(d){this.logger.info(`Skipping email: ${d}`,{from:c.from,subject:c.subject,emailType:c.emailType});let a=this.createAgentInput(c);return this.createSuccessResult(a,void 0,b)}let e=this.createAgentInput(c),f=this.createEventPayload(c,e.correlationId),g=await this.emitEvent("email:received",f,e.correlationId);return this.logger.info("Email processed successfully",{messageId:c.messageId,from:c.from,emailType:c.emailType,threadId:c.threadId,correlationId:e.correlationId}),this.createSuccessResult(e,{type:"email:received",result:g},b)})}async handleSendGridEmail(a){let b=A.safeParse(a);if(!b.success)return{success:!1,input:this.normalizeInput(a,"validation_error"),error:Error(`Invalid SendGrid payload: ${b.error.message}`),processingTimeMs:0};let c=W(b.data);return this.processEmail(c)}async handleMailgunEmail(a){let b=B.safeParse(a);if(!b.success)return{success:!1,input:this.normalizeInput(a,"validation_error"),error:Error(`Invalid Mailgun payload: ${b.error.message}`),processingTimeMs:0};let c=X(b.data);return this.processEmail(c)}async handleGenericEmail(a){let b=C.safeParse(a);if(!b.success)return{success:!1,input:this.normalizeInput(a,"validation_error"),error:Error(`Invalid email payload: ${b.error.message}`),processingTimeMs:0};let c=Y(b.data);return this.processEmail(c)}detectAndParseEmail(a){if(void 0!==a.envelope||a.from&&a.to&&void 0!==a.dkim){let b=A.safeParse(a);if(b.success)return W(b.data)}if(void 0!==a.sender&&void 0!==a.recipient){let b=B.safeParse(a);if(b.success)return X(b.data)}return Y(a)}async processEmail(a){let b=Date.now();this.updateEmailStats(a);let c=this.shouldSkipEmail(a);if(c){this.logger.info(`Skipping email: ${c}`,{from:a.from,subject:a.subject,emailType:a.emailType});let d=this.createAgentInput(a);return this.createSuccessResult(d,void 0,b)}let d=this.createAgentInput(a),e=this.createEventPayload(a,d.correlationId),f=await this.emitEvent("email:received",e,d.correlationId);return this.logger.info("Email processed successfully",{messageId:a.messageId,from:a.from,emailType:a.emailType,threadId:a.threadId,correlationId:d.correlationId}),this.createSuccessResult(d,{type:"email:received",result:f},b)}shouldSkipEmail(a){if(this.skipSpam&&a.isSpam)return this.emailStats.skippedSpam++,"spam detected";if(void 0!==a.spamScore&&a.spamScore>=this.spamThreshold)return this.emailStats.skippedSpam++,`spam score ${a.spamScore} exceeds threshold ${this.spamThreshold}`;if(this.skipBounces&&a.isBounce)return this.emailStats.skippedBounces++,"bounce email";if(this.skipAutoReplies&&a.isAutoReply)return this.emailStats.skippedAutoReplies++,"auto-reply";if(this.allowedDomains.size>0){let b=a.from.split("@")[1]?.toLowerCase();if(b&&!this.allowedDomains.has(b))return this.emailStats.skippedBlockedDomain++,`sender domain ${b} not in allowed list`}if(this.blockedDomains.size>0){let b=a.from.split("@")[1]?.toLowerCase();if(b&&this.blockedDomains.has(b))return this.emailStats.skippedBlockedDomain++,`sender domain ${b} is blocked`}return null}createAgentInput(a){let b={senderEmail:a.from,senderName:a.fromName,emailType:a.emailType,threadId:a.threadId,messageId:a.messageId,isSpam:a.isSpam,isAutoReply:a.isAutoReply,isBounce:a.isBounce,spamScore:a.spamScore,hasAttachments:a.attachments.length>0,attachmentCount:a.attachments.length,provider:a.provider};return this.normalizeInput(a.rawPayload,`email_${a.emailType}`,{metadata:{...b,tags:[a.emailType,a.provider,...a.isSpam?["spam"]:[],...a.isAutoReply?["auto-reply"]:[],...a.isBounce?["bounce"]:[],...a.threadId?["thread"]:["new"]],relatedEntityIds:a.threadId?{threadId:a.threadId,messageId:a.messageId}:{messageId:a.messageId},priorityHint:this.calculatePriority(a)}})}createEventPayload(a,b){return{id:a.messageId,timestamp:a.timestamp??new Date,source:h.nm.EMAIL,orgId:this.orgId,metadata:{provider:a.provider,emailType:a.emailType,threadId:a.threadId,isSpam:a.isSpam,isAutoReply:a.isAutoReply,isBounce:a.isBounce,spamScore:a.spamScore,correlationId:b},emailId:a.messageId,from:a.from,to:a.to,subject:a.subject,body:a.textBody,attachments:a.attachments.map(a=>({filename:a.filename,contentType:a.contentType,size:a.size}))}}calculatePriority(a){let b=3;if(a.isSpam)return 1;if(a.isBounce||a.isAutoReply)return 2;if("newsletter"===a.emailType)return 1;for(let c of[/urgent/i,/asap/i,/emergency/i,/critical/i,/important/i,/priority/i,/time.?sensitive/i])c.test(a.subject)&&(b=Math.min(b+1,5));return"reply"===a.emailType&&(b=Math.min(b+1,5)),b}updateEmailStats(a){this.emailStats.totalEmails++;let b=this.emailStats.byType.get(a.emailType)??0;this.emailStats.byType.set(a.emailType,b+1);let c=this.emailStats.byProvider.get(a.provider)??0;this.emailStats.byProvider.set(a.provider,c+1)}determineInputType(a){return"email_received"}getEmailStats(){return{totalEmails:this.emailStats.totalEmails,byType:Object.fromEntries(this.emailStats.byType),byProvider:Object.fromEntries(this.emailStats.byProvider),skippedSpam:this.emailStats.skippedSpam,skippedBounces:this.emailStats.skippedBounces,skippedAutoReplies:this.emailStats.skippedAutoReplies,skippedBlockedDomain:this.emailStats.skippedBlockedDomain}}resetEmailStats(){this.emailStats={totalEmails:0,byType:new Map,byProvider:new Map,skippedSpam:0,skippedBounces:0,skippedAutoReplies:0,skippedBlockedDomain:0}}static parseEmailAddress(a){let b=K(a),c=L(a),[d="",e=""]=b.split("@");return{email:b,name:c,domain:e,localPart:d}}static isNoReplyAddress(a){return[/^no-?reply/i,/^do-?not-?reply/i,/^noreply/i,/^mailer-?daemon/i,/^postmaster/i,/^bounce/i].some(b=>b.test(a))}static cleanSubject(a){let b=[/^(re|aw|sv|antw|r|rif|res):\s*/i,/^(fwd?|fw|wg|vs|tr|i|rv|enc):\s*/i],c=a.trim(),d=!0;for(;d;)for(let a of(d=!1,b)){let b=c.replace(a,"");b!==c&&(c=b,d=!0)}return c.trim()}}},97845:(a,b,c)=>{function d(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}c.d(b,{io:()=>g});let e="undefined"!=typeof process&&!1,f={debug:(a,b)=>{e&&console.debug(`[EventBus] ${a}`,b??"")},info:(a,b)=>{console.info(`[EventBus] ${a}`,b??"")},warn:(a,b)=>{console.warn(`[EventBus] ${a}`,b??"")},error:(a,b,c)=>{console.error(`[EventBus] ${a}`,b,c??"")}};class g{static{this.instance=null}constructor(a={}){this.subscriptions=new Map,this.eventHistory=[],this.historySize=a.historySize??100,this.logger=a.logger??f,this.debug=a.debug??!1,this.defaultOrgId=a.defaultOrgId,this.stats={totalEventsEmitted:0,totalHandlersInvoked:0,totalErrors:0,eventCounts:new Map},this.logger.info("EventBus initialized",{historySize:this.historySize})}static getInstance(a){return g.instance||(g.instance=new g(a)),g.instance}static resetInstance(){g.instance&&(g.instance.removeAllListeners(),g.instance=null)}on(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!1}),this.debug&&this.logger.debug(`Handler registered for event "${a}"`,{subscriptionId:c}),c}once(a,b){let c=this.generateSubscriptionId();return this.subscriptions.has(a)||this.subscriptions.set(a,new Map),this.subscriptions.get(a).set(c,{eventType:a,handler:b,subscriptionId:c,once:!0}),this.debug&&this.logger.debug(`Once handler registered for event "${a}"`,{subscriptionId:c}),c}onAny(a){let b=this.generateSubscriptionId();return this.subscriptions.has("*")||this.subscriptions.set("*",new Map),this.subscriptions.get("*").set(b,{eventType:"*",handler:a,subscriptionId:b,once:!1}),this.debug&&this.logger.debug("Wildcard handler registered",{subscriptionId:b}),b}off(a){for(let[,b]of this.subscriptions)if(b.has(a))return b.delete(a),this.debug&&this.logger.debug("Handler removed",{subscriptionId:a}),!0;return!1}removeAllListeners(a){a?(this.subscriptions.delete(a),this.logger.info(`All handlers removed for event "${a}"`)):(this.subscriptions.clear(),this.logger.info("All handlers removed"))}async emit(a,b,c){let e=d(),f=new Date,g=[],h=[],i={type:a,payload:b,timestamp:f,source:c?.source??"system",eventId:e,correlationId:c?.correlationId,orgId:c?.orgId??this.defaultOrgId,metadata:c?.metadata};this.stats.totalEventsEmitted++,this.stats.eventCounts.set(a,(this.stats.eventCounts.get(a)??0)+1),this.debug&&this.logger.debug(`Emitting event "${a}"`,{eventId:e,source:i.source});let j=[],k=this.subscriptions.get(a);if(k)for(let a of k.values())j.push(a);let l=this.subscriptions.get("*");if(l)for(let a of l.values())j.push(a);let m=[],n=j.map(async b=>{let c=Date.now();try{return await b.handler(i),this.stats.totalHandlersInvoked++,b.once&&m.push(b.subscriptionId),{subscriptionId:b.subscriptionId,success:!0,executionTimeMs:Date.now()-c}}catch(f){let d=f instanceof Error?f:Error(String(f));return this.stats.totalErrors++,this.logger.error(`Handler ${b.subscriptionId} failed for event "${a}"`,d,{eventId:e,subscriptionId:b.subscriptionId}),{subscriptionId:b.subscriptionId,success:!1,error:d,executionTimeMs:Date.now()-c}}}),o=await Promise.all(n);for(let a of m)this.off(a);for(let a of o)g.push(a),a.error&&h.push(a.error);return this.addToHistory(i,g.length,h.map(a=>a.message)),this.debug&&this.logger.debug(`Event "${a}" processing complete`,{eventId:e,handlersInvoked:g.length,successCount:g.filter(a=>a.success).length,errorCount:h.length}),{eventType:a,eventId:e,timestamp:f,handlersInvoked:g.length,results:g,errors:h}}emitSync(a,b,c){this.emit(a,b,c).catch(b=>{this.logger.error(`Sync emit failed for event "${a}"`,b)})}getHistory(a,b){let c=[...this.eventHistory];if(a){let b=Array.isArray(a)?a:[a];c=c.filter(a=>b.includes(a.event.type))}return b&&b>0&&(c=c.slice(-b)),c}async replay(a){this.logger.info(`Replaying ${a.length} events`);let b=[];for(let c of a){let a=await this.emit(c.event.type,c.event.payload,{source:c.event.source,correlationId:c.event.correlationId,orgId:c.event.orgId,metadata:{...c.event.metadata,replayed:!0,originalEventId:c.event.eventId,originalTimestamp:c.event.timestamp.toISOString()}});b.push(a)}return b}clearHistory(){this.eventHistory=[],this.logger.info("Event history cleared")}getStats(){let a={};for(let[b,c]of this.stats.eventCounts)a[b]=c;let b={};for(let[a,c]of this.subscriptions)b[a]=c.size;return{totalEventsEmitted:this.stats.totalEventsEmitted,totalHandlersInvoked:this.stats.totalHandlersInvoked,totalErrors:this.stats.totalErrors,eventCounts:a,subscriptionCounts:b,historySize:this.eventHistory.length}}listenerCount(a){let b=this.subscriptions.get(a),c=this.subscriptions.get("*");return(b?.size??0)+(c?.size??0)}eventNames(){let a=[];for(let b of this.subscriptions.keys())"*"!==b&&a.push(b);return a}getSubscriptions(){let a=[];for(let b of this.subscriptions.values())for(let c of b.values())a.push(c);return a}generateSubscriptionId(){return`sub_${d().slice(0,8)}`}addToHistory(a,b,c){let e={id:a.eventId??d(),event:a,timestamp:new Date,processed:!0,handlersInvoked:b,errors:c?.length?c:void 0};this.eventHistory.push(e),this.eventHistory.length>this.historySize&&(this.eventHistory=this.eventHistory.slice(-this.historySize))}}}};