"use strict";exports.id=3437,exports.ids=[3437],exports.modules={12740:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{xP:()=>i});var e=c(15718),f=c(21406),g=c(70609),h=a([e,f]);[e,f]=h.then?(await h)():h;let j=["gpt-4","gpt-4-turbo","gpt-4-turbo-preview","gpt-4o","gpt-4o-mini","gpt-3.5-turbo"],k=["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307","claude-sonnet-4-20250514","claude-3-5-sonnet-20241022"];function i(a){console.log(`[LLMFactory] Creating ${a.provider} client with model: ${a.model}`),function(a,b){if(a===g.Dd.OPENAI&&!j.includes(b))throw new g.qx(`Model '${b}' is not a valid OpenAI model. Valid models: ${j.join(", ")}`,"INVALID_MODEL",a,400,!1);if(a===g.Dd.CLAUDE&&!k.includes(b))throw new g.qx(`Model '${b}' is not a valid Claude model. Valid models: ${k.join(", ")}`,"INVALID_MODEL",a,400,!1)}(a.provider,a.model);let b={...function(){let a=process.env.AGENT_DEFAULT_PROVIDER?.toUpperCase();return{defaultProvider:"OPENAI"===a?g.Dd.OPENAI:g.Dd.CLAUDE,defaultModels:{[g.Dd.OPENAI]:process.env.AGENT_DEFAULT_OPENAI_MODEL||"gpt-4-turbo",[g.Dd.CLAUDE]:process.env.AGENT_DEFAULT_CLAUDE_MODEL||"claude-sonnet-4-20250514"},defaultOptions:{temperature:parseFloat(process.env.AGENT_DEFAULT_TEMPERATURE||"0.3"),maxTokens:parseInt(process.env.AGENT_DEFAULT_MAX_TOKENS||"2000",10),timeout:parseInt(process.env.AGENT_DEFAULT_TIMEOUT||"30000",10)}}}().defaultOptions,...a.defaultOptions};if(a.provider===g.Dd.OPENAI){let c={model:a.model,apiKey:a.apiKey,defaultOptions:b,maxRetries:a.maxRetries,retryBaseDelay:a.retryBaseDelay,organizationId:a.organizationId,baseUrl:a.baseUrl,jsonMode:a.jsonMode};return console.log("[LLMFactory] Creating OpenAI client"),new e.g(c)}if(a.provider===g.Dd.CLAUDE){let c={model:a.model,apiKey:a.apiKey,defaultOptions:b,maxRetries:a.maxRetries,retryBaseDelay:a.retryBaseDelay,baseUrl:a.baseUrl,maxTokensToSample:a.maxTokensToSample};return console.log("[LLMFactory] Creating Claude client"),new f.U(c)}throw new g.qx(`Unknown provider: ${a.provider}`,"INVALID_PROVIDER",a.provider,400,!1)}d()}catch(a){d(a)}})},15718:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{g:()=>k});var e=c(87984),f=c(18263),g=c(70609),h=a([e]);function i(a){let b=a??process.env.OPENAI_API_KEY;if(!b)throw new g.uE(g.Dd.OPENAI);return b}e=(h.then?(await h)():h)[0];let j=["gpt-4-turbo","gpt-4-turbo-preview","gpt-4o","gpt-4o-mini","gpt-3.5-turbo"];class k extends f.W{constructor(a){super(a),this.provider=g.Dd.OPENAI;let b=i(a.apiKey);this.openai=new e.default({apiKey:b,organization:a.organizationId,baseURL:a.baseUrl,timeout:a.defaultOptions?.timeout??3e4,maxRetries:0}),this.jsonModeEnabled=a.jsonMode??!1,console.log(`[OpenAIClient] Initialized with model: ${this.model}`),console.log(`[OpenAIClient] JSON mode: ${this.jsonModeEnabled?"enabled":"disabled"}`),console.log(`[OpenAIClient] Organization: ${a.organizationId??"default"}`)}isReady(){try{return i(this.config.apiKey),!0}catch{return!1}}async _complete(a,b){console.log("[OpenAIClient] Sending request to OpenAI API"),console.log(`[OpenAIClient] Model: ${this.model}, Messages: ${a.length}`);try{let c=this.mapToOpenAIMessages(a),d=this.shouldUseJsonMode(a),e={model:this.model,messages:c,temperature:b.temperature,max_tokens:b.maxTokens,top_p:b.topP,presence_penalty:b.presencePenalty,frequency_penalty:b.frequencyPenalty,stop:b.stopSequences,user:b.user};d&&this.supportsJsonMode()&&(e.response_format={type:"json_object"},console.log("[OpenAIClient] Using JSON mode"));let f=Date.now(),h=await this.openai.chat.completions.create(e),i=Date.now()-f;console.log(`[OpenAIClient] Received response in ${i}ms`);let j=h.choices[0];if(!j)throw new g.qx("No completion choice returned from OpenAI","NO_COMPLETION",g.Dd.OPENAI,500);if("content_filter"===j.finish_reason)throw new g.W9("Response was filtered due to content policy",g.Dd.OPENAI);let k=this.mapFinishReason(j.finish_reason),l={id:h.id,content:j.message.content??"",model:h.model,finishReason:k,usage:{promptTokens:h.usage?.prompt_tokens??0,completionTokens:h.usage?.completion_tokens??0,totalTokens:h.usage?.total_tokens??0},latencyMs:i};return console.log(`[OpenAIClient] Completion ID: ${l.id}`),console.log(`[OpenAIClient] Finish reason: ${l.finishReason}`),console.log(`[OpenAIClient] Tokens: ${l.usage?.totalTokens??"unknown"}`),l}catch(a){throw console.log(`[OpenAIClient] Error during completion: ${a.message}`),this.normalizeError(a)}}async completeWithJSON(a,b,c){if(console.log("[OpenAIClient] Starting JSON completion"),this.supportsJsonMode()){console.log("[OpenAIClient] Using native JSON mode");let d=this.addJSONInstructionForOpenAI(a,b),e=await this._complete(d,{...this.config.defaultOptions,...c});return this.parseAndValidate(e.content,b)}return super.completeWithJSON(a,b,c)}normalizeError(a){if(a instanceof g.qx)return a;if(a instanceof e.default.APIError){let b=a.status,c=a.message;if(console.log(`[OpenAIClient] API error - Status: ${b}, Message: ${c}`),429===b){let b=this.extractRetryAfter(a);return new g.OE(c,g.Dd.OPENAI,b,a)}return 401===b?new g.v3(c,g.Dd.OPENAI,a):403===b?new g.v3("Invalid API key or insufficient permissions",g.Dd.OPENAI,a):503===b?new g.z3(g.Dd.OPENAI,void 0,a):400===b?new g.qx(c,"BAD_REQUEST",g.Dd.OPENAI,400,!1,a):b&&b>=500?new g.qx(c,"SERVER_ERROR",g.Dd.OPENAI,b,!0,a):new g.qx(c,"API_ERROR",g.Dd.OPENAI,b,!1,a)}return a instanceof e.default.APIConnectionError?new g.qx(a.message,"CONNECTION_ERROR",g.Dd.OPENAI,void 0,!0,a):a instanceof e.default.RateLimitError?new g.OE(a.message,g.Dd.OPENAI,void 0,a):new g.qx(a.message,"UNKNOWN_ERROR",g.Dd.OPENAI,void 0,!1,a)}getJSONModeInstruction(a){return this.supportsJsonMode()?`

You must respond with a JSON object. ${a}`:super.getJSONModeInstruction(a)}mapToOpenAIMessages(a){return a.map(a=>({role:a.role,content:a.content,name:a.name}))}supportsJsonMode(){return j.includes(this.model)}shouldUseJsonMode(a){if(!this.jsonModeEnabled)return!1;let b=["json","JSON","structured","object"];return a.some(a=>b.some(b=>a.content.includes(b)))}addJSONInstructionForOpenAI(a,b){let c=this.getSchemaDescriptionForOpenAI(b),d=[...a],e=d.findIndex(a=>"system"===a.role),f=`

You MUST respond with valid JSON only. The JSON must conform to this schema:
${c}`;return e>=0?d[e]={...d[e],content:d[e].content+f}:d.unshift({role:"system",content:`You are a helpful assistant that always responds with valid JSON.${f}`}),d}getSchemaDescriptionForOpenAI(a){try{if(a._def&&a._def.shape){let b=a._def.shape(),c=Object.entries(b).map(([a,b])=>{let c=this.getZodTypeName(b);return`  "${a}": ${c}`});return`{
${c.join(",\n")}
}`}}catch{}return"{ ... }"}getZodTypeName(a){switch(a._def?.typeName){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodArray":return"array";case"ZodObject":return"object";case"ZodOptional":return`${this.getZodTypeName(a._def.innerType)} (optional)`;default:return"any"}}parseAndValidate(a,b){let c,d=a.trim(),e=d.match(/```(?:json)?\s*([\s\S]*?)\s*```/);e&&(d=e[1].trim());try{c=JSON.parse(d)}catch(a){throw console.log(`[OpenAIClient] Failed to parse JSON: ${a.message}`),new g.qx(`Failed to parse response as JSON: ${a.message}`,"JSON_PARSE_ERROR",g.Dd.OPENAI,void 0,!1)}let f=b.safeParse(c);if(!f.success)throw console.log(`[OpenAIClient] Schema validation failed: ${f.error.message}`),new g.qx(`Response does not match expected schema: ${f.error.message}`,"SCHEMA_VALIDATION_ERROR",g.Dd.OPENAI,void 0,!1);return f.data}mapFinishReason(a){switch(a){case"stop":default:return"stop";case"length":return"length";case"content_filter":return"content_filter";case"tool_calls":case"function_call":return"tool_calls"}}extractRetryAfter(a){let b=a.headers;if(b&&"function"==typeof b.get){let a=b.get("retry-after");if(a){let b=parseInt(a,10);if(!isNaN(b))return 1e3*b}}return 6e4}}d()}catch(a){d(a)}})},18263:(a,b,c)=>{c.d(b,{W:()=>e});var d=c(70609);class e{constructor(a){this.RATE_LIMIT_WINDOW_MS=6e4,this.MAX_REQUESTS_PER_WINDOW=60,this.MAX_TOKENS_PER_WINDOW=1e5,this.model=a.model,this.config={...d.VN,model:a.model,apiKey:a.apiKey,defaultOptions:a.defaultOptions,organizationId:a.organizationId,baseUrl:a.baseUrl,maxRetries:a.maxRetries??d.VN.maxRetries,retryBaseDelay:a.retryBaseDelay??d.VN.retryBaseDelay},this.defaultOptions={temperature:a.defaultOptions?.temperature??d.Ls.temperature,maxTokens:a.defaultOptions?.maxTokens??d.Ls.maxTokens,timeout:a.defaultOptions?.timeout??d.Ls.timeout},this.rateLimiter={requestTimestamps:[],tokensUsed:0,windowStartTime:Date.now()},console.log(`[LLMClient] Initialized client with model: ${this.model}`)}async complete(a,b){let c,d=Date.now(),e=this.generateRequestId();console.log(`[LLMClient] [${e}] Starting completion request`),console.log(`[LLMClient] [${e}] Messages: ${a.length}, Model: ${this.model}`),this.validateMessages(a),await this.checkRateLimit(e);let f=this.mergeOptions(b),g=0;for(;g<=this.config.maxRetries;)try{g>0&&console.log(`[LLMClient] [${e}] Retry attempt ${g}/${this.config.maxRetries}`);let b=await this.executeWithTimeout(()=>this._complete(a,f),f.timeout??this.defaultOptions.timeout,e);this.updateRateLimiter(b.usage);let c=Date.now()-d;return b.latencyMs=c,console.log(`[LLMClient] [${e}] Completed successfully in ${c}ms`),console.log(`[LLMClient] [${e}] Tokens used: ${b.usage?.totalTokens??"unknown"}`),b}catch(b){if(c=b,g++,!this.shouldRetry(b,g)){console.log(`[LLMClient] [${e}] Error is not retryable, throwing`);break}let a=this.calculateBackoffDelay(g,b);console.log(`[LLMClient] [${e}] Waiting ${a}ms before retry`),await this.sleep(a)}let h=Date.now()-d;throw console.log(`[LLMClient] [${e}] Failed after ${g} attempts in ${h}ms`),this.normalizeError(c)}async completeWithJSON(a,b,c){let d=this.generateRequestId();console.log(`[LLMClient] [${d}] Starting JSON completion request`);let e=this.addJSONInstruction(a,b),f=await this.complete(e,c),g=this.parseJSON(f.content,b,d);return console.log(`[LLMClient] [${d}] JSON parsing and validation successful`),g}getRateLimitStatus(){this.cleanupRateLimiter();let a=this.rateLimiter.requestTimestamps.length,b=a>=this.MAX_REQUESTS_PER_WINDOW||this.rateLimiter.tokensUsed>=this.MAX_TOKENS_PER_WINDOW,c=Math.max(0,(this.rateLimiter.requestTimestamps[0]??Date.now())+this.RATE_LIMIT_WINDOW_MS-Date.now());return{isLimited:b,requestsInWindow:a,maxRequestsPerWindow:this.MAX_REQUESTS_PER_WINDOW,resetInMs:c,tokensUsedInWindow:this.rateLimiter.tokensUsed}}normalizeError(a){return a instanceof d.qx?a:new d.qx(a.message,"UNKNOWN_ERROR",this.provider,void 0,!1,a)}getJSONModeInstruction(a){return`

IMPORTANT: You MUST respond with valid JSON only. No explanations, no markdown formatting, just raw JSON.

Expected JSON structure:
${a}`}validateMessages(a){if(!a||0===a.length)throw new d.yI("Messages array cannot be empty",this.provider);for(let b of a){let a=d.n$.safeParse(b);if(!a.success)throw new d.yI(`Invalid message format: ${a.error.message}`,this.provider,a.error)}}async checkRateLimit(a){this.cleanupRateLimiter();let b=this.getRateLimitStatus();b.isLimited&&(console.log(`[LLMClient] [${a}] Rate limit reached, waiting ${b.resetInMs}ms`),b.resetInMs>0&&(await this.sleep(b.resetInMs),this.cleanupRateLimiter())),this.rateLimiter.requestTimestamps.push(Date.now())}updateRateLimiter(a){a&&(this.rateLimiter.tokensUsed+=a.totalTokens)}cleanupRateLimiter(){let a=Date.now()-this.RATE_LIMIT_WINDOW_MS;this.rateLimiter.requestTimestamps=this.rateLimiter.requestTimestamps.filter(b=>b>a),Date.now()-this.rateLimiter.windowStartTime>this.RATE_LIMIT_WINDOW_MS&&(this.rateLimiter.tokensUsed=0,this.rateLimiter.windowStartTime=Date.now())}mergeOptions(a){return{...this.defaultOptions,...this.config.defaultOptions,...a}}async executeWithTimeout(a,b,c){let e=new Promise((a,c)=>{setTimeout(()=>{c(new d.MU(this.provider,b))},b)});return Promise.race([a(),e])}shouldRetry(a,b){if(b>this.config.maxRetries)return!1;if(a instanceof d.qx)return a.retryable;let c=a.message.toLowerCase();return!!(c.includes("network")||c.includes("econnreset")||c.includes("socket")||c.includes("timeout"))}calculateBackoffDelay(a,b){if(b instanceof d.OE&&b.retryAfterMs)return b.retryAfterMs;let c=this.config.retryBaseDelay*Math.pow(2,a-1),e=.1*Math.random()*c;return Math.min(c+e,6e4)}addJSONInstruction(a,b){let c=this.getSchemaDescription(b),d=this.getJSONModeInstruction(c),e=[...a],f=e.findIndex(a=>"system"===a.role);return f>=0?e[f]={...e[f],content:e[f].content+d}:e.unshift({role:"system",content:`You are a helpful assistant that responds in JSON format.${d}`}),e}getSchemaDescription(a){try{if(a._def&&a._def.shape){let b=a._def.shape(),c=Object.keys(b);return`{
${c.map(a=>`  "${a}": ...`).join(",\n")}
}`}}catch{}return"{ ... }"}parseJSON(a,b,c){let e,f=a.trim(),g=f.match(/```(?:json)?\s*([\s\S]*?)\s*```/);g&&(f=g[1].trim());try{e=JSON.parse(f)}catch(b){throw console.log(`[LLMClient] [${c}] Failed to parse JSON: ${b.message}`),console.log(`[LLMClient] [${c}] Raw content: ${a.substring(0,500)}...`),new d.yI(`Failed to parse LLM response as JSON: ${b.message}`,this.provider)}let h=b.safeParse(e);if(!h.success)throw console.log(`[LLMClient] [${c}] JSON validation failed: ${h.error.message}`),new d.yI(`LLM response does not match expected schema: ${h.error.message}`,this.provider,h.error);return h.data}generateRequestId(){return`${this.provider}-${Date.now()}-${Math.random().toString(36).substring(2,8)}`}sleep(a){return new Promise(b=>setTimeout(b,a))}}},21406:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{U:()=>j});var e=c(50832),f=c(18263),g=c(70609),h=a([e]);function i(a){let b=a??process.env.ANTHROPIC_API_KEY;if(!b)throw new g.uE(g.Dd.CLAUDE);return b}e=(h.then?(await h)():h)[0];class j extends f.W{constructor(a){super(a),this.provider=g.Dd.CLAUDE;let b=i(a.apiKey);this.anthropic=new e.default({apiKey:b,baseURL:a.baseUrl,timeout:a.defaultOptions?.timeout??3e4,maxRetries:0}),this.maxTokensToSample=a.maxTokensToSample??4096,console.log(`[ClaudeClient] Initialized with model: ${this.model}`),console.log(`[ClaudeClient] Max tokens to sample: ${this.maxTokensToSample}`)}isReady(){try{return i(this.config.apiKey),!0}catch{return!1}}async _complete(a,b){console.log("[ClaudeClient] Sending request to Anthropic API"),console.log(`[ClaudeClient] Model: ${this.model}, Messages: ${a.length}`);try{let{systemMessage:c,conversationMessages:d}=this.separateSystemMessage(a),e=this.mapToAnthropicMessages(d),f={model:this.model,max_tokens:b.maxTokens??this.maxTokensToSample,messages:e,system:c,temperature:b.temperature,top_p:b.topP,stop_sequences:b.stopSequences,metadata:b.user?{user_id:b.user}:void 0},g=Date.now(),h=await this.anthropic.messages.create(f),i=Date.now()-g;console.log(`[ClaudeClient] Received response in ${i}ms`);let j=this.extractTextContent(h);"max_tokens"===h.stop_reason&&console.log("[ClaudeClient] Warning: Response truncated due to max_tokens");let k=this.mapFinishReason(h.stop_reason),l={id:h.id,content:j,model:h.model,finishReason:k,usage:{promptTokens:h.usage.input_tokens,completionTokens:h.usage.output_tokens,totalTokens:h.usage.input_tokens+h.usage.output_tokens},latencyMs:i};return console.log(`[ClaudeClient] Response ID: ${l.id}`),console.log(`[ClaudeClient] Stop reason: ${l.finishReason}`),console.log(`[ClaudeClient] Tokens: ${l.usage?.totalTokens}`),l}catch(a){throw console.log(`[ClaudeClient] Error during completion: ${a.message}`),this.normalizeError(a)}}async completeWithJSON(a,b,c){console.log("[ClaudeClient] Starting JSON completion with tool use");try{var d;let{systemMessage:e,conversationMessages:f}=this.separateSystemMessage(a),h=this.mapToAnthropicMessages(f),i=(d=this.extractSchemaProperties(b),{name:"respond_with_json",description:"Use this tool to provide your response in the required JSON format. You MUST use this tool to respond.",input_schema:{type:"object",properties:d,required:Object.keys(d)}}),j=this.buildToolUseSystemMessage(e),k={model:this.model,max_tokens:c?.maxTokens??this.maxTokensToSample,messages:h,system:j,tools:[i],tool_choice:{type:"tool",name:"respond_with_json"},temperature:c?.temperature,top_p:c?.topP},l=Date.now(),m=await this.anthropic.messages.create(k),n=Date.now()-l;console.log(`[ClaudeClient] Tool use response received in ${n}ms`);let o=this.extractToolUseResult(m),p=b.safeParse(o);if(!p.success)throw console.log(`[ClaudeClient] Schema validation failed: ${p.error.message}`),new g.qx(`Response does not match expected schema: ${p.error.message}`,"SCHEMA_VALIDATION_ERROR",g.Dd.CLAUDE,void 0,!1);return console.log("[ClaudeClient] JSON extraction and validation successful"),p.data}catch(d){if(d instanceof g.qx&&"TOOL_USE_FAILED"===d.code)return console.log("[ClaudeClient] Tool use failed, falling back to text extraction"),super.completeWithJSON(a,b,c);throw d}}normalizeError(a){if(a instanceof g.qx)return a;if(a instanceof e.default.APIError){let b=a.status,c=a.message;if(console.log(`[ClaudeClient] API error - Status: ${b}, Message: ${c}`),429===b){let b=this.extractRetryAfter(a);return new g.OE(c,g.Dd.CLAUDE,b,a)}return 401===b?new g.v3(c,g.Dd.CLAUDE,a):403===b?new g.v3("Invalid API key or insufficient permissions",g.Dd.CLAUDE,a):529===b||503===b?new g.z3(g.Dd.CLAUDE,void 0,a):400===b?c.toLowerCase().includes("content")||c.toLowerCase().includes("policy")||c.toLowerCase().includes("filter")?new g.W9(c,g.Dd.CLAUDE,a):new g.qx(c,"BAD_REQUEST",g.Dd.CLAUDE,400,!1,a):b&&b>=500?new g.qx(c,"SERVER_ERROR",g.Dd.CLAUDE,b,!0,a):new g.qx(c,"API_ERROR",g.Dd.CLAUDE,b,!1,a)}return a instanceof e.default.APIConnectionError?new g.qx(a.message,"CONNECTION_ERROR",g.Dd.CLAUDE,void 0,!0,a):a instanceof e.default.RateLimitError?new g.OE(a.message,g.Dd.CLAUDE,void 0,a):new g.qx(a.message,"UNKNOWN_ERROR",g.Dd.CLAUDE,void 0,!1,a)}getJSONModeInstruction(a){return`

IMPORTANT: You MUST respond with valid JSON only. No explanations, no markdown formatting, no code blocks - just the raw JSON object.

Required JSON structure:
${a}`}mapFinishReason(a){switch(a){case"end_turn":case"stop_sequence":default:return"stop";case"max_tokens":return"length";case"tool_use":return"tool_calls"}}separateSystemMessage(a){let b=a.filter(a=>"system"===a.role),c=a.filter(a=>"system"!==a.role);return{systemMessage:b.length>0?b.map(a=>a.content).join("\n\n"):void 0,conversationMessages:c}}mapToAnthropicMessages(a){return a.map(a=>({role:a.role,content:a.content}))}extractTextContent(a){return a.content.filter(a=>"text"===a.type).map(a=>a.text).join("\n")}extractToolUseResult(a){let b=a.content.find(a=>"tool_use"===a.type);if(!b)throw console.log("[ClaudeClient] No tool use block found in response"),new g.qx("Claude did not use the required tool for JSON output","TOOL_USE_FAILED",g.Dd.CLAUDE,void 0,!1);return console.log(`[ClaudeClient] Tool use block found: ${b.name}`),b.input}buildToolUseSystemMessage(a){let b="You MUST use the respond_with_json tool to provide your response. Do not respond with plain text.";return a?`${a}

${b}`:b}extractSchemaProperties(a){try{if(a._def&&a._def.shape){let b=a._def.shape(),c={};for(let[a,d]of Object.entries(b))c[a]=this.zodToJsonSchema(d);return c}}catch{console.log("[ClaudeClient] Failed to extract schema properties, using generic")}return{result:{type:"object",description:"The structured response"}}}zodToJsonSchema(a){switch(a._def?.typeName){case"ZodString":return{type:"string"};case"ZodNumber":return{type:"number"};case"ZodBoolean":return{type:"boolean"};case"ZodArray":{let b=a._def?.type;return{type:"array",items:b?this.zodToJsonSchema(b):{}}}case"ZodObject":{let b=a._def?.shape?.();if(b){let a={};for(let[c,d]of Object.entries(b))a[c]=this.zodToJsonSchema(d);return{type:"object",properties:a,required:Object.keys(a)}}return{type:"object"}}case"ZodOptional":return this.zodToJsonSchema(a._def.innerType);case"ZodEnum":{let b=a._def?.values;return{type:"string",enum:b}}default:return{}}}extractRetryAfter(a){let b=a.headers;if(b&&"function"==typeof b.get){let a=b.get("retry-after");if(a){let b=parseInt(a,10);if(!isNaN(b))return 1e3*b}}return 6e4}}d()}catch(a){d(a)}})},28383:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{D:()=>m});var e=c(70609),f=c(12740),g=c(37289),h=c(75665),i=c(82912),j=c(45600),k=c(48625),l=a([f]);f=(l.then?(await l)():l)[0];let n=["intake:created","intake:updated","intake:escalated","webhook:form_submitted","webhook:booking_requested","email:received","pipeline:stage_changed","calendar:reminder_due","calendar:event_created","calendar:event_updated","calendar:event_cancelled","schedule:triggered"],o={debug:(a,b)=>console.debug(`[OrchestrationAgent] ${a}`,b??""),info:(a,b)=>console.info(`[OrchestrationAgent] ${a}`,b??""),warn:(a,b)=>console.warn(`[OrchestrationAgent] ${a}`,b??""),error:(a,b,c)=>console.error(`[OrchestrationAgent] ${a}`,b,c??"")};class p{constructor(a){this.isRunning=!1,this.startTime=null,this.subscriptionIds=[],this.pendingDecisions=new Map,this.decisionHistory=[],this.rateLimiter={minuteTimestamps:[],hourTimestamps:[]},this.stats={totalDecisions:0,successfulDecisions:0,failedDecisions:0,pendingApprovals:0,totalActionsExecuted:0,totalEventsProcessed:0,totalErrors:0,decisionTimes:[],lastDecisionTime:null},this.orgContextCache=null,this.orgContextCacheTime=null,this.ORG_CONTEXT_CACHE_TTL=3e5,this.config=this.validateAndMergeConfig(a),this.logger=a.logger??o,this.agentId=a.id??`agent-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,this.logger.info("Initializing OrchestrationAgent",{agentId:this.agentId,orgId:this.config.orgId,llmProvider:this.config.llmProvider,llmModel:this.config.llmModel}),this.llmClient=a.llmClient??this.createLLMClient(),this.eventBus=g.io.getInstance(a.eventBusConfig),this.decisionEngine=new h.H({autoExecuteThreshold:this.config.autoExecuteThreshold,requireApprovalThreshold:this.config.requireApprovalThreshold,enabledActions:this.config.enabledActions,enableFallback:!0,logger:this.logger,...a.decisionEngineConfig}),this.actionExecutor=new i.c({dryRun:a.dryRun??!1,orgId:this.config.orgId,logger:this.logger,...a.actionExecutorConfig}),this.logger.info("OrchestrationAgent initialized successfully",{agentId:this.agentId})}start(){if(this.isRunning)return void this.logger.warn("Agent is already running");this.logger.info("Starting OrchestrationAgent",{agentId:this.agentId}),this.isRunning=!0,this.startTime=new Date;let a=this.config.subscribedEvents??n;for(let b of a){let a=this.eventBus.on(b,async a=>{await this.handleEvent(a)});this.subscriptionIds.push(a),this.logger.debug(`Subscribed to event: ${b}`,{subscriptionId:a})}this.logger.info("OrchestrationAgent started",{agentId:this.agentId,subscribedEvents:a.length})}stop(){if(!this.isRunning)return void this.logger.warn("Agent is not running");for(let a of(this.logger.info("Stopping OrchestrationAgent",{agentId:this.agentId}),this.subscriptionIds))this.eventBus.off(a);this.subscriptionIds=[],this.isRunning=!1,this.logger.info("OrchestrationAgent stopped",{agentId:this.agentId,totalDecisions:this.stats.totalDecisions})}isActive(){return this.isRunning}async process(a){let b=Date.now(),c=a.correlationId??`proc-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;if(this.logger.info("Processing input",{source:a.source,type:a.type,correlationId:c}),this.isRateLimited())throw this.logger.warn("Rate limit exceeded, rejecting input"),Error("Rate limit exceeded. Please try again later.");try{let d=await this.buildDecisionContext(a),f=this.buildSystemPrompt(d.org),g=this.buildUserPrompt(a,d),h=await this.makeLLMDecision(f,g),i=this.decisionEngine.processLLMResponse(h,d),j=Date.now()-b;if(this.stats.decisionTimes.push(j),this.stats.lastDecisionTime=new Date,this.stats.totalDecisions++,this.recordRateLimitAction(),this.decisionEngine.shouldAutoExecute(i)){this.logger.info("Auto-executing decision",{intent:i.intent,confidence:i.confidence,actionCount:i.actions.length});let b=await this.executeDecision(i,c);return await this.recordDecision(a,i,b,f,h),b.status===e.tc.EXECUTED?this.stats.successfulDecisions++:this.stats.failedDecisions++,i}if(!this.decisionEngine.requiresApproval(i))return this.logger.warn("Decision rejected due to low confidence",{intent:i.intent,confidence:i.confidence}),this.stats.failedDecisions++,await this.recordDecision(a,i,{status:e.tc.REJECTED,executionTime:0,results:[],errors:[{action:e.PS.NO_ACTION,code:"LOW_CONFIDENCE",message:"Confidence below threshold",retryable:!1}],completedAt:new Date},f,h),i;{this.logger.info("Decision requires approval",{intent:i.intent,confidence:i.confidence});let b=this.storePendingDecision(i,a,d);return this.stats.pendingApprovals++,await this.recordDecision(a,i,{status:e.tc.REQUIRES_APPROVAL,executionTime:0,results:[],errors:[],completedAt:new Date},f,h),this.config.notifyOnHighPriority&&(i.priority??3)>=4&&await this.sendApprovalNotification(b,i),i}}catch(b){throw this.stats.totalErrors++,this.logger.error("Error processing input",b,{correlationId:c}),this.config.notifyOnFailure&&await this.sendErrorNotification(b,a),b}}async handleEvent(a){if(this.stats.totalEventsProcessed++,this.logger.debug("Handling event",{type:a.type,eventId:a.eventId}),"agent"===a.source)return;let b=this.eventToInput(a);try{await this.process(b)}catch(b){this.logger.error("Error handling event",b,{eventType:a.type,eventId:a.eventId})}}async approveDecision(a){let b=this.pendingDecisions.get(a);if(!b)throw Error(`Pending decision not found: ${a}`);if(this.logger.info("Approving decision",{decisionId:a}),new Date>b.expiresAt)throw this.pendingDecisions.delete(a),this.stats.pendingApprovals--,Error("Decision has expired");let c=await this.executeDecision(b.decision,a);return this.pendingDecisions.delete(a),this.stats.pendingApprovals--,c.status===e.tc.EXECUTED?this.stats.successfulDecisions++:this.stats.failedDecisions++,c}async rejectDecision(a,b){let c=this.pendingDecisions.get(a);if(!c)throw Error(`Pending decision not found: ${a}`);this.logger.info("Rejecting decision",{decisionId:a,reason:b}),this.pendingDecisions.delete(a),this.stats.pendingApprovals--,this.stats.failedDecisions++,await this.recordDecision(c.input,c.decision,{status:e.tc.REJECTED,executionTime:0,results:[],errors:[{action:e.PS.NO_ACTION,code:"REJECTED",message:b,retryable:!1}],completedAt:new Date},"","")}getPendingDecisions(){return[...this.pendingDecisions.values()]}updateConfig(a){this.config={...this.config,...a},(void 0!==a.autoExecuteThreshold||void 0!==a.requireApprovalThreshold)&&this.decisionEngine.updateConfig({autoExecuteThreshold:this.config.autoExecuteThreshold,requireApprovalThreshold:this.config.requireApprovalThreshold}),void 0!==a.dryRun&&this.actionExecutor.setDryRun(a.dryRun),this.logger.info("Configuration updated")}getConfig(){return{...this.config}}getStats(){let a=this.stats.decisionTimes.length>0?this.stats.decisionTimes.reduce((a,b)=>a+b,0)/this.stats.decisionTimes.length:0,b=Date.now();return{totalDecisions:this.stats.totalDecisions,successfulDecisions:this.stats.successfulDecisions,failedDecisions:this.stats.failedDecisions,pendingApprovals:this.stats.pendingApprovals,totalActionsExecuted:this.stats.totalActionsExecuted,totalEventsProcessed:this.stats.totalEventsProcessed,totalErrors:this.stats.totalErrors,averageDecisionTimeMs:a,rateLimitStatus:{actionsThisMinute:this.rateLimiter.minuteTimestamps.filter(a=>b-a<6e4).length,actionsThisHour:this.rateLimiter.hourTimestamps.filter(a=>b-a<36e5).length,isLimited:this.isRateLimited()},uptimeMs:this.startTime?b-this.startTime.getTime():0,timeSinceLastDecisionMs:this.stats.lastDecisionTime?b-this.stats.lastDecisionTime.getTime():null}}getDecisionHistory(a){return a?this.decisionHistory.slice(-a):[...this.decisionHistory]}createLLMClient(){return(0,f.xP)({provider:this.config.llmProvider,model:this.config.llmModel,defaultOptions:{temperature:this.config.temperature,maxTokens:this.config.maxTokens}})}buildSystemPrompt(a){let b={orgName:a.name,pipelines:a.pipelines.map(a=>({id:a.id,name:a.name,description:a.description,stages:a.stages.map((a,b)=>({id:a,name:a,order:b}))})),teamMembers:a.users.map(a=>({id:a.id,name:a.name,email:a.email,role:a.role,isAvailable:a.isAvailable})),timezone:a.settings.timezone,currentDateTime:new Date};return j.uh.buildSystemPrompt(b)}buildUserPrompt(a,b){let c=`## Input Information

`;if(c+=`- **Source:** ${a.source}
`,c+=`- **Type:** ${a.type}
`,c+=`- **Timestamp:** ${a.timestamp.toISOString()}
`,a.metadata?.senderEmail&&(c+=`- **Sender Email:** ${a.metadata.senderEmail}
`),a.metadata?.senderName&&(c+=`- **Sender Name:** ${a.metadata.senderName}
`),c+=`
## Content

${a.rawContent}
`,a.structuredData&&Object.keys(a.structuredData).length>0&&(c+=`
## Structured Data

\`\`\`json
${JSON.stringify(a.structuredData,null,2)}
\`\`\`
`),b.history&&b.history.recentDecisions.length>0)for(let a of(c+=`
## Recent Decisions

`,b.history.recentDecisions.slice(0,5)))c+=`- ${a.decisionType} (${a.inputType}): Confidence ${a.confidence.toFixed(2)}, Status: ${a.status}
`;return c+=`
## Available Actions

`,c+=b.availableActions.map(a=>`- ${a}`).join("\n"),c+=`

---

Based on the above information, analyze the input and provide your decision in the required JSON format.`}async makeLLMDecision(a,b){try{return(await this.llmClient.complete([{role:"system",content:a},{role:"user",content:b}])).content}catch(c){this.logger.error("[OA] Primary LLM failed, attempting OpenAI fallback",c,{primaryProvider:this.config.llmProvider});try{let c=(0,f.xP)({provider:e.Dd.OPENAI,model:"gpt-4o",defaultOptions:{temperature:this.config.temperature,maxTokens:this.config.maxTokens}}),d=await c.complete([{role:"system",content:a},{role:"user",content:b}]);return this.logger.info("[OA] OpenAI fallback succeeded",{primaryProvider:this.config.llmProvider}),d.content}catch(a){throw this.logger.error("[OA] OpenAI fallback also failed",a),await this.eventBus.emit("intake:routing_failed",{error:"Both Claude and OpenAI LLM calls failed",primaryError:c instanceof Error?c.message:String(c),fallbackError:a instanceof Error?a.message:String(a),timestamp:new Date},{source:"agent"}),Error(`LLM routing failed - Primary (${this.config.llmProvider}): ${c instanceof Error?c.message:String(c)}, Fallback (OpenAI): ${a instanceof Error?a.message:String(a)}`)}}}async buildDecisionContext(a){let b=await this.getOrganizationContext(),c=await this.getHistoricalContext(a);return{input:a,org:b,history:c,availableActions:this.config.enabledActions,decisionTimestamp:new Date,sessionId:this.agentId}}async getOrganizationContext(){let a=new Date;if(this.orgContextCache&&this.orgContextCacheTime&&a.getTime()-this.orgContextCacheTime.getTime()<this.ORG_CONTEXT_CACHE_TTL)return this.orgContextCache;try{let b=await k.z.organization.findUnique({where:{id:this.config.orgId},select:{id:!0,name:!0}}),c=await k.z.pipeline.findMany({where:{orgId:this.config.orgId,isActive:!0},include:{stages:{orderBy:{order:"asc"},select:{id:!0,name:!0,order:!0}}},orderBy:{createdAt:"asc"}}),d=await k.z.users.findMany({where:{orgId:this.config.orgId,isActive:!0},select:{id:!0,name:!0,email:!0,role:!0}}),e=c.find(a=>a.name.toLowerCase().includes("general")||a.name.toLowerCase().includes("intake"))||c[0],f={id:this.config.orgId,name:b?.name||"Organization",pipelines:c.map(a=>({id:a.id,name:a.name,description:a.description??void 0,stages:a.stages.map(a=>a.name),category:this.inferPipelineCategory(a.name),isActive:!0})),users:d.map(a=>({id:a.id,name:a.name||"Unknown",email:a.email,role:a.role,currentLoad:0,isAvailable:!0})),settings:{timezone:"America/New_York",workingHours:{start:"09:00",end:"17:00",workingDays:[1,2,3,4,5]},defaultPipeline:e?.id||"general",escalationEmail:this.config.escalationEmail,defaultEventDuration:30,lunchBreak:{start:"12:00",end:"13:00"}}};return this.logger.info("Loaded organization context from database",{orgId:this.config.orgId,pipelineCount:c.length,userCount:d.length,pipelines:c.map(a=>({id:a.id,name:a.name}))}),this.orgContextCache=f,this.orgContextCacheTime=a,f}catch(a){return this.logger.error("Failed to load organization context from database, using fallback",a),{id:this.config.orgId,name:"Organization",pipelines:[],users:[],settings:{timezone:"America/New_York",workingHours:{start:"09:00",end:"17:00",workingDays:[1,2,3,4,5]},defaultPipeline:"general",escalationEmail:this.config.escalationEmail,defaultEventDuration:30,lunchBreak:{start:"12:00",end:"13:00"}}}}}inferPipelineCategory(a){let b=a.toLowerCase();return b.includes("sales")||b.includes("lead")||b.includes("opportunity")?"sales":b.includes("scheduling")||b.includes("booking")||b.includes("appointment")||b.includes("calendar")?"scheduling":b.includes("support")||b.includes("ticket")||b.includes("help")?"support":b.includes("billing")||b.includes("invoice")||b.includes("payment")?"billing":b.includes("partner")||b.includes("integration")?"partnership":"general"}async getHistoricalContext(a){return{recentDecisions:this.decisionHistory.slice(-10).map(a=>({id:a.id,decisionType:a.decisionType,inputType:a.inputType,confidence:a.confidence,status:a.status,createdAt:a.createdAt})),relatedIntakes:[],relatedEvents:[]}}async executeDecision(a,b){let c=await this.actionExecutor.execute(a.actions,{executionId:b,correlationId:b,dryRun:this.config.dryRun});return this.stats.totalActionsExecuted+=a.actions.length,c}storePendingDecision(a,b,c){let d=`pending-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,e=new Date(Date.now()+864e5);return this.pendingDecisions.set(d,{id:d,decision:a,input:b,context:c,createdAt:new Date,expiresAt:e}),d}async recordDecision(a,b,c,d,f){let g={id:`dec-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,agentId:this.agentId,orgId:this.config.orgId,inputSource:a.source,inputType:a.type,inputData:{rawContent:a.rawContent,structuredData:a.structuredData},llmPrompt:d,llmResponse:f,confidence:b.confidence,reasoning:b.reasoning,decisionType:b.actions[0]?.type??e.PS.NO_ACTION,actions:b.actions,status:c.status,executionTime:c.executionTime,errorMessage:c.errors[0]?.message,createdAt:new Date,executedAt:c.status===e.tc.EXECUTED?c.completedAt:void 0};this.decisionHistory.push(g),await this.eventBus.emit("agent:decision_made",{id:g.id,decisionId:g.id,agentId:this.agentId,decisionType:g.decisionType,status:g.status,confidence:g.confidence,actions:g.actions,timestamp:new Date,source:"agent"},{source:"agent"})}isRateLimited(){let a=Date.now();this.rateLimiter.minuteTimestamps=this.rateLimiter.minuteTimestamps.filter(b=>a-b<6e4),this.rateLimiter.hourTimestamps=this.rateLimiter.hourTimestamps.filter(b=>a-b<36e5);let b=this.config.maxActionsPerMinute??60,c=this.config.maxActionsPerHour??500;return this.rateLimiter.minuteTimestamps.length>=b||this.rateLimiter.hourTimestamps.length>=c}recordRateLimitAction(){let a=Date.now();this.rateLimiter.minuteTimestamps.push(a),this.rateLimiter.hourTimestamps.push(a)}async sendApprovalNotification(a,b){this.logger.info("Sending approval notification",{decisionId:a,intent:b.intent})}async sendErrorNotification(a,b){this.logger.info("Sending error notification",{error:a.message,inputSource:b.source,inputType:b.type})}eventToInput(a){let b=a.payload,c={};return a.eventId&&(c.eventId=a.eventId),{source:this.mapEventSourceToInputSource(a.source),type:a.type,rawContent:JSON.stringify(b),structuredData:b,metadata:{relatedEntityIds:c,...a.metadata},timestamp:a.timestamp,correlationId:a.correlationId}}mapEventSourceToInputSource(a){if(Object.values(e.nm).includes(a))return a;switch(a){case"agent":case"system":return e.nm.WORKER;default:return e.nm.API}}validateAndMergeConfig(a){return{...a,orgId:a.orgId,llmProvider:a.llmProvider??e.Dd.OPENAI,llmModel:a.llmModel??"gpt-4.1",temperature:a.temperature??e.HA.temperature,autoExecuteThreshold:a.autoExecuteThreshold??e.HA.autoExecuteThreshold,requireApprovalThreshold:a.requireApprovalThreshold??e.HA.requireApprovalThreshold,enabledActions:a.enabledActions??Object.values(e.PS),maxActionsPerMinute:a.maxActionsPerMinute??e.HA.maxActionsPerMinute,maxActionsPerHour:a.maxActionsPerHour??e.HA.maxActionsPerHour,notifyOnHighPriority:a.notifyOnHighPriority??!0,notifyOnFailure:a.notifyOnFailure??!0,escalationEmail:a.escalationEmail??"admin@example.com"}}}function m(a){return new p(a)}d()}catch(a){d(a)}})},74983:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Dy:()=>h.D}),c(18263);var e=c(15718),f=c(21406),g=c(12740);c(70609),c(75665),c(82912);var h=c(28383),i=a([e,f,g,h]);[e,f,g,h]=i.then?(await i)():i,d()}catch(a){d(a)}})},75665:(a,b,c)=>{c.d(b,{H:()=>h});var d=c(70609);let e={SALES_INQUIRY:["price","pricing","cost","quote","buy","purchase","demo","trial"],SUPPORT_REQUEST:["help","support","issue","problem","error","bug","not working","broken"],BILLING_QUESTION:["billing","invoice","payment","charge","subscription","refund"],PARTNERSHIP:["partnership","partner","reseller","affiliate","integrate","api"],SCHEDULING:["schedule","meeting","appointment","calendar","book","slot","availability"],GENERAL:[]},f={HIGH:["urgent","emergency","asap","immediately","critical","down","outage"],MEDIUM:["important","soon","priority","deadline"],LOW:["whenever","no rush","low priority","when possible"]},g={debug:(a,b)=>console.debug(`[DecisionEngine] ${a}`,b??""),info:(a,b)=>console.info(`[DecisionEngine] ${a}`,b??""),warn:(a,b)=>console.warn(`[DecisionEngine] ${a}`,b??""),error:(a,b,c)=>console.error(`[DecisionEngine] ${a}`,b,c??"")};class h{constructor(a={}){this.config={autoExecuteThreshold:a.autoExecuteThreshold??d.HA.autoExecuteThreshold,requireApprovalThreshold:a.requireApprovalThreshold??d.HA.requireApprovalThreshold,enabledActions:a.enabledActions??Object.values(d.PS),enableFallback:a.enableFallback??!0,fallbackPipelineId:a.fallbackPipelineId,fallbackAssigneeId:a.fallbackAssigneeId,logger:a.logger},this.logger=a.logger??g,this.logger.info("DecisionEngine initialized",{autoExecuteThreshold:this.config.autoExecuteThreshold,requireApprovalThreshold:this.config.requireApprovalThreshold,enabledActions:this.config.enabledActions.length})}processLLMResponse(a,b){let c;this.logger.debug("Processing LLM response");try{c=this.parseResponse(a)}catch(a){if(this.logger.warn("Failed to parse LLM response",{error:a.message}),this.config.enableFallback&&b)return this.createFallbackDecision(b,`Parse error: ${a.message}`).decision;throw a}let d=this.validateDecision(c,b);if(!d.isValid){if(this.logger.warn("Decision validation failed",{errors:d.errors}),this.config.enableFallback&&b)return this.createFallbackDecision(b,`Validation failed: ${d.errors.join(", ")}`).decision;throw Error(`Invalid decision: ${d.errors.join(", ")}`)}d.warnings.length>0&&this.logger.warn("Decision has warnings",{warnings:d.warnings});let e=d.sanitizedDecision,f=this.applyThresholds(e);return this.logger.info("Decision processed successfully",{intent:f.intent,confidence:f.confidence,actionCount:f.actions.length,requiresApproval:f.requiresApproval}),f}shouldAutoExecute(a){return!a.requiresApproval&&a.confidence>=this.config.autoExecuteThreshold}requiresApproval(a){return!!a.requiresApproval||a.confidence<this.config.autoExecuteThreshold&&a.confidence>=this.config.requireApprovalThreshold}shouldReject(a){return a.confidence<this.config.requireApprovalThreshold}validateDecision(a,b){let c=[],d=[];if("string"==typeof a.intent&&a.intent.trim()||c.push('Missing or empty "intent" field'),"number"!=typeof a.confidence||isNaN(a.confidence)?c.push('Missing or invalid "confidence" field'):a.confidence<0||a.confidence>1?c.push('"confidence" must be between 0 and 1'):a.confidence<.1&&d.push(`Very low confidence (${a.confidence}), consider rejecting`),"string"!=typeof a.reasoning&&d.push('Missing "reasoning" field - audit trail may be incomplete'),Array.isArray(a.actions)||c.push('Missing or invalid "actions" field (expected array)'),"boolean"!=typeof a.requiresApproval&&d.push('Missing "requiresApproval" field, defaulting to false'),c.length>0)return{isValid:!1,errors:c,warnings:d};let e=[];for(let f=0;f<a.actions.length;f++){let g=a.actions[f],h=this.validateAction(g,f,b);h.errors.length>0&&c.push(...h.errors),h.warnings.length>0&&d.push(...h.warnings),h.validatedAction&&e.push(h.validatedAction)}if(c.length>0)return{isValid:!1,errors:c,warnings:d};let f={intent:a.intent.trim(),confidence:a.confidence,reasoning:a.reasoning??"No reasoning provided",actions:e,requiresApproval:a.requiresApproval??!1,priority:"number"==typeof a.priority?Math.min(5,Math.max(1,a.priority)):void 0,warnings:[...a.warnings||[],...d]};return Array.isArray(a.alternatives)&&a.alternatives.length>0&&(f.alternatives=a.alternatives.filter(a=>"object"==typeof a&&null!==a&&"string"==typeof a.intent&&"number"==typeof a.confidence).map(a=>({intent:String(a.intent),confidence:Number(a.confidence),reason:String(a.reason??"No reason provided")}))),{isValid:!0,errors:[],warnings:d,sanitizedDecision:f}}validateAction(a,b,c){let e=[],f=[];if("object"!=typeof a||null===a)return e.push(`Action ${b}: Invalid action format`),{errors:e,warnings:f};if("string"!=typeof a.type)return e.push(`Action ${b}: Missing or invalid "type" field`),{errors:e,warnings:f};let g=a.type;if(!Object.values(d.PS).includes(g))return e.push(`Action ${b}: Unknown action type "${a.type}"`),{errors:e,warnings:f};if(!this.config.enabledActions.includes(g))return e.push(`Action ${b}: Action type "${a.type}" is not enabled`),{errors:e,warnings:f};if(c?.availableActions&&!c.availableActions.includes(g)&&f.push(`Action ${b}: Action type "${a.type}" may not be available in current context`),"object"!=typeof a.params||null===a.params)return e.push(`Action ${b}: Missing or invalid "params" field`),{errors:e,warnings:f};let h=this.validateActionParams(g,a.params,b);if(e.push(...h.errors),f.push(...h.warnings),e.length>0)return{errors:e,warnings:f};let i={type:g,params:a.params,priority:"number"==typeof a.priority?Math.min(5,Math.max(1,a.priority)):3,requiresConfirmation:"boolean"==typeof a.requiresConfirmation&&a.requiresConfirmation};if("number"==typeof a.delayMs&&a.delayMs>0&&(i.delayMs=a.delayMs),"object"==typeof a.condition&&null!==a.condition){let b=a.condition;"string"==typeof b.type&&"object"==typeof b.params&&(i.condition={type:b.type,params:b.params})}return{validatedAction:i,errors:e,warnings:f}}validateActionParams(a,b,c){let e=[],f=[],g=`Action ${c}:`;switch(a){case d.PS.ASSIGN_PIPELINE:"string"!=typeof b.intakeId&&e.push(`${g} ASSIGN_PIPELINE requires "intakeId" string`),"string"!=typeof b.pipelineId&&e.push(`${g} ASSIGN_PIPELINE requires "pipelineId" string`);break;case d.PS.CREATE_TASK:"string"!=typeof b.templateId&&e.push(`${g} CREATE_TASK requires "templateId" string`),"string"!=typeof b.orgId&&e.push(`${g} CREATE_TASK requires "orgId" string`),"string"==typeof b.source&&["FORM","EMAIL","CHAT","API","CALL"].includes(b.source)||e.push(`${g} CREATE_TASK requires "source" to be one of: FORM, EMAIL, CHAT, API, CALL`),"string"!=typeof b.title&&e.push(`${g} CREATE_TASK requires "title" string`),void 0!==b.priority&&("number"!=typeof b.priority||b.priority<1||b.priority>5)&&e.push(`${g} CREATE_TASK "priority" must be between 1 and 5`);break;case d.PS.CREATE_EVENT:"string"!=typeof b.title&&e.push(`${g} CREATE_EVENT requires "title" string`),b.startTime||e.push(`${g} CREATE_EVENT requires "startTime"`),b.endTime||e.push(`${g} CREATE_EVENT requires "endTime"`),Array.isArray(b.attendees)||f.push(`${g} CREATE_EVENT missing "attendees" array`);break;case d.PS.UPDATE_EVENT:case d.PS.CANCEL_EVENT:"string"!=typeof b.eventId&&e.push(`${g} ${a} requires "eventId" string`);break;case d.PS.SEND_NOTIFICATION:b.recipientIds||b.recipientEmails||e.push(`${g} SEND_NOTIFICATION requires "recipientIds" or "recipientEmails"`),"string"!=typeof b.type&&e.push(`${g} SEND_NOTIFICATION requires "type" string`),"string"!=typeof b.subject&&e.push(`${g} SEND_NOTIFICATION requires "subject" string`),"string"!=typeof b.body&&e.push(`${g} SEND_NOTIFICATION requires "body" string`);break;case d.PS.TRIGGER_AUTOMATION:"string"!=typeof b.workflowId&&e.push(`${g} TRIGGER_AUTOMATION requires "workflowId" string`),"object"!=typeof b.payload&&f.push(`${g} TRIGGER_AUTOMATION missing "payload" object`);break;case d.PS.ESCALATE:"string"!=typeof b.reason&&e.push(`${g} ESCALATE requires "reason" string`),"number"!=typeof b.level&&e.push(`${g} ESCALATE requires "level" number`),"string"!=typeof b.priority&&e.push(`${g} ESCALATE requires "priority" string`);case d.PS.NO_ACTION:}return{errors:e,warnings:f}}applyThresholds(a){return a.requiresApproval?a:a.actions.some(a=>a.requiresConfirmation)||a.confidence<this.config.autoExecuteThreshold?{...a,requiresApproval:!0}:a}createFallbackDecision(a,b){this.logger.info("Creating fallback decision",{reason:b});let c=a.input,e=this.detectIntentFromContent(c.rawContent),f=this.detectUrgencyFromContent(c.rawContent),g=[];if(this.config.enabledActions.includes(d.PS.ASSIGN_PIPELINE)){let h=this.selectFallbackPipeline(a,e);h&&g.push({type:d.PS.ASSIGN_PIPELINE,params:{intakeId:c.structuredData?.intakeId??"unknown",pipelineId:h,priority:f,notes:`[FALLBACK] ${b}. Intent detected: ${e}`},priority:f,requiresConfirmation:!0})}return f>=4&&this.config.enabledActions.includes(d.PS.ESCALATE)&&g.push({type:d.PS.ESCALATE,params:{reason:`High urgency item routed via fallback: ${b}`,level:1,priority:"high"},priority:5,requiresConfirmation:!1}),0===g.length&&g.push({type:d.PS.NO_ACTION,params:{reason:`Fallback with no suitable action: ${b}`},priority:3,requiresConfirmation:!1}),{decision:{intent:e,confidence:.3,reasoning:`[FALLBACK] ${b}. Rule-based detection used.`,actions:g,requiresApproval:!0,priority:f,warnings:[`Decision made via fallback logic: ${b}`]},reason:b,isPartialFailure:!0}}detectIntentFromContent(a){let b=a.toLowerCase();for(let[a,c]of Object.entries(e))if(c.some(a=>b.includes(a)))return a;return"GENERAL"}detectUrgencyFromContent(a){let b=a.toLowerCase();return f.HIGH.some(a=>b.includes(a))?5:f.MEDIUM.some(a=>b.includes(a))?3:f.LOW.some(a=>b.includes(a))?1:2}selectFallbackPipeline(a,b){if(this.config.fallbackPipelineId)return this.config.fallbackPipelineId;let c=a.org.pipelines,d=b.toLowerCase();for(let a of c)if(a.category.toLowerCase().includes(d)||a.name.toLowerCase().includes(d))return a.id;if(a.org.settings.defaultPipeline)return a.org.settings.defaultPipeline;let e=c.find(a=>!1!==a.isActive);return e?.id}parseResponse(a){if("object"==typeof a)return a;let b=a.trim(),c=b.match(/```(?:json)?\s*([\s\S]*?)\s*```/);c&&(b=c[1].trim());try{return JSON.parse(b)}catch(a){throw Error(`Failed to parse LLM response as JSON: ${a.message}`)}}classifyIntentBasic(a){return{intent:this.detectIntentFromContent(a.rawContent),confidence:.3,urgency:this.detectUrgencyFromContent(a.rawContent),keywords:this.extractKeywords(a.rawContent),entities:[]}}extractKeywords(a){let b=Object.values(e).flat(),c=a.toLowerCase();return b.filter(a=>c.includes(a))}updateConfig(a){this.config={...this.config,...a},this.logger.info("Configuration updated",{autoExecuteThreshold:this.config.autoExecuteThreshold,requireApprovalThreshold:this.config.requireApprovalThreshold})}getConfig(){return{...this.config}}}},75818:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{getAgentInstance:()=>f.BN,initializeAgentSystem:()=>f.$r}),c(61083);var e=c(74983);c(37357),c(30504),c(45600);var f=c(10455);c(61215);var g=a([e,f]);[e,f]=g.then?(await g)():g,d()}catch(a){d(a)}})},82912:(a,b,c)=>{c.d(b,{c:()=>k});var d=c(70609),e=c(37289),f=c(58046),g=c(48625),h=c(84895);let i={dryRun:!1,maxExecutionTime:3e5,actionTimeout:3e4,retryAttempts:2,retryDelay:1e3,stopOnFailure:!1,enableRollback:!0},j={debug:(a,b)=>console.debug(`[ActionExecutor] ${a}`,b??""),info:(a,b)=>console.info(`[ActionExecutor] ${a}`,b??""),warn:(a,b)=>console.warn(`[ActionExecutor] ${a}`,b??""),error:(a,b,c)=>console.error(`[ActionExecutor] ${a}`,b,c??"")};class k{constructor(a={}){this.config={...i,...a},this.logger=a.logger??j,this.handlers=new Map,this.rollbackStack=[],this.eventBus=e.io.getInstance(),this.registerDefaultHandlers(),this.logger.info("ActionExecutor initialized",{dryRun:this.config.dryRun,maxExecutionTime:this.config.maxExecutionTime,enableRollback:this.config.enableRollback})}registerHandler(a,b){this.handlers.set(a,b),this.logger.debug(`Registered handler for action type: ${a}`)}unregisterHandler(a){let b=this.handlers.delete(a);return b&&this.logger.debug(`Unregistered handler for action type: ${a}`),b}hasHandler(a){return this.handlers.has(a)}registerDefaultHandlers(){this.registerHandler(d.PS.ASSIGN_PIPELINE,async(a,b)=>{if(this.logger.info("Executing ASSIGN_PIPELINE",{params:a,dryRun:b.dryRun}),b.dryRun)return{success:!0,data:{dryRun:!0,...a}};let c=new h.VC({orgId:b.orgId}),d=await c.assign(a.intakeId,a.pipelineId,a.stageId||void 0,a.assigneeId||void 0);return d.success?(await b.eventBus.emit("intake:assigned",{id:a.intakeId,intakeId:a.intakeId,pipelineId:a.pipelineId,stageId:a.stageId,assigneeId:a.assigneeId,timestamp:new Date,source:"agent"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:{assignmentId:d.auditLogId||`assign-${Date.now()}`,intakeId:a.intakeId,pipelineId:d.newState.pipelineId,stageId:d.newState.stageId,assigneeId:d.newState.assigneeId,previousState:d.previousState,newState:d.newState},rollbackable:!0,rollback:async()=>{this.logger.info("Rolling back ASSIGN_PIPELINE",{intakeId:a.intakeId})}}):{success:!1,error:d.error||"Pipeline assignment failed"}}),this.registerHandler(d.PS.CREATE_TASK,async(a,b)=>{if(this.logger.info("Executing CREATE_TASK",{params:a,dryRun:b.dryRun}),b.dryRun)return{success:!0,data:{dryRun:!0,...a}};try{let c=await g.z.taskTemplate.findUnique({where:{id:a.templateId}});if(!c)return{success:!1,error:`Task template not found: ${a.templateId}`,rollbackable:!1};let d=c.definition,e=await g.z.task.create({data:{templateId:a.templateId,orgId:a.orgId,source:a.source,sourceId:a.intakeId,title:a.title,description:a.description,type:d.label||a.templateId,category:d.category||"GENERAL",department:d.department,staffRole:d.staffRole,priority:a.priority??d.defaultPriority??3,status:"NEW",pipelineKey:d.pipeline?.preferredPipelineKey,stageKey:d.pipeline?.defaultStageKey,typicalMinutes:d.typicalMinutes||60,steps:d.steps?.map(a=>({id:a.id,status:"NEW"}))||[],timeline:{startedAt:new Date().toISOString()},overridden:!1,agentDecisionIds:[]}});return await (0,f.$n)({id:e.id,orgId:e.orgId,source:e.source,type:e.type,category:e.category,priority:e.priority},{correlationId:b.correlationId}),this.logger.info("Task created successfully",{taskId:e.id,templateId:a.templateId}),{success:!0,data:{taskId:e.id,templateId:a.templateId},rollbackable:!0,rollback:async()=>{this.logger.info("Rolling back CREATE_TASK",{taskId:e.id}),await g.z.task.delete({where:{id:e.id}})}}}catch(a){return this.logger.error("Failed to create task",a),{success:!1,error:`Failed to create task: ${a.message}`,rollbackable:!1}}}),this.registerHandler(d.PS.CREATE_EVENT,async(a,b)=>{if(this.logger.info("Executing CREATE_EVENT",{params:a,dryRun:b.dryRun}),b.dryRun)return{success:!0,data:{dryRun:!0,...a}};let c=`evt-${Date.now()}`;return await b.eventBus.emit("calendar:event_created",{id:c,eventId:c,title:a.title,startTime:a.startTime,endTime:a.endTime,attendees:a.attendees,timestamp:new Date,source:"WORKER"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:{eventId:c,...a},rollbackable:!0,rollback:async()=>{this.logger.info("Rolling back CREATE_EVENT",{eventId:c})}}}),this.registerHandler(d.PS.UPDATE_EVENT,async(a,b)=>(this.logger.info("Executing UPDATE_EVENT",{params:a,dryRun:b.dryRun}),b.dryRun)?{success:!0,data:{dryRun:!0,...a},rollbackable:!1}:(await b.eventBus.emit("calendar:event_updated",{id:a.eventId,eventId:a.eventId,updates:a,timestamp:new Date,source:"WORKER"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:a,rollbackable:!1})),this.registerHandler(d.PS.CANCEL_EVENT,async(a,b)=>(this.logger.info("Executing CANCEL_EVENT",{params:a,dryRun:b.dryRun}),b.dryRun)?{success:!0,data:{dryRun:!0,...a},rollbackable:!1}:(await b.eventBus.emit("calendar:event_cancelled",{id:a.eventId,eventId:a.eventId,reason:a.reason,timestamp:new Date,source:"WORKER"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:a,rollbackable:!1})),this.registerHandler(d.PS.SEND_NOTIFICATION,async(a,b)=>(this.logger.info("Executing SEND_NOTIFICATION",{params:a,dryRun:b.dryRun}),b.dryRun)?{success:!0,data:{dryRun:!0,...a}}:{success:!0,data:{notificationId:`notif-${Date.now()}`,sentTo:a.recipientIds??a.recipientEmails},rollbackable:!1}),this.registerHandler(d.PS.TRIGGER_AUTOMATION,async(a,b)=>(this.logger.info("Executing TRIGGER_AUTOMATION",{params:a,dryRun:b.dryRun}),b.dryRun)?{success:!0,data:{dryRun:!0,...a}}:(await b.eventBus.emit("automation:triggered",{id:`auto-${Date.now()}`,workflowId:a.workflowId,workflowName:a.workflowId,status:"success",executionTime:0,timestamp:new Date,source:"WORKER"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:{triggerId:`trigger-${Date.now()}`,...a},rollbackable:!1})),this.registerHandler(d.PS.ESCALATE,async(a,b)=>(this.logger.info("Executing ESCALATE",{params:a,dryRun:b.dryRun}),b.dryRun)?{success:!0,data:{dryRun:!0,...a},rollbackable:!1}:(await b.eventBus.emit("intake:escalated",{id:`esc-${Date.now()}`,intakeId:a.relatedEntityIds?.intakeId??"unknown",type:"escalation",data:a,timestamp:new Date,source:"WORKER"},{source:"agent",correlationId:b.correlationId}),{success:!0,data:a,rollbackable:!1})),this.registerHandler(d.PS.NO_ACTION,async(a,b)=>(this.logger.info("Executing NO_ACTION",{params:a,dryRun:b.dryRun}),{success:!0,data:{noActionReason:a.reason}}))}async execute(a,b={}){let c=Date.now(),e=b.executionId??`exec-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,f=b.dryRun??this.config.dryRun;this.logger.info("Starting action execution",{executionId:e,actionCount:a.length,dryRun:f}),this.rollbackStack=[];let g=[...a].sort((a,b)=>(b.priority??3)-(a.priority??3)),h=[],i=[],j=d.tc.EXECUTED,k={executionId:e,dryRun:f,orgId:this.config.orgId,correlationId:b.correlationId,previousResults:[],eventBus:this.eventBus};for(let a of g){if(Date.now()-c>this.config.maxExecutionTime){this.logger.error("Execution timeout exceeded"),i.push({action:a.type,code:"EXECUTION_TIMEOUT",message:`Execution timeout exceeded (${this.config.maxExecutionTime}ms)`,retryable:!0}),j=d.tc.FAILED;break}if(a.delayMs&&a.delayMs>0&&(this.logger.debug(`Waiting ${a.delayMs}ms before executing ${a.type}`),await this.sleep(a.delayMs)),a.condition&&!await this.evaluateCondition(a.condition,k)){this.logger.info(`Skipping action ${a.type}: condition not met`),h.push({action:a.type,success:!0,data:{skipped:!0,reason:"Condition not met"},executionTime:0,message:"Action skipped: condition not met"});continue}let b=await this.executeAction(a,k);if(h.push(b),k.previousResults=[...h],!b.success){let c={action:a.type,code:"ACTION_FAILED",message:b.message??"Action execution failed",retryable:!0};if(i.push(c),this.config.stopOnFailure){this.logger.warn("Stopping execution due to failure",{action:a.type}),j=d.tc.FAILED;break}}}i.length>0&&this.config.enableRollback&&!f&&await this.performRollback()&&(j=d.tc.FAILED),i.length>0?j=d.tc.FAILED:f&&(j=d.tc.PENDING);let l={status:j,executionTime:Date.now()-c,results:h,errors:i,rolledBack:this.rollbackStack.length>0&&i.length>0,completedAt:new Date};return this.logger.info("Action execution complete",{executionId:e,status:l.status,executionTime:l.executionTime,successCount:h.filter(a=>a.success).length,errorCount:i.length}),await this.eventBus.emit("agent:action_executed",{id:e,decisionId:e,agentId:"orchestration-agent",decisionType:g[0]?.type??d.PS.NO_ACTION,status:l.status,confidence:1,actions:g,timestamp:new Date,source:"agent"},{source:"agent",correlationId:b.correlationId}),l}async executeAction(a,b){let c,d=Date.now(),e=this.handlers.get(a.type);if(!e)return{action:a.type,success:!1,executionTime:Date.now()-d,message:`No handler registered for action type: ${a.type}`};for(let f=0;f<=this.config.retryAttempts;f++)try{f>0&&(this.logger.debug(`Retrying action ${a.type} (attempt ${f+1})`),await this.sleep(this.config.retryDelay*f));let c=await this.executeWithTimeout(()=>e(a.params,b),this.config.actionTimeout);return c.rollbackable&&c.rollback&&!b.dryRun&&this.rollbackStack.push({action:a,rollbackFn:c.rollback,timestamp:new Date}),{action:a.type,success:c.success,data:c.data,executionTime:Date.now()-d,message:c.error}}catch(b){c=b,this.logger.warn(`Action ${a.type} failed (attempt ${f+1})`,{error:c.message})}return{action:a.type,success:!1,executionTime:Date.now()-d,message:c?.message??"Unknown error"}}async executeWithTimeout(a,b){let c=new Promise((a,c)=>{setTimeout(()=>{c(Error(`Action timeout exceeded (${b}ms)`))},b)});return Promise.race([a(),c])}async evaluateCondition(a,b){switch(a.type){case"time_range":{let b=new Date,c=new Date(a.params.start),d=new Date(a.params.end);return b>=c&&b<=d}case"user_available":case"slot_available":default:return!0;case"custom":{let c=a.params.evaluator;if("function"==typeof c)return c(b);return!0}}}async performRollback(){if(0===this.rollbackStack.length)return!0;this.logger.info("Starting rollback",{actionsToRollback:this.rollbackStack.length});let a=!0;for(;this.rollbackStack.length>0;){let b=this.rollbackStack.pop();try{this.logger.debug(`Rolling back action: ${b.action.type}`),await b.rollbackFn()}catch(c){this.logger.error(`Rollback failed for action ${b.action.type}`,c),a=!1}}return this.logger.info("Rollback complete",{successful:a}),a}sleep(a){return new Promise(b=>setTimeout(b,a))}createExecutionPlan(a){let b=[],c=[],d=[],e=new Map;for(let b of a){if(b.condition){d.push(b);continue}let a=b.priority??3;e.has(a)||e.set(a,[]),e.get(a).push(b)}for(let a of[...e.keys()].sort((a,b)=>b-a)){let d=e.get(a);1===d.length?b.push(d[0]):c.push(d)}return{sequential:b,parallel:c,conditional:d}}validateActions(a){let b=[];for(let c of a)this.handlers.has(c.type)||b.push(c.type);return{valid:0===b.length,missing:b}}getStats(){return{registeredHandlers:this.handlers.size,handlerTypes:[...this.handlers.keys()],config:{...this.config}}}updateConfig(a){this.config={...this.config,...a},this.logger.info("Configuration updated")}setDryRun(a){this.config.dryRun=a,this.logger.info(`Dry-run mode ${a?"enabled":"disabled"}`)}}}};