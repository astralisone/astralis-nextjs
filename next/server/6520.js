"use strict";exports.id=6520,exports.ids=[6520],exports.modules={1981:(a,b,c)=>{c.d(b,{z:()=>f});var d=c(88792),e=c(19920);function f(a,b,c){let f=(0,e.a)(a,c?.in);return f.setTime(f.getTime()+b*d.Cg),f}},2573:(a,b,c)=>{c.d(b,{o:()=>f});var d=c(88792),e=c(19920);function f(a,b,c){var f;let g=((0,e.a)(a)-(0,e.a)(b))/d.Cg;return(f=c?.roundingMethod,a=>{let b=(f?Math[f]:Math.trunc)(a);return 0===b?0:b})(g)}},17049:(a,b,c)=>{c.d(b,{f:()=>f});var d=c(37428),e=c(19920);function f(a,b,c){let f=(0,e.a)(a,c?.in);return isNaN(b)?(0,d.w)(c?.in||a,NaN):(b&&f.setDate(f.getDate()+b),f)}},23566:(a,b,c)=>{c.d(b,{Ri:()=>g,o6:()=>h});var d=c(96798),e=c(96330);let f=[e.DayOfWeek.SUNDAY,e.DayOfWeek.MONDAY,e.DayOfWeek.TUESDAY,e.DayOfWeek.WEDNESDAY,e.DayOfWeek.THURSDAY,e.DayOfWeek.FRIDAY,e.DayOfWeek.SATURDAY];async function g(a,b,c,e){let g=[],j=[];try{for(let d of(await h(a,b,c))){let a=i({startTime:b,endTime:c},d),e="partial_overlap";d.startTime<=b&&d.endTime>=c?e="full_overlap":(d.endTime.getTime()===b.getTime()||d.startTime.getTime()===c.getTime())&&(e="back_to_back"),g.push({eventId:d.id,eventTitle:d.title,startTime:d.startTime,endTime:d.endTime,conflictScore:a,conflictType:e})}let k=f[b.getDay()],l=`${b.getHours().toString().padStart(2,"0")}:${b.getMinutes().toString().padStart(2,"0")}`,m=`${c.getHours().toString().padStart(2,"0")}:${c.getMinutes().toString().padStart(2,"0")}`,n=await d.z.availabilityRule.findMany({where:{userId:a,dayOfWeek:k}}),o=!1;for(let a of n)if(a.isActive){if(l>=a.startTime&&m<=a.endTime){o=!0;break}}else(l>=a.startTime&&l<a.endTime||m>a.startTime&&m<=a.endTime||l<=a.startTime&&m>=a.endTime)&&j.push({dayOfWeek:k,message:`Time conflicts with unavailable period ${a.startTime}-${a.endTime}`,affectedTime:`${a.startTime}-${a.endTime}`});if(n.some(a=>a.isActive)&&!o&&j.push({dayOfWeek:k,message:"Time is outside of available hours",affectedTime:`${l}-${m}`}),e&&e.length>0)for(let a of(await d.z.users.findMany({where:{email:{in:e}},select:{id:!0,email:!0,name:!0}})))for(let d of(await h(a.id,b,c)))g.push({eventId:d.id,eventTitle:`${a.name||a.email}: ${d.title}`,startTime:d.startTime,endTime:d.endTime,conflictScore:i({startTime:b,endTime:c},d),conflictType:"partial_overlap"});let p="none";if(g.length>0||j.length>0){let a=Math.max(...g.map(a=>a.conflictScore),0);p=a>=80||j.length>0?"high":a>=50?"medium":"low"}let q=g.length>0||j.length>0;return console.log(`Conflict check for user ${a}: ${q?"conflicts found":"no conflicts"} (severity: ${p})`),{hasConflict:q,conflicts:g,availabilityIssues:j,severity:p}}catch(a){throw console.error("Error detecting conflicts:",a),Error(`Failed to detect conflicts: ${a.message}`)}}async function h(a,b,c){try{return await d.z.schedulingEvent.findMany({where:{userId:a,status:{in:["SCHEDULED","CONFIRMED"]},AND:[{startTime:{lt:c}},{endTime:{gt:b}}]},orderBy:{startTime:"asc"}})}catch(a){throw console.error("Error getting conflicting events:",a),Error(`Failed to get conflicting events: ${a.message}`)}}function i(a,b){let c=new Date(a.startTime).getTime(),d=new Date(a.endTime).getTime(),e=new Date(b.startTime).getTime(),f=new Date(b.endTime).getTime(),g=Math.max(c,e),h=Math.min(d,f);if(g>=h)return 10*(d===e||f===c);if(e<=c&&f>=d||c<=e&&d>=f)return 100;let i=(h-g)/Math.min(d-c,f-e)*100;return i>=75?Math.min(80+(i-75)*.8,99):i>=50?50+(i-50)*1.2:i>=25?25+(i-25):Math.max(1,i)}},36520:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Xt:()=>s});var e=c(87984),f=c(96798),g=c(36836),h=c(78547),i=c(17049),j=c(1981),k=c(60102),l=c(2573),m=c(53437),n=c(82047),o=c(77038),p=c(23566),q=c(96330),r=a([e]);e=(r.then?(await r)():r)[0];let w=[q.DayOfWeek.SUNDAY,q.DayOfWeek.MONDAY,q.DayOfWeek.TUESDAY,q.DayOfWeek.WEDNESDAY,q.DayOfWeek.THURSDAY,q.DayOfWeek.FRIDAY,q.DayOfWeek.SATURDAY],x=new e.default({apiKey:process.env.OPENAI_API_KEY||""}),y={start:"08:00",end:"18:00"};class z{async findAvailableSlots(a){let{userId:b,duration:c,startDate:d,endDate:e,preferredTimes:j,excludeParticipantConflicts:k}=a;console.log(`Finding available slots for user ${b}, duration: ${c} minutes`);let l=[],m=(0,g.o)(d),n=(0,h.D)(e);for(;m<=n;){let a=w[m.getDay()],d=await f.z.availabilityRule.findMany({where:{userId:b,dayOfWeek:a,isActive:!0},orderBy:{startTime:"asc"}}),e=(0,g.o)(m),n=(0,h.D)(m),o=await f.z.schedulingEvent.findMany({where:{userId:b,status:{in:["SCHEDULED","CONFIRMED"]},AND:[{startTime:{lt:n}},{endTime:{gt:e}}]},orderBy:{startTime:"asc"}}),p=[];k&&k.length>0&&(p=await f.z.schedulingEvent.findMany({where:{userId:{in:k},status:{in:["SCHEDULED","CONFIRMED"]},AND:[{startTime:{lt:n}},{endTime:{gt:e}}]},select:{startTime:!0,endTime:!0}}));let q=this.generateSlotsForDay(m,c,d,o,p,j);l.push(...q),m=(0,i.f)(m,1)}return l.sort((a,b)=>b.score-a.score),console.log(`Found ${l.length} available slots`),l}generateSlotsForDay(a,b,c,d,e,f){let g=[];for(let h of c.length>0?c.map(a=>({start:a.startTime,end:a.endTime})):[y]){let[c,i]=h.start.split(":").map(Number),[k,l]=h.end.split(":").map(Number),m=new Date(a);m.setHours(c,i,0,0);let n=new Date(a);for(n.setHours(k,l,0,0);m<n;){let a=(0,j.z)(m,b);if(a>n)break;let c=d.some(b=>m<b.endTime&&a>b.startTime),h=e.some(b=>m<b.endTime&&a>b.startTime);if(!c&&!h){let b=this.calculateSlotScore(m,a,f),c=this.getSlotReason(m,f);g.push({startTime:new Date(m),endTime:new Date(a),score:b,reason:c})}m=(0,j.z)(m,30)}}return g}calculateSlotScore(a,b,c){let d=50,e=a.getHours(),f=a.getDay();if(c&&c.length>0){let a=this.getTimeOfDay(e);c.includes(a)&&(d+=30)}return e>=9&&e<11?d+=15:e>=13&&e<15?d+=10:12===e?d-=10:e<9?d-=5:e>=17&&(d-=15),f>=2&&f<=4?d+=10:(1===f||5===f)&&(d-=5),Math.min(100,Math.max(0,d))}getTimeOfDay(a){return a<12?"morning":a<17?"afternoon":"evening"}getSlotReason(a,b){let c=a.getHours(),d=(0,k.GP)(a,"EEEE"),e=this.getTimeOfDay(c),f=[];return b?.includes(e)&&f.push(`Matches your ${e} preference`),c>=9&&c<11?f.push("Prime productive morning hours"):c>=13&&c<15&&f.push("Good afternoon slot for focused work"),["Tuesday","Wednesday","Thursday"].includes(d)&&f.push(`${d} is a productive mid-week day`),f.length>0?f.join("; "):"Available time slot"}async suggestAlternatives(a,b,c=3){let d=(0,l.o)(a.endTime,a.startTime);console.log(`Suggesting ${c} alternatives for conflicting slot`);let e=[],f=(0,g.o)(a.startTime),j=a.startTime.getHours(),n=(await this.findAvailableSlots({userId:b,duration:d,startDate:f,endDate:(0,h.D)(f)})).sort((a,b)=>{let c=Math.abs(a.startTime.getHours()-j),d=Math.abs(b.startTime.getHours()-j);return c-d});if(e.push(...n.slice(0,Math.ceil(c/2))),e.length<c){let a=(0,i.f)(f,1),g=(await this.findAvailableSlots({userId:b,duration:d,startDate:a,endDate:(0,h.D)(a)})).sort((a,b)=>{let c=Math.abs(a.startTime.getHours()-j),d=Math.abs(b.startTime.getHours()-j);return c-d});e.push(...g.slice(0,c-e.length))}if(e.length<c)for(let a=2;a<=7&&e.length<c;a++){let c=(0,i.f)(f,a),g=(await this.findAvailableSlots({userId:b,duration:d,startDate:c,endDate:(0,h.D)(c)})).find(a=>1>=Math.abs(a.startTime.getHours()-j));g&&(g.reason=`Same time on ${(0,k.GP)(c,"EEEE")}`,e.push(g))}return e.forEach((b,c)=>{(0,m.r)(b.startTime,a.startTime)?b.reason=b.reason||"Alternative on same day":(0,m.r)(b.startTime,(0,i.f)(a.startTime,1))&&(b.reason=b.reason||"Next available day")}),e.slice(0,c)}async detectOverbooking(a,b){let c=(0,g.o)(b),d=(0,h.D)(b);console.log(`Analyzing overbooking for user ${a} on ${(0,k.GP)(b,"yyyy-MM-dd")}`);let e=await f.z.schedulingEvent.findMany({where:{userId:a,status:{in:["SCHEDULED","CONFIRMED"]},AND:[{startTime:{lt:d}},{endTime:{gt:c}}]},orderBy:{startTime:"asc"}}),i=0;for(let a of e){let b=(0,n.d)(a.startTime,c)?a.startTime:c,e=(0,o.Y)(a.endTime,d)?a.endTime:d;i+=(0,l.o)(e,b)}let j=w[b.getDay()],m=await f.z.availabilityRule.findMany({where:{userId:a,dayOfWeek:j,isActive:!0}}),p=0;if(m.length>0)for(let a of m){let[b,c]=a.startTime.split(":").map(Number),[d,e]=a.endTime.split(":").map(Number);p+=60*d+e-(60*b+c)}else p=480;let q=p>0?Math.round(i/p*100):0,r=q>=80,s=[];r&&s.push(`Consider spreading meetings across multiple days - ${q}% of your day is booked`),e.length>=5&&s.push("High number of meetings detected - consider blocking focus time");let t=0;for(let a=1;a<e.length;a++)15>(0,l.o)(e[a].startTime,e[a-1].endTime)&&t++;return t>0&&s.push(`${t} back-to-back meetings detected - add buffer time between meetings`),q>90&&s.push("Consider declining or rescheduling non-essential meetings"),0===s.length&&e.length>0&&s.push("Calendar utilization is healthy"),{date:b,totalMeetings:e.length,totalMinutes:i,utilizationPercent:q,isOverbooked:r,recommendations:s}}async checkConflicts(a){let{userId:b,startTime:c,endTime:d,excludeEventId:e}=a;console.log(`Checking conflicts for user ${b}`);let f=await p.o6(b,c,d),g=e?f.filter(a=>a.id!==e):f,h=g.length>0,i={hasConflict:h,conflictingEvents:g.map(a=>({id:a.id,title:a.title,startTime:a.startTime,endTime:a.endTime}))};return h&&((0,l.o)(d,c),i.suggestions=await this.suggestAlternatives({startTime:c,endTime:d,score:0},b,3)),i}async recommendBufferTime(a,b){console.log(`Checking buffer time recommendation for user ${a}`);let c=(0,j.z)(b,-15),d=await f.z.schedulingEvent.findFirst({where:{userId:a,status:{in:["SCHEDULED","CONFIRMED"]},endTime:{gt:c,lte:b}},orderBy:{endTime:"desc"}});return d&&15>(0,l.o)(b,d.endTime)?{recommendedStart:(0,j.z)(d.endTime,15),reason:`A meeting ends at ${(0,k.GP)(d.endTime,"h:mm a")}. Adding 15-minute buffer for transition time.`}:null}}async function s(a){try{let b=function(a,b,c){let d=[],e=9,f=0,g=17,h=0;if(c){let[a,b]=c.start.split(":").map(Number),[d,i]=c.end.split(":").map(Number);e=a,f=b,g=d,h=i}let i=new Date(a);i.setHours(e,f,0,0);let k=new Date(a);for(k.setHours(g,h,0,0);i<k;){let a=(0,j.z)(i,b);a<=k&&d.push({startTime:new Date(i),endTime:new Date(a)}),i=(0,j.z)(i,30)}return d}(a.date,a.duration,a.preferredTimeRange);console.log(`Generated ${b.length} candidate time slots`);let c=await t(b,a.userId);console.log(`${c.length} slots after availability filtering`);let d=[a.userId];if(a.participantEmails&&a.participantEmails.length>0){let b=await f.z.users.findMany({where:{email:{in:a.participantEmails}},select:{id:!0}});d.push(...b.map(a=>a.id))}let e=await u(c,d,a.bufferMinutes);if(console.log(`${e.length} slots after conflict filtering`),0===e.length)return{slots:[],totalCandidates:b.length,analysisContext:"No available time slots found after filtering for availability and conflicts."};let g=await v(e.slice(0,20),a.context||"General meeting",a.participantEmails?.length||0);return console.log(`AI ranked ${g.length} time slots`),{slots:g.slice(0,5),totalCandidates:b.length,analysisContext:`Analyzed ${b.length} potential slots, filtered to ${e.length} available options, and ranked the top ${Math.min(5,g.length)} using AI.`}}catch(b){let a=b instanceof Error?b.message:"Unknown error";throw console.error("Error generating time slot suggestions:",b),Error(`Failed to suggest time slots: ${a}`)}}async function t(a,b){try{let c=[];for(let d of a){let a=w[d.startTime.getDay()],e=await f.z.availabilityRule.findMany({where:{userId:b,dayOfWeek:a,isActive:!0}});if(0===e.length)continue;let g=`${d.startTime.getHours().toString().padStart(2,"0")}:${d.startTime.getMinutes().toString().padStart(2,"0")}`,h=`${d.endTime.getHours().toString().padStart(2,"0")}:${d.endTime.getMinutes().toString().padStart(2,"0")}`,i=!1;for(let a of e)if(g>=a.startTime&&h<=a.endTime){i=!0;break}i&&c.push(d)}return c}catch(b){let a=b instanceof Error?b.message:"Unknown error";throw console.error("Error filtering by availability:",b),Error(`Failed to filter by availability: ${a}`)}}async function u(a,b,c=0){try{let d=[];for(let e of a){let a=!1,f=(0,j.z)(e.startTime,-c),g=(0,j.z)(e.endTime,c);for(let c of b)if((await p.o6(c,f,g)).length>0){a=!0;break}a||d.push(e)}return d}catch(b){let a=b instanceof Error?b.message:"Unknown error";throw console.error("Error filtering by conflicts:",b),Error(`Failed to filter by conflicts: ${a}`)}}async function v(a,b,c){try{let d;if(0===a.length)return[];let e=a.map((a,b)=>`${b+1}. ${(0,k.GP)(a.startTime,"EEEE, MMMM d, yyyy")} at ${(0,k.GP)(a.startTime,"h:mm a")} - ${(0,k.GP)(a.endTime,"h:mm a")}`).join("\n"),f=`You are an intelligent scheduling assistant. Analyze the following available time slots for a meeting and rank the top 5 based on typical business preferences and best practices.

Meeting Context: ${b}
Number of Participants: ${c}

Available Time Slots:
${e}

Consider the following factors:
1. Time of day preferences (mid-morning and early afternoon are generally preferred)
2. Avoid very early morning (before 9 AM) or late afternoon (after 4 PM) slots when possible
3. Mid-week days (Tuesday, Wednesday, Thursday) are often better than Monday or Friday
4. Allow for preparation time (mid-morning slots like 10 AM are often ideal)
5. Avoid immediately after lunch (12-1 PM) for important meetings
6. Consider participant count (larger meetings benefit from mid-day slots)

Respond with a JSON array of the top 5 slots in this exact format:
[
  {
    "slotIndex": 1,
    "score": 95,
    "reasoning": "Tuesday at 10:00 AM is ideal for productive meetings, allowing morning preparation time and avoiding early-morning fatigue.",
    "confidenceLevel": "high"
  }
]

Score from 0-100 where 100 is the most ideal time.
Confidence levels: "low", "medium", "high"
Only return the JSON array, no other text.`,g=await x.chat.completions.create({model:"gpt-4",messages:[{role:"system",content:"You are a scheduling expert that provides practical, business-focused recommendations."},{role:"user",content:f}],temperature:.7,max_tokens:1e3}),h=g.choices[0]?.message?.content;if(!h)throw Error("No response from AI");try{d=JSON.parse(h)}catch{return console.error("Failed to parse AI response:",h),a.slice(0,5).map((a,b)=>({startTime:a.startTime,endTime:a.endTime,score:80-10*b,reasoning:"Available time slot based on calendar availability.",confidenceLevel:"medium"}))}let i=d.map(b=>{let c=a[b.slotIndex-1];return{startTime:c.startTime,endTime:c.endTime,score:b.score,reasoning:b.reasoning,confidenceLevel:b.confidenceLevel}});return console.log(`AI successfully ranked ${i.length} time slots`),i}catch(b){return console.error("Error ranking slots with AI:",b),a.slice(0,5).map((a,b)=>{let c=a.startTime.getHours(),d=70;return c>=9&&c<11?d=90:c>=13&&c<15?d=85:c>=11&&c<12?d=80:(c>=8&&c<9||c>=15&&c<16)&&(d=75),d-=2*b,{startTime:a.startTime,endTime:a.endTime,score:Math.max(d,50),reasoning:"Available time slot based on calendar availability and general business hour preferences.",confidenceLevel:"medium"}})}}new z,d()}catch(a){d(a)}})},53437:(a,b,c)=>{c.d(b,{r:()=>f});var d=c(91776),e=c(36836);function f(a,b,c){let[f,g]=(0,d.x)(c?.in,a,b);return+(0,e.o)(f)==+(0,e.o)(g)}},77038:(a,b,c)=>{c.d(b,{Y:()=>e});var d=c(19920);function e(a,b){return+(0,d.a)(a)<+(0,d.a)(b)}},82047:(a,b,c)=>{c.d(b,{d:()=>e});var d=c(19920);function e(a,b){return+(0,d.a)(a)>+(0,d.a)(b)}}};