exports.id=529,exports.ids=[529],exports.modules={78335:()=>{},90701:(a,b,c)=>{"use strict";c.d(b,{BW:()=>j,Rw:()=>r,SX:()=>o,fx:()=>q,lh:()=>m,nf:()=>s,qM:()=>n});var d=c(67859),e=c(96798);let f=process.env.GOOGLE_CALENDAR_CLIENT_ID||"",g=process.env.GOOGLE_CALENDAR_CLIENT_SECRET||"",h=process.env.GOOGLE_CALENDAR_REDIRECT_URI||"http://localhost:3001/api/calendar/callback";async function i(a){let b=new d.q7g.auth.OAuth2(f,g,h),c=await e.z.calendarConnection.findFirst({where:{userId:a,provider:"GOOGLE",isActive:!0}});return c&&c.accessToken&&(b.setCredentials({access_token:c.accessToken,refresh_token:c.refreshToken||void 0,expiry_date:c.expiresAt?.getTime()}),c.expiresAt&&c.expiresAt<new Date&&await l(a)),b}async function j(a){let b=new d.q7g.auth.OAuth2(f,g,h).generateAuthUrl({access_type:"offline",scope:["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events"],state:a,prompt:"consent"});return console.log(`Generated auth URL for user ${a}`),b}async function k(a,b){let c=new d.q7g.auth.OAuth2(f,g,h);try{let{tokens:f}=await c.getToken(a);if(!f.access_token)throw Error("No access token received from Google");let g=new Date(f.expiry_date?f.expiry_date:Date.now()+36e5);c.setCredentials(f);let h=d.q7g.oauth2({version:"v2",auth:c}),i=(await h.userinfo.get()).data.id||"default",j=f.scope||"https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";await e.z.calendarConnection.upsert({where:{userId_provider_providerAccountId:{userId:b,provider:"GOOGLE",providerAccountId:i}},update:{accessToken:f.access_token,refreshToken:f.refresh_token||void 0,expiresAt:g,isActive:!0,lastSyncAt:new Date,scope:j},create:{userId:b,provider:"GOOGLE",providerAccountId:i,accessToken:f.access_token,refreshToken:f.refresh_token||void 0,expiresAt:g,isActive:!0,lastSyncAt:new Date,scope:j}}),console.log(`Successfully stored tokens for user ${b}`)}catch(a){throw console.error("Error exchanging code for tokens:",a),Error("Failed to exchange authorization code for tokens")}}async function l(a){let b=await e.z.calendarConnection.findFirst({where:{userId:a,provider:"GOOGLE",isActive:!0}});if(!b||!b.refreshToken)throw Error("No refresh token available for user");let c=new d.q7g.auth.OAuth2(f,g,h);c.setCredentials({refresh_token:b.refreshToken});try{let{credentials:d}=await c.refreshAccessToken();if(!d.access_token)throw Error("No access token received during refresh");let f=new Date(d.expiry_date?d.expiry_date:Date.now()+36e5);await e.z.calendarConnection.update({where:{id:b.id},data:{accessToken:d.access_token,expiresAt:f}}),console.log(`Successfully refreshed token for user ${a}`)}catch(a){throw console.error("Error refreshing access token:",a),await e.z.calendarConnection.update({where:{id:b.id},data:{isActive:!1}}),Error("Failed to refresh access token")}}async function m(a,b){let c=await i(a),e=d.q7g.calendar({version:"v3",auth:c});try{let c=await e.events.insert({calendarId:"primary",requestBody:b});return console.log(`Created Google Calendar event ${c.data.id} for user ${a}`),c.data}catch(c){if(401===c.code||c.message?.includes("invalid_grant")){console.log("Token expired, refreshing and retrying..."),await l(a);let c=await i(a),e=d.q7g.calendar({version:"v3",auth:c});return(await e.events.insert({calendarId:"primary",requestBody:b})).data}throw console.error("Error creating Google Calendar event:",c),Error(`Failed to create event: ${c.message}`)}}async function n(a,b,c){let e=await i(a),f=d.q7g.calendar({version:"v3",auth:e});try{let d=await f.events.update({calendarId:"primary",eventId:b,requestBody:c});return console.log(`Updated Google Calendar event ${b} for user ${a}`),d.data}catch(e){if(401===e.code||e.message?.includes("invalid_grant")){console.log("Token expired, refreshing and retrying..."),await l(a);let e=await i(a),f=d.q7g.calendar({version:"v3",auth:e});return(await f.events.update({calendarId:"primary",eventId:b,requestBody:c})).data}throw console.error("Error updating Google Calendar event:",e),Error(`Failed to update event: ${e.message}`)}}async function o(a,b){let c=await i(a),e=d.q7g.calendar({version:"v3",auth:c});try{await e.events.delete({calendarId:"primary",eventId:b}),console.log(`Deleted Google Calendar event ${b} for user ${a}`)}catch(c){if(401===c.code||c.message?.includes("invalid_grant")){console.log("Token expired, refreshing and retrying..."),await l(a);let c=await i(a),e=d.q7g.calendar({version:"v3",auth:c});await e.events.delete({calendarId:"primary",eventId:b});return}throw console.error("Error deleting Google Calendar event:",c),Error(`Failed to delete event: ${c.message}`)}}async function p(a,b,c){let e=await i(a),f=d.q7g.calendar({version:"v3",auth:e});try{let d=await f.events.list({calendarId:"primary",timeMin:b.toISOString(),timeMax:c.toISOString(),singleEvents:!0,orderBy:"startTime",maxResults:2500});return console.log(`Retrieved ${d.data.items?.length||0} events from Google Calendar for user ${a}`),d.data.items||[]}catch(e){if(401===e.code||e.message?.includes("invalid_grant")){console.log("Token expired, refreshing and retrying..."),await l(a);let e=await i(a),f=d.q7g.calendar({version:"v3",auth:e});return(await f.events.list({calendarId:"primary",timeMin:b.toISOString(),timeMax:c.toISOString(),singleEvents:!0,orderBy:"startTime",maxResults:2500})).data.items||[]}throw console.error("Error listing Google Calendar events:",e),Error(`Failed to list events: ${e.message}`)}}async function q(a){let b=[],c=0;try{let d=new Date;d.setDate(d.getDate()-30);let f=new Date;for(let g of(f.setDate(f.getDate()+90),await p(a,d,f)))try{if(!g.start?.dateTime||!g.end?.dateTime)continue;let b=new Date(g.start.dateTime),d=new Date(g.end.dateTime),f=await e.z.schedulingEvent.findFirst({where:{userId:a,calendarIntegrationData:{path:["googleEventId"],equals:g.id}}});f?await e.z.schedulingEvent.update({where:{id:f.id},data:{title:g.summary||"Untitled Event",description:g.description,location:g.location,startTime:b,endTime:d,status:"cancelled"===g.status?"CANCELLED":f.status,calendarIntegrationData:{googleEventId:g.id,provider:"GOOGLE",syncedAt:new Date().toISOString()}}}):await e.z.schedulingEvent.create({data:{userId:a,title:g.summary||"Untitled Event",description:g.description,location:g.location,startTime:b,endTime:d,calendarIntegrationData:{googleEventId:g.id,provider:"GOOGLE",syncedAt:new Date().toISOString()},status:"cancelled"===g.status?"CANCELLED":"CONFIRMED"}}),c++}catch(a){console.error(`Error syncing event ${g.id}:`,a),b.push(`Event ${g.id}: ${a.message}`)}return await e.z.calendarConnection.updateMany({where:{userId:a,provider:"GOOGLE",isActive:!0},data:{lastSyncAt:new Date}}),console.log(`Sync complete for user ${a}: ${c} events synced, ${b.length} errors`),{synced:c,errors:b}}catch(a){return console.error("Error during Google Calendar sync:",a),b.push(`Sync failed: ${a.message}`),{synced:c,errors:b}}}async function r(a,b){return k(a,b)}async function s(a,b){try{let c=await e.z.calendarConnection.findUnique({where:{id:a}});if(!c)throw Error("Calendar connection not found");if(c.userId!==b)throw Error("Unauthorized: You do not own this calendar connection");await e.z.calendarConnection.update({where:{id:a},data:{isActive:!1,accessToken:"",refreshToken:null}}),console.log(`Disconnected calendar connection ${a} for user ${b}`)}catch(a){throw console.error("Error disconnecting calendar:",a),a}}},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};