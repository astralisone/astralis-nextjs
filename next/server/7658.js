"use strict";exports.id=7658,exports.ids=[7658],exports.modules={22553:(a,b,c)=>{var d=c(55511)},25603:(a,b,c)=>{c.d(b,{K:()=>d});let d=new(c(37659)).Redis(process.env.REDIS_URL||"redis://localhost:6379",{maxRetriesPerRequest:null,enableReadyCheck:!1,retryStrategy:a=>Math.min(50*a,2e3)});d.on("error",a=>{console.error("[Redis] Connection error:",a)}),d.on("connect",()=>{console.log("[Redis] Connected successfully")}),d.on("ready",()=>{console.log("[Redis] Ready to accept commands")}),d.on("close",()=>{console.log("[Redis] Connection closed")}),d.on("reconnecting",()=>{console.log("[Redis] Reconnecting...")})},25988:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{$r:()=>k,BN:()=>j});var e=c(42100),f=c(56842),g=c(97498),h=c(65152),i=a([e]);e=(i.then?(await i)():i)[0];let l=new Map,m=null,n={debug:(a,b)=>{},info:(a,b)=>{console.info(`[Agent] ${a}`,b||"")},warn:(a,b)=>{console.warn(`[Agent] ${a}`,b||"")},error:(a,b,c)=>{console.error(`[Agent] ${a}`,b,c||"")}};function j(a,b){let c=l.get(a);return c||(c=function(a,b={}){var c;let{llmProvider:d=h.Dd.CLAUDE,llmModel:f=d===h.Dd.CLAUDE?"claude-sonnet-4-20250514":"gpt-4-turbo",temperature:g=.3,maxTokens:i=2e3,autoExecuteThreshold:j=.85,requireApprovalThreshold:k=.5,enabledActions:l=Object.values(h.PS),escalationEmail:m=(c="admin@localhost","undefined"!=typeof process&&process.env?process.env.AGENT_ESCALATION_EMAIL??c:c),notifyOnHighPriority:o=!0,notifyOnFailure:p=!0,maxActionsPerMinute:q=60,maxActionsPerHour:r=500,systemPrompt:s,logger:t=n}=b;return t.info("Creating agent for organization",{orgId:a,llmProvider:d,llmModel:f}),(0,e.Dy)({orgId:a,llmProvider:d,llmModel:f,temperature:g,maxTokens:i,autoExecuteThreshold:j,requireApprovalThreshold:k,enabledActions:l,escalationEmail:m,notifyOnHighPriority:o,notifyOnFailure:p,maxActionsPerMinute:q,maxActionsPerHour:r,systemPrompt:s,logger:t})}(a,b),l.set(a,c)),c}async function k(a={}){let{enableWebhooks:b=!0,enableEmail:c=!0,enableDBTriggers:d=!1,enableWorkerEvents:e=!1,eventBusConfig:h={},logger:i=n}=a;i.info("Initializing agent system",{enableWebhooks:b,enableEmail:c,enableDBTriggers:d,enableWorkerEvents:e});let j=f.io.getInstance({historySize:h.historySize??1e3,debug:h.debug??!1,defaultOrgId:h.defaultOrgId,logger:i}),l={};b&&(l.webhook=(0,f.su)({eventBus:j,logger:i}),i.debug("Webhook handler initialized")),c&&(l.email=new f.L_({eventBus:j,logger:i}),i.debug("Email handler initialized")),d&&(l.dbTrigger=new f.nM({eventBus:j,logger:i}),i.debug("DB trigger handler initialized")),e&&(l.workerEvent=new f.v_({eventBus:j,logger:i}),i.debug("Worker event handler initialized"));let o={};return o.notificationDispatcher=g.Pc,o.automationTrigger=(0,g.w4)(),m={eventBus:j,handlers:l,actions:o,initialized:!0},i.info("Agent system initialized successfully"),m}d()}catch(a){d(a)}})},26253:(a,b,c)=>{c.d(b,{vh:()=>g});var d=c(83367),e=c(25603);let f=new d.Queue("scheduling-reminders",{connection:e.K,defaultJobOptions:{attempts:3,backoff:{type:"exponential",delay:2e3},removeOnComplete:{age:604800,count:500},removeOnFail:{age:1209600}}});async function g(a){await f.add("send-reminder",a,{jobId:`reminder-${a.reminderId}`}),console.log(`[Queue] Reminder job queued: ${a.reminderId} for event ${a.eventId}`)}},65152:(a,b,c)=>{c.d(b,{Dd:()=>d.Dd,PS:()=>d.PS,nm:()=>d.nm});var d=c(83878)},67658:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{BN:()=>g.BN,Ju:()=>f.Ju,initializeAgentSystem:()=>g.$r}),c(65152);var e=c(42100),f=c(56842);c(97498),c(9545);var g=c(25988);c(22553);var h=a([e,g]);[e,g]=h.then?(await h)():h,d()}catch(a){d(a)}})},97498:(a,b,c)=>{c.d(b,{w4:()=>r,Pc:()=>x}),c(2932);var d=c(45711);let e=d.Ik({workflowId:d.Yj().min(1),triggerData:d.g1(d.L5()),context:d.Ik({orgId:d.Yj().min(1),userId:d.Yj().optional(),sourceEvent:d.Yj().optional(),correlationId:d.Yj().optional(),metadata:d.g1(d.L5()).optional()}),options:d.Ik({timeout:d.ai().positive().optional(),retries:d.ai().int().min(0).max(10).optional(),async:d.zM().optional(),callbackUrl:d.Yj().url().optional(),headers:d.g1(d.Yj()).optional(),priority:d.ai().int().min(1).max(5).optional()}).optional()}),f=d.Ik({webhookUrl:d.Yj().url(),payload:d.g1(d.L5()),options:d.Ik({timeout:d.ai().positive().optional(),retries:d.ai().int().min(0).max(10).optional(),headers:d.g1(d.Yj()).optional(),method:d.k5(["GET","POST","PUT","PATCH"]).optional()}).optional()});class g extends Error{constructor(a,b,c=!1,d,e){super(a),this.code=b,this.retryable=c,this.statusCode=d,this.originalError=e,this.name="AutomationError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,g)}}class h extends g{constructor(a,b){super(`Rate limit exceeded for workflow ${a}`,"RATE_LIMIT_EXCEEDED",!0,429),this.retryAfterMs=b,this.name="RateLimitExceededError"}}class i extends g{constructor(a){super(`Workflow not found: ${a}`,"WORKFLOW_NOT_FOUND",!1,404),this.name="WorkflowNotFoundError"}}class j extends g{constructor(a,b,c=!1,d){super(a,"WEBHOOK_REQUEST_FAILED",c,b,d),this.name="WebhookRequestError"}}class k extends g{constructor(a,b){super(`Execution timed out after ${b}ms for workflow ${a}`,"EXECUTION_TIMEOUT",!0,408),this.name="ExecutionTimeoutError"}}let l="undefined"!=typeof process&&!1;function m(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{let b=16*Math.random()|0;return("x"===a?b:3&b|8).toString(16)})}function n(a){return new Promise(b=>setTimeout(b,a))}class o{constructor(a,b){this.limitPerWindow=a,this.globalLimit=b,this.entries=new Map,this.windowMs=6e4}isAllowed(a){let b=Date.now();this.cleanup(b);let c=this.entries.get("__global__")??{timestamps:[],lastReset:b};if(c.timestamps.length>=this.globalLimit)return{allowed:!1,retryAfterMs:Math.max(0,c.timestamps[0]+this.windowMs-b)};let d=this.entries.get(a)??{timestamps:[],lastReset:b};return d.timestamps.length>=this.limitPerWindow?{allowed:!1,retryAfterMs:Math.max(0,d.timestamps[0]+this.windowMs-b)}:{allowed:!0}}record(a){let b=Date.now(),c=this.entries.get("__global__")??{timestamps:[],lastReset:b};c.timestamps.push(b),this.entries.set("__global__",c);let d=this.entries.get(a)??{timestamps:[],lastReset:b};d.timestamps.push(b),this.entries.set(a,d)}cleanup(a){let b=a-this.windowMs;for(let[a,c]of this.entries.entries())c.timestamps=c.timestamps.filter(a=>a>b),0===c.timestamps.length&&this.entries.delete(a)}getStats(a){this.cleanup(Date.now());let b=this.entries.get(a)??{timestamps:[],lastReset:Date.now()};return{requestsInWindow:b.timestamps.length,remaining:Math.max(0,this.limitPerWindow-b.timestamps.length)}}}class p{add(a){this.entries.unshift(a),this.entries.length>this.maxEntries&&(this.entries=this.entries.slice(0,this.maxEntries))}update(a,b){let c=this.entries.find(b=>b.id===a);c&&Object.assign(c,b)}get(a){return this.entries.find(b=>b.id===a)}getRecent(a=100){return this.entries.slice(0,a)}getByWorkflow(a,b=50){return this.entries.filter(b=>b.workflowId===a).slice(0,b)}constructor(){this.entries=[],this.maxEntries=1e3}}class q{constructor(a){this.scheduledAutomations=new Map,this.workflowCache=new Map,this.stats={totalTriggers:0,successfulTriggers:0,failedTriggers:0,totalWebhookCalls:0,averageExecutionTimeMs:0},this.config={n8nBaseUrl:a.n8nBaseUrl.replace(/\/$/,""),n8nApiKey:a.n8nApiKey??"",defaultTimeout:a.defaultTimeout??3e4,defaultRetries:a.defaultRetries??3,rateLimitPerWorkflow:a.rateLimitPerWorkflow??30,globalRateLimit:a.globalRateLimit??100,logger:a.logger??function(a){return{debug:(b,c)=>{l&&console.debug(`[${a}] ${b}`,c??"")},info:(b,c)=>{console.info(`[${a}] ${b}`,c??"")},warn:(b,c)=>{console.warn(`[${a}] ${b}`,c??"")},error:(b,c,d)=>{console.error(`[${a}] ${b}`,c,d??"")}}}("AutomationTrigger"),debug:a.debug??!1},this.logger=this.config.logger,this.rateLimiter=new o(this.config.rateLimitPerWorkflow,this.config.globalRateLimit),this.executionLog=new p,this.logger.info("AutomationTrigger initialized",{n8nBaseUrl:this.config.n8nBaseUrl,defaultTimeout:this.config.defaultTimeout,rateLimitPerWorkflow:this.config.rateLimitPerWorkflow})}async trigger(a,b,c,d){let f=Date.now(),j=m(),k=c?.correlationId??m();this.logger.info(`Triggering workflow ${a}`,{executionId:j,correlationId:k,async:d?.async});let l=e.safeParse({workflowId:a,triggerData:b,context:c??{orgId:"default"},options:d});if(!l.success)return this.createFailedResult(a,f,"VALIDATION_ERROR",`Invalid trigger payload: ${l.error.message}`,!1);let n=this.rateLimiter.isAllowed(a);if(!n.allowed)throw this.logger.warn(`Rate limit exceeded for workflow ${a}`,{retryAfterMs:n.retryAfterMs}),new h(a,n.retryAfterMs);this.rateLimiter.record(a),this.executionLog.add({id:j,workflowId:a,status:"pending",triggeredAt:new Date,context:c});try{let c,e=await this.getWorkflowDetails(a);if(!e)throw new i(a);if(!e.isActive)return this.createFailedResult(a,f,"WORKFLOW_INACTIVE",`Workflow ${a} is not active`,!1);return c=e.webhookUrl?await this.executeWebhookTrigger(e.webhookUrl,b,j,a,f,d):await this.executeApiTrigger(a,b,j,f,d),this.executionLog.update(j,{status:c.status,completedAt:c.completedAt,executionTimeMs:c.executionTimeMs,error:c.error}),this.updateStats(c),c}catch(b){let a=b instanceof Error?b.message:String(b);throw b instanceof g&&b.retryable,this.executionLog.update(j,{status:"failed",completedAt:new Date,executionTimeMs:Date.now()-f,error:a}),this.stats.failedTriggers++,b}}async triggerByName(a,b,c,d){this.logger.info(`Looking up workflow by name: ${a}`,{orgId:c});let e=(await this.listAvailableWorkflows(c)).find(b=>b.name.toLowerCase()===a.toLowerCase());if(!e)throw new i(`name:${a}`);return this.trigger(e.id,b,{orgId:c},d)}async triggerWebhook(a,b,c){let d,e=Date.now(),g=m(),i=f.safeParse({webhookUrl:a,payload:b,options:c});if(!i.success)return{success:!1,workflowId:"webhook",status:"failed",executionTimeMs:Date.now()-e,error:`Invalid webhook request: ${i.error.message}`,errorCode:"VALIDATION_ERROR",retryable:!1,triggeredAt:new Date,statusCode:400};let j=this.rateLimiter.isAllowed("__webhooks__");if(!j.allowed)throw new h("__webhooks__",j.retryAfterMs);this.rateLimiter.record("__webhooks__"),this.stats.totalWebhookCalls++;let k=c?.timeout??this.config.defaultTimeout,l=c?.retries??this.config.defaultRetries,o=c?.method??"POST",p=0;for(;p<=l;)try{return p>0&&(this.logger.info(`Webhook retry attempt ${p}/${l}`,{executionId:g,webhookUrl:a}),await n(Math.min(1e3*Math.pow(2,p-1),3e4))),await this.executeWebhookRequest(a,b,o,k,c?.headers,g,e)}catch(a){if(d=a,p++,!this.shouldRetryError(a))break}return{success:!1,workflowId:"webhook",status:"failed",executionTimeMs:Date.now()-e,error:d?.message??"Unknown error",errorCode:"WEBHOOK_FAILED",retryable:!1,triggeredAt:new Date,statusCode:500}}async scheduleAutomation(a,b,c,d){let e=m();if(c<=new Date)throw new g("Scheduled time must be in the future","INVALID_SCHEDULE_TIME",!1);let f={id:e,workflowId:a,payload:b,context:d??{orgId:"default"},runAt:c,status:"pending",createdAt:new Date};this.scheduledAutomations.set(e,f);let h=c.getTime()-Date.now();return setTimeout(async()=>{await this.executeScheduledAutomation(e)},h),this.logger.info(`Scheduled automation ${e}`,{workflowId:a,runAt:c.toISOString(),delayMs:h}),e}async cancelScheduled(a){let b=this.scheduledAutomations.get(a);if(!b)throw new g(`Scheduled automation not found: ${a}`,"SCHEDULE_NOT_FOUND",!1);if("pending"!==b.status)throw new g(`Cannot cancel automation with status: ${b.status}`,"INVALID_SCHEDULE_STATUS",!1);b.status="cancelled",this.scheduledAutomations.set(a,b),this.logger.info(`Cancelled scheduled automation ${a}`)}async getWorkflowStatus(a){let b=this.executionLog.get(a);if(b)return{executionId:a,workflowId:b.workflowId,status:b.status,startedAt:b.triggeredAt,finishedAt:b.completedAt,durationMs:b.executionTimeMs,mode:"trigger",retryCount:0,error:b.error?{message:b.error}:void 0};if(this.config.n8nApiKey)try{let b=await this.makeApiRequest(`/executions/${a}`,"GET");return this.mapN8nExecutionToStatus(b)}catch(b){this.logger.error("Failed to get execution status from n8n",b,{executionId:a})}throw new g(`Execution not found: ${a}`,"EXECUTION_NOT_FOUND",!1)}async listAvailableWorkflows(a){if(!this.config.n8nApiKey)return this.logger.warn("n8n API key not configured, returning cached workflows only"),Array.from(this.workflowCache.values()).filter(b=>b.orgId===a);try{let b=(await this.makeApiRequest("/workflows","GET")).data.map(b=>this.mapN8nWorkflowToWorkflow(b,a));for(let a of b)this.workflowCache.set(a.id,a);return b}catch(b){return this.logger.error("Failed to list workflows from n8n",b,{orgId:a}),Array.from(this.workflowCache.values()).filter(b=>b.orgId===a)}}getStats(){return{...this.stats,rateLimitStats:{global:this.rateLimiter.getStats("__global__")}}}getRecentExecutions(a=100){return this.executionLog.getRecent(a)}getScheduledAutomations(){return Array.from(this.scheduledAutomations.values())}async executeWebhookTrigger(a,b,c,d,e,f){let g,h=f?.timeout??this.config.defaultTimeout,i=f?.retries??this.config.defaultRetries,j=0;for(;j<=i;)try{return j>0&&(this.logger.info(`Trigger retry attempt ${j}/${i}`,{executionId:c,workflowId:d}),await n(Math.min(1e3*Math.pow(2,j-1),3e4))),{...await this.executeWebhookRequest(a,b,"POST",h,f?.headers,c,e),workflowId:d,executionId:c}}catch(a){if(g=a,j++,!this.shouldRetryError(a))break}return this.createFailedResult(d,e,"TRIGGER_FAILED",g?.message??"Webhook trigger failed",!1,c)}async executeApiTrigger(a,b,c,d,e){if(!this.config.n8nApiKey)return this.createFailedResult(a,d,"API_NOT_CONFIGURED","n8n API key not configured",!1,c);try{let f=await this.makeApiRequest(`/workflows/${a}/execute`,"POST",b,e?.timeout);return{success:!0,executionId:f.id??c,workflowId:a,data:f.data,status:this.mapN8nStatus(f.status),executionTimeMs:Date.now()-d,triggeredAt:new Date(d),completedAt:new Date}}catch(b){return this.createFailedResult(a,d,"API_TRIGGER_FAILED",b.message,this.shouldRetryError(b),c)}}async executeWebhookRequest(a,b,c,d,e,f,g){let h=g??Date.now(),i=new AbortController,j=setTimeout(()=>i.abort(),d);try{let d,g=await fetch(a,{method:c,headers:{"Content-Type":"application/json","User-Agent":"AstralisOps-AutomationTrigger/1.0","X-Execution-ID":f??m(),...e},body:"GET"!==c?JSON.stringify(b):void 0,signal:i.signal});clearTimeout(j);let k=await g.text();try{d=JSON.parse(k)}catch{}let l=Date.now()-h;if(!g.ok)return{success:!1,workflowId:"webhook",status:"failed",executionTimeMs:l,error:`HTTP ${g.status}: ${g.statusText}`,errorCode:`HTTP_${g.status}`,retryable:g.status>=500||429===g.status,triggeredAt:new Date(h),completedAt:new Date,statusCode:g.status,rawResponse:k};return{success:!0,executionId:f??m(),workflowId:"webhook",data:d,status:"success",executionTimeMs:l,triggeredAt:new Date(h),completedAt:new Date,statusCode:g.status,headers:Object.fromEntries(g.headers.entries()),rawResponse:k}}catch(b){clearTimeout(j);let a="AbortError"===b.name;return{success:!1,workflowId:"webhook",status:a?"timed_out":"failed",executionTimeMs:Date.now()-h,error:a?`Request timed out after ${d}ms`:b.message,errorCode:a?"TIMEOUT":"REQUEST_FAILED",retryable:a,triggeredAt:new Date(h),completedAt:new Date,statusCode:0}}}async executeScheduledAutomation(a){let b=this.scheduledAutomations.get(a);if(b&&"pending"===b.status){this.logger.info(`Executing scheduled automation ${a}`);try{let a=await this.trigger(b.workflowId,b.payload,b.context);b.status=a.success?"executed":"failed",b.result=a}catch(a){b.status="failed",b.result=this.createFailedResult(b.workflowId,b.runAt.getTime(),"SCHEDULED_EXECUTION_FAILED",a.message,!1)}this.scheduledAutomations.set(a,b)}}async getWorkflowDetails(a){if(this.workflowCache.has(a))return this.workflowCache.get(a)??null;if(this.config.n8nApiKey)try{let b=await this.makeApiRequest(`/workflows/${a}`,"GET"),c=this.mapN8nWorkflowToWorkflow(b,"default");return this.workflowCache.set(a,c),c}catch(b){this.logger.error("Failed to get workflow from n8n",b,{workflowId:a})}return null}async makeApiRequest(a,b,c,d){let e=`${this.config.n8nBaseUrl}/api/v1${a}`,f=d??this.config.defaultTimeout,g=new AbortController,h=setTimeout(()=>g.abort(),f);try{let a=await fetch(e,{method:b,headers:{"Content-Type":"application/json","X-N8N-API-KEY":this.config.n8nApiKey},body:c?JSON.stringify(c):void 0,signal:g.signal});if(clearTimeout(h),!a.ok)throw new j(`n8n API error: ${a.status} ${a.statusText}`,a.status,a.status>=500);return await a.json()}catch(a){if(clearTimeout(h),"AbortError"===a.name)throw new k("n8n-api",f);throw a}}createFailedResult(a,b,c,d,e,f){return{success:!1,executionId:f,workflowId:a,status:"failed",executionTimeMs:Date.now()-b,error:d,errorCode:c,retryable:e,triggeredAt:new Date(b),completedAt:new Date}}shouldRetryError(a){if(a instanceof g)return a.retryable;let b=a.message.toLowerCase();return b.includes("timeout")||b.includes("network")||b.includes("econnreset")||b.includes("socket")||b.includes("502")||b.includes("503")||b.includes("504")}updateStats(a){this.stats.totalTriggers++,a.success?this.stats.successfulTriggers++:this.stats.failedTriggers++;let b=this.stats.successfulTriggers+this.stats.failedTriggers;this.stats.averageExecutionTimeMs=(this.stats.averageExecutionTimeMs*(b-1)+a.executionTimeMs)/b}mapN8nWorkflowToWorkflow(a,b){let c;if(a.nodes){let b=a.nodes.find(a=>"n8n-nodes-base.webhook"===a.type);b?.parameters?.path&&(c=`${this.config.n8nBaseUrl}/webhook/${b.parameters.path}`)}return{id:a.id,name:a.name,description:a.settings?.description,type:this.inferWorkflowType(a),isActive:a.active,webhookUrl:c,orgId:b,tags:a.tags?.map(a=>a.name)??[],createdAt:new Date(a.createdAt),updatedAt:new Date(a.updatedAt),executionCount:0,successRate:1}}inferWorkflowType(a){let b=a.nodes?.map(a=>a.type.toLowerCase())??[];return b.some(a=>a.includes("email")||a.includes("sendgrid")||a.includes("mailgun"))?"email_sequence":b.some(a=>a.includes("slack"))?"slack_notification":b.some(a=>a.includes("salesforce")||a.includes("hubspot")||a.includes("crm"))?"crm_update":b.some(a=>a.includes("spreadsheet")||a.includes("google sheets")||a.includes("excel"))?"report_generation":"custom_integration"}mapN8nStatus(a){switch(a?.toLowerCase()){case"success":return"success";case"running":return"running";case"waiting":return"waiting";case"error":case"failed":return"failed";case"cancelled":return"cancelled";default:return"pending"}}mapN8nExecutionToStatus(a){return{executionId:a.id,workflowId:a.workflowId??"unknown",status:this.mapN8nStatus(a.status),startedAt:new Date(a.startedAt??Date.now()),finishedAt:a.finishedAt?new Date(a.finishedAt):void 0,durationMs:a.stoppedAt&&a.startedAt?new Date(a.stoppedAt).getTime()-new Date(a.startedAt).getTime():void 0,mode:a.mode,retryCount:0,data:a.data,error:a.error?{message:a.error.message,code:a.error.code}:void 0}}}function r(){let a=process.env.N8N_BASE_URL??process.env.NEXT_PUBLIC_N8N_BASE_URL,b=process.env.N8N_API_KEY;if(!a)throw Error("N8N_BASE_URL environment variable is required");return new q({n8nBaseUrl:a,n8nApiKey:b,defaultTimeout:parseInt(process.env.N8N_TIMEOUT??"30000",10),defaultRetries:parseInt(process.env.N8N_RETRIES??"3",10),rateLimitPerWorkflow:parseInt(process.env.N8N_RATE_LIMIT_PER_WORKFLOW??"30",10),globalRateLimit:parseInt(process.env.N8N_GLOBAL_RATE_LIMIT??"100",10),debug:!1})}var s=c(45494);c(26253),d.Ik({userId:d.Yj().min(1),orgId:d.Yj().optional(),title:d.Yj().min(1).max(200),description:d.Yj().max(5e3).optional(),startTime:d.p6(),endTime:d.p6(),timezone:d.Yj().optional(),location:d.Yj().max(500).optional(),createMeetingLink:d.zM().optional(),conferenceProvider:d.k5(["google_meet","zoom","teams","webex","custom"]).optional(),attendees:d.YO(d.Ik({id:d.Yj().nullable().optional(),email:d.Yj().email(),name:d.Yj().min(1),isRequired:d.zM().optional()})).optional(),visibility:d.k5(["default","public","private","confidential"]).optional(),reminders:d.YO(d.Ik({minutesBefore:d.ai().int().positive(),method:d.k5(["email","push","sms","popup"])})).optional(),recurrence:d.Ik({frequency:d.k5(["daily","weekly","monthly","yearly"]),interval:d.ai().int().positive(),daysOfWeek:d.YO(d.ai().int().min(0).max(6)).optional(),dayOfMonth:d.ai().int().min(1).max(31).optional(),endDate:d.p6().optional(),count:d.ai().int().positive().optional(),exceptions:d.YO(d.p6()).optional()}).optional(),metadata:d.g1(d.L5()).optional(),sendInvites:d.zM().optional()}),d.Ik({title:d.Yj().min(1).max(200).optional(),description:d.Yj().max(5e3).optional().nullable(),startTime:d.p6().optional(),endTime:d.p6().optional(),timezone:d.Yj().optional(),location:d.Yj().max(500).optional().nullable(),meetingLink:d.Yj().url().optional().nullable(),status:d.k5(["scheduled","confirmed","cancelled","completed","conflict"]).optional(),visibility:d.k5(["default","public","private","confidential"]).optional(),notifyAttendees:d.zM().optional()}),s.Ln.bufferMinutes,s.Ln.businessHours,s.Ln.lunchHours,s.Ln.maxMeetingsPerDay,s.Ln.maxConsecutiveHours;var t=c(96798);let u={rateLimits:{perMinute:10,perHour:50,perDay:200,urgentBurstLimit:5},deduplicationWindowSeconds:300,retry:{maxAttempts:3,baseDelayMs:1e3,maxDelayMs:3e4},services:{email:{provider:"sendgrid",fromAddress:"noreply@astralis.agency",fromName:"Astralis Agency"}}},v={debug:(a,b)=>{},info:(a,b)=>{console.info(`[NotificationDispatcher] ${a}`,b||"")},warn:(a,b)=>{console.warn(`[NotificationDispatcher] ${a}`,b||"")},error:(a,b,c)=>{console.error(`[NotificationDispatcher] ${a}`,b,c||"")}};class w{constructor(a,b){this.templates=new Map,this.rateLimitCache=new Map,this.deduplicationCache=new Map,this.scheduledNotifications=new Map,this.config={...u,...a},this.logger=b||v,this.initializeTemplates(),this.startDeduplicationCleanup()}async send(a){let b=Date.now();try{let c;if(this.validatePayload(a),a.deduplicationKey&&this.checkDeduplication(a.deduplicationKey))return this.logger.info("Notification deduplicated",{deduplicationKey:a.deduplicationKey}),{success:!0,channel:a.channel,recipient:a.recipient,status:"sent",timestamp:new Date,deduplicated:!0};let d=await this.checkRateLimit(a.recipient,a.priority);if(!d.allowed)return this.logger.warn("Rate limit exceeded",{recipient:a.recipient,limit:d.limit}),{success:!1,channel:a.channel,recipient:a.recipient,status:"failed",error:`Rate limit exceeded. Try again in ${d.retryAfterMs}ms`,timestamp:new Date};if(!1!==a.respectQuietHours){let b=await this.checkQuietHours(a.recipient,a.priority);if(b.inQuietHours&&"urgent"!==a.priority&&(this.logger.info("Notification deferred for quiet hours",{recipient:a.recipient,resumeAt:b.resumeAt}),b.resumeAt)){let c=await this.scheduleNotification(a,b.resumeAt);return{success:!0,notificationId:c,channel:a.channel,recipient:a.recipient,status:"queued",timestamp:new Date,deferredForQuietHours:!0}}}let e=a.subject,f=a.body;if(a.templateId){let b=await this.renderTemplate(a.templateId,a.templateData||{});e=b.subject,f=b.body}let g=await this.personalizeContent(f,a.recipient,a.metadata);switch(a.channel){case"email":c=await this.sendViaEmail(a.recipient,e,g,a);break;case"in_app":c=await this.sendViaInApp(a.recipient,e,g,a);break;case"sms":c=await this.sendViaSMS(a.recipient,g,a);break;case"push":c=await this.sendViaPush(a.recipient,e,g,a);break;default:throw Error(`Unsupported notification channel: ${a.channel}`)}a.deduplicationKey&&c.success&&this.recordDeduplication(a.deduplicationKey),c.success&&this.recordRateLimitUsage(a.recipient),await this.storeNotificationRecord({...a,subject:e,body:g},c);let h=Date.now()-b;return this.logger.info("Notification sent",{channel:a.channel,recipient:a.recipient,success:c.success,processingTimeMs:h}),c}catch(c){let b=c instanceof Error?c.message:"Unknown error";return this.logger.error("Failed to send notification",c,{channel:a.channel,recipient:a.recipient}),{success:!1,channel:a.channel,recipient:a.recipient,status:"failed",error:b,timestamp:new Date}}}async sendEmail(a,b,c,d){let e=await this.send({channel:"email",recipient:a,subject:b,body:c,priority:"medium",metadata:d});if(!e.success)throw Error(`Failed to send email: ${e.error}`)}async sendInApp(a,b,c,d){let e=await this.send({channel:"in_app",recipient:a,subject:c,body:b,priority:"medium",notificationType:c,metadata:d});if(!e.success)throw Error(`Failed to send in-app notification: ${e.error}`)}async sendBulk(a){let b=Date.now(),c=[],d=0,e=0,f=0;for(let b of this.chunkArray(a,10))for(let a of(await Promise.all(b.map(a=>this.send(a)))))c.push(a),a.deduplicated?f++:a.success?d++:e++;let g=Date.now()-b;return this.logger.info("Bulk notifications sent",{total:a.length,successful:d,failed:e,deduplicated:f,processingTimeMs:g}),{total:a.length,successful:d,failed:e,deduplicated:f,results:c,processingTimeMs:g}}async scheduleNotification(a,b){let c=this.generateId(),d=b.getTime()-Date.now();if(d<=0)return await this.send(a),c;try{await t.z.$executeRaw`
        INSERT INTO scheduled_notifications (id, payload, scheduled_for, created_at, status)
        VALUES (${c}, ${JSON.stringify(a)}::jsonb, ${b}, NOW(), 'pending')
        ON CONFLICT DO NOTHING
      `}catch{this.logger.warn("scheduled_notifications table not found, using in-memory scheduling")}let e=setTimeout(async()=>{this.scheduledNotifications.delete(c),await this.send(a)},Math.min(d,0x7fffffff));return this.scheduledNotifications.set(c,e),this.logger.info("Notification scheduled",{notificationId:c,sendAt:b.toISOString(),delayMs:d}),c}async cancelScheduled(a){let b=this.scheduledNotifications.get(a);b&&(clearTimeout(b),this.scheduledNotifications.delete(a));try{await t.z.$executeRaw`
        UPDATE scheduled_notifications
        SET status = 'cancelled', updated_at = NOW()
        WHERE id = ${a}
      `}catch{this.logger.warn("Could not update scheduled_notifications table")}this.logger.info("Scheduled notification cancelled",{notificationId:a})}async getNotificationHistory(a,b=50){try{return(await t.z.$queryRaw`
        SELECT * FROM in_app_notifications
        WHERE user_id = ${a}
        ORDER BY created_at DESC
        LIMIT ${b}
      `).map(a=>({id:a.id,channel:a.channel,recipient:a.user_id,subject:a.subject,body:a.body,priority:a.priority,status:a.status,metadata:a.metadata,actionUrl:a.action_url||void 0,sentAt:a.sent_at||void 0,deliveredAt:a.delivered_at||void 0,readAt:a.read_at||void 0,createdAt:a.created_at,updatedAt:a.updated_at,externalId:a.external_id||void 0,errorMessage:a.error_message||void 0,retryCount:a.retry_count}))}catch{return this.logger.warn("in_app_notifications table not found"),[]}}async markAsRead(a,b){try{await t.z.$executeRaw`
        UPDATE in_app_notifications
        SET read_at = NOW(), status = 'delivered', updated_at = NOW()
        WHERE id = ${a} AND user_id = ${b}
      `}catch{this.logger.warn("Could not mark notification as read",{notificationId:a,userId:b})}}async getUnreadCount(a){try{let b=await t.z.$queryRaw`
        SELECT COUNT(*) as count FROM in_app_notifications
        WHERE user_id = ${a} AND read_at IS NULL
      `;return Number(b[0].count)}catch{return 0}}registerTemplate(a){this.templates.set(a.id,a),this.logger.debug("Template registered",{templateId:a.id})}destroy(){for(let[a,b]of this.scheduledNotifications)clearTimeout(b),this.scheduledNotifications.delete(a);this.logger.info("NotificationDispatcher destroyed")}async sendViaEmail(a,b,c,d){let e=this.config.services.email;if(!e)return{success:!1,channel:"email",recipient:a,status:"failed",error:"Email service not configured",timestamp:new Date};try{switch(e.provider){case"sendgrid":this.logger.debug("Would send via SendGrid",{to:a,subject:b});break;case"ses":this.logger.debug("Would send via AWS SES",{to:a,subject:b});break;case"resend":this.logger.debug("Would send via Resend",{to:a,subject:b});break;default:this.logger.debug("Would send via SMTP",{to:a,subject:b})}let d=this.generateId();try{await t.z.$executeRaw`
          INSERT INTO email_queue (id, to_address, subject, body, status, created_at)
          VALUES (${d}, ${a}, ${b}, ${c}, 'queued', NOW())
          ON CONFLICT DO NOTHING
        `}catch{}return{success:!0,notificationId:d,channel:"email",recipient:a,status:"queued",timestamp:new Date}}catch(b){return{success:!1,channel:"email",recipient:a,status:"failed",error:b instanceof Error?b.message:"Unknown error",timestamp:new Date}}}async sendViaInApp(a,b,c,d){try{let e=this.generateId();try{await t.z.$executeRaw`
          INSERT INTO in_app_notifications (
            id, user_id, channel, subject, body, priority, status,
            metadata, action_url, created_at, updated_at, retry_count
          )
          VALUES (
            ${e}, ${a}, 'in_app', ${b}, ${c},
            ${d.priority}, 'sent', ${JSON.stringify(d.metadata||{})}::jsonb,
            ${d.actionUrl||null}, NOW(), NOW(), 0
          )
        `}catch(a){this.logger.warn("in_app_notifications table not found, notification not persisted",{error:a instanceof Error?a.message:"Unknown error"})}return{success:!0,notificationId:e,channel:"in_app",recipient:a,status:"sent",timestamp:new Date}}catch(b){return{success:!1,channel:"in_app",recipient:a,status:"failed",error:b instanceof Error?b.message:"Unknown error",timestamp:new Date}}}async sendViaSMS(a,b,c){let d=this.config.services.sms;if(!d)return{success:!1,channel:"sms",recipient:a,status:"failed",error:"SMS service not configured",timestamp:new Date};try{switch(d.provider){case"twilio":this.logger.debug("Would send via Twilio",{to:a,messageLength:b.length});break;case"vonage":this.logger.debug("Would send via Vonage",{to:a});break;case"aws-sns":this.logger.debug("Would send via AWS SNS",{to:a})}let c=this.generateId();return{success:!0,notificationId:c,channel:"sms",recipient:a,status:"queued",timestamp:new Date}}catch(b){return{success:!1,channel:"sms",recipient:a,status:"failed",error:b instanceof Error?b.message:"Unknown error",timestamp:new Date}}}async sendViaPush(a,b,c,d){let e=this.config.services.push;if(!e)return{success:!1,channel:"push",recipient:a,status:"failed",error:"Push notification service not configured",timestamp:new Date};try{switch(e.provider){case"fcm":this.logger.debug("Would send via FCM",{userId:a,title:b});break;case"apns":this.logger.debug("Would send via APNs",{userId:a,title:b});break;case"expo":this.logger.debug("Would send via Expo",{userId:a,title:b})}let c=this.generateId();return{success:!0,notificationId:c,channel:"push",recipient:a,status:"queued",timestamp:new Date}}catch(b){return{success:!1,channel:"push",recipient:a,status:"failed",error:b instanceof Error?b.message:"Unknown error",timestamp:new Date}}}validatePayload(a){if(!a.channel)throw Error("Notification channel is required");if(!a.recipient)throw Error("Notification recipient is required");if(!a.subject&&"sms"!==a.channel)throw Error("Notification subject is required");if(!a.body&&!a.templateId)throw Error("Notification body or templateId is required");if("email"===a.channel&&!this.isValidEmail(a.recipient))throw Error("Invalid email address");if("sms"===a.channel&&!this.isValidPhone(a.recipient))throw Error("Invalid phone number")}isValidEmail(a){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)}isValidPhone(a){return/^\+?[\d\s\-\(\)]{10,}$/.test(a)}async checkRateLimit(a,b){let c=new Date,d=this.config.rateLimits,e=this.rateLimitCache.get(a)||[],f=new Date(c.getTime()-6e4),g=new Date(c.getTime()-36e5),h=new Date(c.getTime()-864e5),i=(e=e.filter(a=>a.resetAt>h)).filter(a=>a.resetAt>f).length,j=e.filter(a=>a.resetAt>g).length,k=e.length;return i>=("urgent"===b?d.perMinute+d.urgentBurstLimit:d.perMinute)?{allowed:!1,limit:"perMinute",retryAfterMs:6e4-(c.getTime()-f.getTime())}:j>=d.perHour?{allowed:!1,limit:"perHour",retryAfterMs:36e5-(c.getTime()-g.getTime())}:k>=d.perDay?{allowed:!1,limit:"perDay",retryAfterMs:864e5-(c.getTime()-h.getTime())}:{allowed:!0}}recordRateLimitUsage(a){let b=this.rateLimitCache.get(a)||[];b.push({count:1,resetAt:new Date(Date.now()+864e5)}),this.rateLimitCache.set(a,b)}async checkQuietHours(a,b){let c=this.config.defaultQuietHours;if(!c?.enabled||"urgent"===b&&c.allowUrgent)return{inQuietHours:!1};let d=new Date,[e,f]=c.startTime.split(":").map(Number),[g,h]=c.endTime.split(":").map(Number),i=60*d.getHours()+d.getMinutes(),j=60*e+f,k=60*g+h,l=!1;if((l=j<=k?i>=j&&i<k:i>=j||i<k)&&c.daysOfWeek){let a=d.getDay();c.daysOfWeek.includes(a)||(l=!1)}if(l){let a=new Date(d);return j<=k||i>=j&&a.setDate(a.getDate()+1),a.setHours(g,h,0,0),{inQuietHours:!0,resumeAt:a}}return{inQuietHours:!1}}checkDeduplication(a){let b=this.deduplicationCache.get(a);if(!b)return!1;let c=1e3*this.config.deduplicationWindowSeconds;return Date.now()-b.getTime()<c||(this.deduplicationCache.delete(a),!1)}recordDeduplication(a){this.deduplicationCache.set(a,new Date)}startDeduplicationCleanup(){setInterval(()=>{let a=1e3*this.config.deduplicationWindowSeconds,b=new Date(Date.now()-a);for(let[a,c]of this.deduplicationCache)c<b&&this.deduplicationCache.delete(a)},6e4)}async renderTemplate(a,b){let c=this.templates.get(a);if(!c)throw Error(`Template not found: ${a}`);let d={...c.defaultData,...b},e=c.subject,f=c.bodyTemplate;for(let[a,b]of Object.entries(d)){let c=RegExp(`{{\\s*${a}\\s*}}`,"g"),d=String(b??"");e=e.replace(c,d),f=f.replace(c,d)}return{subject:e,body:f}}async personalizeContent(a,b,c){let d=a;try{let a=await t.z.users.findFirst({where:{OR:[{id:b},{email:b}]},select:{name:!0,email:!0}});if(a){let b=a.name?.split(" ")[0]||"there";d=d.replace(/{{user\.name}}/g,a.name||"").replace(/{{user\.firstName}}/g,b).replace(/{{user\.email}}/g,a.email)}}catch{}if(c)for(let[a,b]of Object.entries(c)){let c=RegExp(`{{\\s*${a}\\s*}}`,"g");d=d.replace(c,String(b??""))}return d}async storeNotificationRecord(a,b){try{await t.z.$executeRaw`
        INSERT INTO notification_logs (
          id, channel, recipient, subject, body, priority, status,
          metadata, action_url, external_id, error_message, created_at
        )
        VALUES (
          ${b.notificationId||this.generateId()},
          ${a.channel},
          ${a.recipient},
          ${a.subject},
          ${a.body},
          ${a.priority},
          ${b.status},
          ${JSON.stringify(a.metadata||{})}::jsonb,
          ${a.actionUrl||null},
          ${b.externalId||null},
          ${b.error||null},
          NOW()
        )
        ON CONFLICT DO NOTHING
      `}catch{this.logger.debug("Could not store notification log")}}initializeTemplates(){this.templates.set("welcome",{id:"welcome",name:"Welcome Email",channel:"email",subject:"Welcome to {{appName}}!",bodyTemplate:`
Hi {{user.firstName}},

Welcome to {{appName}}! We're excited to have you on board.

Here are a few things you can do to get started:
- Complete your profile
- Explore our features
- Connect with your team

If you have any questions, feel free to reach out to our support team.

Best regards,
The {{appName}} Team
      `.trim(),variables:["user.firstName","appName"],defaultData:{appName:"Astralis"}}),this.templates.set("task_assigned",{id:"task_assigned",name:"Task Assigned Notification",channel:"in_app",subject:"New Task Assigned",bodyTemplate:"You have been assigned a new task: {{taskName}}",variables:["taskName"]}),this.templates.set("meeting_reminder",{id:"meeting_reminder",name:"Meeting Reminder",channel:"push",subject:"Meeting Starting Soon",bodyTemplate:'Your meeting "{{meetingTitle}}" starts in {{minutesBefore}} minutes',variables:["meetingTitle","minutesBefore"]}),this.templates.set("intake_received",{id:"intake_received",name:"Intake Received Confirmation",channel:"email",subject:"We received your inquiry",bodyTemplate:`
Hi {{user.firstName}},

Thank you for reaching out! We've received your inquiry and a member of our team will be in touch shortly.

Reference: {{intakeId}}
Subject: {{subject}}

Best regards,
The {{appName}} Team
      `.trim(),variables:["user.firstName","intakeId","subject","appName"],defaultData:{appName:"Astralis"}})}generateId(){return`ntf_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}chunkArray(a,b){let c=[];for(let d=0;d<a.length;d+=b)c.push(a.slice(d,d+b));return c}}let x=new w}};