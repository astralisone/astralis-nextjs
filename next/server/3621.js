exports.id=3621,exports.ids=[3621],exports.modules={6829:(a,b,c)=>{"use strict";c.d(b,{Sd:()=>e,X5:()=>f});var d=c(75625);let e=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number"),name:d.Yj().min(2,"Name must be at least 2 characters").max(100),orgName:d.Yj().min(2,"Organization name required").max(100)}),f=d.Ik({email:d.Yj().email("Invalid email address"),password:d.Yj().min(1,"Password is required")});d.Ik({email:d.Yj().email("Invalid email address")}),d.Ik({token:d.Yj().min(1,"Token is required"),password:d.Yj().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain uppercase letter").regex(/[a-z]/,"Password must contain lowercase letter").regex(/[0-9]/,"Password must contain number")})},15141:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{z:()=>h});var e=c(87984),f=c(99750),g=a([e]);e=(g.then?(await g)():g)[0];class i{constructor(a){this.embeddingModel="text-embedding-3-small",this.embeddingDimensions=1536,this.defaultChunkingOptions={chunkSize:500,overlap:50,maxChunkSize:800},this.retryConfig={maxRetries:3,initialDelayMs:1e3,maxDelayMs:3e4,backoffMultiplier:2},this.batchSize=20,this.rateLimitDelayMs=100;let b=a||process.env.OPENAI_API_KEY;if(!b)throw Error("OpenAI API key is required. Set OPENAI_API_KEY environment variable.");this.openai=new e.default({apiKey:b})}chunkText(a,b={}){let{chunkSize:c,overlap:d,maxChunkSize:e}={...this.defaultChunkingOptions,...b};if(!c||!d||!e)throw Error("Invalid chunking options");let f=a.replace(/\r\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();if(!f)return[];let g=f.split(/\s+/);if(0===g.length)return[];if(g.length<=c)return[f];let h=[],i=0;for(;i<g.length;){let a=Math.min(i+c,g.length);a-i>e&&(a=i+e);let b=g.slice(i,a).join(" ");if(h.push(b),a>=g.length)break;(i+=c-d)<=h.length*d&&(console.warn("[Embedding] Overlap too large, adjusting to prevent infinite loop"),i=a-Math.floor(d/2))}return h}async generateEmbeddings(a){if(!a||0===a.length)return[];let b=[],c=this.batchArray(a,this.batchSize);console.log(`[Embedding] Generating embeddings for ${a.length} chunks in ${c.length} batches`);for(let a=0;a<c.length;a++){let d=c[a];console.log(`[Embedding] Processing batch ${a+1}/${c.length} (${d.length} chunks)`);try{let e=await this.generateEmbeddingBatch(d);b.push(...e),a<c.length-1&&await this.sleep(this.rateLimitDelayMs)}catch(b){throw console.error(`[Embedding] Failed to generate embeddings for batch ${a+1}:`,b),Error(`Embedding generation failed at batch ${a+1}: ${b instanceof Error?b.message:"Unknown error"}`)}}return b}async generateEmbeddingBatch(a){let b=null;for(let c=0;c<=this.retryConfig.maxRetries;c++)try{return(await this.openai.embeddings.create({model:this.embeddingModel,input:a,encoding_format:"float"})).data.sort((a,b)=>a.index-b.index).map(a=>a.embedding)}catch(d){if(b=d instanceof Error?d:Error("Unknown error"),!this.isRetryableError(d)||c>=this.retryConfig.maxRetries)throw console.error("[Embedding] Non-retryable error or max retries reached:",d),b;let a=Math.min(this.retryConfig.initialDelayMs*Math.pow(this.retryConfig.backoffMultiplier,c),this.retryConfig.maxDelayMs);console.warn(`[Embedding] Attempt ${c+1} failed, retrying in ${a}ms...`),await this.sleep(a)}throw b||Error("Failed to generate embeddings after retries")}async storeEmbeddings(a,b,c,d){if(c.length!==d.length)throw Error(`Chunks and embeddings length mismatch: ${c.length} vs ${d.length}`);console.log(`[Embedding] Storing ${c.length} embeddings for document ${a}`);try{let e=await f.z.documentEmbedding.deleteMany({where:{documentId:a}});e.count>0&&console.log(`[Embedding] Deleted ${e.count} existing embeddings`);let g=c.map((c,e)=>({documentId:a,orgId:b,chunkIndex:e,content:c,embedding:JSON.stringify(d[e]),metadata:{wordCount:c.split(/\s+/).length,charCount:c.length}})),h=await f.z.documentEmbedding.createMany({data:g,skipDuplicates:!1});console.log(`[Embedding] Successfully stored ${h.count} embeddings`)}catch(a){throw console.error("[Embedding] Failed to store embeddings in database:",a),Error(`Failed to store embeddings: ${a instanceof Error?a.message:"Unknown error"}`)}}async embedDocument(a){console.log(`[Embedding] Starting embedding process for document ${a}`);let b=Date.now();try{let c=await f.z.document.findUnique({where:{id:a},select:{id:!0,orgId:!0,fileName:!0,ocrText:!0,status:!0}});if(!c)throw Error(`Document not found: ${a}`);if(!c.ocrText)throw Error(`Document ${a} has no OCR text. Run OCR processing first.`);"COMPLETED"!==c.status&&console.warn(`[Embedding] Document status is ${c.status}, not COMPLETED. Proceeding anyway.`),console.log(`[Embedding] Processing document: ${c.fileName} (${c.ocrText.length} characters)`);let d=this.chunkText(c.ocrText);if(console.log(`[Embedding] Created ${d.length} chunks`),0===d.length)throw Error("No chunks generated from OCR text");let e=await this.generateEmbeddings(d);if(e.length!==d.length)throw Error(`Embedding count mismatch: expected ${d.length}, got ${e.length}`);await this.storeEmbeddings(c.id,c.orgId,d,e);let g=Date.now()-b;console.log(`[Embedding] Successfully embedded document ${a} in ${g}ms`),console.log(`[Embedding] Stats: ${d.length} chunks, ${e.length} embeddings, avg chunk size: ${Math.round(c.ocrText.length/d.length)} chars`)}catch(b){throw console.error(`[Embedding] Failed to embed document ${a}:`,b),Error(`Document embedding failed: ${b instanceof Error?b.message:"Unknown error"}`)}}async embedDocuments(a){console.log(`[Embedding] Batch embedding ${a.length} documents`);let b=[],c=[];for(let d of a){try{await this.embedDocument(d),b.push(d)}catch(b){let a=b instanceof Error?b.message:"Unknown error";console.error(`[Embedding] Failed to embed document ${d}:`,a),c.push({documentId:d,error:a})}a.indexOf(d)<a.length-1&&await this.sleep(500)}return console.log(`[Embedding] Batch complete: ${b.length} successful, ${c.length} failed`),{successful:b,failed:c}}async searchSimilarChunks(a,b,c=5,d){console.log(`[Embedding] Searching for similar chunks in org ${b}`);let e=(await this.generateEmbeddings([a]))[0],g=(await f.z.documentEmbedding.findMany({where:{orgId:b,...d&&{documentId:d}},select:{documentId:!0,chunkIndex:!0,content:!0,embedding:!0}})).map(a=>{let b=JSON.parse(a.embedding),c=this.cosineSimilarity(e,b);return{documentId:a.documentId,chunkIndex:a.chunkIndex,content:a.content,similarity:c}}).sort((a,b)=>b.similarity-a.similarity).slice(0,c);return console.log(`[Embedding] Found ${g.length} similar chunks (top ${c})`),g}cosineSimilarity(a,b){if(a.length!==b.length)throw Error("Vectors must have the same length");let c=0,d=0,e=0;for(let f=0;f<a.length;f++)c+=a[f]*b[f],d+=a[f]*a[f],e+=b[f]*b[f];return(d=Math.sqrt(d),e=Math.sqrt(e),0===d||0===e)?0:c/(d*e)}batchArray(a,b){let c=[];for(let d=0;d<a.length;d+=b)c.push(a.slice(d,d+b));return c}sleep(a){return new Promise(b=>setTimeout(b,a))}isRetryableError(a){if(a instanceof Error){let b=a.message.toLowerCase();if(b.includes("rate limit")||b.includes("timeout")||b.includes("network")||b.includes("econnreset")||b.includes("econnrefused")||b.includes("socket hang up")||b.includes("503")||b.includes("502")||b.includes("500"))return!0;if(b.includes("401")||b.includes("403")||b.includes("400")||b.includes("invalid")||b.includes("api key"))return!1}return!0}async getEmbeddingStats(a){let b=await f.z.documentEmbedding.findMany({where:{documentId:a},select:{content:!0}});if(0===b.length)return null;let c=b.map(a=>a.content.split(/\s+/).length),d=c.reduce((a,b)=>a+b,0);return{totalChunks:b.length,totalWords:d,avgChunkSize:Math.round(d/b.length),minChunkSize:Math.min(...c),maxChunkSize:Math.max(...c)}}}let j=null;function h(a){return j||(j=new i(a)),j}d()}catch(a){d(a)}})},20229:(a,b,c)=>{"use strict";c.d(b,{N:()=>k,j:()=>l});var d=c(89966),e=c(26413),f=c(4696),g=c(13028),h=c(99750),i=c(65585),j=c(6829);let k={adapter:(0,g.y)(h.z),providers:[(0,e.A)({id:"credentials",name:"Email & Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){let b=j.X5.safeParse(a);if(!b.success)return null;let{email:c,password:d}=b.data,e=await h.z.users.findUnique({where:{email:c},include:{organization:!0}});return e&&e.password&&await (0,i.BE)(d,e.password)?{id:e.id,email:e.email,name:e.name,role:e.role,orgId:e.orgId||"",image:e.avatar}:null}}),(0,f.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{async jwt({token:a,user:b,account:c,trigger:d,session:e}){if(b&&(a.id=b.id,a.role=b.role,a.orgId=b.orgId,a.picture=b.image),"update"===d&&e&&(void 0!==e.image&&(a.picture=e.image),void 0!==e.name&&(a.name=e.name)),c?.provider==="google"&&b){let c=await h.z.users.findUnique({where:{id:b.id},include:{organization:!0}});c&&(a.orgId=c.orgId||"",a.role=c.role,a.picture=c.avatar)}return a},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id,a.user.role=b.role,a.user.orgId=b.orgId,a.user.image=b.picture),a),async signIn({user:a,account:b,profile:c}){if(b?.provider==="email")return!0;if(b?.provider==="google"){let b=await h.z.users.findUnique({where:{email:a.email},include:{organization:!0}});if(!b?.organization){let c=await h.z.organization.create({data:{name:`${a.name}'s Organization`,users:{connect:{id:b.id}}}});await h.z.users.update({where:{id:b.id},data:{orgId:c.id,role:"ADMIN"}})}}return!0}},pages:{signIn:"/auth/signin",signOut:"/auth/signout",error:"/auth/error",verifyRequest:"/auth/verify-email"},events:{async signIn({user:a}){}}},l=()=>(0,d.getServerSession)(k)},56931:()=>{},65585:(a,b,c)=>{"use strict";c.d(b,{BE:()=>i,Er:()=>h,HU:()=>j,Yc:()=>m,w:()=>l});var d=c(84437),e=c(55511),f=c.n(e);let g="aes-256-gcm";async function h(a){if(!a||"string"!=typeof a)throw TypeError("hashPassword: password must be a non-empty string");return d.tW(a,12)}async function i(a,b){return d.UD(a,b)}function j(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}function k(){let a=process.env.N8N_ENCRYPTION_KEY||process.env.NEXTAUTH_SECRET;if(!a)throw Error("Encryption key not found in environment variables");return f().pbkdf2Sync(a,"astralis-salt",1e5,32,"sha256")}function l(a){try{let b=f().randomBytes(16),c=f().randomBytes(64),d=k(),e=f().createCipheriv(g,d,b),h=e.update(a,"utf8","hex");h+=e.final("hex");let i=e.getAuthTag();return c.toString("hex")+":"+b.toString("hex")+":"+i.toString("hex")+":"+h}catch(a){throw console.error("Encryption error:",a),Error("Failed to encrypt data")}}function m(a){try{let b=a.split(":");if(4!==b.length)throw Error("Invalid encrypted data format");Buffer.from(b[0],"hex");let c=Buffer.from(b[1],"hex"),d=Buffer.from(b[2],"hex"),e=b[3],h=k(),i=f().createDecipheriv(g,h,c);i.setAuthTag(d);let j=i.update(e,"hex","utf8");return j+=i.final("utf8")}catch(a){throw console.error("Decryption error:",a),Error("Failed to decrypt data")}}},71003:()=>{},99750:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient({log:["error","warn"]})}};